 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\AssemblyInfo.cs 
======================================================== 
﻿using System.Reflection;
using System.Runtime.InteropServices;

[assembly: AssemblyTitle("Andromeda Emulator")]
[assembly: AssemblyCompany("")]
[assembly: AssemblyProduct("Andromeda Emulator")]
[assembly: AssemblyCopyright("Copyright ©  2018")]
[assembly: AssemblyFileVersion("1.0.0.0")]
[assembly: AssemblyDescription("")]
[assembly: AssemblyConfiguration("")]
[assembly: AssemblyTrademark("")]
[assembly: ComVisible(false)]
[assembly: Guid("dd076b3b-3056-431c-b4fc-06f49ed8cf2f")]
[assembly: AssemblyVersion("1.0.0.0")]
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Input.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Input
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Config;
using OrbitReborn_Emulator.Game.Sessions;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Threading;

namespace OrbitReborn_Emulator
{
  public static class Input
  {
    public static Timer mTimer;

    public static void Listen()
    {
      while (Program.Alive)
      {
        if (Console.ReadKey(true).Key == ConsoleKey.Enter)
        {
          Console.Write("$" + Environment.UserName.ToLower() + "@Andromeda> ");
          string str = Console.ReadLine();
          if (str.Length > 0)
            Input.ProcessInput(str.Split(' '));
        }
      }
    }

    public static void StopDelay(object state)
    {
      int num = (int) state;
      if (num == 0)
      {
        Program.Stop();
      }
      else
      {
        foreach (Session key in (IEnumerable<Session>) SessionManager.SessionsUser.Keys)
        {
          if (key != null)
          {
            string str = "Server stopping in -= " + (object) num + " =-";
            key.SendData(PacketComposer.Compose("A", "STD|" + str));
          }
        }
        Input.mTimer = new Timer(new TimerCallback(Input.StopDelay), (object) (num - 1), 1000, 0);
      }
    }

    public static void ProcessInput(string[] Args)
    {
      switch (Args[0].ToLower())
      {
        case "delay":
          int result = 5000;
          if (Args.Length > 1)
            int.TryParse(Args[1], out result);
          Thread.Sleep(result);
          break;
        case "restart":
          Process.Start(Environment.CurrentDirectory + "\\OrbitReborn.exe", "\"delay 1500\"");
          Program.Stop();
          break;
        case "crash":
          Environment.FailFast(string.Empty);
          break;
        case "stop":
          Timer timer = new Timer(new TimerCallback(Input.StopDelay), (object) null, TimeSpan.FromSeconds(1.0), TimeSpan.FromSeconds(1.0));
          break;
        case "cls":
          Output.ClearStream();
          break;
        default:
          Output.WriteLine((object) Localization.GetValue("core.input.error", Args[0].ToLower()), OutputLevel.Warning);
          break;
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Output.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Output
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Config;
using System;
using System.IO;
using System.Text;

namespace OrbitReborn_Emulator
{
  public static class Output
  {
    private static bool mEnableLogging;
    private static string mLogFilePath;
    private static OutputLevel mVerbosityLevel;
    private static object mWritebackSyncRoot;

    public static void InitializeStream(bool EnableLogging, OutputLevel VerbosityLevel)
    {
      Output.mEnableLogging = EnableLogging;
      Output.mVerbosityLevel = VerbosityLevel;
      Output.mWritebackSyncRoot = new object();
      if (EnableLogging)
      {
        DateTime now = DateTime.Now;
        string path = Constants.LogFileDirectory + "\\";
        Output.mLogFilePath = path + now.ToString("dd-MM-yy [HH\\hmm]") + ".log";
        try
        {
          if (!Directory.Exists(path))
            Directory.CreateDirectory(path);
          File.WriteAllText(Output.mLogFilePath, Output.ComposeDefaultLogHeader(), Constants.DefaultEncoding);
        }
        catch (Exception ex)
        {
          Output.mEnableLogging = false;
        }
      }
      Output.ClearStream();
      Output.WriteBanner();
    }

    public static void ClearStream()
    {
      Console.Clear();
      Console.Title = Constants.ConsoleTitle;
      Console.WindowWidth = Constants.ConsoleWindowWidth;
      Console.WindowHeight = Constants.ConsoleWindowHeight;
      Output.ResetColorScheme();
    }

    private static void ResetColorScheme()
    {
      Output.ApplyColorScheme(ConsoleColor.Gray, ConsoleColor.Black);
    }

    private static void ApplyColorScheme(ConsoleColor ForegroundColor)
    {
      Output.ApplyColorScheme(ForegroundColor, ConsoleColor.Black);
    }

    private static void ApplyColorScheme(ConsoleColor ForegroundColor, ConsoleColor BackgroundColor)
    {
      Console.ForegroundColor = ForegroundColor;
      Console.BackgroundColor = BackgroundColor;
    }

    private static void SetColorSchemeForSeverity(OutputLevel SeverityLevel)
    {
      switch (SeverityLevel)
      {
        case OutputLevel.DebugInformation:
          Output.ApplyColorScheme(ConsoleColor.DarkGray);
          break;
        case OutputLevel.Notification:
          Output.ApplyColorScheme(ConsoleColor.Green);
          break;
        case OutputLevel.Warning:
          Output.ApplyColorScheme(ConsoleColor.Yellow);
          break;
        case OutputLevel.CriticalError:
          Output.ApplyColorScheme(ConsoleColor.Red);
          break;
        default:
          Output.ResetColorScheme();
          break;
      }
    }

    public static void WriteBanner()
    {
      Output.ApplyColorScheme(ConsoleColor.Green);
      Console.WriteLine("Andromeda, version 2.5.0 by Soukyone, credits : LoW, Adion, mwK");
      Console.WriteLine();
      Output.ResetColorScheme();
    }

    private static string ComposeDefaultLogHeader()
    {
      StringBuilder stringBuilder = new StringBuilder("## OrbitReborn" + (object) Constants.LineBreakChar);
      stringBuilder.Append("## Server output log file" + (object) Constants.LineBreakChar);
      stringBuilder.Append("## " + DateTime.Now.ToLongDateString() + " " + DateTime.Now.ToLongTimeString() + (object) Constants.LineBreakChar);
      stringBuilder.Append(Constants.LineBreakChar);
      return stringBuilder.ToString();
    }

    private static void WriteLogIfNeeded(object Line)
    {
      if (!Output.mEnableLogging)
        return;
      lock (Output.mWritebackSyncRoot)
        File.AppendAllText(Output.mLogFilePath, Output.FormatTimestamp() + Line + (object) Constants.LineBreakChar, Constants.DefaultEncoding);
    }

    public static void WriteLine()
    {
      if (Output.mVerbosityLevel > OutputLevel.Notification)
        return;
      Console.WriteLine();
      Output.WriteLogIfNeeded((object) Constants.LineBreakChar.ToString());
    }

    public static void WriteLine(object Line)
    {
      Output.WriteLine(Line, OutputLevel.Informational);
    }

    public static void WriteLine(object Line, OutputLevel Level)
    {
      if (Output.mVerbosityLevel > Level)
        return;
      Console.Write(Output.FormatTimestamp());
      Output.SetColorSchemeForSeverity(Level);
      Console.WriteLine(Line);
      Output.ResetColorScheme();
      Output.WriteLogIfNeeded(Line);
    }

    private static string FormatTimestamp()
    {
      return DateTime.Now.ToString("[HH\\hmm\\sss\\mff]");
    }

    public static void SetVerbosityLevel(OutputLevel OutputLevel)
    {
      Output.mVerbosityLevel = OutputLevel;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\OutputLevel.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.OutputLevel
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator
{
  public enum OutputLevel
  {
    DebugInformation = -1,
    Informational = 0,
    Notification = 1,
    Warning = 2,
    CriticalError = 3,
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Program.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Program
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Config;
using OrbitReborn_Emulator.Game.Characters;
using OrbitReborn_Emulator.Game.Chat;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Handlers;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Misc;
using OrbitReborn_Emulator.Game.Moderation;
using OrbitReborn_Emulator.Game.Npcs;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Network;
using OrbitReborn_Emulator.Specialized;
using OrbitReborn_Emulator.Storage;
using OrbitReborn_Emulator.Util;
using ScreenShotDemo;
using System;
using System.Diagnostics;
using System.Drawing.Imaging;
using System.Net;
using System.Security.Permissions;
using System.Text;
using System.Threading;

namespace OrbitReborn_Emulator
{
    public static class Program
    {
        private static bool mAlive;
        private static System.Threading.Timer mServerMonitor;
        private static DateTime InitStart;
        private static SocketListener mServer;

        public static bool Alive
        {
            get
            {
                return !Environment.HasShutdownStarted && Program.mAlive;
            }
        }

        [SecurityPermission(SecurityAction.Demand, Flags = SecurityPermissionFlag.ControlAppDomain)]
        public static void Main(string[] args)
        {
            AppDomain.CurrentDomain.UnhandledException += new UnhandledExceptionEventHandler(Program.CurrentDomain_UnhandledException);
            Console.OutputEncoding = Encoding.UTF8;
            Program.mAlive = true;

            GC.KeepAlive((object)Program.mServerMonitor);
            Program.InitStart = DateTime.Now;

            Output.InitializeStream(true, OutputLevel.DebugInformation);
            Output.WriteLine((object)"Initializing Andromeda's Emulator...");

            ConfigManager.Initialize(Constants.DataFileDirectory + "\\server-main.cfg");
            Output.SetVerbosityLevel((OutputLevel)ConfigManager.GetValue("output.verbositylevel"));

            Localization.Initialize(Constants.LangFileDirectory + "\\lang_" + ConfigManager.GetValue("lang") + ".lang");

            foreach (string str in args)
            {
                Output.WriteLine((object)Localization.GetValue("core.init.cmdarg", str));
                Input.ProcessInput(str.Split(' '));
            }

            try
            {
                Output.WriteLine((object)Localization.GetValue("core.init.mysql", (string[])null));
                SqlDatabaseManager.Initialize();

                Output.WriteLine((object)Localization.GetValue("core.init.net", ConfigManager.GetValue("net.bind.port").ToString()));
                Program.mServer = new SocketListener(
                    new IPEndPoint(IPAddress.Any, (int)ConfigManager.GetValue("net.bind.port")),
                    (int)ConfigManager.GetValue("net.backlog"),
                    new OnNewConnectionCallback(SessionManager.HandleIncomingConnection)
                );

                // ⭐ AJOUT : démarrage du serveur WebSocket HTML5
                WebSocketGameServer.Start();

                using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                {
                    Output.WriteLine((object)Localization.GetValue("core.init.dbcleanup", (string[])null));
                    Program.PerformDatabaseCleanup(client);

                    Output.WriteLine((object)Localization.GetValue("core.init.game", (string[])null));
                    DataRouter.Initialize();
                    Handshake.Initialize();
                    SettingsHandlers.Initialize();
                    ShipMovement.Initialize();
                    Fight.Initialize();
                    SessionManager.Initialize();
                    CharacterInfoLoader.Initialize();
                    SelectAction.Initialize();
                    OrbitReborn_Emulator.Game.Handlers.Chat.Initialize();
                    Others.Initialize();
                    Laboratory.Initialize();
                    NpcManager.Initialize();
                    Spaceball.Initialize();
                    Survivor.Initialize();
                    PvPFarming.Initialize();
                    Invasion.Initialize();
                    Groupsystem.Initialize();
                    MapManager.Initialize(client);
                    MapInfoLoader.Initialize();
                    ChatManager.Initialize();
                    PortalManager.Initialize();
                    NpcAI.LaunchAI();
                    ModerationBanManager.Initialize(client);
                    CrossdomainPolicy.Initialize("Data\\crossdomain.xml");
                    StatisticsSyncUtil.Initialize();
                    _1v1.initialize();
                }
            }
            catch (Exception ex)
            {
                Program.HandleFatalError(Localization.GetValue("core.init.error.details", new string[2]
                {
                    ex.Message,
                    ex.StackTrace
                }));
                return;
            }

            Output.WriteLine(
                (object)Localization.GetValue("core.init.ok", Math.Round((DateTime.Now - Program.InitStart).TotalSeconds, 2).ToString()),
                OutputLevel.Notification
            );

            Output.WriteLine((object)Localization.GetValue("core.init.ok.cmdinfo", (string[])null), OutputLevel.Notification);

            Program.mServerMonitor = new System.Threading.Timer(
                new TimerCallback(Program.ServerMonitor),
                (object)null,
                TimeSpan.FromSeconds(5.0),
                TimeSpan.FromSeconds(5.0)
            );

            Input.Listen();
        }

        private static void PerformDatabaseCleanup(SqlDatabaseClient MySqlClient)
        {
            MySqlClient.ExecuteNonQuery("UPDATE users SET online = 0");
        }

        private static void CurrentDomain_UnhandledException(object sender, UnhandledExceptionEventArgs e)
        {
            Output.WriteLine((object)(e.ExceptionObject as Exception).ToString());
            ScreenCapture screenCapture = new ScreenCapture();
            screenCapture.CaptureScreen();

            IntPtr mainWindowHandle = Process.GetCurrentProcess().MainWindowHandle;
            string str = DateTime.Now.ToString("dd-MM-yy [HH\\hmm]");
            screenCapture.CaptureWindowToFile(mainWindowHandle, "C:\\" + str + "_error.gif", ImageFormat.Gif);
        }

        public static void HandleFatalError(string Message)
        {
            Output.WriteLine((object)Message, OutputLevel.CriticalError);
            Output.WriteLine((object)Localization.GetValue("core.init.error.pressanykey", (string[])null), OutputLevel.CriticalError);
            Console.ReadKey(true);
            Program.Stop();
        }

        public static void ServerMonitor(object state)
        {
            Console.Title = "Andromeda | uptime : " +
                string.Format("{0:%d}d {0:%h}h {0:%m}m {0:%s}s", (object)(DateTime.Now - Program.InitStart)) +
                " | Sessions : " + (object)SessionManager.ActiveConnections +
                " | Players : " + (object)SessionManager.ConnectedUserData.Count +
                " | Running timer : " + (object)TimerManager.TimerRunning +
                " | " + (object)Math.Round((double)GC.GetTotalMemory(false) / 1048576.0, 2) + " MB ";
        }

        public static void Stop()
        {
            Output.WriteLine((object)Localization.GetValue("core.uninit", (string[])null));
            Program.mAlive = false;
            SqlDatabaseManager.Uninitialize();
            Program.mServer.Dispose();
            Program.mServer = (SocketListener)null;
            Environment.Exit(0);
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\UnixTimestamp.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.UnixTimestamp
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System;

namespace OrbitReborn_Emulator
{
  public static class UnixTimestamp
  {
    public static double GetCurrent()
    {
      return (DateTime.Now - new DateTime(1970, 1, 1, 0, 0, 0)).TotalSeconds;
    }

    public static DateTime GetDateTimeFromUnixTimestamp(double Timestamp)
    {
      DateTime dateTime = new DateTime(1970, 1, 1, 0, 0, 0, 0);
      dateTime = dateTime.AddSeconds(Timestamp);
      return dateTime;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\WebSocketGameServer.cs 
======================================================== 
﻿using System;
using System.Net;
using System.Net.Sockets;
using System.Security.Cryptography;
using System.Text;
using System.Threading;
using OrbitReborn_Emulator.Util;

namespace OrbitReborn_Emulator.Network
{
    public static class WebSocketGameServer
    {
        private static TcpListener _listener;
        private static bool _isRunning = false;

        public static void Start()
        {
            if (_isRunning)
                return;

            int port = 8081;

            try
            {
                _listener = new TcpListener(IPAddress.Any, port);
                _listener.Start();
                _isRunning = true;

                Output.WriteLine($"[WebSocket] Serveur WebSocket démarré sur ws://127.0.0.1:{port}", OutputLevel.Notification);

                Thread acceptThread = new Thread(AcceptClients);
                acceptThread.Start();
            }
            catch (Exception ex)
            {
                Output.WriteLine($"[WebSocket] Erreur lors du démarrage : {ex.Message}", OutputLevel.CriticalError);
            }
        }

        private static void AcceptClients()
        {
            while (_isRunning)
            {
                TcpClient client = _listener.AcceptTcpClient();
                Thread clientThread = new Thread(() => HandleClient(client));
                clientThread.Start();
            }
        }

        private static void HandleClient(TcpClient client)
        {
            NetworkStream stream = client.GetStream();

            // Read client handshake
            byte[] buffer = new byte[1024];
            int byteCount = stream.Read(buffer, 0, buffer.Length);
            string request = Encoding.UTF8.GetString(buffer, 0, byteCount);

            if (request.Contains("Sec-WebSocket-Key"))
            {
                string key = request.Split(new string[] { "Sec-WebSocket-Key: " }, StringSplitOptions.None)[1]
                                    .Split('\r')[0]
                                    .Trim();

                string responseKey = ComputeWebSocketAcceptKey(key);

                string handshakeResponse =
                    "HTTP/1.1 101 Switching Protocols\r\n" +
                    "Connection: Upgrade\r\n" +
                    "Upgrade: websocket\r\n" +
                    "Sec-WebSocket-Accept: " + responseKey + "\r\n\r\n";

                byte[] responseBytes = Encoding.UTF8.GetBytes(handshakeResponse);
                stream.Write(responseBytes, 0, responseBytes.Length);

                Output.WriteLine("[WebSocket] Client connecté", OutputLevel.Notification);

                SendMessage(stream, "Hello from WebSocket server!");

                // Listen for messages from client
                while (client.Connected)
                {
                    try
                    {
                        byte[] msgBuffer = new byte[1024];
                        int msgCount = stream.Read(msgBuffer, 0, msgBuffer.Length);
                        if (msgCount == 0) break;

                        string decoded = DecodeMessage(msgBuffer, msgCount);
                        Output.WriteLine($"[WebSocket] Message reçu : {decoded}", OutputLevel.DebugInformation);

                        // Echo back
                        SendMessage(stream, "Server received: " + decoded);
                    }
                    catch { break; }
                }
            }

            client.Close();
        }

        private static string ComputeWebSocketAcceptKey(string key)
        {
            string longKey = key + "258EAFA5-E914-47DA-95CA-C5AB0DC85B11";

            SHA1 sha1 = SHA1.Create();
            byte[] hash = sha1.ComputeHash(Encoding.UTF8.GetBytes(longKey));

            return Convert.ToBase64String(hash);
        }

        private static string DecodeMessage(byte[] buffer, int length)
        {
            int dataStart = 2;
            byte mask1 = buffer[2];
            byte mask2 = buffer[3];
            byte mask3 = buffer[4];
            byte mask4 = buffer[5];

            dataStart = 6;

            byte[] decoded = new byte[length - dataStart];

            for (int i = dataStart; i < length; i++)
            {
                decoded[i - dataStart] = (byte)(buffer[i] ^ new byte[] { mask1, mask2, mask3, mask4 }[(i - dataStart) % 4]);
            }

            return Encoding.UTF8.GetString(decoded);
        }

        public static void SendMessage(NetworkStream stream, string message)
        {
            byte[] response = EncodeMessage(message);
            stream.Write(response, 0, response.Length);
        }

        public static byte[] EncodeMessage(string message)
        {
            byte[] response;
            byte[] rawData = Encoding.UTF8.GetBytes(message);

            if (rawData.Length <= 125)
            {
                response = new byte[2 + rawData.Length];
                response[1] = (byte)rawData.Length;
                Buffer.BlockCopy(rawData, 0, response, 2, rawData.Length);
            }
            else
            {
                throw new NotImplementedException("Longer WebSocket frames not implemented yet.");
            }

            response[0] = 0x81; // text frame

            return response;
        }

        public static void Stop()
        {
            if (!_isRunning)
                return;

            _isRunning = false;
            _listener.Stop();

            Output.WriteLine("[WebSocket] Serveur WebSocket arrêté.", OutputLevel.Notification);
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\.vs\Andromeda Emulator\v17\DocumentLayout.backup.json 
======================================================== 
{
  "Version": 1,
  "WorkspaceRootPath": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\",
  "Documents": [
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|c:\\users\\the_k\\onedrive\\desktop\\serveur andromeda\\server\\andromeda-emu source\\communication\\outgoing\\mapheroinitcomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\outgoing\\mapheroinitcomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|c:\\users\\the_k\\onedrive\\desktop\\serveur andromeda\\server\\andromeda-emu source\\game\\maps\\mapinstance.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\maps\\mapinstance.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\game\\handlers\\shipmovement.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\handlers\\shipmovement.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|c:\\users\\the_k\\onedrive\\desktop\\serveur andromeda\\server\\andromeda-emu source\\communication\\outgoing\\mapuserleavecomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\outgoing\\mapuserleavecomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\communication\\outgoing\\mapusermovementlistcomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\outgoing\\mapusermovementlistcomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\communication\\outgoing\\mapuserentercomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\outgoing\\mapuserentercomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\websocketgameserver.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:websocketgameserver.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\communication\\clientmessage.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\clientmessage.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\game\\sessions\\singlesignonauthenticator.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\sessions\\singlesignonauthenticator.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\game\\handlers\\handshake.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\handlers\\handshake.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\communication\\incoming\\datarouter.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\incoming\\datarouter.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\game\\handlers\\selectaction.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\handlers\\selectaction.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\program.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:program.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    }
  ],
  "DocumentGroupContainers": [
    {
      "Orientation": 0,
      "VerticalTabListWidth": 256,
      "DocumentGroups": [
        {
          "DockedWidth": 200,
          "SelectedChildIndex": 0,
          "Children": [
            {
              "$type": "Document",
              "DocumentIndex": 0,
              "Title": "MapHeroInitComposer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapHeroInitComposer.cs",
              "RelativeDocumentMoniker": "Communication\\Outgoing\\MapHeroInitComposer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapHeroInitComposer.cs*",
              "RelativeToolTip": "Communication\\Outgoing\\MapHeroInitComposer.cs*",
              "ViewState": "AgIAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T13:35:44.523Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 1,
              "Title": "MapInstance.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Maps\\MapInstance.cs",
              "RelativeDocumentMoniker": "Game\\Maps\\MapInstance.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Maps\\MapInstance.cs",
              "RelativeToolTip": "Game\\Maps\\MapInstance.cs",
              "ViewState": "AgIAAFYBAAAAAAAAAAAhwHEBAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T12:30:37.824Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 3,
              "Title": "MapUserLeaveComposer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserLeaveComposer.cs",
              "RelativeDocumentMoniker": "Communication\\Outgoing\\MapUserLeaveComposer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserLeaveComposer.cs",
              "RelativeToolTip": "Communication\\Outgoing\\MapUserLeaveComposer.cs",
              "ViewState": "AgIAAAAAAAAAAAAAAAAAABMAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T00:23:27.099Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 4,
              "Title": "MapUserMovementListComposer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserMovementListComposer.cs",
              "RelativeDocumentMoniker": "Communication\\Outgoing\\MapUserMovementListComposer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserMovementListComposer.cs",
              "RelativeToolTip": "Communication\\Outgoing\\MapUserMovementListComposer.cs",
              "ViewState": "AgIAAB4AAAAAAAAAAAAqwEUAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T00:21:04.431Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 5,
              "Title": "MapUserEnterComposer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserEnterComposer.cs",
              "RelativeDocumentMoniker": "Communication\\Outgoing\\MapUserEnterComposer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserEnterComposer.cs",
              "RelativeToolTip": "Communication\\Outgoing\\MapUserEnterComposer.cs",
              "ViewState": "AgIAADQAAAAAAAAAAAAAAFsAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T00:20:05.111Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 2,
              "Title": "ShipMovement.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\ShipMovement.cs",
              "RelativeDocumentMoniker": "Game\\Handlers\\ShipMovement.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\ShipMovement.cs",
              "RelativeToolTip": "Game\\Handlers\\ShipMovement.cs",
              "ViewState": "AgIAAB0CAAAAAAAAAAAiwEMCAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T22:58:09.113Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 8,
              "Title": "SingleSignOnAuthenticator.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Sessions\\SingleSignOnAuthenticator.cs",
              "RelativeDocumentMoniker": "Game\\Sessions\\SingleSignOnAuthenticator.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Sessions\\SingleSignOnAuthenticator.cs",
              "RelativeToolTip": "Game\\Sessions\\SingleSignOnAuthenticator.cs",
              "ViewState": "AgIAAEIAAAAAAAAAAAAcwHEAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T16:59:47.255Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 9,
              "Title": "Handshake.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\Handshake.cs",
              "RelativeDocumentMoniker": "Game\\Handlers\\Handshake.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\Handshake.cs",
              "RelativeToolTip": "Game\\Handlers\\Handshake.cs",
              "ViewState": "AgIAAAQAAAAAAAAAAAAewCIAAACCAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T15:05:30.602Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 10,
              "Title": "DataRouter.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Incoming\\DataRouter.cs",
              "RelativeDocumentMoniker": "Communication\\Incoming\\DataRouter.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Incoming\\DataRouter.cs",
              "RelativeToolTip": "Communication\\Incoming\\DataRouter.cs",
              "ViewState": "AgIAACQAAAAAAAAAAAAAwE4AAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T14:46:23.853Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 11,
              "Title": "SelectAction.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\SelectAction.cs",
              "RelativeDocumentMoniker": "Game\\Handlers\\SelectAction.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\SelectAction.cs",
              "RelativeToolTip": "Game\\Handlers\\SelectAction.cs",
              "ViewState": "AgIAANEAAAAAAAAAAAA3wP0AAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T14:24:51.684Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 6,
              "Title": "WebSocketGameServer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\WebSocketGameServer.cs",
              "RelativeDocumentMoniker": "WebSocketGameServer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\WebSocketGameServer.cs",
              "RelativeToolTip": "WebSocketGameServer.cs",
              "ViewState": "AgIAAJMAAAAAAAAAAAAwwKoAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T00:15:31.793Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 12,
              "Title": "Program.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Program.cs",
              "RelativeDocumentMoniker": "Program.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Program.cs",
              "RelativeToolTip": "Program.cs",
              "ViewState": "AgIAAJoAAAAAAAAAAADwv8EAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T00:10:46.458Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 7,
              "Title": "ClientMessage.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\ClientMessage.cs",
              "RelativeDocumentMoniker": "Communication\\ClientMessage.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\ClientMessage.cs",
              "RelativeToolTip": "Communication\\ClientMessage.cs",
              "ViewState": "AgIAACgAAAAAAAAAAAAAAFUAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-16T21:55:15.623Z"
            }
          ]
        }
      ]
    }
  ]
} 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\.vs\Andromeda Emulator\v17\DocumentLayout.json 
======================================================== 
{
  "Version": 1,
  "WorkspaceRootPath": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\",
  "Documents": [
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|c:\\users\\the_k\\onedrive\\desktop\\serveur andromeda\\server\\andromeda-emu source\\communication\\outgoing\\mapheroinitcomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\outgoing\\mapheroinitcomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|c:\\users\\the_k\\onedrive\\desktop\\serveur andromeda\\server\\andromeda-emu source\\game\\maps\\mapinstance.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\maps\\mapinstance.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\game\\handlers\\shipmovement.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\handlers\\shipmovement.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|c:\\users\\the_k\\onedrive\\desktop\\serveur andromeda\\server\\andromeda-emu source\\communication\\outgoing\\mapuserleavecomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\outgoing\\mapuserleavecomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\communication\\outgoing\\mapusermovementlistcomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\outgoing\\mapusermovementlistcomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\communication\\outgoing\\mapuserentercomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\outgoing\\mapuserentercomposer.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\websocketgameserver.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:websocketgameserver.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\communication\\clientmessage.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\clientmessage.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\game\\sessions\\singlesignonauthenticator.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\sessions\\singlesignonauthenticator.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\game\\handlers\\handshake.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\handlers\\handshake.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\communication\\incoming\\datarouter.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:communication\\incoming\\datarouter.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\game\\handlers\\selectaction.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:game\\handlers\\selectaction.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\program.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}",
      "RelativeMoniker": "D:0:0:{FF1A2832-6C91-4013-9E43-FAF76040FC29}|Andromeda Emulator.csproj|solutionrelative:program.cs||{A6C744A8-0E4A-4FC6-886A-064283054674}"
    }
  ],
  "DocumentGroupContainers": [
    {
      "Orientation": 0,
      "VerticalTabListWidth": 256,
      "DocumentGroups": [
        {
          "DockedWidth": 200,
          "SelectedChildIndex": 0,
          "Children": [
            {
              "$type": "Document",
              "DocumentIndex": 0,
              "Title": "MapHeroInitComposer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapHeroInitComposer.cs",
              "RelativeDocumentMoniker": "Communication\\Outgoing\\MapHeroInitComposer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapHeroInitComposer.cs",
              "RelativeToolTip": "Communication\\Outgoing\\MapHeroInitComposer.cs",
              "ViewState": "AgIAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T13:35:44.523Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 1,
              "Title": "MapInstance.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Maps\\MapInstance.cs",
              "RelativeDocumentMoniker": "Game\\Maps\\MapInstance.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Maps\\MapInstance.cs",
              "RelativeToolTip": "Game\\Maps\\MapInstance.cs",
              "ViewState": "AgIAAFYBAAAAAAAAAAAhwHEBAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T12:30:37.824Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 3,
              "Title": "MapUserLeaveComposer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserLeaveComposer.cs",
              "RelativeDocumentMoniker": "Communication\\Outgoing\\MapUserLeaveComposer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserLeaveComposer.cs",
              "RelativeToolTip": "Communication\\Outgoing\\MapUserLeaveComposer.cs",
              "ViewState": "AgIAAAAAAAAAAAAAAAAAABMAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T00:23:27.099Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 4,
              "Title": "MapUserMovementListComposer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserMovementListComposer.cs",
              "RelativeDocumentMoniker": "Communication\\Outgoing\\MapUserMovementListComposer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserMovementListComposer.cs",
              "RelativeToolTip": "Communication\\Outgoing\\MapUserMovementListComposer.cs",
              "ViewState": "AgIAAB4AAAAAAAAAAAAqwEUAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T00:21:04.431Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 5,
              "Title": "MapUserEnterComposer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserEnterComposer.cs",
              "RelativeDocumentMoniker": "Communication\\Outgoing\\MapUserEnterComposer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Outgoing\\MapUserEnterComposer.cs",
              "RelativeToolTip": "Communication\\Outgoing\\MapUserEnterComposer.cs",
              "ViewState": "AgIAADQAAAAAAAAAAAAAAFsAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-18T00:20:05.111Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 2,
              "Title": "ShipMovement.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\ShipMovement.cs",
              "RelativeDocumentMoniker": "Game\\Handlers\\ShipMovement.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\ShipMovement.cs",
              "RelativeToolTip": "Game\\Handlers\\ShipMovement.cs",
              "ViewState": "AgIAAB0CAAAAAAAAAAAiwEMCAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T22:58:09.113Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 8,
              "Title": "SingleSignOnAuthenticator.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Sessions\\SingleSignOnAuthenticator.cs",
              "RelativeDocumentMoniker": "Game\\Sessions\\SingleSignOnAuthenticator.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Sessions\\SingleSignOnAuthenticator.cs",
              "RelativeToolTip": "Game\\Sessions\\SingleSignOnAuthenticator.cs",
              "ViewState": "AgIAAEIAAAAAAAAAAAAcwHEAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T16:59:47.255Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 9,
              "Title": "Handshake.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\Handshake.cs",
              "RelativeDocumentMoniker": "Game\\Handlers\\Handshake.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\Handshake.cs",
              "RelativeToolTip": "Game\\Handlers\\Handshake.cs",
              "ViewState": "AgIAAAQAAAAAAAAAAAAewCIAAACCAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T15:05:30.602Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 10,
              "Title": "DataRouter.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Incoming\\DataRouter.cs",
              "RelativeDocumentMoniker": "Communication\\Incoming\\DataRouter.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\Incoming\\DataRouter.cs",
              "RelativeToolTip": "Communication\\Incoming\\DataRouter.cs",
              "ViewState": "AgIAACQAAAAAAAAAAAAAwE4AAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T14:46:23.853Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 11,
              "Title": "SelectAction.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\SelectAction.cs",
              "RelativeDocumentMoniker": "Game\\Handlers\\SelectAction.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Game\\Handlers\\SelectAction.cs",
              "RelativeToolTip": "Game\\Handlers\\SelectAction.cs",
              "ViewState": "AgIAANEAAAAAAAAAAAA3wP0AAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T14:24:51.684Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 6,
              "Title": "WebSocketGameServer.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\WebSocketGameServer.cs",
              "RelativeDocumentMoniker": "WebSocketGameServer.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\WebSocketGameServer.cs",
              "RelativeToolTip": "WebSocketGameServer.cs",
              "ViewState": "AgIAAJMAAAAAAAAAAAAwwKoAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T00:15:31.793Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 12,
              "Title": "Program.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Program.cs",
              "RelativeDocumentMoniker": "Program.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Program.cs",
              "RelativeToolTip": "Program.cs",
              "ViewState": "AgIAAJoAAAAAAAAAAADwv8EAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-17T00:10:46.458Z"
            },
            {
              "$type": "Document",
              "DocumentIndex": 7,
              "Title": "ClientMessage.cs",
              "DocumentMoniker": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\ClientMessage.cs",
              "RelativeDocumentMoniker": "Communication\\ClientMessage.cs",
              "ToolTip": "C:\\Users\\the_k\\OneDrive\\Desktop\\serveur andromeda\\Server\\Andromeda-emu source\\Communication\\ClientMessage.cs",
              "RelativeToolTip": "Communication\\ClientMessage.cs",
              "ViewState": "AgIAACgAAAAAAAAAAAAAAFUAAAAAAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.000738|",
              "WhenOpened": "2025-11-16T21:55:15.623Z"
            }
          ]
        }
      ]
    }
  ]
} 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\ClientMessage.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.ClientMessage
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System;

namespace OrbitReborn_Emulator.Communication
{
  public class ClientMessage
  {
    private string mHeader;
    private string mPacket;
    private string mtmpPacket;
    private string[] mSplittedPacket;

    public string Header
    {
      get
      {
        return this.mHeader;
      }
    }

    public string Packet
    {
      get
      {
        return this.mPacket;
      }
    }

    public ClientMessage(string _Data)
    {
      this.mPacket = _Data;
      this.mPacket = this.mPacket.Replace("\n", string.Empty).Replace("\0", string.Empty);
      this.mtmpPacket = this.mPacket;
      this.mSplittedPacket = this.mtmpPacket.Split(new char[3]
      {
        '|',
        '%',
        '@'
      });
      this.mHeader = this.mSplittedPacket[0];
      this.mHeader = this.Header.Replace("\r", string.Empty).Replace("\n", string.Empty).Replace("\0", string.Empty);
    }

    public int GetNextInt(int index)
    {
      try
      {
        int result;
        if (this.mSplittedPacket.Length > index && int.TryParse(this.mSplittedPacket[index], out result))
          return result;
        return 0;
      }
      catch (Exception ex)
      {
        Output.WriteLine((object) ("[INCOMING PACKET] Error while getting next int!\n\n" + ex.StackTrace), OutputLevel.CriticalError);
        return 0;
      }
    }

    public string GetNextString(int index)
    {
      try
      {
        if (this.mSplittedPacket.Length >= index)
          return this.mSplittedPacket[index];
        return "";
      }
      catch (Exception ex)
      {
        Output.WriteLine((object) ("[INCOMING PACKET] Error while getting next string!\n\n" + ex.StackTrace), OutputLevel.CriticalError);
        return "";
      }
    }

    public override string ToString()
    {
      return this.mPacket;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\OpcodesIn.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.OpcodesIn
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Communication
{
  public static class OpcodesIn
  {
    public const string LOGIN = "LOGIN";
    public const string SHIP_MOVEMENT = "1";
    public const string CLIENT_SETTING = "7";
    public const string SET_ATTRIBUTE = "A";
    public const string SET_FLASH_SETTINGS = "SET";
    public const string LASER_ATTACK = "a";
    public const string LASER_STOP = "G";
    public const string SELECT_AMMO = "u";
    public const string SELECT_SHIP_DECOY = "SEL";
    public const string SELECT_SHIP = "SES";
    public const string SELECT = "S";
    public const string CONFIGURATION = "CFG";
    public const string LOGOUT = "l";
    public const string LOGOUT_CANCEL_FROM_CLIENT = "o";
    public const string ROCKET_ATTACK = "v";
    public const string PING = "PNG";
    public const string PORTAL_JUMP = "j";
    public const string SELECT_ROCKET = "d";
    public const string READY_COMMAND = "RDY";
    public const string LAB = "LAB";
    public const string BUY = "5";
    public const string I = "i";
    public const string GET_ORE_PRICES = "b";
    public const string SELL_ORE = "T";
    public const string REFINEMENT = "REF";
    public const string PRODUCE = "PROD";
    public const string UPDATE = "UPD";
    public const string SET = "SET";
    public const string GET = "GET";
    public const string TECHS = "TX";
    public const string CHAT_INIT = "bu";
    public const string CMD_GET_USER_ROOMLIST = "bx";
    public const string CMD_USER_JOIN = "bz";
    public const string COLLECT_BOX = "x";
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\OpcodesOut.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.OpcodesOut
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Communication
{
  public static class OpcodesOut
  {
    public const string HERO_INIT = "RDY|I";
    public const string CREATE_SHIP = "f|C";
    public const string SHIP_MOVEMENT = "0|1";
    public const string REMOVE_SHIP = "0|R";
    public const string SHIP_SELECTED = "0|N";
    public const string OUT_OF_RANGE = "0|O";
    public const string TARGET_IN_RANGE = "0|X";
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\ServerMessage.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.ServerMessage
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System.Collections.Generic;
using System.Text;

namespace OrbitReborn_Emulator.Communication
{
  public class ServerMessage
  {
    private List<byte> Message;

    public ServerMessage()
    {
      this.Message = new List<byte>();
    }

    public void AppendShort(string _Sign)
    {
      try
      {
        this.AppendDeltas(Encoding.UTF8.GetBytes(_Sign));
      }
      catch
      {
      }
    }

    public void AppendShortChat(string _Sign)
    {
      try
      {
        this.AppendDeltasChatMSG(Encoding.UTF8.GetBytes(_Sign));
      }
      catch
      {
      }
    }

    public void Append(int _Number)
    {
      try
      {
        this.AppendDeltas(Encoding.UTF8.GetBytes(_Number.ToString()));
      }
      catch
      {
      }
    }

    public void Append(string _String)
    {
      try
      {
        this.AppendDeltas(Encoding.UTF8.GetBytes(_String));
      }
      catch
      {
      }
    }

    public void LastAppend(string _String)
    {
      try
      {
        this.LastAppendDeltas(Encoding.UTF8.GetBytes(_String));
      }
      catch
      {
      }
    }

    public void AppendBreak()
    {
      this.Message.AddRange((IEnumerable<byte>) Encoding.UTF8.GetBytes("\0"));
    }

    public void AppendChatMSG(string _String)
    {
      try
      {
        this.AppendDeltasChatMSG(Encoding.UTF8.GetBytes(_String));
      }
      catch
      {
      }
    }

    public void AppendChatATRIBUTE(string _String)
    {
      try
      {
        this.AppendDeltasChatATRIBUTE(Encoding.UTF8.GetBytes(_String));
      }
      catch
      {
      }
    }

    public void AppendChatPARAM(string _String)
    {
      try
      {
        this.AppendDeltasChatPARAM(Encoding.UTF8.GetBytes(_String));
      }
      catch
      {
      }
    }

    private void AppendDeltas(byte[] _Byte)
    {
      this.Message.AddRange((IEnumerable<byte>) _Byte);
      this.Message.AddRange((IEnumerable<byte>) Encoding.UTF8.GetBytes("|"));
    }

    private void LastAppendDeltas(byte[] _Byte)
    {
      this.Message.AddRange((IEnumerable<byte>) _Byte);
    }

    private void AppendDeltasChatMSG(byte[] _Byte)
    {
      this.Message.AddRange((IEnumerable<byte>) _Byte);
      this.Message.AddRange((IEnumerable<byte>) Encoding.UTF8.GetBytes("%"));
    }

    private void AppendDeltasChatATRIBUTE(byte[] _Byte)
    {
      this.Message.AddRange((IEnumerable<byte>) _Byte);
      this.Message.AddRange((IEnumerable<byte>) Encoding.UTF8.GetBytes("|"));
    }

    private void AppendDeltasChatPARAM(byte[] _Byte)
    {
      this.Message.AddRange((IEnumerable<byte>) _Byte);
      this.Message.AddRange((IEnumerable<byte>) Encoding.UTF8.GetBytes("@"));
    }

    public byte[] ToDeltas()
    {
      List<byte> byteList = new List<byte>();
      byteList.Reverse();
      byteList.AddRange((IEnumerable<byte>) this.Message);
      byteList.RemoveRange(byteList.Count - 1, 1);
      byteList.AddRange((IEnumerable<byte>) Encoding.UTF8.GetBytes("\0"));
      return byteList.ToArray();
    }

    public override string ToString()
    {
      return Encoding.UTF8.GetString(this.ToDeltas());
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Incoming\DataRouter.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Incoming.DataRouter
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Chat;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System.Collections.Generic;

namespace OrbitReborn_Emulator.Communication.Incoming
{
    public static class DataRouter
    {
        private static CDictionnary<string, ProcessRequestCallback> mCallbacks;
        private static CList<string> mCallbacksWithoutAuthentication;
        private static List<string> authorizedPacket = new List<string> { "UI", "RL", "fc", "PNG1", "jj", "jjj", "jjjj", "jj1", "j1" };
        public static bool HasToKick = false;

        public static void Initialize()
        {
            DataRouter.mCallbacks = new CDictionnary<string, ProcessRequestCallback>();
            DataRouter.mCallbacksWithoutAuthentication = new CList<string>();
        }

        public static bool RegisterHandler(string MessageHeader, ProcessRequestCallback Callback, bool PermitedUnauthenticated = false)
        {
            if (MessageHeader == "" || Callback == null || DataRouter.mCallbacks.ContainsKey(MessageHeader))
                return false;
            DataRouter.mCallbacks.Add(MessageHeader, Callback);
            if (PermitedUnauthenticated)
                DataRouter.mCallbacksWithoutAuthentication.Add(MessageHeader);
            return true;
        }

        public static void refreshGroup(Session Session) { }
        public static void kick(Session Session)
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                if (Session.CharacterInfo != null)
                {
                    MapManager.RemoveUserFromMap(Session);
                    ChatManager.RemovePlayerFromEICChannel(Session);
                    ChatManager.RemovePlayerFromMMOChannel(Session);
                    ChatManager.RemovePlayerFromVRUChannel(Session);
                    ChatManager.RemovePlayerFromGlobalChannel(Session);
                    Session.CharacterInfo.Disconnected = true;
                }
                Session.Stop(client);
                Session.Dispose();
            }
        }
        public static void HandleData(Session Session, ClientMessage Message)
        {
            if (Session == null || Session.Stopped || Message == null)
                Output.WriteLine((object)("Session is null or stopped or no message IP : " + Session.RemoteAddress), OutputLevel.Warning);
            else if (!DataRouter.mCallbacks.ContainsKey(Message.Header))
            {
                Output.WriteLine((object)("Unhandled packet: " + Message.Header + " from :" + Session.RemoteAddress + ", no suitable handler found."), OutputLevel.Warning);
                if (DataRouter.HasToKick && !DataRouter.authorizedPacket.Contains(Message.Header))
                {
                    Output.WriteLine((object)(" " + Session.RemoteAddress + " kicked !"), OutputLevel.Warning);
                    DataRouter.kick(Session);
                }
            }
            else
            {
                if (!Session.Authenticated && !DataRouter.mCallbacksWithoutAuthentication.Contains(Message.Header))
                    return;
                DataRouter.mCallbacks[Message.Header](Session, Message);
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Incoming\ProcessRequestCallback.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Incoming.ProcessRequestCallback
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Sessions;

namespace OrbitReborn_Emulator.Communication.Incoming
{
  public delegate void ProcessRequestCallback(Session Client, ClientMessage Message);
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\FightSelectPlayerComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.FightSelectPlayerComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Characters;

namespace OrbitReborn_Emulator.Communication.Outgoing
{
  public static class FightSelectPlayerComposer
  {
    public static ServerMessage Compose(CharacterInfo Info)
    {
      ServerMessage serverMessage = new ServerMessage();
      serverMessage.AppendShort("0|N");
      serverMessage.Append(Info.Id);
      serverMessage.Append(Info.Username);
      serverMessage.Append(Info.ShipShield);
      serverMessage.Append(Info.ShipMaxShield);
      serverMessage.Append(Info.ShipHp);
      serverMessage.Append(Info.ShipMaxHp);
      return serverMessage;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\MapHeroInitComposer.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Game.Characters;

namespace OrbitReborn_Emulator.Communication.Outgoing
{
    public static class MapHeroInitComposer
    {
        public static ServerMessage Compose(CharacterInfo info)
        {
            var serverMessage = new ServerMessage();

            // Paquet : 0|H|x|y
            serverMessage.AppendShort("0|H");
            serverMessage.Append(info.LocX);
            serverMessage.Append(info.LocY);
            serverMessage.AppendBreak();

            return serverMessage;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\MapPortalsComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.MapPortalsComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using System.Collections.Generic;

namespace OrbitReborn_Emulator.Communication.Outgoing
{
  public static class MapPortalsComposer
  {
    public static ServerMessage Compose(CList<PortalInfo> Portals, Session Session)
    {
      ServerMessage serverMessage = new ServerMessage();
      foreach (PortalInfo key in (IEnumerable<PortalInfo>) Portals.Keys)
      {
        serverMessage.AppendShort("0|p");
        serverMessage.Append(key.Id);
        serverMessage.Append(key.Type);
        serverMessage.Append(key.LinkedId);
        serverMessage.Append(key.PosX);
        serverMessage.LastAppend(string.Concat((object) key.PosY));
        serverMessage.AppendBreak();
      }
      return serverMessage;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\MapShipMovementComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.MapShipMovementComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Communication.Outgoing
{
  public static class MapShipMovementComposer
  {
    public static ServerMessage Compose(int ReferenceId, int LocX, int LocY, double TimeTaken)
    {
      ServerMessage serverMessage = new ServerMessage();
      serverMessage.AppendShort("0|1");
      serverMessage.Append(ReferenceId);
      serverMessage.Append(LocX);
      serverMessage.Append(LocY);
      serverMessage.Append((int) TimeTaken);
      return serverMessage;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\MapUserEnterComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.MapUserEnterComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Characters;
using OrbitReborn_Emulator.Game.Sessions;

namespace OrbitReborn_Emulator.Communication.Outgoing
{
    public static class MapUserEnterComposer
    {
        public static ServerMessage Compose(CharacterInfo Info, Session Session)
        {
            ServerMessage serverMessage = new ServerMessage();
            if (Info.IsInvisibleForAll && Info.IsAdmin)
            {
                serverMessage.AppendShort("0|R");
                serverMessage.Append(Info.Id.ToString());
                serverMessage.AppendBreak();
                return serverMessage;
            }
            serverMessage.AppendShort("f|C");
            serverMessage.Append(Info.Id);
            if (Info.MapId == 80)
                serverMessage.Append("10");
            else
                serverMessage.Append(Info.ShipId);
            serverMessage.Append(3);
            if (Info.MapId == 80)
                serverMessage.Append("***");
            else
                serverMessage.Append(Info.ClanTag);
            if (Info.MapId == 80)
                serverMessage.Append("********");
            else
                serverMessage.Append(Info.Username);
            serverMessage.Append(Info.LocX);
            serverMessage.Append(Info.LocY);
            serverMessage.Append(Info.FactionId);
            serverMessage.Append(Info.ClanId);
            if (Info.MapId == 80)
                serverMessage.Append("1");
            else
                serverMessage.Append(Info.Grade);
            serverMessage.Append(0);
            if (Session.CharacterInfo.ClanWar.Contains(Info.ClanId))
                serverMessage.Append(3);
            else if (Session.CharacterInfo.ClanAlliance.Contains(Info.ClanId))
                serverMessage.Append(1);
            else
                serverMessage.Append(0);
            if (Info.MapId == 80)
                serverMessage.Append("0");
            else
                serverMessage.Append(Info.GGRings);

            serverMessage.AppendBreak();
            if (Session.CharacterInfo.Settings.ShowDrones == 1)
            {
                serverMessage.AppendShort("0|n");
                serverMessage.Append("d|" + (object)Info.Id + "|" + Info.Drones);
                serverMessage.AppendBreak();
            }
            else
            {
                serverMessage.AppendShort("0|n");
                int num = Info.Drones.Split('-').Length - 1 - 2;
                serverMessage.Append("e|" + (object)Info.Id + "|0/" + (object)num);
                serverMessage.AppendBreak();
            }
            if (Info.GameTitle != "")
            {
                serverMessage.AppendShort("0|n");
                serverMessage.Append("pt|" + (object)Info.Id + "|" + Info.GameTitle);
                serverMessage.AppendBreak();
            }
            serverMessage.AppendShort("0|n");
            serverMessage.Append("INV|" + (object)Info.Id + "|" + (object)Info.Invisible);
            serverMessage.AppendBreak();
            if (Info.KillStrek >= 10)
            {
                serverMessage.AppendShort("0|n");
                serverMessage.Append("fx|start|RAGE|" + (object)Info.Id);
                serverMessage.AppendBreak();
            }
            return serverMessage;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\MapUserLeaveComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.MapUserLeaveComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Communication.Outgoing
{
  public static class MapUserLeaveComposer
  {
    public static ServerMessage Compose(int ActorId)
    {
      ServerMessage serverMessage = new ServerMessage();
      serverMessage.AppendShort("0|R");
      serverMessage.Append(ActorId);
      return serverMessage;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\MapUserMovementListComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.MapUserMovementListComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Characters;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Npcs;
using OrbitReborn_Emulator.Libs;
using System;
using System.Collections.Generic;

namespace OrbitReborn_Emulator.Communication.Outgoing
{
  public static class MapUserMovementListComposer
  {
    public static ServerMessage Compose(CList<MapActor> Actors)
    {
      ServerMessage serverMessage = new ServerMessage();
      foreach (MapActor key in (IEnumerable<MapActor>) Actors.Keys)
      {
        if (((CharacterInfo) key.ReferenceObject).IsMoving)
        {
          int locX = ((CharacterInfo) key.ReferenceObject).LocX;
          int locY = ((CharacterInfo) key.ReferenceObject).LocY;
          int newLocX = ((CharacterInfo) key.ReferenceObject).NewLocX;
          int newLocY = ((CharacterInfo) key.ReferenceObject).NewLocY;
          double a = Math.Sqrt(Math.Pow((double) (locX - newLocX), 2.0) + Math.Pow((double) (locY - newLocY), 2.0)) / (double) ((CharacterInfo) key.ReferenceObject).ShipSpeed * 1000.0;
          serverMessage.AppendShort("0|1");
          serverMessage.Append(key.ReferenceId);
          serverMessage.Append(newLocX);
          serverMessage.Append(newLocY);
          serverMessage.Append(Math.Round(a).ToString());
          serverMessage.AppendBreak();
        }
      }
      return serverMessage;
    }

    public static ServerMessage ComposeIA(CList<MapActor> Actors)
    {
      ServerMessage serverMessage = new ServerMessage();
      int num = 0;
      foreach (MapActor key in (IEnumerable<MapActor>) Actors.Keys)
      {
        Npc referenceObject = (Npc) key.ReferenceObject;
        if (referenceObject.IsMoving)
        {
          double a = Math.Sqrt(Math.Pow((double) (referenceObject.LocX - referenceObject.NewLocX), 2.0) + Math.Pow((double) (referenceObject.LocY - referenceObject.NewLocY), 2.0)) / (double) referenceObject.ShipSpeed * 1000.0;
          serverMessage.AppendShort("0|1");
          serverMessage.Append(key.ReferenceId);
          serverMessage.Append(referenceObject.NewLocX);
          serverMessage.Append(referenceObject.NewLocY);
          serverMessage.Append(Math.Round(a).ToString());
          serverMessage.AppendBreak();
          ++num;
        }
      }
      if (num == 0)
      {
        serverMessage.AppendShort("");
        serverMessage.Append("");
        serverMessage.AppendBreak();
      }
      return serverMessage;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\MapUserObjectListComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.MapUserObjectListComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Characters;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using System.Collections.Generic;

namespace OrbitReborn_Emulator.Communication.Outgoing
{
    public static class MapUserObjectListComposer
    {
        public static ServerMessage Compose(CList<MapActor> Actors, Session Session)
        {
            ServerMessage serverMessage = new ServerMessage();
            foreach (MapActor key in (IEnumerable<MapActor>)Actors.Keys)
            {
                if (((CharacterInfo)key.ReferenceObject).IsInvisibleForAll && ((CharacterInfo)key.ReferenceObject).IsAdmin)
                {
                    serverMessage.AppendShort("0|R");
                    serverMessage.Append(((CharacterInfo)key.ReferenceObject).Id.ToString());
                    serverMessage.AppendBreak();
                    continue;
                }
                serverMessage.AppendShort("f|C");
                serverMessage.Append(key.ReferenceId);
                serverMessage.Append(((CharacterInfo)key.ReferenceObject).ShipId);
                serverMessage.Append(3);
                serverMessage.Append(((CharacterInfo)key.ReferenceObject).ClanTag);
                serverMessage.Append(key.Name);
                serverMessage.Append(((CharacterInfo)key.ReferenceObject).LocX);
                serverMessage.Append(((CharacterInfo)key.ReferenceObject).LocY);
                serverMessage.Append(((CharacterInfo)key.ReferenceObject).FactionId);
                serverMessage.Append(((CharacterInfo)key.ReferenceObject).ClanId);
                serverMessage.Append(((CharacterInfo)key.ReferenceObject).Grade);
                serverMessage.Append(0);
                if (Session.CharacterInfo.ClanWar.Contains(((CharacterInfo)key.ReferenceObject).ClanId))
                    serverMessage.Append(3);
                else if (Session.CharacterInfo.ClanAlliance.Contains(((CharacterInfo)key.ReferenceObject).ClanId))
                    serverMessage.Append(1);
                else
                    serverMessage.Append(0);
                serverMessage.Append(0);
                serverMessage.AppendBreak();
                if (Session.CharacterInfo.Settings.ShowDrones == 1)
                {
                    serverMessage.AppendShort("0|n");
                    serverMessage.Append("d|" + (object)key.ReferenceId + "|" + ((CharacterInfo)key.ReferenceObject).Drones);
                    serverMessage.AppendBreak();
                }
                else
                {
                    serverMessage.AppendShort("0|n");
                    int num = ((CharacterInfo)key.ReferenceObject).Drones.Split('-').Length - 1 - 2;
                    serverMessage.Append("e|" + (object)key.ReferenceId + "|0/" + (object)num);
                    serverMessage.AppendBreak();
                }
                if (((CharacterInfo)key.ReferenceObject).GameTitle != "")
                {
                    serverMessage.AppendShort("0|n");
                    serverMessage.Append("pt|" + (object)key.ReferenceId + "|" + ((CharacterInfo)key.ReferenceObject).GameTitle);
                    serverMessage.AppendBreak();
                }
                serverMessage.AppendShort("0|n");
                serverMessage.Append("INV|" + (object)((CharacterInfo)key.ReferenceObject).Id + "|" + (object)((CharacterInfo)key.ReferenceObject).Invisible);
                serverMessage.AppendBreak();
                if (((CharacterInfo)key.ReferenceObject).KillStrek >= 10)
                {
                    serverMessage.AppendShort("0|n");
                    serverMessage.Append("fx|start|RAGE|" + (object)((CharacterInfo)key.ReferenceObject).Id);
                    serverMessage.AppendBreak();
                }
            }
            return serverMessage;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\PacketComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.PacketComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Communication.Outgoing
{
  public static class PacketComposer
  {
    public static ServerMessage Compose(string header, string packet)
    {
      ServerMessage serverMessage = new ServerMessage();
      serverMessage.AppendShort("0|" + header);
      serverMessage.Append(packet);
      return serverMessage;
    }

    public static ServerMessage ComposeChat(string packet)
    {
      ServerMessage serverMessage = new ServerMessage();
      serverMessage.Append(packet);
      return serverMessage;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Communication\Outgoing\UserDataComposer.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Communication.Outgoing.UserDataComposer
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Sessions;

namespace OrbitReborn_Emulator.Communication.Outgoing
{
    public static class UserDataComposer
    {
        public static ServerMessage Compose(Session Session)
        {
            ServerMessage serverMessage = new ServerMessage();
            serverMessage.AppendShort("RDY|I");
            serverMessage.Append(Session.CharacterId);
            serverMessage.Append(Session.CharacterInfo.Username);
            serverMessage.Append(Session.CharacterInfo.ShipId);
            serverMessage.Append(Session.CharacterInfo.ShipSpeed);
            serverMessage.Append(Session.CharacterInfo.ShipShield);
            serverMessage.Append(Session.CharacterInfo.ShipMaxShield);
            serverMessage.Append(Session.CharacterInfo.ShipHp);
            serverMessage.Append(Session.CharacterInfo.ShipMaxHp);
            serverMessage.Append(Session.CharacterInfo.ShipCargo);
            serverMessage.Append(Session.CharacterInfo.ShipMaxCargo);
            serverMessage.Append(Session.CharacterInfo.LocX);
            serverMessage.Append(Session.CharacterInfo.LocY);
            serverMessage.Append(Session.CharacterInfo.MapId);
            serverMessage.Append(Session.CharacterInfo.FactionId);
            serverMessage.Append(Session.CharacterInfo.ClanId);
            serverMessage.Append("10000");
            serverMessage.Append("100");
            serverMessage.Append("4");
            serverMessage.Append("1");
            serverMessage.Append(Session.CharacterInfo.NpcKill);
            serverMessage.Append(Session.CharacterInfo.UserKill);
            serverMessage.Append("1");
            serverMessage.Append(Session.CharacterInfo.Credits.ToString());
            serverMessage.Append(Session.CharacterInfo.Uridium.ToString());
            serverMessage.Append("0");
            serverMessage.Append(Session.CharacterInfo.Grade);
            serverMessage.Append(Session.CharacterInfo.ClanTag);
            serverMessage.Append(Session.CharacterInfo.GGRings);
            serverMessage.Append("0");
            serverMessage.Append(Session.CharacterInfo.Invisible);
            return serverMessage;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Config\ConfigElement.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Config.ConfigElement
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System.Net;

namespace OrbitReborn_Emulator.Config
{
  public class ConfigElement
  {
    private string mKey;
    private ConfigElementType mType;
    private object mCurrentValue;
    private bool mUserConfigured;

    public string Key
    {
      get
      {
        return this.mKey;
      }
    }

    public ConfigElementType Type
    {
      get
      {
        return this.mType;
      }
    }

    public object CurrentValue
    {
      get
      {
        return this.mCurrentValue;
      }
      set
      {
        string str = value.ToString();
        switch (this.mType)
        {
          case ConfigElementType.Boolean:
            this.mCurrentValue = (object) false;
            if (str == "1" || str.ToLower() == "true")
            {
              this.mCurrentValue = (object) true;
              break;
            }
            break;
          case ConfigElementType.Integer:
            int result = 0;
            int.TryParse(str, out result);
            this.mCurrentValue = (object) result;
            break;
          case ConfigElementType.IpAddress:
            IPAddress address = IPAddress.Any;
            IPAddress.TryParse(str, out address);
            this.mCurrentValue = (object) address;
            break;
          default:
            this.mCurrentValue = (object) str;
            break;
        }
        this.mUserConfigured = true;
      }
    }

    public bool UserConfigured
    {
      get
      {
        return this.mUserConfigured;
      }
    }

    public ConfigElement(string Key, ConfigElementType Type, object DefaultValue)
    {
      this.mKey = Key;
      this.mType = Type;
      this.CurrentValue = DefaultValue;
      this.mUserConfigured = false;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Config\ConfigElementType.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Config.ConfigElementType
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Config
{
  public enum ConfigElementType
  {
    Text,
    Boolean,
    Integer,
    IpAddress,
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Config\ConfigManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Config.ConfigManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Libs;
using System.Collections.Generic;
using System.Net;

namespace OrbitReborn_Emulator.Config
{
  public static class ConfigManager
  {
    private static string mConfigPath;
    private static CDictionnary<string, ConfigElement> mConfigData;

    public static string ConfigPath
    {
      get
      {
        return ConfigManager.mConfigPath;
      }
    }

    public static void Initialize(string ConfigPath)
    {
      ConfigManager.mConfigPath = ConfigPath;
      ConfigManager.mConfigData = new CDictionnary<string, ConfigElement>();
      ConfigManager.mConfigData.Add("output.enablelogfiles", new ConfigElement("output.enablelogfiles", ConfigElementType.Boolean, (object) true));
      ConfigManager.mConfigData.Add("output.verbositylevel", new ConfigElement("output.verbositylevel", ConfigElementType.Integer, (object) -1));
      ConfigManager.mConfigData.Add("mysql.pool.min", new ConfigElement("mysql.pool.min", ConfigElementType.Integer, (object) 5));
      ConfigManager.mConfigData.Add("mysql.pool.max", new ConfigElement("mysql.pool.max", ConfigElementType.Integer, (object) 20));
      ConfigManager.mConfigData.Add("mysql.pool.lifetime", new ConfigElement("mysql.pool.lifetime", ConfigElementType.Integer, (object) 10));
      ConfigManager.mConfigData.Add("mysql.user", new ConfigElement("mysql.user", ConfigElementType.Text, (object) "root"));
      ConfigManager.mConfigData.Add("mysql.pass", new ConfigElement("mysql.pass", ConfigElementType.Text, (object)"Mv24j5zDDi2JPVu659XyTrjfe985QR"));
      ConfigManager.mConfigData.Add("mysql.host", new ConfigElement("mysql.host", ConfigElementType.Text, (object) "127.0.0.1"));
      ConfigManager.mConfigData.Add("mysql.port", new ConfigElement("mysql.port", ConfigElementType.Integer, (object) 3306));
      ConfigManager.mConfigData.Add("mysql.dbname", new ConfigElement("mysql.port", ConfigElementType.Text, (object) "andromeda"));
      ConfigManager.mConfigData.Add("net.backlog", new ConfigElement("net.backlog", ConfigElementType.Integer, (object) 50));
      ConfigManager.mConfigData.Add("net.bind.ip", new ConfigElement("net.bind.ip", ConfigElementType.IpAddress, (object) IPAddress.Any));
      ConfigManager.mConfigData.Add("net.bind.port", new ConfigElement("net.bind.port", ConfigElementType.Integer, (object) 8080));
      ConfigManager.mConfigData.Add("debug.sso", new ConfigElement("debug.sso", ConfigElementType.Text, (object) string.Empty));
      ConfigManager.mConfigData.Add("lang", new ConfigElement("lang", ConfigElementType.Text, (object) "en"));
      if (System.IO.File.Exists(ConfigManager.mConfigPath))
      {
        ConfigManager.RetrieveValuesFromFile();
        foreach (ConfigElement configElement in (IEnumerable<ConfigElement>) ConfigManager.mConfigData.Values)
        {
          if (!configElement.UserConfigured)
            Output.WriteLine((object) ("Configuration value '" + configElement.Key.ToLower() + "' missing; using default value."), OutputLevel.Warning);
        }
      }
      else
        Output.WriteLine((object) ("Configuration file is missing at " + ConfigManager.mConfigPath + "; using default values."), OutputLevel.Warning);
    }

    private static void RetrieveValuesFromFile()
    {
      foreach (string readAllLine in System.IO.File.ReadAllLines(ConfigManager.mConfigPath, Constants.DefaultEncoding))
      {
        if (!readAllLine.StartsWith("#") && readAllLine.Contains("="))
        {
          string[] strArray = readAllLine.Split('=');
          string lower = strArray[0].ToLower();
          string empty = string.Empty;
          for (int index = 1; index < strArray.Length; ++index)
          {
            if (index > 1)
              empty += (string) (object) '=';
            empty += strArray[index];
          }
          if (ConfigManager.mConfigData.ContainsKey(lower))
            ConfigManager.mConfigData[lower].CurrentValue = (object) empty;
        }
      }
    }

    public static object GetValue(string Key)
    {
      if (ConfigManager.mConfigData == null || !ConfigManager.mConfigData.ContainsKey(Key))
        throw new KeyNotFoundException();
      return ConfigManager.mConfigData[Key].CurrentValue;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Config\Constants.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Config.Constants
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System;
using System.Text;

namespace OrbitReborn_Emulator.Config
{
  public static class Constants
  {
    public static readonly string ConsoleTitle = "Andromeda \\o/ waiting for connections...";
    public static readonly int ConsoleWindowWidth = 90;
    public static readonly int ConsoleWindowHeight = 30;
    public static readonly string DataFileDirectory = Environment.CurrentDirectory + "\\data";
    public static readonly string LogFileDirectory = Environment.CurrentDirectory + "\\logs";
    public static readonly string LangFileDirectory = Environment.CurrentDirectory + "\\lang";
    public static readonly Encoding DefaultEncoding = Encoding.Default;
    public static readonly char LineBreakChar = Convert.ToChar(13);
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Config\Localization.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Config.Localization
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Libs;
using System.IO;

namespace OrbitReborn_Emulator.Config
{
  public static class Localization
  {
    private static string mLangPath;
    private static CDictionnary<string, string> mLangData;

    public static string LangPath
    {
      get
      {
        return Localization.mLangPath;
      }
    }

    public static void Initialize(string LangPath)
    {
      Localization.mLangPath = LangPath;
      Localization.mLangData = new CDictionnary<string, string>();
      if (File.Exists(Localization.mLangPath))
        Localization.RetrieveValuesFromFile();
      else
        Output.WriteLine((object) ("Server translation file is missing at " + Localization.mLangPath + "."), OutputLevel.Warning);
    }

    private static void RetrieveValuesFromFile()
    {
      foreach (string readAllLine in File.ReadAllLines(Localization.mLangPath, Constants.DefaultEncoding))
      {
        if (!readAllLine.StartsWith("#") && readAllLine.Contains("="))
        {
          string[] strArray = readAllLine.Split('=');
          string lower = strArray[0].ToLower();
          string empty = string.Empty;
          for (int index = 1; index < strArray.Length; ++index)
          {
            if (index > 1)
              empty += (string) (object) '=';
            empty += strArray[index];
          }
          if (!Localization.mLangData.ContainsKey(lower))
            Localization.mLangData.Add(lower, empty);
          else
            Localization.mLangData[lower] = empty;
        }
      }
    }

    public static string GetValue(string Key, string Arg)
    {
      return Localization.GetValue(Key, new string[1]
      {
        Arg
      });
    }

    public static string GetValue(string Key, string[] Args = null)
    {
      if (Localization.mLangData == null || !Localization.mLangData.ContainsKey(Key))
        return Key;
      string str = Localization.mLangData[Key];
      if (Args != null)
      {
        for (int index = 0; index < Args.Length; ++index)
          str = str.Replace("%" + (object) index + "%", Args[index]);
      }
      return str.Replace("<br>", "\n");
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Characters\CharacterConfig.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Characters.CharacterConfig
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Game.Characters
{
  public class CharacterConfig
  {
    private int mShield;
    private int mMaxShield;
    private int mShipSpeed;
    private int mDamages;

    public int Shield
    {
      get
      {
        return this.mShield;
      }
      set
      {
        this.mShield = value;
      }
    }

    public int MaxShield
    {
      get
      {
        return this.mMaxShield;
      }
      set
      {
        this.mMaxShield = value;
      }
    }

    public int ShipSpeed
    {
      get
      {
        return this.mShipSpeed;
      }
      set
      {
        this.mShipSpeed = value;
      }
    }

    public int MinDamage
    {
      get
      {
        return this.mDamages;
      }
      set
      {
        this.mDamages = value;
      }
    }

    public int MaxDamage
    {
      get
      {
        return this.mDamages;
      }
      set
      {
        this.mDamages = value;
      }
    }

    public CharacterConfig(int Shield, int MaxShield, int ShipSpeed, int Damages)
    {
      this.mShield = Shield;
      this.mMaxShield = MaxShield;
      this.mShipSpeed = ShipSpeed;
      this.mDamages = Damages;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Characters\CharacterInfo.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Characters.CharacterInfo
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Laboratory;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Maps.Collectables;
using OrbitReborn_Emulator.Game.Misc;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Net;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Characters
{
    public class CharacterInfo
    {
        private bool mCanMove = true;
        private double mLastRSB75 = 0.0;
        private double mLastEMP = 0.0;
        private int mInvisibleCooldown = 0;
        private CDictionnary<string, int> mSkillTree = new CDictionnary<string, int>();
        public double MultiplierAgainstNpcs = 1.0;
        public double MultiplierAgainstPlayers = 1.0;
        public double ShieldAbsorption = 0.7;
        public int SmbDamages = 20000;
        public int RepairBotHp = 10000;
        public int RckDamages = 1000;
        public int RocketPattern = 0;
        public int ShRegen = 7000;
        private string[] npc_name = new string[17]
        {
      "Streuner",
      "Lordakia",
      "Saimon",
      "Sibelon",
      "Kristallin",
      "Kristallon",
      "Cubikon",
      "IceMeteroid",
      "Melter",
      "Scorcher",
      "BossCurcubitor",
      "Hitac",
      "Devourer",
      "BossKuKu",
      "Saboteur",
      "Annihilator",
      "Battleray"
        };
        private int mId;
        private int mSessionId;
        private string mAuthTicket;
        private string mUsername;
        private string mGameTitle;
        private int mKillStrek;
        private bool mIsMod;
        private bool mIsAdmin;
        private bool mIsInvisibleForAll;
        private Stopwatch mLastMove;
        private int mCheckSpeedHackCounter;
        private int mSpeedHackDetect;
        private int mSpeedHackTotalDetect;
        private int mShipId;
        private int mGGRings;
        private Random mRandomDamage;
        private int mShipCargo;
        private int mShipMaxCargo;
        private int mOldLocX;
        private int mOldLocY;
        private int mNewLocX;
        private int mNewLocY;
        private int mLocX;
        private int mLocY;
        private int mCurrentPortal;
        private bool mPortalZone;
        private bool mIsMoving;
        private int mMapId;
        private long mCredits;
        private long mUridium;
        private int mGrade;
        private int mFactionId;
        private int mClanId;
        private string mClanTag;
        private bool mOnline;
        private int mSelectedPlayer;
        private int mSelectedAmmo;
        private int mSelectedRocket;
        private int mSelectedPlayerRocket;
        private long mRankPoints;
        private int mUserKill;
        private int mNpcKill;
        private bool mDestroy;
        private bool mPeaceZone;
        private bool mAttacking;
        public CList<int> Members;
        public CList<int> InvitationSend;
        public CList<int> InvitationReceive;
        /* public CList<int> Members = new CList<int>();
        public CList<int> InvitationSend = new CList<int>();
        public CList<int> InvitationReceive = new CList<int>(); */
        private bool mGroupLeader = false;

        private CList<Session> mAttacked;
        private CList<int> mClanWar;
        private CList<int> mClanAlliance;
        private int mNoFightTimer;
        private bool mOutOfRange;
        private int mActiveConfig;
        private int mTmpActiveConfig;
        private bool mWarningZone;
        private double mLastConfigChange;
        private double mLastRocket;
        private double mLastTechSh;
        private double mLastTechHp;
        private double mLastISH;
        private double mLastSMB;
        private int mSMBLocX;
        private int mSMBLocY;
        private System.Threading.Timer mPathTime;
        private System.Threading.Timer mPathFinding;
        private System.Threading.Timer mWarningZoneTimer;
        private System.Threading.Timer mUpdateMovementTimer;
        private System.Threading.Timer mLaserAttackTimer;
        private System.Threading.Timer mLaserAttackCanTimer;
        private bool mCanLaserAttack;
        private System.Threading.Timer mDisconnectTimer;
        private System.Threading.Timer mRepairTimer;
        private System.Threading.Timer mBattleRepairTimer;
        private int mBattleRepairCount;
        private System.Threading.Timer mPortalJumpTimer;
        private System.Threading.Timer mRocketAttackTimer;
        private bool mIsJumping;
        private double mLastTimeElapsed;
        private bool mIsRepairing;
        private int mDisconnectCounter;
        private int mPathTimeTaken;
        private Settings mSettings;
        private int mShipHp;
        private int mShipMaxHp;
        private CharacterConfig mConfig1;
        private CharacterConfig mConfig2;
        private LabInfos mLabInfos;
        private double mCacheAge;
        CList<int> clist;
        private double mTimestampLastOnline;
        public int FatLasers;
        public int ShieldMechanics;
        public string Drones;
        private int mLevel;
        private int mAttackSpeed;
        private Session mAttacker;
        private double mLastAttackByAttackerReceived;
        private int mBootyKeys;
        private int mBoosterHpTime;
        private int mBoosterShdTime;
        private int mBoosterDmgTime;
        private int mBoosterNpcTime;
        private int mBoosterSpdTime;
        private bool mApisBuilt;
        private bool mZeusBuilt;
        public int AutoRocketSkill = 0;
        private int mBlk = 0;
        private int mGroupBoss = 0;
        private int mPvpPoints;
        private bool mActiveAutoRocket = false;
        private bool mAttackingRepBug;
        private CDictionnary<Session, double> assistAttacker = new CDictionnary<Session, double>();
        private bool mDisableNpc = false;
        private int mPreviousAttacked = 0;
        private double mPreviousDamageTime = 0;
        private string mExtraBooster = "";
        private int mRealFaction;
        private int mRealClan;
        public Timer UpdateGroupTimer;
        public bool IsBeginner = false;
        private int duelPending = 0;
        public CDictionnary<int, double> duelSend = new CDictionnary<int, double>();
        public double LastDuel = 0;

        public int DuelPending
        {
            get
            {
                return this.duelPending;
            }
            set
            {
                this.duelPending = value;
            }
        }

        public int RealClan
        {
            get
            {
                return this.mRealClan;
            }
        }
        public string ExtraBooster
        {
            get
            {
                return this.mExtraBooster;
            }
            set
            {
                this.mExtraBooster = value;
            }
        }
        public double PreviousDamageTime
        {
            get
            {
                return this.mPreviousDamageTime;
            }
            set
            {
                this.mPreviousDamageTime = value;
            }
        }

        public int PreviousAttacked
        {
            get
            {
                return this.mPreviousAttacked;
            }
            set
            {
                this.mPreviousAttacked = value;
            }
        }

        public bool DisableNpc
        {
            get
            {
                return this.mDisableNpc;
            }
            set
            {
                this.mDisableNpc = value;
            }
        }
        public bool AttackingRepBug
        {
            get
            {
                return this.mAttackingRepBug;
            }
            set
            {
                this.mAttacking = value;
            }
        }
        public bool ActiveAutoRocket
        {
            get
            {
                return this.mActiveAutoRocket;
            }
            set
            {
                this.mActiveAutoRocket = value;
            }
        }
        public int PvpPoints
        {
            get
            {
                return this.mPvpPoints;
            }
            set
            {
                this.mPvpPoints = value;
            }
        }
        public bool GroupLeader
        {
            get
            {
                return this.mGroupLeader;
            }
            set
            {
                this.mGroupLeader = value;
            }
        }
        public int GroupBoss
        {
            get
            {
                return this.mGroupBoss;
            }
            set
            {
                this.mGroupBoss = value;
            }
        }
        public int Blk
        {
            get
            {
                return this.mBlk;
            }
            set
            {
                this.mBlk = value;
            }
        }
        public int Id
        {
            get
            {
                return this.mId;
            }
        }

        public int SessionId
        {
            get
            {
                return this.mSessionId;
            }
        }

        public string AuthTicket
        {
            get
            {
                return this.mAuthTicket;
            }
            set
            {
                this.mAuthTicket = value;
            }
        }

        public string Username
        {
            get
            {
                return this.mUsername;
            }
        }

        public string GameTitle
        {
            get
            {
                return this.mGameTitle;
            }
            set
            {
                this.mGameTitle = value;
            }
        }

        public int KillStrek
        {
            get
            {
                return this.mKillStrek;
            }
            set
            {
                this.mKillStrek = value;
            }
        }

        public double LastTimeElapsed
        {
            get
            {
                return this.mLastTimeElapsed;
            }
            set
            {
                this.mLastTimeElapsed = value;
            }
        }

        public Stopwatch LastMove
        {
            get
            {
                return this.mLastMove;
            }
            set
            {
                this.mLastMove = value;
            }
        }

        public int CheckSpeedHackCounter
        {
            get
            {
                return this.mCheckSpeedHackCounter;
            }
            set
            {
                this.mCheckSpeedHackCounter = value;
            }
        }

        public int SpeedHackDetect
        {
            get
            {
                return this.mSpeedHackDetect;
            }
            set
            {
                this.mSpeedHackDetect = value;
            }
        }

        public int SpeedHackTotalDetect
        {
            get
            {
                return this.mSpeedHackTotalDetect;
            }
            set
            {
                this.mSpeedHackTotalDetect = value;
            }
        }

        public bool IsMod
        {
            get
            {
                return this.mIsMod;
            }
            set
            {
                this.mIsMod = value;
            }
        }

        public bool IsAdmin
        {
            get
            {
                return this.mIsAdmin;
            }
            set
            {
                this.mIsAdmin = value;
            }
        }

        public bool IsInvisibleForAll
        {
            get
            {
                return this.mIsInvisibleForAll;
            }
            set
            {
                this.mIsInvisibleForAll = value;
            }
        }

        public bool CanMove
        {
            get
            {
                return this.mCanMove;
            }
            set
            {
                this.mCanMove = value;
            }
        }

        public int ShipId
        {
            get
            {
                return this.mShipId;
            }
        }

        public int ShipSpeed
        {
            get
            {
                double totalSeconds = (DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0)).TotalSeconds;
                int num = this.ActiveConfig != 1 ? this.Config2.ShipSpeed : this.Config1.ShipSpeed;
                if ((double)this.LabInfos.Speed[1] <= totalSeconds)
                    return num;
                if (this.LabInfos.Speed[0] == 12)
                    return num + 15;
                if (this.LabInfos.Speed[0] == 13)
                    return num + 30;
                return num;
            }
            set
            {
                if (this.ActiveConfig == 1)
                    this.Config1.ShipSpeed = value;
                else
                    this.Config2.ShipSpeed = value;
            }
        }

        public int ShipShield
        {
            get
            {
                if (this.ActiveConfig == 1)
                {
                    if (this.Config1.Shield > this.ShipMaxShield)
                        this.Config1.Shield = this.Config1.MaxShield;
                    return this.Config1.Shield;
                }
                if (this.Config2.Shield > this.ShipMaxShield)
                    this.Config2.Shield = this.Config2.MaxShield;
                return this.Config2.Shield;
            }
            set
            {
                if (this.ActiveConfig == 1)
                    this.Config1.Shield = value;
                else
                    this.Config2.Shield = value;
            }
        }

        public int ShipMaxShield
        {
            get
            {
                double totalSeconds = (DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0)).TotalSeconds;
                int num = this.ActiveConfig != 1 ? this.Config2.MaxShield : this.Config1.MaxShield;
                if ((double)this.LabInfos.Shield[1] <= totalSeconds)
                    return num;
                if (this.LabInfos.Shield[0] == 12)
                    return (int)((double)num * 1.15);
                if (this.LabInfos.Shield[0] == 13)
                    return (int)((double)num * 1.3);
                return num;
            }
            set
            {
                if (this.ActiveConfig == 1)
                    this.Config1.MaxShield = value;
                else
                    this.Config2.MaxShield = value;
            }
        }

        public int ShipHp
        {
            get
            {
                return this.mShipHp;
            }
            set
            {
                this.mShipHp = value;
            }
        }

        public int ShipMaxHp
        {
            get
            {
                return this.mShipMaxHp;
            }
        }

        public int GGRings
        {
            get
            {
                return this.mGGRings;
            }
            set
            {
                this.mGGRings = value;
            }
        }

        public LabInfos LabInfos
        {
            get
            {
                return this.mLabInfos;
            }
            set
            {
                this.mLabInfos = value;
            }
        }

        public int MaxDamage
        {
            get
            {
                if (this.ActiveConfig == 1)
                    return this.Config1.MaxDamage;
                return this.Config2.MaxDamage;
            }
            set
            {
                if (this.ActiveConfig == 1)
                    this.Config1.MaxDamage = value;
                else
                    this.Config2.MaxDamage = value;
            }
        }

        public int MinDamage
        {
            get
            {
                if (this.ActiveConfig == 1)
                    return this.Config1.MinDamage;
                return this.Config2.MinDamage;
            }
            set
            {
                if (this.ActiveConfig == 1)
                    this.Config1.MinDamage = value;
                else
                    this.Config2.MinDamage = value;
            }
        }

        public Random RandomDamage
        {
            get
            {
                return this.mRandomDamage;
            }
            set
            {
                this.mRandomDamage = value;
            }
        }

        public int ShipCargo
        {
            get
            {
                return this.mShipCargo;
            }
        }

        public int ShipMaxCargo
        {
            get
            {
                return this.mShipMaxCargo;
            }
        }

        public int OldLocX
        {
            get
            {
                return this.mOldLocX;
            }
            set
            {
                this.mOldLocX = value;
            }
        }

        public int OldLocY
        {
            get
            {
                return this.mOldLocY;
            }
            set
            {
                this.mOldLocY = value;
            }
        }

        public int NewLocX
        {
            get
            {
                return this.mNewLocX;
            }
            set
            {
                this.mNewLocX = value;
            }
        }

        public int NewLocY
        {
            get
            {
                return this.mNewLocY;
            }
            set
            {
                this.mNewLocY = value;
            }
        }

        public int LocX
        {
            get
            {
                return this.mLocX;
            }
            set
            {
                this.mLocX = value;
            }
        }

        public int LocY
        {
            get
            {
                return this.mLocY;
            }
            set
            {
                this.mLocY = value;
            }
        }

        public int CurrentPortal
        {
            get
            {
                return this.mCurrentPortal;
            }
            set
            {
                this.mCurrentPortal = value;
            }
        }

        public bool PortalZone
        {
            get
            {
                return this.mPortalZone;
            }
            set
            {
                this.mPortalZone = value;
            }
        }

        public bool IsMoving
        {
            get
            {
                return this.mIsMoving;
            }
            set
            {
                this.mIsMoving = value;
            }
        }

        public int MapId
        {
            get
            {
                return this.mMapId;
            }
            set
            {
                this.mMapId = value;
            }
        }

        public long Credits
        {
            get
            {
                return this.mCredits;
            }
            set
            {
                this.mCredits = value;
            }
        }

        public long Uridium
        {
            get
            {
                return this.mUridium;
            }
            set
            {
                this.mUridium = value;
            }
        }

        public int Grade
        {
            get
            {
                return this.mGrade;
            }
        }

        public int FactionId
        {
            get
            {
                return this.mFactionId;
            }
            set
            {
                this.mFactionId = value;
            }
        }

        public int RealFaction
        {
            get
            {
                return this.mRealFaction;
            }
        }

        public int ClanId
        {
            get
            {
                return this.mClanId;
            }
            set
            {
                this.mClanId = value;
            }
        }

        public string ClanTag
        {
            get
            {
                return this.mClanTag;
            }
        }

        public bool Disconnected
        {
            get
            {
                return this.mOnline;
            }
            set
            {
                this.mOnline = value;
            }
        }

        public int SelectedPlayer
        {
            get
            {
                return this.mSelectedPlayer;
            }
            set
            {
                this.mSelectedPlayer = value;
            }
        }

        public int SelectedAmmo
        {
            get
            {
                return this.mSelectedAmmo;
            }
            set
            {
                this.mSelectedAmmo = value;
            }
        }

        public int SelectedRocket
        {
            get
            {
                return this.mSelectedRocket;
            }
            set
            {
                this.mSelectedRocket = value;
            }
        }

        public int SelectedPlayerRocket
        {
            get
            {
                return this.mSelectedPlayerRocket;
            }
            set
            {
                this.mSelectedPlayerRocket = value;
            }
        }

        public long RankPoints
        {
            get
            {
                return this.mRankPoints;
            }
        }

        public int NpcKill
        {
            get
            {
                return this.mNpcKill;
            }
        }

        public int UserKill
        {
            get
            {
                return this.mUserKill;
            }
        }

        public bool Destroy
        {
            get
            {
                return this.mDestroy;
            }
            set
            {
                this.mDestroy = value;
            }
        }

        public bool PeaceZone
        {
            get
            {
                return this.mPeaceZone;
            }
            set
            {
                this.mPeaceZone = value;
            }
        }

        public bool Attacking
        {
            get
            {
                return this.mAttacking;
            }
            set
            {
                this.mAttacking = value;
                this.mAttackingRepBug = value;
            }
        }

        public CList<Session> Attacked
        {
            get
            {
                return this.mAttacked;
            }
            set
            {
                this.mAttacked = value;
            }
        }

        public CList<int> ClanWar
        {
            get
            {
                return this.mClanWar;
            }
            set
            {
                this.mClanWar = value;
            }
        }

        public CList<int> ClanAlliance
        {
            get
            {
                return this.mClanAlliance;
            }
            set
            {
                this.mClanAlliance = value;
            }
        }

        public bool OutOfRange
        {
            get
            {
                return this.mOutOfRange;
            }
            set
            {
                this.mOutOfRange = value;
            }
        }

        public int ActiveConfig
        {
            get
            {
                return this.mActiveConfig;
            }
            set
            {
                this.mActiveConfig = value;
            }
        }

        public int TmpActiveConfig
        {
            get
            {
                return this.mTmpActiveConfig;
            }
            set
            {
                this.mTmpActiveConfig = value;
            }
        }

        public double LastConfigChange
        {
            get
            {
                return this.mLastConfigChange;
            }
            set
            {
                this.mLastConfigChange = value;
            }
        }

        public double LastRocket
        {
            get
            {
                return this.mLastRocket;
            }
            set
            {
                this.mLastRocket = value;
            }
        }

        public bool CanChangeConfig
        {
            get
            {
                return UnixTimestamp.GetCurrent() - this.mLastConfigChange >= 4.0;
            }
        }

        public double LastTechSh
        {
            get
            {
                return this.mLastTechSh;
            }
            set
            {
                this.mLastTechSh = value;
            }
        }

        public double LastTechHp
        {
            get
            {
                return this.mLastTechHp;
            }
            set
            {
                this.mLastTechHp = value;
            }
        }

        public double LastISH
        {
            get
            {
                return this.mLastISH;
            }
            set
            {
                this.mLastISH = value;
            }
        }

        public double LastSMB
        {
            get
            {
                return this.mLastSMB;
            }
            set
            {
                this.mLastSMB = value;
            }
        }

        public int CoolDownTechSh
        {
            get
            {
                int int32 = Convert.ToInt32(Math.Round(45.0 - (UnixTimestamp.GetCurrent() - this.mLastTechSh)));
                if (int32 <= 0)
                    return 0;
                return int32;
            }
        }

        public int CoolDownTechHp
        {
            get
            {
                int int32 = Convert.ToInt32(Math.Round(45.0 - (UnixTimestamp.GetCurrent() - this.mLastTechHp)));
                if (int32 <= 0)
                    return 0;
                return int32;
            }
        }

        public int CoolDownISH
        {
            get
            {
                int int32 = Convert.ToInt32(Math.Round(30.0 - (UnixTimestamp.GetCurrent() - this.mLastISH)));
                if (int32 <= 0)
                    return 0;
                return int32;
            }
        }

        public int CoolDownSMB
        {
            get
            {
                int int32 = Convert.ToInt32(Math.Round(30.0 - (UnixTimestamp.GetCurrent() - this.mLastSMB)));
                if (int32 <= 0)
                    return 0;
                return int32;
            }
        }

        public int SMBLocX
        {
            get
            {
                return this.mSMBLocX;
            }
            set
            {
                this.mSMBLocX = value;
            }
        }

        public int SMBLocY
        {
            get
            {
                return this.mSMBLocY;
            }
            set
            {
                this.mSMBLocY = value;
            }
        }

        public bool ActiveISH
        {
            get
            {
                return 30 - this.CoolDownISH <= 3;
            }
        }

        public CharacterConfig Config1
        {
            get
            {
                return this.mConfig1;
            }
        }

        public CharacterConfig Config2
        {
            get
            {
                return this.mConfig2;
            }
        }

        public int NoFightTimer
        {
            get
            {
                return this.mNoFightTimer;
            }
            set
            {
                this.mNoFightTimer = value;
            }
        }

        public bool CanRegenShield
        {
            get
            {
                return this.mNoFightTimer >= 10;
            }
        }

        public System.Threading.Timer PathTime
        {
            get
            {
                return this.mPathTime;
            }
            set
            {
                this.mPathTime = value;
            }
        }

        public System.Threading.Timer PathFinding
        {
            get
            {
                return this.mPathFinding;
            }
            set
            {
                this.mPathFinding = value;
            }
        }

        public bool WarningZone
        {
            get
            {
                return this.mWarningZone;
            }
            set
            {
                this.mWarningZone = value;
            }
        }

        public System.Threading.Timer WarningZoneTimer
        {
            get
            {
                return this.mWarningZoneTimer;
            }
            set
            {
                this.mWarningZoneTimer = value;
            }
        }

        public System.Threading.Timer UpdateMovementTimer
        {
            get
            {
                return this.mUpdateMovementTimer;
            }
            set
            {
                this.mUpdateMovementTimer = value;
            }
        }

        public System.Threading.Timer LaserAttackTimer
        {
            get
            {
                return this.mLaserAttackTimer;
            }
            set
            {
                this.mLaserAttackTimer = value;
            }
        }

        public System.Threading.Timer LaserAttackCanTimer
        {
            get
            {
                return this.mLaserAttackCanTimer;
            }
            set
            {
                this.mLaserAttackCanTimer = value;
            }
        }

        public bool CanLaserAttack
        {
            get
            {
                return this.mCanLaserAttack;
            }
            set
            {
                this.mCanLaserAttack = value;
            }
        }

        public System.Threading.Timer DisconnectTimer
        {
            get
            {
                return this.mDisconnectTimer;
            }
            set
            {
                this.mDisconnectTimer = value;
            }
        }

        public int DisconnectCounter
        {
            get
            {
                return this.mDisconnectCounter;
            }
            set
            {
                this.mDisconnectCounter = value;
            }
        }

        public System.Threading.Timer RepairTimer
        {
            get
            {
                return this.mRepairTimer;
            }
            set
            {
                this.mRepairTimer = value;
            }
        }

        public System.Threading.Timer BattleRepairTimer
        {
            get
            {
                return this.mBattleRepairTimer;
            }
            set
            {
                this.mBattleRepairTimer = value;
            }
        }

        public int BattleRepairCount
        {
            get
            {
                return this.mBattleRepairCount;
            }
            set
            {
                this.mBattleRepairCount = value;
            }
        }

        public System.Threading.Timer PortalJumpTimer
        {
            get
            {
                return this.mPortalJumpTimer;
            }
            set
            {
                this.mPortalJumpTimer = value;
            }
        }

        public System.Threading.Timer RocketAttackTimer
        {
            get
            {
                return this.mRocketAttackTimer;
            }
            set
            {
                this.mRocketAttackTimer = value;
            }
        }

        public bool IsJumping
        {
            get
            {
                return this.mIsJumping;
            }
            set
            {
                this.mIsJumping = value;
            }
        }

        public bool IsRepairing
        {
            get
            {
                return this.mIsRepairing;
            }
            set
            {
                this.mIsRepairing = value;
            }
        }

        public int TimeTaken
        {
            get
            {
                return this.mPathTimeTaken;
            }
            set
            {
                this.mPathTimeTaken = value;
            }
        }

        public bool HasLinkedSession
        {
            get
            {
                return this.SessionId > 0;
            }
        }

        public double CacheAge
        {
            get
            {
                return UnixTimestamp.GetCurrent() - this.mCacheAge;
            }
        }

        public double TimestampLastOnline
        {
            get
            {
                return this.mTimestampLastOnline;
            }
            set
            {
                this.mTimestampLastOnline = value;
            }
        }

        public Settings Settings
        {
            get
            {
                return this.mSettings;
            }
        }

        public int Level
        {
            get
            {
                return this.mLevel;
            }
        }

        public int AttackSpeed
        {
            get
            {
                return this.mAttackSpeed;
            }
        }

        public double LastRSB75
        {
            get
            {
                return this.mLastRSB75;
            }
            set
            {
                this.mLastRSB75 = value;
            }
        }

        public double LastEMP
        {
            get
            {
                return this.mLastEMP;
            }
            set
            {
                this.mLastEMP = value;
            }
        }

        public Session Attacker
        {
            get
            {
                return this.mAttacker;
            }
            set
            {
                this.mAttacker = value;
            }
        }

        public double LastAttackByAttackerReceived
        {
            get
            {
                return this.mLastAttackByAttackerReceived;
            }
            set
            {
                this.mLastAttackByAttackerReceived = value;
            }
        }

        public int BootyKeys
        {
            get
            {
                return this.mBootyKeys;
            }
            set
            {
                this.mBootyKeys = value;
            }
        }

        public int BoosterHpTime
        {
            get
            {
                return this.mBoosterHpTime;
            }
            set
            {
                this.mBoosterHpTime = value;
            }
        }

        public int BoosterShdTime
        {
            get
            {
                return this.mBoosterShdTime;
            }
            set
            {
                this.mBoosterShdTime = value;
            }
        }

        public int BoosterDmgTime
        {
            get
            {
                return this.mBoosterDmgTime;
            }
            set
            {
                this.mBoosterDmgTime = value;
            }
        }

        public int BoosterNpcTime
        {
            get
            {
                return this.mBoosterNpcTime;
            }
            set
            {
                this.mBoosterNpcTime = value;
            }
        }

        public bool ApisBuilt
        {
            get
            {
                return this.mApisBuilt;
            }
            set
            {
                this.mApisBuilt = value;
            }
        }

        public bool ZeusBuilt
        {
            get
            {
                return this.mZeusBuilt;
            }
            set
            {
                this.mZeusBuilt = value;
            }
        }

        public CList<int> NpcInRange { get; set; }

        public CList<int> PlayerInRange { get; set; }

        public int Invisible { get; set; }

        public int InvisibleCooldown
        {
            get
            {
                return this.mInvisibleCooldown;
            }
            set
            {
                this.mInvisibleCooldown = value;
            }
        }

        public CDictionnary<string, int> SkillTree
        {
            get
            {
                return this.mSkillTree;
            }
            set
            {
                this.mSkillTree = value;
            }
        }

        public CharacterInfo(SqlDatabaseClient MySqlClient, int SessionId, int Id, string AuthTicket)
        {
            this.NpcInRange = new CList<int>();
            this.PlayerInRange = new CList<int>();
            this.Invisible = 0;
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)Id);
            DataRow dataRow = MySqlClient.ExecuteQueryRow("SELECT username, is_mod, is_admin, shipid, locx, locy, mapid, cooldown_ISH, cooldown_SMB  FROM users WHERE id = @id LIMIT 1");
            this.mSessionId = SessionId;
            this.mId = Id;
            this.mAuthTicket = AuthTicket;
            this.mLastMove = new Stopwatch();
            this.mUsername = WebUtility.HtmlDecode((string)dataRow["username"]);
            this.mIsAdmin = (bool)dataRow["is_admin"];
            this.mIsMod = (bool)dataRow["is_mod"];
            this.mShipId = (int)dataRow["shipid"];
            this.mOldLocX = (int)dataRow["locx"];
            this.mOldLocY = (int)dataRow["locy"];
            this.mLocX = (int)dataRow["locx"];
            this.mLocY = (int)dataRow["locy"];
            this.mMapId = (int)dataRow["mapid"];
            this.mLastEMP = (double)Convert.ToInt32(Math.Round(UnixTimestamp.GetCurrent() - (double)(30 - (int)dataRow["cooldown_ISH"])));
            this.mLastSMB = (double)Convert.ToInt32(Math.Round(UnixTimestamp.GetCurrent() - (double)(30 - (int)dataRow["cooldown_SMB"])));
            this.mGameTitle = "";
            this.mShipCargo = 0;
            this.mShipMaxCargo = 0;
            this.mCredits = 0L;
            this.mUridium = 0L;
            this.mKillStrek = 0;
            this.mGrade = 1;
            this.mFactionId = 0;
            this.mClanId = 0;
            this.mClanTag = WebUtility.HtmlDecode("");
            this.mOnline = true;
            this.mSelectedPlayer = 0;
            this.mSelectedAmmo = 4;
            this.mSelectedRocket = 3;
            this.mRankPoints = 0L;
            this.mUserKill = 0;
            this.mNpcKill = 0;
            this.mGGRings = 0;
            this.mShipMaxHp = 10000;
            this.mShipHp = 10000;
            this.mConfig1 = new CharacterConfig(10000, 10000, 28, 1000);
            this.mConfig2 = new CharacterConfig(10000, 10000, 28, 1000);
            this.mActiveConfig = 1;
            this.mLabInfos = new LabInfos();
            this.mAttacked = new CList<Session>();
            this.mClanWar = new CList<int>();
            this.mClanAlliance = new CList<int>();
            this.FatLasers = 0;
            this.ShieldMechanics = 0;
            this.Drones = "";
            this.mLevel = 1;
            this.mAttackSpeed = 800;
            this.mDestroy = false;
            this.Members = new CList<int>();
            this.InvitationReceive = new CList<int>();
            this.InvitationSend = new CList<int>();
        }

        public void RefreshSettings(SqlDatabaseClient MySqlClient)
        {
            if (MySqlClient == null)
                return;
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("userid", (object)this.mId);
            DataRow dataRow = MySqlClient.ExecuteQueryRow("SELECT * FROM users_settings WHERE playerid = @userid");
            this.mSettings = new Settings((int)dataRow["playerid"], (string)dataRow["flash_set"], (string)dataRow["minimap_scale"], (string)dataRow["resizable_windows"], Convert.ToInt32(dataRow["display_player_names"]), Convert.ToInt32(dataRow["display_chat"]), Convert.ToInt32(dataRow["play_music"]), Convert.ToInt32(dataRow["play_sfx"]), (string)dataRow["bar_status"], (string)dataRow["window_settings"], (string)dataRow["client_resolution"], Convert.ToInt32(dataRow["auto_refinement"]), Convert.ToInt32(dataRow["quickslot_stop_attack"]), Convert.ToInt32(dataRow["doubleclick_attack"]), Convert.ToInt32(dataRow["auto_start"]), Convert.ToInt32(dataRow["display_notifications"]), Convert.ToInt32(dataRow["show_drones"]), Convert.ToInt32(dataRow["display_window_background"]), Convert.ToInt32(dataRow["always_draggable_windows"]), Convert.ToInt32(dataRow["preload_user_ships"]), (int)dataRow["quality_presetting"], (int)dataRow["quality_customized"], (int)dataRow["quality_background"], (int)dataRow["quality_poizone"], (int)dataRow["quality_ship"], (int)dataRow["quality_engine"], (int)dataRow["quality_collectable"], (int)dataRow["quality_attack"], (int)dataRow["quality_effect"], (int)dataRow["quality_explosion"], (string)dataRow["quickbar_slot"], (string)dataRow["mainmenu_position"], (string)dataRow["slotmenu_position"], (string)dataRow["slotmenu_order"]);
        }

        public void UpdateSettings(SqlDatabaseClient MySqlClient, string RowName, string Value)
        {
            RowName = RowName.ToLower();
            if (RowName == "flash_set" || RowName == "minimap_scale" || (RowName == "resizable_windows" || RowName == "display_player_names") || (RowName == "display_chat" || RowName == "play_music" || (RowName == "play_sfx" || RowName == "bar_status")) || (RowName == "window_settings" || RowName == "client_resolution" || (RowName == "auto_refinement" || RowName == "quickslot_stop_attack") || (RowName == "doubleclick_attack" || RowName == "auto_start" || (RowName == "show_drones" || RowName == "display_window_background"))) || (RowName == "always_draggable_windows" || RowName == "mainmenu_position" || (RowName == "quality_collectable" || RowName == "quality_attack") || (RowName == "quality_effect" || RowName == "quality_explosion" || (RowName == "quickbar_slot" || RowName == "preload_user_ships")) || (RowName == "slotmenu_position" || RowName == "slotmenu_order" || (RowName == "display_notifications" || RowName == "quality_presetting") || (RowName == "quality_customized" || RowName == "quality_background" || (RowName == "quality_poizone" || RowName == "quality_ship")))) || RowName == "quality_engine")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("userid", (object)this.mId);
                MySqlClient.SetParameter("value", (object)Value);
                MySqlClient.ExecuteNonQuery("UPDATE users_settings SET " + RowName + "=@value WHERE playerid=@userid LIMIT 1");
            }
            else
                Output.WriteLine((object)("Error updatesettings : " + RowName + " - " + Value));
        }

        public void RefreshClan(SqlDatabaseClient MySqlClient)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            DataRow dataRow1 = MySqlClient.ExecuteQueryRow("SELECT clanid FROM users WHERE id = @id LIMIT 1");
            this.mClanId = dataRow1 == null ? 0 : (int)dataRow1["clanid"];
            this.mRealClan = this.mClanId;
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("clanid", (object)this.mClanId);
            DataRow dataRow2 = MySqlClient.ExecuteQueryRow("SELECT clan_tag FROM clan WHERE id = @clanid LIMIT 1");
            this.mClanTag = dataRow2 == null ? "" : WebUtility.HtmlDecode((string)dataRow2["clan_tag"]);
            this.mClanWar.Clear();
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("clanid", (object)this.mClanId);
            DataTable dataTable1 = MySqlClient.ExecuteQueryTable("SELECT second_clan_id FROM clan_diplomacy WHERE clan_id=@clanid AND type='war'");
            if (dataTable1 != null)
            {
                bool lockTaken = false;
                try
                {
                    Monitor.Enter((object)(clist = this.mClanWar), ref lockTaken);
                    foreach (DataRow row in (InternalDataCollectionBase)dataTable1.Rows)
                    {
                        if (!this.mClanWar.Contains((int)row["second_clan_id"]))
                            this.mClanWar.Add((int)row["second_clan_id"]);
                    }
                }
                finally
                {
                    if (lockTaken)
                        Monitor.Exit((object)clist);
                }
            }
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("clanid", (object)this.mClanId);
            DataTable dataTable2 = MySqlClient.ExecuteQueryTable("SELECT clan_id FROM clan_diplomacy WHERE second_clan_id=@clanid AND type='war'");
            if (dataTable2 != null)
            {
                bool lockTaken = false;
                try
                {
                    Monitor.Enter((object)(clist = this.mClanWar), ref lockTaken);
                    foreach (DataRow row in (InternalDataCollectionBase)dataTable2.Rows)
                    {
                        if (!this.mClanWar.Contains((int)row["clan_id"]))
                            this.mClanWar.Add((int)row["clan_id"]);
                    }
                }
                finally
                {
                    if (lockTaken)
                        Monitor.Exit((object)clist);
                }
            }
            this.mClanAlliance.Clear();
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("clanid", (object)this.mClanId);
            DataTable dataTable3 = MySqlClient.ExecuteQueryTable("SELECT second_clan_id FROM clan_diplomacy WHERE clan_id=@clanid AND type='alliance'");
            if (dataTable3 != null)
            {
                bool lockTaken = false;
                try
                {
                    Monitor.Enter((object)(clist = this.mClanAlliance), ref lockTaken);
                    foreach (DataRow row in (InternalDataCollectionBase)dataTable3.Rows)
                    {
                        if (!this.mClanAlliance.Contains((int)row["second_clan_id"]))
                            this.mClanAlliance.Add((int)row["second_clan_id"]);
                    }
                }
                finally
                {
                    if (lockTaken)
                        Monitor.Exit((object)clist);
                }
            }
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("clanid", (object)this.mClanId);
            DataTable dataTable4 = MySqlClient.ExecuteQueryTable("SELECT clan_id FROM clan_diplomacy WHERE second_clan_id=@clanid AND type='alliance'");
            if (dataTable4 == null)
                return;
            bool lockTaken1 = false;
            try
            {
                Monitor.Enter((object)(clist = this.mClanAlliance), ref lockTaken1);
                foreach (DataRow row in (InternalDataCollectionBase)dataTable4.Rows)
                {
                    if (!this.mClanAlliance.Contains((int)row["clan_id"]))
                        this.mClanAlliance.Add((int)row["clan_id"]);
                }
            }
            finally
            {
                if (lockTaken1)
                    Monitor.Exit((object)clist);
            }
        }

        public void SynchronizeStatistics(SqlDatabaseClient MySqlClient, int online)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.SetParameter("lastlogin", (object)UnixTimestamp.GetCurrent());
            MySqlClient.SetParameter("cdISH", (object)this.CoolDownISH);
            MySqlClient.SetParameter("cdSMB", (object)this.CoolDownSMB);
            if (this.MapId != 80)
            {
                MySqlClient.SetParameter("locx", (object)this.LocX);
                MySqlClient.SetParameter("locy", (object)this.LocY);
                MySqlClient.SetParameter("mapid", (object)this.MapId);
            }
            else if (this.FactionId == 1)
            {
                MySqlClient.SetParameter("locx", (object)2000);
                MySqlClient.SetParameter("locy", (object)1100);
                MySqlClient.SetParameter("mapid", (object)1);
            }
            else if (this.FactionId == 2)
            {
                MySqlClient.SetParameter("locx", (object)18500);
                MySqlClient.SetParameter("locy", (object)1100);
                MySqlClient.SetParameter("mapid", (object)5);
            }
            else if (this.FactionId == 3)
            {
                MySqlClient.SetParameter("locx", (object)19000);
                MySqlClient.SetParameter("locy", (object)11000);
                MySqlClient.SetParameter("mapid", (object)9);
            }
            MySqlClient.SetParameter("online", (object)online);
            MySqlClient.SetParameter("current_hp", (object)this.ShipHp);
            MySqlClient.ExecuteNonQuery("UPDATE users SET lastlogin = @lastlogin, locx = @locx, locy = @locy, cooldown_ISH = @cdISH, cooldown_SMB = @cdSMB, mapid = @mapid, online = @online, current_hp = @current_hp WHERE id = @id LIMIT 1");
        }

        public void addTdmVictory(SqlDatabaseClient MySqlClient, int amount = 1)
        {

            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.SetParameter("amount", (object)amount);
            MySqlClient.ExecuteNonQuery("UPDATE users SET nb_tdm = nb_tdm + @amount WHERE id = @id LIMIT 1");
        }

        public void AddLog(SqlDatabaseClient MySqlClient, string _Message)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.SetParameter("message", (object)_Message);
            MySqlClient.ExecuteNonQuery("INSERT INTO `users_log`(`playerid`, `message`) VALUES (@id, @message)");
        }

        public void AddNpcCount(SqlDatabaseClient MySqlClient, string NpcName)
        {
            if (NpcName == "-=[ Streuner ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Streuner = Streuner + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss Streuner ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Streuner = Streuner + 2 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Lordakia ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Lordakia = Lordakia + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss Lordakia ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Lordakia = Lordakia + 2 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Saimon ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Saimon = Saimon + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss Saimon ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Saimon = Saimon + 2 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Sibelon ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Sibelon = Sibelon + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss Sibelon ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Sibelon = Sibelon + 2 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Kristallin ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Kristallin = Kristallin + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss Kristallin ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Kristallin = Kristallin + 2 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Kristallon ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Kristallon = Kristallon + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss Kristallon ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Kristallon = Kristallon + 2 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Cubikon ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Cubikon = Cubikon + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss Cubikon ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Cubikon = Cubikon + 2 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Ice Meteroid ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET IceMeteroid = IceMeteroid + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss KuKu ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET BossKuKu = BossKuKu + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Hitac ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Hitac = Hitac + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Scorcher ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Scorcher = Scorcher + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Boss Curcubitor ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET BossCurcubitor = BossCurcubitor + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Melter ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Melter = Melter + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Devourer ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Devourer = Devourer + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Saboteur ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Saboteur = Saboteur + 1 WHERE id = @id LIMIT 1");
            }
            else if (NpcName == "-=[ Annihilator ]=-")
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Annihilator = Annihilator + 1 WHERE id = @id LIMIT 1");
            }
            else
            {
                if (!(NpcName == "-=[ Battleray ]=-"))
                    return;
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users_npc_counts SET Battleray = Battleray + 1 WHERE id = @id LIMIT 1");
            }
        }

        public void AddSpeedhack(SqlDatabaseClient MySqlClient)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.SetParameter("username", (object)this.mUsername);
            MySqlClient.ExecuteNonQuery("INSERT INTO `speedhack_detect`(`user_id`, `username`) VALUES (@id, @username)");
        }

        public void AddKill(SqlDatabaseClient MySqlClient)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET user_kill = user_kill + 1 WHERE id = @id LIMIT 1");
            if (this.mClanId == 0)
                return;
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mClanId);
            MySqlClient.ExecuteNonQuery("UPDATE clan SET kill_count = kill_count + 1 WHERE id = @id LIMIT 1");
        }

        public void AddLastDuel(SqlDatabaseClient MySqlClient)
        {
            MySqlClient.ClearParameters();
            double time = UnixTimestamp.GetCurrent();
            MySqlClient.SetParameter("time", (object)time);
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET last_duel = @time WHERE id = @id LIMIT 1");
            this.LastDuel = time;
        }

        public void AddRankpoints(SqlDatabaseClient MySqlClient, int rankpoints)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET rankpoints = rankpoints + " + (object)rankpoints + " WHERE id = @id LIMIT 1");
        }
        public void AddDuelReward(SqlDatabaseClient MySqlClient, int nbMatch, int nbWin)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET nb_duel = nb_duel + " + (object)nbMatch + ", duel_win = duel_win + " + (object)nbWin + "  WHERE id = @id LIMIT 1");
        }

        public void AddKillReward(SqlDatabaseClient MySqlClient, int kill)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET user_kill = user_kill + " + (object)kill + " WHERE id = @id LIMIT 1");
        }

        public void AddReward(SqlDatabaseClient MySqlClient, int credits, int uridium, int npcPoints = 0, bool isNpc = false)
        {
            try
            {
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users SET uridium = uridium + " + (object)uridium + ", credits = credits + " + (object)credits + " WHERE id = @id LIMIT 1");
                int num = npcPoints;
                MySqlClient.SetParameter("id", (object)this.mId);
                MySqlClient.ExecuteNonQuery("UPDATE users SET npc_kill = npc_kill + " + (object)num + "  WHERE id = @id LIMIT 1");
                this.Uridium += (long)uridium;
                this.Credits += (long)credits;
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR ADDING REWARD :", e.Message);
            }
        }

        public void AddSurvivorWin(SqlDatabaseClient MySqlClient, int nbSurvivor)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET win_survivor = win_survivor +" + (object)nbSurvivor + " WHERE id = @id");
        }

        public void AddTdmMatch(SqlDatabaseClient MySqlClient, int nbVictory, int nbMatch)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET tdm_win = tdm_win +" + (object)nbVictory + ", nb_tdm = nb_tdm +" + (object)nbMatch + " WHERE id = @id");
        }

        public void RemoveRankPoints(SqlDatabaseClient MySqlClient, int amount)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET rankpoints = rankpoints - " + (object)amount + " WHERE id = @id LIMIT 1");
        }

        public void RemoveReward(long credits, long uridium)
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE users SET uridium = uridium - " + (object)uridium + ", credits = credits - " + (object)credits + " WHERE id = @id LIMIT 1");
                this.Uridium -= uridium;
                this.Credits -= credits;
            }
        }

        public void RefreshUserData(SqlDatabaseClient MySqlClient)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            DataRow dataRow1 = MySqlClient.ExecuteQueryRow("SELECT * FROM users WHERE id = @id LIMIT 1");
            if (dataRow1 == null)
                return;

            // Infos de base
            this.mFactionId = (int)dataRow1["factionid"];
            this.mRealFaction = (int)dataRow1["factionid"];
            this.mGameTitle = (string)dataRow1["game_title"];
            this.mGrade = (int)dataRow1["grade"];
            this.mCredits = (long)dataRow1["credits"];
            this.mUridium = (long)dataRow1["uridium"];
            this.mPvpPoints = (int)dataRow1["pvp_points"];
            this.mBootyKeys = (int)dataRow1["booty_keys"];
            this.mUserKill = (int)dataRow1["user_kill"];
            this.mNpcKill = (int)dataRow1["npc_kill"];
            AutoRocketSkill = (int)dataRow1["auto_rkt_skill"];
            this.mRankPoints = (long)dataRow1["rankpoints"];
            int canBeginner = (int)dataRow1["canBeginner"];
            this.mDisableNpc = false;
            this.LastDuel = (int)dataRow1["last_duel"];

            // Beginner mode
            if (this.mRankPoints < 25000L && canBeginner == 1)
            {
                this.mGameTitle = "title_5";
                this.IsBeginner = true;
            }
            if (canBeginner == 1 && this.mRankPoints >= 25000L)
            {
                this.IsBeginner = false;
                MySqlClient.ClearParameters();
                MySqlClient.SetParameter("id", this.Id);
                MySqlClient.SetParameter("beginner", 0);
                MySqlClient.ExecuteNonQuery("UPDATE users SET canBeginner = @beginner WHERE id = @id");
            }

            int num1 = 0;
            if (this.mNpcKill >= 1000000L)
                ++num1;
            if (this.mPvpPoints >= 1000000L)
                ++num1;
            if (this.mUserKill >= 2500)
                ++num1;

            // NPC lvl → anneaux GG
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            DataRow dataRow2 = MySqlClient.ExecuteQueryRow("SELECT * FROM users_npc_lvl WHERE id = @id LIMIT 1");
            if (dataRow2 != null)
            {
                int num2 = 0;
                foreach (string index in this.npc_name)
                    num2 += (int)dataRow2[index];
                if (num2 >= 70)
                    ++num1;
            }
            this.mGGRings = num1;

            // Drones + Apis / Zeus
            this.Drones = (string)dataRow1["drones"];
            this.mApisBuilt = (bool)dataRow1["apis_built"];
            this.mZeusBuilt = (bool)dataRow1["zeus_built"];
            int num3 = this.Drones.Split('-').Length - 1 - 2;
            if (num3 < 0)
                num3 = 0;

            // Upgrades / compétences (HP / DMG / SHD / SPEED)
            int num4 = (int)dataRow1["hp_lvl"];
            if (num4 > 20 || num4 < 0)
                num4 = 0;
            int num5 = (int)dataRow1["dmg_lvl"];
            if (num5 > 25 || num5 < 0)
                num5 = 0;
            int num6 = (int)dataRow1["shd_lvl"];
            if (num6 > 20 || num6 < 0)
                num6 = 0;
            int num7 = (int)dataRow1["speed_lvl"];
            if (num7 > 5 || num7 < 0)
                num7 = 0;

            // HP : on garde l’ancienne logique (HP upgrades + drones)
            this.mShipMaxHp = 100000;
            this.mShipMaxHp += 5000 * num4;
            this.mShipMaxHp += 1250 * num3;

            int mShipMaxHp = (int)dataRow1["current_hp"];
            if (mShipMaxHp > this.mShipMaxHp)
                mShipMaxHp = this.mShipMaxHp;
            this.mShipHp = mShipMaxHp;

            // --- NOUVELLE PARTIE : base configs avant skilltree/boosters ---

            // Valeurs de base (fallback si aucune config enregistrée en BDD)
            int baseMaxDmg = 1500 + 50 * num5 + 38 * num3;
            if (this.mApisBuilt)
                baseMaxDmg += 100;
            if (this.mZeusBuilt)
                baseMaxDmg += 100;

            int baseMaxShield = 10000 + 4000 * num6 + 1250 * num3;
            int baseSpeed = 250 + 10 * num7;

            // On initialise Config1 / Config2 avec ces valeurs de base
            this.mConfig1.MaxDamage = baseMaxDmg;
            this.mConfig2.MaxDamage = baseMaxDmg;
            this.mConfig1.MaxShield = baseMaxShield;
            this.mConfig2.MaxShield = baseMaxShield;
            this.mConfig1.Shield = baseMaxShield;
            this.mConfig2.Shield = baseMaxShield;
            this.mConfig1.ShipSpeed = baseSpeed;
            this.mConfig2.ShipSpeed = baseSpeed;

            // Puis on essaie de charger les stats issues du NOUVEAU système (ship_config_stats)
            // Ces valeurs ont été calculées par ton config_save.php à partir de l’équipement.
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("pid", (object)this.mId);
            DataTable cfgTable = MySqlClient.ExecuteQueryTable(
                "SELECT scs.config, scs.damage_total, scs.shield_total, scs.speed_total " +
                "FROM ship_config_stats scs " +
                "INNER JOIN ship_config sc ON scs.ship_config_id = sc.id " +
                "WHERE sc.player_id = @pid"
            );

            if (cfgTable != null)
            {
                foreach (DataRow r in cfgTable.Rows)
                {
                    string cfgName = ((string)r["config"]).ToUpper();
                    int dmgCfg = (int)r["damage_total"];
                    int shdCfg = (int)r["shield_total"];
                    int spdCfg = (int)r["speed_total"];

                    if (cfgName == "A")
                    {
                        this.mConfig1.MaxDamage = dmgCfg;
                        this.mConfig1.MaxShield = shdCfg;
                        this.mConfig1.Shield = shdCfg;
                        this.mConfig1.ShipSpeed = spdCfg;
                    }
                    else if (cfgName == "B")
                    {
                        this.mConfig2.MaxDamage = dmgCfg;
                        this.mConfig2.MaxShield = shdCfg;
                        this.mConfig2.Shield = shdCfg;
                        this.mConfig2.ShipSpeed = spdCfg;
                    }
                }
            }

            // NOTE : ici on ne lit plus player_config (damage1/shield1/speed1, etc.)
            // L’ancien système de "15 points" est donc totalement désactivé.

            // Avantages admin
            if (this.IsAdmin)
            {
                this.mConfig2.ShipSpeed = 1000;
                this.mConfig2.MaxDamage *= 10;
            }
            if (this.IsAdmin || this.IsMod)
                this.mGrade = 21;

            // Boosters temps (HP / DMG / SHD / SPD / NPC)
            this.mBoosterHpTime = (int)dataRow1["booster_hp_time"];
            this.mBoosterShdTime = (int)dataRow1["booster_shd_time"];
            this.mBoosterDmgTime = (int)dataRow1["booster_dmg_time"];
            this.mBoosterNpcTime = (int)dataRow1["booster_npc_time"];
            this.mBoosterSpdTime = (int)dataRow1["booster_spd_time"];
            this.mExtraBooster = (string)dataRow1["extra_booster"];

            double totalSeconds = (DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0)).TotalSeconds;
            if ((double)(int)dataRow1["booster_hp_time"] > totalSeconds)
                this.mShipMaxHp += (int)(this.mShipMaxHp * 0.15);
            if ((double)(int)dataRow1["booster_dmg_time"] > totalSeconds)
            {
                this.mConfig1.MaxDamage += (int)(this.mConfig1.MaxDamage * 0.1);
                this.mConfig2.MaxDamage += (int)(this.mConfig2.MaxDamage * 0.1);
            }
            if ((double)(int)dataRow1["booster_shd_time"] > totalSeconds)
            {
                this.mConfig1.MaxShield += (int)(this.mConfig1.MaxShield * 0.25);
                this.mConfig2.MaxShield += (int)(this.mConfig2.MaxShield * 0.25);
            }
            if ((double)(int)dataRow1["booster_spd_time"] > totalSeconds)
            {
                this.mConfig1.ShipSpeed += 20;
                this.mConfig2.ShipSpeed += 20;
            }

            // Extra booster (dmg/shd/hp)
            this.Boosters();

            // Skilltree
            this.mSkillTree.Clear();
            string str1 = (string)dataRow1["skilltree"];
            char[] chArray1 = new char[1] { '/' };
            foreach (string str2 in str1.Split(chArray1))
            {
                char[] chArray2 = new char[1] { ':' };
                string[] strArray = str2.Split(chArray2);
                if (!this.mSkillTree.ContainsKey(strArray[0]))
                    this.mSkillTree.Add(strArray[0], Convert.ToInt32(strArray[1]));
            }

            if (this.mSkillTree.ContainsKey("dmg") && this.mSkillTree["dmg"] > 0)
            {
                switch (this.mSkillTree["dmg"])
                {
                    case 1:
                        this.MultiplierAgainstPlayers = 1.02;
                        this.MultiplierAgainstNpcs = 1.04;
                        break;
                    case 2:
                        this.MultiplierAgainstPlayers = 1.04;
                        this.MultiplierAgainstNpcs = 1.06;
                        break;
                    case 3:
                        this.MultiplierAgainstPlayers = 1.06;
                        this.MultiplierAgainstNpcs = 1.09;
                        break;
                    case 4:
                        this.MultiplierAgainstPlayers = 1.09;
                        this.MultiplierAgainstNpcs = 1.13;
                        break;
                    case 5:
                        this.MultiplierAgainstPlayers = 1.12;
                        this.MultiplierAgainstNpcs = 1.18;
                        this.FatLasers = 1;
                        break;
                }
            }

            if (this.mSkillTree.ContainsKey("hp") && this.mSkillTree["hp"] > 0)
            {
                switch (this.mSkillTree["hp"])
                {
                    case 1:
                        this.mShipMaxHp += 10000;
                        break;
                    case 2:
                        this.mShipMaxHp += 25000;
                        break;
                    case 3:
                        this.mShipMaxHp += 50000;
                        break;
                }
            }

            if (this.mSkillTree.ContainsKey("shd_abs") && this.mSkillTree["shd_abs"] > 0)
            {
                switch (this.mSkillTree["shd_abs"])
                {
                    case 1:
                        this.ShieldAbsorption = 0.73;
                        break;
                    case 2:
                        this.ShieldAbsorption = 0.76;
                        break;
                    case 3:
                        this.ShieldAbsorption = 0.8;
                        this.ShieldMechanics = 1;
                        break;
                }
            }

            if (this.mSkillTree.ContainsKey("smb") && this.mSkillTree["smb"] > 0)
            {
                switch (this.mSkillTree["smb"])
                {
                    case 1:
                        this.SmbDamages = 25000;
                        break;
                    case 2:
                        this.SmbDamages = 35000;
                        break;
                }
            }

            if (this.mSkillTree.ContainsKey("rep") && this.mSkillTree["rep"] > 0)
            {
                switch (this.mSkillTree["rep"])
                {
                    case 1:
                        this.RepairBotHp = 15000;
                        break;
                    case 2:
                        this.RepairBotHp = 20000;
                        break;
                    case 3:
                        this.RepairBotHp = 30000;
                        break;
                }
            }

            if (this.mSkillTree.ContainsKey("rck") && this.mSkillTree["rck"] > 0)
            {
                switch (this.mSkillTree["rck"])
                {
                    case 1:
                        this.RckDamages = 2000;
                        break;
                    case 2:
                        this.RckDamages = 3000;
                        break;
                    case 3:
                        this.RckDamages = 4000;
                        break;
                    case 4:
                        this.RckDamages = 5000;
                        break;
                    case 5:
                        this.RckDamages = 6000;
                        this.RocketPattern = 1;
                        break;
                }
            }

            if (this.mSkillTree.ContainsKey("shreg") && this.mSkillTree["shreg"] > 0)
            {
                switch (this.mSkillTree["shreg"])
                {
                    case 1:
                        this.ShRegen = 8000;
                        break;
                    case 2:
                        this.ShRegen = 9000;
                        break;
                    case 3:
                        this.ShRegen = 10000;
                        break;
                    case 4:
                        this.ShRegen = 11000;
                        break;
                    case 5:
                        this.ShRegen = 12000;
                        break;
                }
            }

            // Cargo
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            DataRow dataRow4 = MySqlClient.ExecuteQueryRow("SELECT * FROM player_cargo WHERE id = @id LIMIT 1");
            if (dataRow4 != null)
            {
                this.mLabInfos.Prometium = (int)dataRow4["prometium"];
                this.mLabInfos.Endurium = (int)dataRow4["endurium"];
                this.mLabInfos.Terbium = (int)dataRow4["terbium"];
                this.mLabInfos.Xenomit = (int)dataRow4["xenomit"];
                this.mLabInfos.Palladium = (int)dataRow4["palladium"];
                this.mLabInfos.Prometid = (int)dataRow4["prometid"];
                this.mLabInfos.Duranium = (int)dataRow4["duranium"];
                this.mLabInfos.Promerium = (int)dataRow4["promerium"];
            }

            // Labo reff
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            DataRow dataRow5 = MySqlClient.ExecuteQueryRow("SELECT * FROM player_reff WHERE id = @id LIMIT 1");
            if (dataRow5 != null)
            {
                this.mLabInfos.Laser[0] = (int)dataRow5["laser0"];
                this.mLabInfos.Laser[1] = (int)dataRow5["laser1"];
                this.mLabInfos.Rocket[0] = (int)dataRow5["rocket0"];
                this.mLabInfos.Rocket[1] = (int)dataRow5["rocket1"];
                this.mLabInfos.Speed[0] = (int)dataRow5["speed0"];
                this.mLabInfos.Speed[1] = (int)dataRow5["speed1"];
                this.mLabInfos.Shield[0] = (int)dataRow5["shield0"];
                this.mLabInfos.Shield[1] = (int)dataRow5["shield1"];
            }

            this.Members.Clear();
            this.InvitationSend.Clear();
            this.InvitationReceive.Clear();
        }


        public void Boosters()
        {
            switch (this.mExtraBooster)
            {
                case "dmg":
                    this.Config1.MaxDamage += (int)(this.Config1.MaxDamage * 0.1);
                    this.Config2.MaxDamage += (int)(this.Config2.MaxDamage * 0.1);
                    return;
                case "shd":
                    this.Config1.MaxShield += (int)(this.Config1.MaxShield * 0.25);
                    this.Config2.MaxShield += (int)(this.Config2.MaxShield * 0.25);
                    return;
                case "hlt":
                    this.mShipMaxHp += (int)(this.mShipMaxHp * 0.25);
                    return;
                default:
                    return;
            }
        }

        public long GetUpdatedUridium()
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                DataRow dataRow = client.ExecuteQueryRow("SELECT uridium FROM users WHERE id = @id LIMIT 1");
                if (dataRow == null)
                    return 0;
                if (this.Uridium != (long)dataRow["uridium"])
                    this.Uridium = (long)dataRow["uridium"];
                return this.Uridium;
            }
        }

        public long GetUpdatedCredits()
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                DataRow dataRow = client.ExecuteQueryRow("SELECT credits FROM users WHERE id = @id LIMIT 1");
                if (dataRow == null)
                    return 0;
                if (this.Credits != (long)dataRow["credits"])
                    this.Credits = (long)dataRow["credits"];
                return this.Credits;
            }
        }

        public void SendCollectibles(Session user)
        {
            foreach (KeyValuePair<int, Collectable> collectable in (ConcurrentDictionary<int, Collectable>)MapManager.GetInstanceByMapId(this.MapId).Info.Collectables)
                user.SendData(PacketComposer.Compose("c", collectable.Value.Id.ToString() + "|" + (object)collectable.Value.Type + "|" + (object)collectable.Value.X + "|" + (object)collectable.Value.Y));
        }

        public void UpdateAttacker(Session attacker)
        {
            double time = UnixTimestamp.GetCurrent();
            if (this.Attacker == null || this.Attacker.CharacterInfo == null)
            {
                this.Attacker = attacker;
                this.LastAttackByAttackerReceived = time;
                return;
            }
            if (this.Attacker == attacker)
            {
                this.LastAttackByAttackerReceived = time;
                return;
            }
            if (time - this.LastAttackByAttackerReceived < 10.0)
            {
                if (!this.assistAttacker.ContainsKey(attacker))
                    this.assistAttacker.Add(attacker, time);
                else
                {
                    this.assistAttacker[attacker] = time;
                }
                return;
            }
            this.Attacker = attacker;
            this.assistAttacker.Remove(attacker);
            this.Attacker.SendData(PacketComposer.Compose("n", "USH|" + (object)this.Id));
        }

        public void SendReward(Session ennemy)
        {
            if (ennemy == null)
            {
                return;
            }
            try
            {
                if (ennemy.CharacterInfo.Destroy || this.Attacker == null)
                    return;
                if (this.Attacker.CharacterInfo == null)
                    return;
                ennemy.CharacterInfo.Destroy = true;
                using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                {
                    string _Message1 = "You have destroyed " + this.Username + ".";
                    string _Message2 = "You have been destroyed by " + WebUtility.HtmlEncode(this.Attacker.CharacterInfo.Username) + ".";
                    this.Attacker.SendData(PacketComposer.Compose("A", "STD|" + _Message1));
                    if (this.Attacker.CharacterInfo.FactionId != ennemy.CharacterInfo.FactionId || this.Attacker.CharacterInfo.MapId == 80)
                    {
                        this.Attacker.CharacterInfo.AddKill(client);
                        this.Attacker.CharacterInfo.AddLog(client, _Message1);
                        ennemy.CharacterInfo.AddLog(client, _Message2);
                        if (ennemy.CharacterInfo.IsBeginner)
                        {
                            int rankpointsAmount = 100;
                            int amountPvpPoints = 50;
                            if (HappyHour.Enabled)
                            {
                                amountPvpPoints = 100;
                                rankpointsAmount = 200;
                            }
                            if (this.mExtraBooster == "pts")
                            {
                                amountPvpPoints += (int)(amountPvpPoints * 0.5);
                                rankpointsAmount += (int)(rankpointsAmount * 0.5);
                            }
                            this.Attacker.CharacterInfo.AddPvpPoints(client, amountPvpPoints);
                            this.Attacker.SendData(PacketComposer.Compose("A", "STD|You received " + amountPvpPoints + " Pvp points."));

                            this.Attacker.CharacterInfo.AddRankpoints(client, rankpointsAmount);
                            this.Attacker.SendData(PacketComposer.Compose("A", "STD|You received " + rankpointsAmount + " rankpoint(s)."));
                        }
                        else
                        {
                            int num = this.Attacker.CharacterInfo.KillStrek * 25;
                            if (num > 125)
                                num = 125;
                            int rankpoints = 250 + num;
                            if (this.Attacker.CharacterInfo.MapId == 17)
                                rankpoints *= 2;
                            if (HappyHour.Enabled)
                                rankpoints *= 2;
                            if(!_1v1.IsOnMap(this.Attacker.CharacterInfo.MapId))
                                ++this.Attacker.CharacterInfo.KillStrek;
                            int amountPvpPoints = this.CalculatePvpPoints(ennemy);
                            if (this.Attacker.CharacterInfo.ExtraBooster == "pts")
                            {
                                rankpoints += (int)(rankpoints * 0.5);
                                amountPvpPoints += (int)(amountPvpPoints * 0.5);
                            }
                            this.Attacker.CharacterInfo.AddRankpoints(client, rankpoints);
                            this.Attacker.SendData(PacketComposer.Compose("A", "STD|You received " + (object)rankpoints + " rankpoint(s)."));

                            this.Attacker.CharacterInfo.AddPvpPoints(client, amountPvpPoints);
                            this.Attacker.SendData(PacketComposer.Compose("A", "STD|You received " + amountPvpPoints + " Pvp points."));

                        }
                    }
                    else if (!this.Attacker.CharacterInfo.ClanWar.Contains(ennemy.CharacterInfo.ClanId))
                    {
                        this.Attacker.CharacterInfo.AddLog(client, _Message1);
                        ennemy.CharacterInfo.AddLog(client, _Message2);

                        this.Attacker.CharacterInfo.RemoveRankPoints(client, 500);
                        this.Attacker.SendData(PacketComposer.Compose("A", "STD|You lost " + (object)500 + " rankpoint(s)."));
                    }

                    MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.mAttacker.CurrentMapId);
                    if (instanceByMapId != null)
                    {
                        string str = this.Username + " has been destroyed by " + this.Attacker.CharacterInfo.Username + ".";
                        instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                    }
                    this.SendRewardAssistAttacker(client, ennemy);
                }
                this.assistAttacker.Clear();
            }
            catch (Exception exception)
            {
                Console.WriteLine("ERROR :", exception);

                return;

            }
        }

        public void SendRewardAssistAttacker(SqlDatabaseClient client, Session ennemy)
        {
            int BaseRp = 75;
            int BasePvppoints = 50;
            if (ennemy.CharacterInfo.RankPoints <= 35000L)
            {
                BaseRp = 30;
                BasePvppoints = 25;
            }
            if (HappyHour.Enabled)
            {
                BaseRp *= 2;
                BasePvppoints *= 2;
            }
            foreach (KeyValuePair<Session, double> entry in this.assistAttacker)
            {
                if (entry.Key != null && UnixTimestamp.GetCurrent() - entry.Value <= 15.0 &&
                    entry.Key.CharacterInfo.FactionId != ennemy.CharacterInfo.FactionId
                    && entry.Key.CharacterInfo.FactionId == this.Attacker.CharacterInfo.FactionId)
                {
                    int rpReceive = BaseRp;
                    int pvpReceive = BasePvppoints;
                    if (entry.Key.CharacterInfo.mExtraBooster == "pts")
                    {
                        rpReceive += (int)(rpReceive * 0.5);
                        pvpReceive += (int)(pvpReceive * 0.5);
                    }
                    string message = "You helped " + this.Attacker.CharacterInfo.Username + " !\n" +
                        "You received " + rpReceive + " Rankpoints !\n" +
                        "You received " + pvpReceive + " Pvp points !";
                    entry.Key.SendData(PacketComposer.Compose("A", "STD|" + message));
                    entry.Key.CharacterInfo.AddLog(client, message);
                    entry.Key.CharacterInfo.AddRankpoints(client, rpReceive);
                    entry.Key.CharacterInfo.AddPvpPoints(client, pvpReceive);
                    entry.Key.CharacterInfo.AddAssists(client, 1);
                }
            }
        }

        public int CalculatePvpPoints(Session ennemy)
        {
            int amountPvpPoints = this.Attacker.CharacterInfo.KillStrek * 100;
            if (this.Attacker.CharacterInfo.KillStrek == 10)
            {
                MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.Attacker.CurrentMapId);
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "fx|start|RAGE|" + (object)this.Attacker.CharacterInfo.Id));
            }
            if (ennemy.CharacterInfo.KillStrek >= 10)
            {
                amountPvpPoints = 3000;
            }
            else if (this.Attacker.CharacterInfo.KillStrek >= 5 && this.Attacker.CharacterInfo.KillStrek < 10)
            {
                amountPvpPoints = 500;
            }
            else if (this.Attacker.CharacterInfo.KillStrek >= 10)
            {
                amountPvpPoints = 1500;
            }
            if (HappyHour.Enabled)
            {
                amountPvpPoints *= 2;
            }
            if (this.mExtraBooster == "pts")
            {
                amountPvpPoints += (int)(amountPvpPoints * 0.5);
            }
            return amountPvpPoints;
        }

        public void AddAssists(SqlDatabaseClient MySqlClient, int amount)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET kill_assists = kill_assists + " + (object)amount + " WHERE id = @id LIMIT 1");
        }

        public void AddPvpPoints(SqlDatabaseClient MySqlClient, int amount)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users SET pvp_points = pvp_points + " + (object)amount + " WHERE id = @id LIMIT 1");
        }

        public void AddTokens(SqlDatabaseClient MySqlClient, int amount)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users_infos SET tokens = tokens + " + (object)amount + " WHERE id = @id LIMIT 1");
        }

        public void AddTickets(SqlDatabaseClient MySqlClient, int amount)
        {
            MySqlClient.ClearParameters();
            MySqlClient.SetParameter("id", (object)this.mId);
            MySqlClient.ExecuteNonQuery("UPDATE users_infos SET tickets = tickets + " + (object)amount + " WHERE id = @id LIMIT 1");
        }

        public void RemoveRankPoints(Session ennemy, int amount)
        {
            if (ennemy.CharacterInfo.Destroy || this.Attacker == null || this.Attacker.CharacterInfo == null)
                return;
            ennemy.CharacterInfo.Destroy = true;
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                string _Message1 = "You have destroyed " + this.Username + ".";
                this.Attacker.SendData(PacketComposer.Compose("A", "STD|" + _Message1));
                this.Attacker.CharacterInfo.AddLog(client, _Message1);
                this.Attacker.CharacterInfo.RemoveRankPoints(client, amount);
                this.Attacker.SendData(PacketComposer.Compose("A", "STD|You lost " + (object)amount + " rankpoint(s)."));
                string _Message2 = "You have been destroyed by " + WebUtility.HtmlEncode(this.Attacker.CharacterInfo.Username) + ".";
                ennemy.CharacterInfo.AddLog(client, _Message2);
                MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.mAttacker.CurrentMapId);
                if (instanceByMapId != null)
                {
                    string str = this.Username + " has been destroyed by " + this.Attacker.CharacterInfo.Username + ".";
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                }
            }
        }

        public void RemoveBootyKey(int amount)
        {
            this.mBootyKeys -= amount;
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE users SET booty_keys = booty_keys - " + (object)amount + " WHERE id = @id LIMIT 1");
                if (SessionManager.GetSessionById(this.Id) == null)
                    ;
            }
        }

        public void SetTitle(string title)
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.SetParameter("title", (object)title);
                client.ExecuteNonQuery("UPDATE users SET game_title = @title WHERE id = @id LIMIT 1");
            }
        }

        public void AddBoosterReward(string type, int hours)
        {
            int num = hours * 3600;
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                int totalSeconds = (int)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;
                if (type == "npcPoints")
                {
                    if (this.mBoosterNpcTime > totalSeconds)
                        this.mBoosterNpcTime += num;
                    else
                        this.mBoosterNpcTime = totalSeconds + num;
                    client.ExecuteNonQuery("UPDATE users SET booster_npc_time = " + (object)this.mBoosterNpcTime + " WHERE id = @id LIMIT 1");
                }
                else if (type == "shd")
                {
                    if (this.mBoosterShdTime > totalSeconds)
                        this.mBoosterShdTime += num;
                    else
                        this.mBoosterShdTime = totalSeconds + num;
                    client.ExecuteNonQuery("UPDATE users SET booster_shd_time = " + (object)this.mBoosterShdTime + "  WHERE id = @id LIMIT 1");
                }
                else if (type == "dmg")
                {
                    if (this.mBoosterDmgTime > totalSeconds)
                        this.mBoosterDmgTime += num;
                    else
                        this.mBoosterDmgTime = totalSeconds + num;
                    client.ExecuteNonQuery("UPDATE users SET booster_dmg_time = " + (object)this.mBoosterDmgTime + " WHERE id = @id LIMIT 1");
                }
                else if (type == "hp")
                {
                    if (this.mBoosterHpTime > totalSeconds)
                        this.mBoosterHpTime += num;
                    else
                        this.mBoosterHpTime = totalSeconds + num;
                    client.ExecuteNonQuery("UPDATE users SET booster_hp_time = " + (object)this.mBoosterHpTime + " WHERE id = @id LIMIT 1");
                }
                else
                {
                    if (!(type == "spd"))
                        return;
                    if (this.mBoosterSpdTime > totalSeconds)
                        this.mBoosterSpdTime += num;
                    else
                        this.mBoosterSpdTime = totalSeconds + num;
                    client.ExecuteNonQuery("UPDATE users SET booster_spd_time = " + (object)this.mBoosterSpdTime + " WHERE id = @id LIMIT 1");
                }
            }
        }

        public void AddDronePart(int amount = 1)
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE users SET drone_parts = drone_parts + " + (object)amount + " WHERE id = @id LIMIT 1");
            }
        }

        public void AddLogfiles(int amount = 1)
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE users SET logfiles = logfiles + " + (object)amount + " WHERE id = @id LIMIT 1");
            }
        }

        public static string GetResName(long iResId)
        {
            if (iResId == 1L)
                return "prometium";
            if (iResId == 2L)
                return "endurium";
            if (iResId == 3L)
                return "terbium";
            if (iResId == 4L)
                return "xenomit";
            if (iResId == 5L)
                return "palladium";
            if (iResId == 11L)
                return "prometid";
            if (iResId == 12L)
                return "duranium";
            return iResId == 13L ? "promerium" : "error";
        }

        public void AddCargo(long iResId, int iAmount)
        {
            if (iAmount < 0)
            {
                Console.WriteLine(iResId + " = montant negatif: " + iAmount);
                return;
            }
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE player_cargo SET " + CharacterInfo.GetResName(iResId) + " = " + CharacterInfo.GetResName(iResId) + " + " + (object)iAmount + " WHERE id = @id LIMIT 1");
            }
            this.mLabInfos.AddCargo(iResId, iAmount);
        }

        public void RemoveCargo(long iResId, int iAmount)
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE player_cargo SET " + CharacterInfo.GetResName(iResId) + " = " + CharacterInfo.GetResName(iResId) + " - " + (object)iAmount + " WHERE id = @id LIMIT 1");
            }
            this.mLabInfos.RemoveCargo(iResId, iAmount);
        }

        public ServerMessage GetCargoMessage()
        {
            return PacketComposer.Compose("E", this.mLabInfos.Prometium.ToString() + "|" + (object)this.mLabInfos.Endurium + "|" + (object)this.mLabInfos.Terbium + "|" + (object)this.mLabInfos.Xenomit + "|" + (object)this.mLabInfos.Prometid + "|" + (object)this.mLabInfos.Duranium + "|" + (object)this.mLabInfos.Promerium + "|" + (object)0 + "|" + (object)this.mLabInfos.Palladium);
        }

        public ServerMessage GetReffMessage()
        {
            int totalSeconds = (int)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;
            int num1 = this.mLabInfos.Speed[1] - totalSeconds;
            int num2 = num1 <= 60 ? (num1 <= 0 ? 0 : 1) : num1 / 60 + 1;
            int num3 = this.mLabInfos.Shield[1] - totalSeconds;
            int num4 = num3 <= 60 ? (num3 <= 0 ? 0 : 1) : num3 / 60 + 1;
            return PacketComposer.Compose("LAB", "UPD|INFO|LASER|" + (object)this.mLabInfos.Laser[0] + "|" + (object)this.mLabInfos.Laser[1] + "|ROCKET|" + (object)this.mLabInfos.Rocket[0] + "|" + (object)this.mLabInfos.Rocket[1] + "|DRIVING|" + (object)this.mLabInfos.Speed[0] + "|" + (object)num2 + "|SHIELD|" + (object)this.mLabInfos.Shield[0] + "|" + (object)num4);
        }

        public void AddSpeedReff(int iResId, int iAmount)
        {
            int totalSeconds = (int)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;
            if (this.mLabInfos.Speed[0] != iResId)
            {
                this.mLabInfos.Speed[0] = iResId;
                this.mLabInfos.Speed[1] = totalSeconds + 600 * iAmount;
            }
            else if (this.mLabInfos.Speed[1] > totalSeconds)
                this.mLabInfos.Speed[1] += 600 * iAmount;
            else
                this.mLabInfos.Speed[1] = totalSeconds + 600 * iAmount;
            this.mLabInfos.Speed[1] -= 5;
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE player_reff SET speed0 = " + (object)this.mLabInfos.Speed[0] + ", speed1  = " + (object)this.mLabInfos.Speed[1] + " WHERE id = @id LIMIT 1");
            }
        }

        public void AddShieldReff(int iResId, int iAmount)
        {
            int totalSeconds = (int)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;
            if (this.mLabInfos.Shield[0] != iResId)
            {
                this.mLabInfos.Shield[0] = iResId;
                this.mLabInfos.Shield[1] = totalSeconds + 600 * iAmount;
            }
            else if (this.mLabInfos.Shield[1] > totalSeconds)
                this.mLabInfos.Shield[1] += 600 * iAmount;
            else
                this.mLabInfos.Shield[1] = totalSeconds + 600 * iAmount;
            this.mLabInfos.Shield[1] -= 5;
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE player_reff SET shield0 = " + (object)this.mLabInfos.Shield[0] + ", shield1  = " + (object)this.mLabInfos.Shield[1] + " WHERE id = @id LIMIT 1");
            }
        }

        public void AddLaserReff(int iResId, int iAmount)
        {
            if (this.mLabInfos.Laser[0] != iResId)
            {
                this.mLabInfos.Laser[0] = iResId;
                this.mLabInfos.Laser[1] = iAmount;
            }
            else
                this.mLabInfos.Laser[1] += iAmount;
            this.UpdateLaserReff();
        }

        public void UpdateLaserReff()
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE player_reff SET laser0 = " + (object)this.mLabInfos.Laser[0] + ", laser1  = " + (object)this.mLabInfos.Laser[1] + " WHERE id = @id LIMIT 1");
            }
        }

        public void AddRocketReff(int iResId, int iAmount)
        {
            if (this.mLabInfos.Rocket[0] != iResId)
            {
                this.mLabInfos.Rocket[0] = iResId;
                this.mLabInfos.Rocket[1] = iAmount;
            }
            else
                this.mLabInfos.Rocket[1] += iAmount;
            this.UpdateRocketReff();
        }

        public void UpdateRocketReff()
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE player_reff SET rocket0 = " + (object)this.mLabInfos.Rocket[0] + ", rocket1  = " + (object)this.mLabInfos.Rocket[1] + " WHERE id = @id LIMIT 1");
            }
        }

        public void UpdateLaserRocketReff()
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("id", (object)this.mId);
                client.ExecuteNonQuery("UPDATE player_reff SET laser0 = " + (object)this.mLabInfos.Laser[0] + ", laser1  = " + (object)this.mLabInfos.Laser[1] + ", rocket0  = " + (object)this.mLabInfos.Rocket[0] + ", rocket1  = " + (object)this.mLabInfos.Rocket[1] + " WHERE id = @id LIMIT 1");
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Characters\CharacterInfoLoader.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Characters.CharacterInfoLoader
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Characters
{
  public static class CharacterInfoLoader
  {
    private const double CACHE_LIFE_TIME = 300.0;
    private static CDictionnary<int, CharacterInfo> mCharacterInfoCache;
    private static Timer mCacheMonitor;

    public static void Initialize()
    {
      CharacterInfoLoader.mCharacterInfoCache = new CDictionnary<int, CharacterInfo>();
      CharacterInfoLoader.mCacheMonitor = new Timer(new TimerCallback(CharacterInfoLoader.MonitorCache), (object) null, TimeSpan.FromSeconds(30.0), TimeSpan.FromSeconds(30.0));
    }

    private static void MonitorCache(object state)
    {
      lock (CharacterInfoLoader.mCharacterInfoCache)
      {
        CList<int> local_0 = new CList<int>();
        foreach (CharacterInfo item_0 in (IEnumerable<CharacterInfo>) CharacterInfoLoader.mCharacterInfoCache.Values)
        {
          if (SessionManager.ContainsCharacterId(item_0.Id) || item_0.CacheAge >= 300.0)
            local_0.Add(item_0.Id);
        }
        foreach (int item_1 in (IEnumerable<int>) local_0.Keys)
          CharacterInfoLoader.mCharacterInfoCache.Remove(item_1);
      }
    }

    private static CharacterInfo TryGetInfoFromCache(int CharacterId)
    {
      lock (CharacterInfoLoader.mCharacterInfoCache)
      {
        if (CharacterInfoLoader.mCharacterInfoCache.ContainsKey(CharacterId))
          return CharacterInfoLoader.mCharacterInfoCache[CharacterId];
      }
      return (CharacterInfo) null;
    }

        public static CharacterInfo GetCharacterInfo(SqlDatabaseClient MySqlClient, int CharacterId, int LinkedClientId, string Ticket, bool IgnoreCache)
    {
      if (SessionManager.ContainsCharacterIdCache(CharacterId))
      {
        Session characterIdCache = SessionManager.GetSessionByCharacterIdCache(CharacterId);
        if (characterIdCache != null)
          return characterIdCache.CharacterInfo;
        return (CharacterInfo) null;
      }
      if (!IgnoreCache)
      {
        CharacterInfo infoFromCache = CharacterInfoLoader.TryGetInfoFromCache(CharacterId);
        if (infoFromCache != null)
          return infoFromCache;
      }
      return CharacterInfoLoader.GenerateCharacterInfo(MySqlClient, CharacterId, LinkedClientId, Ticket);
    }

    public static CharacterInfo GenerateCharacterInfo(SqlDatabaseClient MySqlClient, int CharacterId, int LinkedClientId, string Ticket)
    {
      return new CharacterInfo(MySqlClient, LinkedClientId, CharacterId, Ticket);
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Characters\Settings.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Characters.Settings
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Game.Characters
{
  public class Settings
  {
    private int mPlayerId;
    private string mSet;
    private string mMinimapScale;
    private string mResizableWindows;
    private int mDisplayPlayerNames;
    private int mDisplayChat;
    private int mPlayMusic;
    private int mPlaySfx;
    private string mBarStatus;
    private string mWindowSettings;
    private string mClientResolution;
    private int mAutoRefinement;
    private int mQuickSlotStopAttack;
    private int mDoubleClickAttack;
    private int mAutoStart;
    private int mDisplayNotification;
    private int mShowDrones;
    private int mDisplayWindowBackground;
    private int mAlwaysDraggableWindows;
    private int mPreloadUserShips;
    private int mQualityPresseting;
    private int mQualityCustomized;
    private int mQualityBackground;
    private int mQualityPoizone;
    private int mQualityShip;
    private int mQualityEngine;
    private int mQualityCollectable;
    private int mQualityAttack;
    private int mQualityEffect;
    private int mQualityExplosion;
    private string mQuickbarSlot;
    private string mMainmenuPosition;
    private string mSlotmenuPosition;
    private string mSlotmenuOrder;

    public int PlayerId
    {
      get
      {
        return this.mPlayerId;
      }
    }

    public string Set
    {
      get
      {
        return this.mSet;
      }
    }

    public string MinimapScale
    {
      get
      {
        return this.mMinimapScale;
      }
    }

    public string ResizableWindows
    {
      get
      {
        return this.mResizableWindows;
      }
    }

    public int DisplayPlayerNames
    {
      get
      {
        return this.mDisplayPlayerNames;
      }
    }

    public int DisplayChat
    {
      get
      {
        return this.mDisplayChat;
      }
    }

    public int PlayMusic
    {
      get
      {
        return this.mPlayMusic;
      }
    }

    public int PlaySfx
    {
      get
      {
        return this.mPlaySfx;
      }
    }

    public string BarStatus
    {
      get
      {
        return this.mBarStatus;
      }
    }

    public string WindowSettings
    {
      get
      {
        return this.mWindowSettings;
      }
    }

    public string ClientResolution
    {
      get
      {
        return this.mClientResolution;
      }
    }

    public int AutoRefinement
    {
      get
      {
        return this.mAutoRefinement;
      }
    }

    public int QuickSlotStopAttack
    {
      get
      {
        return this.mQuickSlotStopAttack;
      }
    }

    public int DoubleClickAttack
    {
      get
      {
        return this.mDoubleClickAttack;
      }
    }

    public int AutoStart
    {
      get
      {
        return this.mAutoStart;
      }
    }

    public int DisplayNotification
    {
      get
      {
        return this.mDisplayNotification;
      }
    }

    public int ShowDrones
    {
      get
      {
        return this.mShowDrones;
      }
    }

    public int DisplayWindowBackground
    {
      get
      {
        return this.mDisplayWindowBackground;
      }
    }

    public int AlwaysDraggableWindows
    {
      get
      {
        return this.mAlwaysDraggableWindows;
      }
    }

    public int PreloadUserShips
    {
      get
      {
        return this.mPreloadUserShips;
      }
    }

    public int QualityPresseting
    {
      get
      {
        return this.mQualityPresseting;
      }
    }

    public int QualityCustomized
    {
      get
      {
        return this.mQualityCustomized;
      }
    }

    public int QualityBackground
    {
      get
      {
        return this.mQualityBackground;
      }
    }

    public int QualityPoizone
    {
      get
      {
        return this.mQualityPoizone;
      }
    }

    public int QualityShip
    {
      get
      {
        return this.mQualityShip;
      }
    }

    public int QualityEngine
    {
      get
      {
        return this.mQualityEngine;
      }
    }

    public int QualityCollectable
    {
      get
      {
        return this.mQualityCollectable;
      }
    }

    public int QualityAttack
    {
      get
      {
        return this.mQualityAttack;
      }
    }

    public int QualityEffect
    {
      get
      {
        return this.mQualityEffect;
      }
    }

    public int QualityExplosion
    {
      get
      {
        return this.mQualityExplosion;
      }
    }

    public string QuickbarSlot
    {
      get
      {
        return this.mQuickbarSlot;
      }
    }

    public string MainmenuPosition
    {
      get
      {
        return this.mMainmenuPosition;
      }
    }

    public string SlotmenuPosition
    {
      get
      {
        return this.mSlotmenuPosition;
      }
    }

    public string SlotmenuOrder
    {
      get
      {
        return this.mSlotmenuOrder;
      }
    }

    public Settings(int PlayerId, string Set, string MinimapScale, string ResizableWindows, int DisplayPlayerNames, int DisplayChat, int PlayMusic, int PlaySfx, string BarStatus, string WindowSettings, string ClientResolution, int AutoRefinement, int QuickSlotStopAttack, int DoubleClickAttack, int AutoStart, int DisplayNotification, int ShowDrones, int DisplayWindowBackground, int AlwaysDraggableWindows, int PreloadUserShips, int QualityPresseting, int QualityCustomized, int QualityBackground, int QualityPoizone, int QualityShip, int QualityEngine, int QualityCollectable, int QualityAttack, int QualityEffect, int QualityExplosion, string QuickbarSlot, string MainmenuPosition, string SlotmenuPosition, string SlotmenuOrder)
    {
      this.mPlayerId = PlayerId;
      this.mSet = Set;
      this.mMinimapScale = MinimapScale;
      this.mResizableWindows = ResizableWindows;
      this.mDisplayPlayerNames = DisplayPlayerNames;
      this.mDisplayChat = DisplayChat;
      this.mPlayMusic = PlayMusic;
      this.mPlaySfx = PlaySfx;
      this.mBarStatus = BarStatus;
      this.mWindowSettings = WindowSettings;
      this.mClientResolution = ClientResolution;
      this.mAutoRefinement = AutoRefinement;
      this.mQuickSlotStopAttack = QuickSlotStopAttack;
      this.mDoubleClickAttack = DoubleClickAttack;
      this.mAutoStart = AutoStart;
      this.mDisplayNotification = DisplayNotification;
      this.mShowDrones = ShowDrones;
      this.mDisplayWindowBackground = DisplayWindowBackground;
      this.mAlwaysDraggableWindows = AlwaysDraggableWindows;
      this.mPreloadUserShips = PreloadUserShips;
      this.mQualityPresseting = QualityPresseting;
      this.mQualityCustomized = QualityCustomized;
      this.mQualityBackground = QualityBackground;
      this.mQualityPoizone = QualityPoizone;
      this.mQualityShip = QualityShip;
      this.mQualityEngine = QualityEngine;
      this.mQualityCollectable = QualityCollectable;
      this.mQualityAttack = QualityAttack;
      this.mQualityEffect = QualityEffect;
      this.mQualityExplosion = QualityExplosion;
      this.mQuickbarSlot = QuickbarSlot;
      this.mMainmenuPosition = MainmenuPosition;
      this.mSlotmenuPosition = SlotmenuPosition;
      this.mSlotmenuOrder = SlotmenuOrder;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Chat\ChatAction.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Sessions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Handlers
{
    static class ChatAction
    {
        // /duel
        public static void AskDuel(string entered, Session Session)
        {
            string[] command = entered.Split(' ');
            if (command.Length < 2)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- Use /duel [name_of_player] .#"));
                return;
            }
            if(TeamDeathMatch.IsActive())
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- Duel are disabled during TDM.#"));
                return;
            }
            if(Session.CharacterInfo.IsBeginner)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- You can't do duel, if you are beginner .#"));
                return;
            }
            double now = UnixTimestamp.GetCurrent();
            if (now - Session.CharacterInfo.LastDuel <= 60.0)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- You did a duel less than 1 min ago.#"));
                return;
            }
            Session user = SessionManager.GetSessionByUsernameChat(command[1].ToLower());
            if (user == null)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- This player doesn't exist, or is offline.#"));
                return;
            }
            if (user.CharacterId == Session.CharacterId)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- You can't invit yourself.#"));
                return;
            }
            if(user.CharacterInfo.IsBeginner)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- You can't invit beginner for duel.#"));
                return;
            }
            if (_1v1.IsOnMap(user.CharacterInfo.MapId))
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- This player is already on duel.#"));
                return;
            }
            if (now - user.CharacterInfo.LastDuel <= 60.0)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- This player did a duel less than 1 min ago.#"));
                return;
            }
            if (Session.CharacterInfo.duelSend.ContainsKey(user.CharacterId) &&
                (UnixTimestamp.GetCurrent() - Session.CharacterInfo.duelSend[user.CharacterId]) <= 120.0)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- You already sent an invitation to this player.#"));
                return;
            }
            Session.CharacterInfo.duelSend.Add(user.CharacterId, UnixTimestamp.GetCurrent());
            user.CharacterInfo.DuelPending = Session.CharacterId;
            user.SendData(PacketComposer.ComposeChat("dq%- You received invitation from " + Session.CharacterInfo.Username + " for a duel.#"));
            user.SendData(PacketComposer.ComposeChat("dq%- /duel_accept to accept the duel.#"));
            Session.SendData(PacketComposer.ComposeChat("dq%- You invited " + command[1] + " for a duel.#"));
        }

        // /duel_accept
        public static void DuelAccept(string entered, Session Session)
        {
            if (TeamDeathMatch.IsActive())
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- Duel are disabled during TDM.#"));
                return;
            }
            if (Session.CharacterInfo.DuelPending == 0)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- You didnt receive any invitation for a duel.#"));
                return;
            }
            if (_1v1.IsOnMap(Session.CharacterInfo.MapId))
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- You are already in a duel.#"));
                return;
            }
            Session user1 = SessionManager.GetSessionByCharacterId(Session.CharacterInfo.DuelPending);
            if (user1 == null || user1.CharacterInfo == null)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- Sender of the duel is probably disconnected.#"));
                Session.CharacterInfo.DuelPending = 0;
                return;
            }
            if (!user1.CharacterInfo.duelSend.ContainsKey(Session.CharacterId)
                || (UnixTimestamp.GetCurrent() - user1.CharacterInfo.duelSend[Session.CharacterId]) >= 120.0)
            {
                Session.SendData(PacketComposer.ComposeChat("dq%- Invitation from " + user1.CharacterInfo.Username + " has expired.#"));
                Session.CharacterInfo.DuelPending = 0;
                user1.CharacterInfo.duelSend.Remove(Session.CharacterId);
                return;
            }
            if (_1v1.canMatch())
            {
                string msgduel = "You accepted duel of " + user1.CharacterInfo.Username + "! Prepare!";
                Session.SendData(PacketComposer.ComposeChat("dq%- " + msgduel + "#"));
                user1.SendData(PacketComposer.Compose("A", "STD|" + Session.CharacterInfo.Username + " accepted your duel! Prepare!"));
                _1v1.initMatch(Session.CharacterId, Session.CharacterInfo.DuelPending);
                user1.CharacterInfo.duelSend.Clear();
                Session.CharacterInfo.DuelPending = 0;
                return;
            }
            Session.SendData(PacketComposer.ComposeChat("dq%- There is no free map actually, wait a while, and retry.#"));
        }

    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Chat\ChatManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Chat.ChatManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using System.Collections.Generic;

namespace OrbitReborn_Emulator.Game.Chat
{
    public static class ChatManager
    {
        private static bool mChatMuted = false;
        private static CList<Session> mGlobalChannel;
        private static CList<Session> mMMOChannel;
        private static CList<Session> mEICChannel;
        private static CList<Session> mVRUChannel;
        private static CList<int> mMutedPlayers;

        public static bool ChatMuted
        {
            get
            {
                return ChatManager.mChatMuted;
            }
            set
            {
                ChatManager.mChatMuted = value;
            }
        }

        public static CList<Session> GlobalChannel
        {
            get
            {
                return ChatManager.mGlobalChannel;
            }
            set
            {
                ChatManager.mGlobalChannel = value;
            }
        }

        public static CList<int> MutedPlayers
        {
            get
            {
                return ChatManager.mMutedPlayers;
            }
            set
            {
                ChatManager.mMutedPlayers = value;
            }
        }

        public static void Initialize()
        {
            ChatManager.mGlobalChannel = new CList<Session>();
            ChatManager.mMMOChannel = new CList<Session>();
            ChatManager.mEICChannel = new CList<Session>();
            ChatManager.mVRUChannel = new CList<Session>();
            ChatManager.mMutedPlayers = new CList<int>();
        }

        public static void AddPlayerToGlobalChannel(Session Session)
        {
            lock (ChatManager.GlobalChannel)
            {
                if (ChatManager.GlobalChannel.Contains(Session))
                    return;
                ChatManager.GlobalChannel.Add(Session);
            }
        }

        public static void RemovePlayerFromGlobalChannel(Session Session)
        {
            lock (ChatManager.GlobalChannel)
            {
                if (!ChatManager.GlobalChannel.Contains(Session))
                    return;
                ChatManager.GlobalChannel.Remove(Session);
            }
        }

        public static void AddPlayerToMMOChannel(Session Session)
        {
            lock (ChatManager.mMMOChannel)
            {
                if (ChatManager.mMMOChannel.Contains(Session))
                    return;
                ChatManager.mMMOChannel.Add(Session);
            }
        }

        public static void RemovePlayerFromMMOChannel(Session Session)
        {
            lock (ChatManager.mMMOChannel)
            {
                if (!ChatManager.mMMOChannel.Contains(Session))
                    return;
                ChatManager.mMMOChannel.Remove(Session);
            }
        }

        public static void AddPlayerToEICChannel(Session Session)
        {
            lock (ChatManager.mEICChannel)
            {
                if (ChatManager.mEICChannel.Contains(Session))
                    return;
                ChatManager.mEICChannel.Add(Session);
            }
        }

        public static void RemovePlayerFromEICChannel(Session Session)
        {
            lock (ChatManager.mEICChannel)
            {
                if (!ChatManager.mEICChannel.Contains(Session))
                    return;
                ChatManager.mEICChannel.Remove(Session);
            }
        }

        public static void AddPlayerToVRUChannel(Session Session)
        {
            lock (ChatManager.mVRUChannel)
            {
                if (ChatManager.mVRUChannel.Contains(Session))
                    return;
                ChatManager.mVRUChannel.Add(Session);
            }
        }

        public static void RemovePlayerFromVRUChannel(Session Session)
        {
            lock (ChatManager.mVRUChannel)
            {
                if (!ChatManager.mVRUChannel.Contains(Session))
                    return;
                ChatManager.mVRUChannel.Remove(Session);
            }
        }

        public static void BroadcastMessage(ServerMessage Message, bool UsersWithRightsOnly = false)
        {
            lock (ChatManager.GlobalChannel)
            {
                foreach (Session item_0 in (IEnumerable<Session>)ChatManager.GlobalChannel.Keys)
                {
                    if (item_0 != null)
                        item_0.SendData(Message);
                }
            }
        }

        public static void BroadcastMessageDifferentForAdmin(ServerMessage MessageNormal, ServerMessage MessageAdmin, bool UsersWithRightsOnly = false)
        {
            lock (ChatManager.GlobalChannel)
            {
                foreach (Session item_0 in (IEnumerable<Session>)ChatManager.GlobalChannel.Keys)
                {
                    if (item_0 != null)
                    {
                        if (item_0.CharacterInfo.IsAdmin)
                            item_0.SendData(MessageAdmin);
                        else
                            item_0.SendData(MessageNormal);
                    }
                }
            }
        }

        public static bool IsMuted(int _Id)
        {
            return ChatManager.mMutedPlayers.Contains(_Id);
        }

        public static void MutePlayer(int _Id)
        {
            lock (ChatManager.mMutedPlayers)
            {
                if (ChatManager.mMutedPlayers.Contains(_Id))
                    return;
                ChatManager.mMutedPlayers.Add(_Id);
            }
        }

        public static void UnmutePlayer(int _Id)
        {
            lock (ChatManager.mMutedPlayers)
            {
                if (!ChatManager.mMutedPlayers.Contains(_Id))
                    return;
                ChatManager.mMutedPlayers.Remove(_Id);
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Event\1v1.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Event
{
    public static class _1v1
    {
        private static int[] mapArray = { 85, 86, 87 };
        private static CDictionnary<int, bool> mapUsed;
        private static CDictionnary<int, int[]> mapsOpponent;
        private static CDictionnary<int, Timer> timerCooldownTp;
        private static CDictionnary<int, Timer> timerCooldownSafeBattle;
        private static CDictionnary<int, Timer> timerMatch;
        private static CDictionnary<int, double> timestampMatch;
        private static CDictionnary<int, bool> safeBattle;


        public static void initialize()
        {
            _1v1.mapUsed = new CDictionnary<int, bool>();
            _1v1.mapsOpponent = new CDictionnary<int, int[]>();
            _1v1.timerCooldownTp = new CDictionnary<int, Timer>();
            _1v1.timerCooldownSafeBattle = new CDictionnary<int, Timer>();
            _1v1.timerMatch = new CDictionnary<int, Timer>();
            _1v1.timestampMatch = new CDictionnary<int, double>();
            _1v1.safeBattle = new CDictionnary<int, bool>();
            foreach (int i in _1v1.mapArray)
            {
                _1v1.mapUsed.Add(i, false);
                _1v1.mapsOpponent.Add(i, null);
                _1v1.timerCooldownTp.Add(i, null);
                _1v1.timerCooldownSafeBattle.Add(i, null);
                _1v1.timerMatch.Add(i, null);
                _1v1.timestampMatch.Add(i, 0);
                _1v1.safeBattle.Add(i, false);
            }
        }

        private static void displayMessage1v1(string msg)
        {
            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
            {
                if (!mapInstance.Unloaded)
                {
                    mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + msg), false);
                }
            }
        }

        public static bool isSafeBattle(int mapId)
        {
            return _1v1.safeBattle[mapId];
        }

        public static bool IsOnMap(int mapid)
        {
            return _1v1.mapArray.Contains(mapid);
        }

        public static bool canMatch()
        {
            foreach (KeyValuePair<int, bool> entry in _1v1.mapUsed)
            {
                if (!entry.Value)
                    return true;
            }
            return false;
        }

        public static int getMap()
        {
            foreach (KeyValuePair<int, bool> entry in _1v1.mapUsed)
            {
                if (!entry.Value)
                    return entry.Key;
            }
            return 0;
        }

        public static void initMatch(int op1, int op2)
        {
            Session session1 = SessionManager.GetSessionByCharacterId(op1);
            Session session2 = SessionManager.GetSessionByCharacterId(op2);

            if (session1 == null || session1.CharacterInfo == null)
                return;
            if (session2 == null || session2.CharacterInfo == null)
                return;

            int map = _1v1.getMap();
            if (map == 0)
                return;

            int[] opArray = { op1, op2 };
            _1v1.mapUsed.Add(map, true);
            _1v1.mapsOpponent.Add(map, opArray);

            _1v1.prepareMatch(map);
        }

        public static void prepareMatch(int map)
        {
            ObjectCooldown obj = new ObjectCooldown(map, 10);
            Timer timer = new Timer(new TimerCallback(_1v1.cooldownTp), (object)obj, 5000, 0);
            _1v1.timerCooldownTp.Add(map, timer);
        }

        private static void cooldownTp(object state)
        {
            ObjectCooldown obj = (ObjectCooldown)state;

            if (obj.time == 0)
            {
                if (_1v1.timerCooldownTp[obj.map] != null)
                    _1v1.timerCooldownTp[obj.map].Dispose();
                _1v1.tpOpponent(obj.map);
                return;
            }
            String msg = "You will be teleport in " + obj.time + " seconds !";
            Session session1 = SessionManager.GetSessionByCharacterId(_1v1.mapsOpponent[obj.map][0]);
            Session session2 = SessionManager.GetSessionByCharacterId(_1v1.mapsOpponent[obj.map][1]);

            if (session1 == null || session2 == null)
            {
                _1v1.clearMap(obj.map);
                return;
            }

            string canTp = _1v1.checkCanTp(session1, session2);
            if (canTp != null)
            {
                session1.SendData(PacketComposer.Compose("A", "STD|" + canTp));
                session2.SendData(PacketComposer.Compose("A", "STD|" + canTp));
                _1v1.clearMap(obj.map);
                return;
            }

            session1.SendData(PacketComposer.Compose("A", "STD|" + msg));
            session2.SendData(PacketComposer.Compose("A", "STD|" + msg));

            obj.time--;

            Timer timer = new Timer(new TimerCallback(_1v1.cooldownTp), (object)obj, 1000, 0);
            _1v1.timerCooldownTp.Add(obj.map, timer);
        }

        private static string checkCanTp(Session session1, Session session2)
        {
            if (session1.CharacterInfo.Attacking || session1.CharacterInfo.Attacked.Count > 0 || (UnixTimestamp.GetCurrent() - session1.CharacterInfo.LastAttackByAttackerReceived) < 60.0)
            {
                return session1.CharacterInfo.Username + " is under attack!";
            }

            if (session2.CharacterInfo.Attacking || session2.CharacterInfo.Attacked.Count > 0 || (UnixTimestamp.GetCurrent() - session2.CharacterInfo.LastAttackByAttackerReceived) < 60.0)
            {
                return session2.CharacterInfo.Username + " is under attack!";
            }
            return null;
        }

        private static void cooldownSafeBattle(object state)
        {
            ObjectCooldown obj = (ObjectCooldown)state;

            Session session1 = SessionManager.GetSessionByCharacterId(_1v1.mapsOpponent[obj.map][0]);
            Session session2 = SessionManager.GetSessionByCharacterId(_1v1.mapsOpponent[obj.map][1]);

            if (session1 == null || session2 == null)
            {
                _1v1.clearMap(obj.map);
                return;
            }

            if (obj.time == 0)
            {
                session1.SendData(PacketComposer.Compose("A", "STD|FIGHT !"));
                session2.SendData(PacketComposer.Compose("A", "STD|FIGHT !"));

                _1v1.safeBattle.Add(obj.map, false);
                if (_1v1.timerCooldownSafeBattle[obj.map] != null)
                    _1v1.timerCooldownSafeBattle[obj.map].Dispose();
                _1v1.timestampMatch.Add(obj.map, UnixTimestamp.GetCurrent());
                Timer timerMatch = new Timer(new TimerCallback(_1v1.Match), (object)obj.map, 0, 5000);
                _1v1.timerMatch.Add(obj.map, timerMatch);
                return;
            }
            String msg = "Fight will begin in " + obj.time + " seconds !";

            session1.SendData(PacketComposer.Compose("A", "STD|" + msg));
            session2.SendData(PacketComposer.Compose("A", "STD|" + msg));

            obj.time--;

            Timer timer = new Timer(new TimerCallback(_1v1.cooldownSafeBattle), (object)obj, 1000, 0);
            _1v1.timerCooldownTp.Add(obj.map, timer);
        }

        public static void tpOpponent(int map)
        {
            Session session1 = SessionManager.GetSessionByCharacterId(_1v1.mapsOpponent[map][0]);
            Session session2 = SessionManager.GetSessionByCharacterId(_1v1.mapsOpponent[map][1]);

            if (session1 == null || session2 == null)
            {
                _1v1.clearMap(map);
                return;
            }

            session1.CharacterInfo.LocX = 8600;
            session1.CharacterInfo.LocY = 6600;
            session1.CharacterInfo.NewLocX = session1.CharacterInfo.LocX;
            session1.CharacterInfo.NewLocY = session1.CharacterInfo.LocY;
            session1.CharacterInfo.PlayerInRange.Clear();
            session1.CharacterInfo.FactionId = 1;

            session2.CharacterInfo.LocX = 12000;
            session2.CharacterInfo.LocY = 6600;
            session2.CharacterInfo.NewLocX = session2.CharacterInfo.LocX;
            session2.CharacterInfo.NewLocY = session2.CharacterInfo.LocY;
            session2.CharacterInfo.PlayerInRange.Clear();
            session2.CharacterInfo.FactionId = 2;

            MapHandler.OpenPublicConnection(session1, map, (PortalInfo)null);
            MapHandler.OpenPublicConnection(session2, map, (PortalInfo)null);

            ObjectCooldown obj = new ObjectCooldown(map, 15);

            Timer timer = new Timer(new TimerCallback(_1v1.cooldownSafeBattle), (object)obj, 0, 0);
            _1v1.timerCooldownSafeBattle.Add(obj.map, timer);
            _1v1.safeBattle.Add(obj.map, true);
        }

        private static void Match(object state)
        {
            int map = (int)state;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(map);
            int num = 0;
            int id = 0;

            if (instanceByMapId == null)
            {
                _1v1.clearMap(map);
                return;
            }

            foreach (MapActor actor in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                num++;
                Session sessionById = SessionManager.GetSessionById(actor.ReferenceSessionId);
                id = sessionById.CharacterId;
            }

            if (_1v1.checkWinner(id, num, map))
            {
                if (_1v1.timerMatch[map] != null)
                    _1v1.timerMatch[map].Dispose();
                _1v1.finishMatch(map);
            }
        }

        private static bool checkWinner(int id, int num, int map)
        {
            if (num <= 0)
            {
                _1v1.sendEquality(map);
                return true;
            }
            if (num == 1)
            {
                _1v1.sendVictory(id, map);
                return true;
            }
            if (UnixTimestamp.GetCurrent() - _1v1.timestampMatch[map] >= 300)
            {
                _1v1.sendEquality(map);
                return true;
            }

            return false;

        }

        private static void sendVictory(int id, int map)
        {
            Session session = SessionManager.GetSessionByCharacterId(id);
            if (session == null)
                return;
            session.SendData(PacketComposer.Compose("A", "STD|You won the duel !"));
            Session sessionLost = null;
            foreach (int idDefeat in _1v1.mapsOpponent[map])
            {
                if (idDefeat != id)
                {
                    sessionLost = _1v1.sendDefeat(idDefeat);
                    break;
                }
            }
            if (session != null && sessionLost != null)
                _1v1.displayMessage1v1(session.CharacterInfo.Username + " won the duel against " + sessionLost.CharacterInfo.Username + " !");

            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                if (session != null && session.CharacterInfo != null)
                    session.CharacterInfo.AddDuelReward(client, 1, 1);
                if (sessionLost != null && sessionLost.CharacterInfo != null)
                    sessionLost.CharacterInfo.AddDuelReward(client, 1, 0);
            }

        }

        public static Session sendDefeat(int id)
        {
            Session session = SessionManager.GetSessionByCharacterId(id);
            if (session == null)
                return null;
            session.SendData(PacketComposer.Compose("A", "STD|You lost the duel ..."));
            return session;
        }

        public static void sendEquality(int map)
        {
            Session session1 = SessionManager.GetSessionByCharacterId(_1v1.mapsOpponent[map][0]);
            Session session2 = SessionManager.GetSessionByCharacterId(_1v1.mapsOpponent[map][0]);

            if (session1 != null)
                session1.SendData(PacketComposer.Compose("A", "STD|Equality !"));
            if (session2 != null)
                session2.SendData(PacketComposer.Compose("A", "STD|Equality !"));

            if (session1 != null && session2 != null)
                _1v1.displayMessage1v1("Equality between " + session1.CharacterInfo.Username + " and " + session2.CharacterInfo.Username + " !");

            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {

                if (session1 != null && session1.CharacterInfo != null)
                    session1.CharacterInfo.AddDuelReward(client, 1, 0);
                if (session2 != null && session2.CharacterInfo != null)
                    session2.CharacterInfo.AddDuelReward(client, 1, 0);
            }

            //TODO + 1 match
        }

        private static void finishMatch(int map)
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(map);

            if (instanceByMapId == null)
            {
                _1v1.clearMap(map);
                return;
            }
            foreach (int id in _1v1.mapsOpponent[map])
            {
                Session session = SessionManager.GetSessionByCharacterId(id);
                if (session != null && session.CharacterInfo != null)
                {
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        session.CharacterInfo.AddLastDuel(client);
                    }
                }
            }
            foreach (MapActor actor in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                Session sessionById = SessionManager.GetSessionById(actor.ReferenceSessionId);
                if (sessionById != null && sessionById.CharacterInfo != null)
                    _1v1.backToBase(sessionById);
            }
            _1v1.clearMap(map);
        }

        private static void backToBase(Session Session)
        {
            Session.CharacterInfo.FactionId = Session.CharacterInfo.RealFaction;
            if (Session.CharacterInfo.FactionId == 1)
            {
                Session.CharacterInfo.LocX = 2000;
                Session.CharacterInfo.LocY = 1100;
                Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
                Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
                Session.CharacterInfo.MapId = 1;
            }
            else if (Session.CharacterInfo.FactionId == 2)
            {
                Session.CharacterInfo.LocX = 18500;
                Session.CharacterInfo.LocY = 1100;
                Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
                Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
                Session.CharacterInfo.MapId = 5;
            }
            else if (Session.CharacterInfo.FactionId == 3)
            {
                Session.CharacterInfo.LocX = 19000;
                Session.CharacterInfo.LocY = 11300;
                Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
                Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
                Session.CharacterInfo.MapId = 9;
            }

            MapHandler.OpenPublicConnection(Session, Session.CharacterInfo.MapId, (PortalInfo)null);
        }

        private static void clearMap(int map)
        {
            _1v1.mapUsed.Add(map, false);
            _1v1.mapsOpponent.Add(map, null);
            if (_1v1.timerCooldownTp[map] != null)
                _1v1.timerCooldownTp[map].Dispose();
            if (_1v1.timerCooldownSafeBattle[map] != null)
                _1v1.timerCooldownSafeBattle[map].Dispose();
            if (_1v1.timerMatch[map] != null)
                _1v1.timerMatch[map].Dispose();
        }
    }

    public class ObjectCooldown
    {
        public int map;
        public int time;

        public ObjectCooldown(int map, int time)
        {
            this.time = time;
            this.map = map;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Event\Invasion.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Event.Invasion
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Npcs;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Event
{
    internal static class Invasion
    {
        private static bool mActive;
        private static bool mSafeBattle;
        private static int mPlayerCount;
        private static int mNpcCount;
        private static int mLevel;
        private static CList<int> IdPlayers;
        private static int mPlayerCountMax;
        private static Timer mPerformUpdate;

        public static bool Active
        {
            get
            {
                return Invasion.mActive;
            }
            set
            {
                Invasion.mActive = value;
            }
        }

        public static bool SafeBattle
        {
            get
            {
                return Invasion.mSafeBattle;
            }
            set
            {
                Invasion.mSafeBattle = value;
            }
        }

        public static int PlayerCount
        {
            get
            {
                return Invasion.mPlayerCount;
            }
            set
            {
                Invasion.mPlayerCount = value;
            }
        }

        public static int NpcCount
        {
            get
            {
                return Invasion.mNpcCount;
            }
            set
            {
                Invasion.mNpcCount = value;
            }
        }

        public static int Level
        {
            get
            {
                return Invasion.mLevel;
            }
            set
            {
                Invasion.mLevel = value;
            }
        }

        public static int PlayerCountMax
        {
            get
            {
                return Invasion.mPlayerCountMax;
            }
            set
            {
                Invasion.mPlayerCountMax = value;
            }
        }

        public static Timer PerformUpdate
        {
            get
            {
                return Invasion.mPerformUpdate;
            }
            set
            {
                Invasion.mPerformUpdate = value;
            }
        }

        public static void Initialize()
        {
            Invasion.Active = false;
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 1");
            }
            Invasion.SafeBattle = false;
            Invasion.PerformUpdate = (Timer)null;
            Invasion.PlayerCount = 0;
            Invasion.IdPlayers = new CList<int>();
        }

        public static void StartInvasion()
        {
            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
            {
                if (!mapInstance.Unloaded)
                {
                    string str = "Invasion Event will start in 20 seconds. Prepare to fight !";
                    mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                }
            }
            Invasion.PerformUpdate = new Timer(new TimerCallback(Invasion.StartCoolDown), (object)10, 10000, 0);
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ExecuteNonQuery("UPDATE event_information SET isActif=1 WHERE id = 1");
            }
        }

        public static bool Join(Session Session)
        {
            // if (Invasion.IdPlayers.Contains(Session.CharacterId) && !Session.CharacterInfo.IsAdmin)
            // return false;
            if (Session.CharacterInfo.MapId == 81)
            {
                Session.SendData(PacketComposer.Compose("A", "STD| You are already on Invasion !"));
                return false;
            }
            ++Invasion.PlayerCountMax;
            Invasion.IdPlayers.Add(Session.CharacterId);
            MapHandler.OpenPublicConnection(Session, 81, (PortalInfo)null);
            return true;
        }

        public static void Allow(int iId)
        {
            if (!Invasion.IdPlayers.Contains(iId))
                return;
            Invasion.IdPlayers.Remove(iId);
        }

        private static void StartCoolDown(object state)
        {
            int num = (int)state;
            if (num == 0)
            {
                Invasion.BeginInvasion();
            }
            else
            {
                foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
                {
                    if (mapInstance != null && !mapInstance.Unloaded)
                    {
                        string str = "Invasion Event will start in " + (object)num + " seconds...";
                        mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                    }
                }
                Invasion.PerformUpdate = new Timer(new TimerCallback(Invasion.StartCoolDown), (object)(num - 1), 1000, 0);
            }
        }

        private static void BeginInvasion()
        {
            Invasion.Active = true;
            Invasion.SafeBattle = true;
            Invasion.PlayerCountMax = 0;
            Invasion.NpcCount = 0;
            Invasion.Level = 0;
            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
            {
                if (mapInstance != null && !mapInstance.Unloaded)
                {
                    foreach (MapActor mapActor in (IEnumerable<MapActor>)mapInstance.Actors.Values)
                    {
                        if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                        {
                            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null)
                            {
                                ++Invasion.PlayerCountMax;
                                Invasion.IdPlayers.Add(sessionById.CharacterId);
                                MapHandler.OpenPublicConnection(sessionById, 81, (PortalInfo)null);
                            }
                        }
                    }
                }
            }
            Invasion.PerformUpdate = new Timer(new TimerCallback(Invasion.SafePeriod), (object)30, 1000, 0);
        }

        private static void SafePeriod(object state)
        {
            int num = (int)state;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(81);
            if (instanceByMapId == null && Invasion.PerformUpdate != null)
            {
                Invasion.PerformUpdate.Dispose();
                Invasion.SafeBattle = false;
                Invasion.Active = false;
                Invasion.PlayerCount = 0;
                using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                {
                    client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 1");
                }
            }
            if (num == 0)
            {
                string str = "Invasion Event begin... Kill them all !";
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                Invasion.PerformUpdate = new Timer(new TimerCallback(Invasion.Monitor), (object)null, 0, 15000);
            }
            else
            {
                if (num < 5 || num % 5 == 0)
                {
                    string str = "Invasion Event will begin in " + (object)num + " seconds...";
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                }
                Invasion.PerformUpdate = new Timer(new TimerCallback(Invasion.SafePeriod), (object)(num - 1), 1000, 0);
            }
        }

        private static void Monitor(object state)
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(81);
            if (instanceByMapId == null && Invasion.PerformUpdate != null)
            {
                Invasion.PerformUpdate.Dispose();
                Invasion.Active = false;
                Invasion.PlayerCount = 0;
                using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                {
                    client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 1");
                }
            }
            Invasion.PlayerCount = 0;
            foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
            {
                if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                {
                    Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                    if (sessionById != null && sessionById.CharacterInfo != null)
                        ++Invasion.PlayerCount;
                }
            }
            if (Invasion.PlayerCount > 0)
            {
                Invasion.NpcCount = 0;
                foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                {
                    if (mapActor.Type == MapActorType.AiBot)
                    {
                        Npc referenceObject = (Npc)instanceByMapId.GetActorByReferenceId(mapActor.ReferenceId, MapActorType.AiBot).ReferenceObject;
                        if (referenceObject != null && !referenceObject.Respawn)
                            ++Invasion.NpcCount;
                    }
                }
                if (Invasion.NpcCount > 0)
                {
                    foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                    {
                        if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                        {
                            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null)
                            {
                                string str = Invasion.PlayerCount.ToString() + " players and " + (object)Invasion.NpcCount + " Invaders left...";
                                sessionById.SendData(PacketComposer.Compose("A", "STD|" + str));
                            }
                        }
                    }
                }
                else if (Invasion.Level == 2)
                {
                    List<string> npc1 = new List<string>()
          {
            "-=[ Super Invader ]=-",
            "2",
            "0",
            "0",
            "155",
            "60000000",
            "60000000",
            "45000000",
            "45000000",
            "320",
            "500000000",
            "800000",
            "0",
            "1",
            "0",
            "",
            "0",
            "0",
            "0",
            "0",
            "7000",
            "65000"
          };
                    List<string> npc2 = new List<string>()
          {
            "-=[ Invader ]=-",
            "2",
            "0",
            "0",
            "148",
            "20000000",
            "20000000",
            "15000000",
            "15000000",
            "300",
            "180000000",
            "200000",
            "0",
            "1",
            "0",
            "",
            "0",
            "0",
            "0",
            "0",
            "2600",
            "55000"
          };
                    List<string> npc3 = new List<string>()
          {
            "-=[ Invader ]=-",
            "2",
            "0",
            "0",
            "149",
            "20000000",
            "20000000",
            "15000000",
            "15000000",
            "300",
            "180000000",
            "200000",
            "0",
            "1",
            "0",
            "",
            "0",
            "0",
            "0",
            "0",
            "2600",
            "55000"
          };
                    NpcAI.CreateNpc(npc1, 81, 3, false);
                    NpcAI.CreateNpc(npc2, 81, 5, false);
                    NpcAI.CreateNpc(npc3, 81, 5, false);
                    foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                    {
                        if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                        {
                            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null)
                            {
                                string str = "Third and final wave of invaders detected !";
                                sessionById.SendData(PacketComposer.Compose("A", "STD|" + str));
                            }
                        }
                    }
                    ++Invasion.Level;
                }
                else if (Invasion.Level == 1)
                {
                    List<string> npc1 = new List<string>()
          {
            "-=[ Fast Invader ]=-",
            "2",
            "0",
            "0",
            "146",
            "10000000",
            "10000000",
            "7000000",
            "7000000",
            "350",
            "90000000",
            "100000",
            "0",
            "1",
            "0",
            "",
            "0",
            "0",
            "0",
            "0",
            "1300",
            "35000"
          };
                    List<string> npc2 = new List<string>()
          {
            "-=[ Invader ]=-",
            "2",
            "0",
            "0",
            "148",
            "20000000",
            "20000000",
            "15000000",
            "15000000",
            "300",
            "180000000",
            "200000",
            "0",
            "1",
            "0",
            "",
            "0",
            "0",
            "0",
            "0",
            "2600",
            "55000"
          };
                    List<string> npc3 = new List<string>()
          {
            "-=[ Invader ]=-",
            "2",
            "0",
            "0",
            "149",
            "20000000",
            "20000000",
            "15000000",
            "15000000",
            "300",
            "180000000",
            "200000",
            "0",
            "1",
            "0",
            "",
            "0",
            "0",
            "0",
            "0",
            "2600",
            "55000"
          };
                    NpcAI.CreateNpc(npc1, 81, 15, false);
                    NpcAI.CreateNpc(npc2, 81, 3, false);
                    NpcAI.CreateNpc(npc3, 81, 3, false);
                    foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                    {
                        if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                        {
                            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null)
                            {
                                string str = "Second wave of invaders detected !";
                                sessionById.SendData(PacketComposer.Compose("A", "STD|" + str));
                            }
                        }
                    }
                    ++Invasion.Level;
                }
                else if (Invasion.Level == 0)
                {
                    List<string> npc = new List<string>()
                      {
                        "-=[ Invader ]=-",
                        "2",
                        "0",
                        "0",
                        "15",
                        "20000000",
                        "20000000",
                        "15000000",
                        "15000000",
                        "300",
                        "180000000",
                        "200000",
                        "0",
                        "1",
                        "0",
                        "",
                        "0",
                        "0",
                        "0",
                        "0",
                        "2600",
                        "55000"
                      };
                                NpcAI.CreateNpc(new List<string>()
                      {
                        "-=[ Fast Invader ]=-",
                        "2",
                        "0",
                        "0",
                        "81",
                        "8000000",
                        "8000000",
                        "5000000",
                        "5000000",
                        "350",
                        "80000000",
                        "80000",
                        "0",
                        "1",
                        "0",
                        "",
                        "0",
                        "0",
                        "0",
                        "0",
                        "1300",
                        "30000"
                      }, 81, 10, false);
                    NpcAI.CreateNpc(npc, 81, 3, false);
                    foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                    {
                        if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                        {
                            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null)
                            {
                                string str = "First wave of invaders detected !";
                                sessionById.SendData(PacketComposer.Compose("A", "STD|" + str));
                            }
                        }
                    }
                    ++Invasion.Level;
                }
                else
                {
                    foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                    {
                        if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                        {
                            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null)
                            {
                                string str = "You won the invasion event !";
                                sessionById.SendData(PacketComposer.Compose("A", "STD|" + str));
                                using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                                {
                                    string _Message = "Congratulations ! You won the invasion event !";
                                    sessionById.SendData(PacketComposer.Compose("A", "STD|" + _Message));
                                    sessionById.CharacterInfo.AddLog(client, _Message);
                                    sessionById.CharacterInfo.AddReward(client, 0, 200000, 0, true);
                                    sessionById.SendData(PacketComposer.Compose("y", "URI|" + (object)200000 + "|" + (object)sessionById.CharacterInfo.Uridium));
                                }
                                if (Invasion.PerformUpdate != null)
                                    Invasion.PerformUpdate.Dispose();
                                MapHandler.OpenPublicConnection(sessionById, 17, (PortalInfo)null);
                            }
                        }
                    }
                    Invasion.Active = false;
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 1");
                    }
                }
            }
            else
            {
                if (Invasion.PerformUpdate != null)
                    Invasion.PerformUpdate.Dispose();
                foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                {
                    if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                    {
                        Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                        if (sessionById != null && sessionById.CharacterInfo != null)
                        {
                            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
                            {
                                if (mapInstance != null && !mapInstance.Unloaded)
                                {
                                    string str = "Invasion Event was lost !";
                                    mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                                }
                            }
                            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                            {
                                client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 1");
                            }
                            Invasion.Active = false;
                            Invasion.PlayerCount = 0;
                            break;
                        }
                    }
                }
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Event\PvPFarming.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Event.PvPFarming
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Npcs;
using OrbitReborn_Emulator.Game.Sessions;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Event
{
  internal static class PvPFarming
  {
    private static bool mActive;
    private static bool mSafeBattle;
    private static int mNpcCount;
    private static Timer mPerformUpdate;

    public static bool Active
    {
      get
      {
        return PvPFarming.mActive;
      }
      set
      {
        PvPFarming.mActive = value;
      }
    }

    public static bool SafeBattle
    {
      get
      {
        return PvPFarming.mSafeBattle;
      }
      set
      {
        PvPFarming.mSafeBattle = value;
      }
    }

    public static int NpcCount
    {
      get
      {
        return PvPFarming.mNpcCount;
      }
      set
      {
        PvPFarming.mNpcCount = value;
      }
    }

    public static Timer PerformUpdate
    {
      get
      {
        return PvPFarming.mPerformUpdate;
      }
      set
      {
        PvPFarming.mPerformUpdate = value;
      }
    }

    public static void Initialize()
    {
      PvPFarming.Active = false;
      PvPFarming.SafeBattle = false;
      PvPFarming.PerformUpdate = (Timer) null;
      PvPFarming.NpcCount = 0;
    }

    public static void StartPvPFarm()
    {
      foreach (MapInstance mapInstance in (IEnumerable<MapInstance>) MapManager.MapInstances.Values)
      {
        if (!mapInstance.Unloaded)
        {
          string str = "PvP Farm Event will start in 20 seconds. Prepare to farm !";
          mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
        }
      }
      PvPFarming.PerformUpdate = new Timer(new TimerCallback(PvPFarming.StartCoolDown), (object) 10, 10000, 0);
    }

    private static void StartCoolDown(object state)
    {
      int num = (int) state;
      if (num == 0)
      {
        PvPFarming.BeginPvPFarm();
      }
      else
      {
        foreach (MapInstance mapInstance in (IEnumerable<MapInstance>) MapManager.MapInstances.Values)
        {
          if (mapInstance != null && !mapInstance.Unloaded)
          {
            string str = "PvP Farm will start in " + (object) num + " seconds...";
            mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
          }
        }
        PvPFarming.PerformUpdate = new Timer(new TimerCallback(PvPFarming.StartCoolDown), (object) (num - 1), 1000, 0);
      }
    }

    private static void BeginPvPFarm()
    {
      PvPFarming.Active = true;
      MapInstance instanceByMapId = MapManager.GetInstanceByMapId(17);
      if (instanceByMapId != null)
      {
        string str = "Invaders detected in PvP map !";
        instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
      }
      List<string> npc1 = new List<string>()
      {
        "-=[ Super Invader ]=-",
        "2",
        "0",
        "0",
        "155",
        "60000000",
        "60000000",
        "45000000",
        "45000000",
        "150",
        "500000000",
        "400000",
        "0",
        "1",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "7000",
        "65000"
      };
      List<string> npc2 = new List<string>()
      {
        "-=[ Invader ]=-",
        "2",
        "0",
        "0",
        "148",
        "20000000",
        "20000000",
        "15000000",
        "15000000",
        "300",
        "180000000",
        "200000",
        "0",
        "1",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "2600",
        "55000"
      };
      NpcAI.CreateNpc(npc1, 17, 3, false);
      NpcAI.CreateNpc(npc2, 17, 9, false);
      PvPFarming.PerformUpdate = new Timer(new TimerCallback(PvPFarming.Monitor), (object) null, 0, 30000);
    }

    private static void Monitor(object state)
    {
      MapInstance instanceByMapId = MapManager.GetInstanceByMapId(17);
      if (instanceByMapId == null && PvPFarming.PerformUpdate != null)
      {
        PvPFarming.PerformUpdate.Dispose();
        PvPFarming.Active = false;
      }
      PvPFarming.NpcCount = 0;
      foreach (MapActor mapActor in (IEnumerable<MapActor>) instanceByMapId.Actors.Values)
      {
        if (mapActor.Type == MapActorType.AiBot)
        {
          Npc referenceObject = (Npc) instanceByMapId.GetActorByReferenceId(mapActor.ReferenceId, MapActorType.AiBot).ReferenceObject;
          if (referenceObject != null && !referenceObject.Respawn)
            ++PvPFarming.NpcCount;
        }
      }
      if (PvPFarming.NpcCount > 0)
      {
        foreach (MapActor mapActor in (IEnumerable<MapActor>) instanceByMapId.Actors.Values)
        {
          if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
          {
            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
            if (sessionById != null && sessionById.CharacterInfo != null)
            {
              string str = PvPFarming.NpcCount.ToString() + " Invaders left...";
              sessionById.SendData(PacketComposer.Compose("A", "STD|" + str));
            }
          }
        }
      }
      else
      {
        if (PvPFarming.PerformUpdate != null)
          PvPFarming.PerformUpdate.Dispose();
        foreach (MapActor mapActor in (IEnumerable<MapActor>) instanceByMapId.Actors.Values)
        {
          if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
          {
            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
            if (sessionById != null && sessionById.CharacterInfo != null)
            {
              foreach (MapInstance mapInstance in (IEnumerable<MapInstance>) MapManager.MapInstances.Values)
              {
                if (mapInstance != null && !mapInstance.Unloaded)
                {
                  string str = "Well played to you all, the Invaders lost !";
                  mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                }
              }
              PvPFarming.Active = false;
              break;
            }
          }
        }
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Event\Spaceball.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Event.Spaceball
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Handlers;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Maps.Collectables;
using OrbitReborn_Emulator.Game.Npcs;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Event
{
    public static class Spaceball
    {
        private static Npc mNpc;
        private static bool mActive;
        private static int mMMOScore;
        private static int mEICScore;
        private static int mVRUScore;
        private static int mMoveToFirm;
        private static int mBallSpeed;
        private static int mLastMoveToFirm;
        private static int mLastBallSpeed;
        private static int mDamageMMO;
        private static int mDamageEIC;
        private static int mDamageVRU;
        private static long mTotalDamageMMO;
        private static long mTotalDamageEIC;
        private static long mTotalDamageVRU;
        private static Timer mPerformUpdate;
        private static Timer mAuto;

        public static void Initialize()
        {
            Spaceball.mNpc = NpcManager.CreateNewInstance("Spaceball", 17, 10500, 5200, 442, 1000, 1000, 1000, 1000, 40, 0, 0, 0, 0, 0, "", 1, 0, 0, 0, 0, 0);
            Spaceball.mActive = false;
            Spaceball.mMMOScore = 0;
            Spaceball.mEICScore = 0;
            Spaceball.mVRUScore = 0;
            Spaceball.mMoveToFirm = 0;
            Spaceball.mBallSpeed = 0;
            Spaceball.mLastMoveToFirm = 0;
            Spaceball.mLastBallSpeed = 0;
            Spaceball.mDamageMMO = 0;
            Spaceball.mDamageEIC = 0;
            Spaceball.mDamageVRU = 0;
            Spaceball.mTotalDamageMMO = 0L;
            Spaceball.mTotalDamageEIC = 0L;
            Spaceball.mTotalDamageVRU = 0L;
            Spaceball.mPerformUpdate = (Timer)null;
            DateTime now = DateTime.Now;
            DateTime dateTime = DateTime.Today;
            dateTime = dateTime.AddHours(20.0);
            double totalMilliseconds = (dateTime.TimeOfDay - now.TimeOfDay).TotalMilliseconds;
            if (totalMilliseconds < 0.0)
                totalMilliseconds += TimeSpan.FromHours(24.0).TotalMilliseconds;
            Spaceball.mAuto = new Timer(new TimerCallback(Spaceball.cbStartSpaceball), (object)null, (long)totalMilliseconds, 0L);
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 3");
            }
        }

        public static void ShowHud(Session Session)
        {
            if (!Spaceball.mActive)
                return;
            Session.SendData(PacketComposer.Compose("n", "ssi|" + (object)Spaceball.mMMOScore + "|" + (object)Spaceball.mEICScore + "|" + (object)Spaceball.mVRUScore + "|" + (object)Spaceball.mBallSpeed + "|" + (object)Spaceball.mMoveToFirm));
        }

        public static void SendHud()
        {
            SessionManager.BroadcastToUser(PacketComposer.Compose("n", "ssi|" + (object)Spaceball.mMMOScore + "|" + (object)Spaceball.mEICScore + "|" + (object)Spaceball.mVRUScore + "|" + (object)Spaceball.mBallSpeed + "|" + (object)Spaceball.mMoveToFirm));
        }

        public static void UpdateHudScore(int FactionId)
        {
            if (FactionId == 1)
                SessionManager.BroadcastToUser(PacketComposer.Compose("n", "ssc|" + (object)FactionId + "|" + (object)Spaceball.mMMOScore));
            if (FactionId == 2)
                SessionManager.BroadcastToUser(PacketComposer.Compose("n", "ssc|" + (object)FactionId + "|" + (object)Spaceball.mEICScore));
            if (FactionId != 3)
                return;
            SessionManager.BroadcastToUser(PacketComposer.Compose("n", "ssc|" + (object)FactionId + "|" + (object)Spaceball.mVRUScore));
        }

        public static void UpdateHudSpeed(int FactionId)
        {
            if (FactionId == 1)
                SessionManager.BroadcastToUser(PacketComposer.Compose("n", "sss|" + (object)FactionId + "|" + (object)Spaceball.mBallSpeed));
            if (FactionId == 2)
                SessionManager.BroadcastToUser(PacketComposer.Compose("n", "sss|" + (object)FactionId + "|" + (object)Spaceball.mBallSpeed));
            if (FactionId == 3)
                SessionManager.BroadcastToUser(PacketComposer.Compose("n", "sss|" + (object)FactionId + "|" + (object)Spaceball.mBallSpeed));
            if (FactionId != 0)
                return;
            SessionManager.BroadcastToUser(PacketComposer.Compose("n", "sss|0|" + (object)Spaceball.mBallSpeed));
        }

        public static void ResetBall()
        {
            Spaceball.mNpc.LocX = -100;
            Spaceball.mNpc.LocY = -100;
            Spaceball.mNpc.NewLocX = -100;
            Spaceball.mNpc.NewLocY = -100;
            if (Spaceball.mNpc.PathFinder != null)
                Spaceball.mNpc.PathFinder.Dispose();
            Spaceball.mNpc.IsMoving = false;
            MapInfo mapInfo = MapInfoLoader.GetMapInfo(17);
            if (!MapManager.InstanceIsLoadedForMap(mapInfo.Id))
                MapManager.TryLoadMapInstance(mapInfo.Id);
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(17);
            if (instanceByMapId != null)
            {
                instanceByMapId.BroadcastMessageInRange(PacketComposer.Compose("K", Spaceball.mNpc.Id.ToString()), Spaceball.mNpc.Id, false);
                foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                {
                    if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                    {
                        Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                        if (sessionById != null && sessionById.CharacterInfo != null && sessionById.CharacterInfo.NpcInRange.Contains(Spaceball.mNpc.Id))
                        {
                            if (sessionById.CharacterInfo.SelectedPlayer == Spaceball.mNpc.Id)
                            {
                                if (sessionById.CharacterInfo.LaserAttackTimer != null)
                                    sessionById.CharacterInfo.LaserAttackTimer.Dispose();
                                if (sessionById.CharacterInfo.LaserAttackCanTimer != null)
                                    sessionById.CharacterInfo.LaserAttackCanTimer.Dispose();
                                sessionById.CharacterInfo.Attacking = false;
                                sessionById.CharacterInfo.CanLaserAttack = false;
                                sessionById.CharacterInfo.SelectedPlayer = 0;
                                sessionById.SendData(PacketComposer.Compose("N", "-1"));
                                sessionById.CharacterInfo.LaserAttackCanTimer = new Timer(new TimerCallback(Fight.CanAttack), (object)sessionById, 1000, 0);
                            }
                            sessionById.CharacterInfo.NpcInRange.Remove(Spaceball.mNpc.Id);
                            sessionById.SendData(PacketComposer.Compose("R", Spaceball.mNpc.Id.ToString()));
                        }
                    }
                }
            }
            Spaceball.mMoveToFirm = 0;
            Spaceball.mBallSpeed = 0;
            Spaceball.mLastMoveToFirm = 0;
            Spaceball.mLastBallSpeed = 0;
            Spaceball.mDamageMMO = 0;
            Spaceball.mDamageEIC = 0;
            Spaceball.mDamageVRU = 0;
            Spaceball.mTotalDamageMMO = 0L;
            Spaceball.mTotalDamageEIC = 0L;
            Spaceball.mTotalDamageVRU = 0L;
            Spaceball.mNpc.LocX = 10500;
            Spaceball.mNpc.LocY = 5200;
            Spaceball.mNpc.NewLocX = 10500;
            Spaceball.mNpc.NewLocY = 5200;
            Spaceball.mNpc.ShipSpeed = 10;
        }

        public static void GiveReward(int FactionId, int amount)
        {
            CList<Session> sessionsUser = SessionManager.SessionsUser;
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                foreach (Session key in (IEnumerable<Session>)sessionsUser.Keys)
                {
                    if (key.CharacterInfo.FactionId == FactionId)
                    {
                        string _Message = "Spaceball reward : + " + (object)amount + " C.";
                        key.CharacterInfo.AddLog(client, _Message);
                        key.CharacterInfo.AddReward(client, amount, 0, 0, true);
                        key.SendData(PacketComposer.Compose("y", "CRE|" + (object)amount + "|" + (object)key.CharacterInfo.Credits));
                    }
                }
            }
        }

        public static void StartSpaceball()
        {
            if (Spaceball.mActive)
                return;
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ExecuteNonQuery("UPDATE event_information SET isActif=1 WHERE id = 3");
            }

            Spaceball.mMMOScore = 0;
            Spaceball.mEICScore = 0;
            Spaceball.mVRUScore = 0;
            Spaceball.ResetBall();
            Spaceball.mActive = true;
            SessionManager.BroadcastToUser(PacketComposer.Compose("n", "ssi|" + (object)Spaceball.mMMOScore + "|" + (object)Spaceball.mEICScore + "|" + (object)Spaceball.mVRUScore + "|" + (object)Spaceball.mBallSpeed + "|" + (object)Spaceball.mMoveToFirm));
            MapInfo mapInfo = MapInfoLoader.GetMapInfo(17);
            if (!MapManager.InstanceIsLoadedForMap(mapInfo.Id))
                MapManager.TryLoadMapInstance(mapInfo.Id);
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(17);
            if (instanceByMapId == null)
                return;
            instanceByMapId.AddNpcToMap(Spaceball.mNpc);
            Spaceball.mPerformUpdate = new Timer(new TimerCallback(Spaceball.PerformUpdate), (object)Spaceball.mNpc, 0, 2000);
        }

        private static void cbStartSpaceball(object state)
        {
            DateTime now = DateTime.Now;
            DateTime dateTime = DateTime.Now;
            dateTime = dateTime.AddHours(20.0);
            double totalMilliseconds = (dateTime.TimeOfDay - now.TimeOfDay).TotalMilliseconds;
            if (totalMilliseconds > 0.0)
            {
                Spaceball.mAuto = new Timer(new TimerCallback(Spaceball.cbStartSpaceball), (object)null, Convert.ToInt64(totalMilliseconds), 0L);
            }
            else
            {
                Spaceball.StartSpaceball();
                Spaceball.mAuto = new Timer(new TimerCallback(Spaceball.cbStopSpaceball), (object)null, Convert.ToInt64(TimeSpan.FromHours(1.0).TotalMilliseconds), 0L);
            }
        }

        public static void StopSpaceball()
        {
            if (Spaceball.mPerformUpdate != null)
                Spaceball.mPerformUpdate.Dispose();
            Spaceball.mActive = false;
            Spaceball.ResetBall();
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(17);
            if (instanceByMapId == null)
                return;
            instanceByMapId.Info.MaxUsers = 0;
            MapActor actorByReferenceId = instanceByMapId.GetActorByReferenceId(Spaceball.mNpc.Id, MapActorType.AiBot);
            if (actorByReferenceId != null)
            {
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("K", actorByReferenceId.Id.ToString()), false);
                instanceByMapId.KickNpc(actorByReferenceId.Id);
            }
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 3");
            }
        }

        private static void cbStopSpaceball(object state)
        {
            Spaceball.StopSpaceball();
            DateTime now = DateTime.Now;
            DateTime dateTime = DateTime.Now;
            dateTime = dateTime.AddHours(20.0);
            double totalMilliseconds = (dateTime.TimeOfDay - now.TimeOfDay).TotalMilliseconds;
            if (totalMilliseconds < 0.0)
                totalMilliseconds += TimeSpan.FromHours(24.0).TotalMilliseconds;
            Spaceball.mAuto = new Timer(new TimerCallback(Spaceball.cbStartSpaceball), (object)null, Convert.ToInt64(totalMilliseconds), 0L);
        }

        public static void DoDamage(int Damage, int FactionId)
        {
            if (FactionId == 1)
            {
                Spaceball.mDamageMMO += Damage;
                Spaceball.mTotalDamageMMO += (long)Damage;
            }
            if (FactionId == 2)
            {
                Spaceball.mDamageEIC += Damage;
                Spaceball.mTotalDamageEIC += (long)Damage;
            }
            if (FactionId != 3)
                return;
            Spaceball.mDamageVRU += Damage;
            Spaceball.mTotalDamageVRU += (long)Damage;
        }

        private static void PerformUpdate(object state)
        {
            if (Spaceball.mNpc == null)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(17);
            if (instanceByMapId == null)
                return;
            if (Spaceball.mDamageMMO == 0 && Spaceball.mDamageEIC == 0 && Spaceball.mDamageVRU == 0)
            {
                if (Spaceball.mNpc.PathFinder != null)
                    Spaceball.mNpc.PathFinder.Dispose();
                NpcAI.TryMoveNpc(Spaceball.mNpc);
                Spaceball.mNpc.NewLocX = Spaceball.mNpc.LocX;
                Spaceball.mNpc.NewLocY = Spaceball.mNpc.LocY;
                Spaceball.mNpc.ShipSpeed = 10;
                Spaceball.mNpc.IsMoving = false;
                if (instanceByMapId != null)
                    instanceByMapId.BroadcastMessageInRange(MapShipMovementComposer.Compose(Spaceball.mNpc.Id, Spaceball.mNpc.NewLocX, Spaceball.mNpc.NewLocY, 0.0), Spaceball.mNpc.Id, false);
                Spaceball.mMoveToFirm = 0;
                Spaceball.mLastMoveToFirm = 0;
                Spaceball.mBallSpeed = 0;
                if (Spaceball.mBallSpeed == Spaceball.mLastBallSpeed)
                    return;
                Spaceball.mNpc.ShipSpeed = 10 + 40 * Spaceball.mBallSpeed;
                Spaceball.UpdateHudSpeed(Spaceball.mMoveToFirm);
                Spaceball.mLastBallSpeed = Spaceball.mBallSpeed;
            }
            else
            {
                int num1 = Spaceball.mDamageMMO;
                int num2 = 1;
                if (Spaceball.mDamageEIC > num1)
                {
                    num1 = Spaceball.mDamageEIC;
                    num2 = 2;
                }
                if (Spaceball.mDamageVRU > num1)
                {
                    num1 = Spaceball.mDamageVRU;
                    num2 = 3;
                }
                Spaceball.mDamageMMO = 0;
                Spaceball.mDamageEIC = 0;
                Spaceball.mDamageVRU = 0;
                Spaceball.mMoveToFirm = num2;
                if (Spaceball.mMoveToFirm == 1 && Math.Sqrt(Math.Pow((double)(Spaceball.mNpc.LocX - 6000), 2.0) + Math.Pow((double)(Spaceball.mNpc.LocY - 2500), 2.0)) < 50.0)
                    Spaceball.SpaceBallReward();
                if (Spaceball.mMoveToFirm == 2 && Math.Sqrt(Math.Pow((double)(Spaceball.mNpc.LocX - 15000), 2.0) + Math.Pow((double)(Spaceball.mNpc.LocY - 2500), 2.0)) < 50.0)
                    Spaceball.SpaceBallReward();
                if (Spaceball.mMoveToFirm == 3 && Math.Sqrt(Math.Pow((double)(Spaceball.mNpc.LocX - 10500), 2.0) + Math.Pow((double)(Spaceball.mNpc.LocY - 10000), 2.0)) < 50.0)
                    Spaceball.SpaceBallReward();
                if (num1 > 40000)
                    Spaceball.mBallSpeed = 1;
                if (num1 > 250000)
                    Spaceball.mBallSpeed = 2;
                if (num1 > 500000)
                    Spaceball.mBallSpeed = 3;
                bool flag = false;
                if (Spaceball.mBallSpeed != Spaceball.mLastBallSpeed)
                {
                    Spaceball.mNpc.ShipSpeed = 10 + 40 * Spaceball.mBallSpeed;
                    Spaceball.UpdateHudSpeed(Spaceball.mMoveToFirm);
                    Spaceball.mLastBallSpeed = Spaceball.mBallSpeed;
                    flag = true;
                }
                if (Spaceball.mMoveToFirm != Spaceball.mLastMoveToFirm)
                {
                    if (Spaceball.mMoveToFirm == 1)
                    {
                        Spaceball.mNpc.NewLocX = 6000;
                        Spaceball.mNpc.NewLocY = 2500;
                    }
                    if (Spaceball.mMoveToFirm == 2)
                    {
                        Spaceball.mNpc.NewLocX = 15000;
                        Spaceball.mNpc.NewLocY = 2500;
                    }
                    if (Spaceball.mMoveToFirm == 3)
                    {
                        Spaceball.mNpc.NewLocX = 10500;
                        Spaceball.mNpc.NewLocY = 10000;
                    }
                    Spaceball.mLastMoveToFirm = Spaceball.mMoveToFirm;
                    flag = true;
                }
                if (!flag)
                    return;
                if (Spaceball.mNpc.PathFinder != null)
                    Spaceball.mNpc.PathFinder.Dispose();
                if (!Spaceball.mNpc.IsMoving)
                    Spaceball.mNpc.LastMove = DateTime.Now;
                NpcAI.TryMoveNpc(Spaceball.mNpc);
                double TimeTaken = Math.Sqrt(Math.Pow((double)(Spaceball.mNpc.LocX - Spaceball.mNpc.NewLocX), 2.0) + Math.Pow((double)(Spaceball.mNpc.LocY - Spaceball.mNpc.NewLocY), 2.0)) / (double)Spaceball.mNpc.ShipSpeed * 1000.0;
                Spaceball.mNpc.IsMoving = true;
                if (instanceByMapId != null)
                    instanceByMapId.BroadcastMessageInRange(MapShipMovementComposer.Compose(Spaceball.mNpc.Id, Spaceball.mNpc.NewLocX, Spaceball.mNpc.NewLocY, TimeTaken), Spaceball.mNpc.Id, false);
                Spaceball.mNpc.PathFinder = new Timer(new TimerCallback(NpcAI.PathFinding), (object)Spaceball.mNpc, 300, 300);
            }
        }

        private static void SpaceBallReward()
        {
            Spaceball.Loot();
            if (Spaceball.mMoveToFirm == 1)
            {
                ++Spaceball.mMMOScore;
                Spaceball.UpdateHudScore(1);
                Spaceball.GiveReward(1, (int)(Spaceball.mTotalDamageMMO / 10L));
            }
            else if (Spaceball.mMoveToFirm == 2)
            {
                ++Spaceball.mEICScore;
                Spaceball.UpdateHudScore(2);
                Spaceball.GiveReward(2, (int)(Spaceball.mTotalDamageEIC / 10L));
            }
            else if (Spaceball.mMoveToFirm == 3)
            {
                ++Spaceball.mVRUScore;
                Spaceball.UpdateHudScore(3);
                Spaceball.GiveReward(3, (int)(Spaceball.mTotalDamageVRU / 10L));
            }
            Spaceball.mDamageMMO = 0;
            Spaceball.mDamageEIC = 0;
            Spaceball.mDamageVRU = 0;
            Spaceball.mTotalDamageMMO = 0L;
            Spaceball.mTotalDamageEIC = 0L;
            Spaceball.mTotalDamageVRU = 0L;
            Spaceball.ResetBall();
        }

        private static void Loot()
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(17);
            if (instanceByMapId == null)
                return;
            int num1 = 0;
            if (Spaceball.mMoveToFirm == 1)
                num1 = (int)(Spaceball.mTotalDamageMMO / 1000000L);
            else if (Spaceball.mMoveToFirm == 2)
                num1 = (int)(Spaceball.mTotalDamageEIC / 1000000L);
            else if (Spaceball.mMoveToFirm == 3)
                num1 = (int)(Spaceball.mTotalDamageVRU / 1000000L);
            int num2 = 0;
            Random random = new Random();
            for (; num2 < num1; ++num2)
            {
                int num3 = num2 - 1000000;
                SpaceballBox spaceballBox = new SpaceballBox(num3, Spaceball.mNpc.LocX + random.Next(-800, 800), Spaceball.mNpc.LocY + random.Next(-500, 500), Spaceball.mNpc.MapId);
                instanceByMapId.Info.Collectables.Add(num3, (Collectable)spaceballBox);
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("c", num3.ToString() + "|" + (object)1 + "|" + (object)spaceballBox.X + "|" + (object)spaceballBox.Y), 0 != 0);
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Event\Survivor.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Event.Survivor
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Event
{
    internal static class Survivor
    {
        private static bool mActive;
        private static bool mSafeBattle;
        private static int mPlayerCount;
        private static int mPlayerCountMax;
        private static Timer mPerformUpdate;

        public static bool Active
        {
            get
            {
                return Survivor.mActive;
            }
            set
            {
                Survivor.mActive = value;
            }
        }

        public static bool SafeBattle
        {
            get
            {
                return Survivor.mSafeBattle;
            }
            set
            {
                Survivor.mSafeBattle = value;
            }
        }

        public static int PlayerCount
        {
            get
            {
                return Survivor.mPlayerCount;
            }
            set
            {
                Survivor.mPlayerCount = value;
            }
        }

        public static int PlayerCountMax
        {
            get
            {
                return Survivor.mPlayerCountMax;
            }
            set
            {
                Survivor.mPlayerCountMax = value;
            }
        }

        public static Timer PerformUpdate
        {
            get
            {
                return Survivor.mPerformUpdate;
            }
            set
            {
                Survivor.mPerformUpdate = value;
            }
        }

        public static void Initialize()
        {
            Survivor.Active = false;
            Survivor.SafeBattle = false;
            Survivor.PerformUpdate = (Timer)null;
            Survivor.PlayerCount = 0;
        }

        public static void StartSurvivor()
        {
            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
            {
                if (!mapInstance.Unloaded)
                {
                    string str = "Survivor Event will start in 20 seconds. Prepare to fight !";
                    mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                }
            }
            Survivor.PerformUpdate = new Timer(new TimerCallback(Survivor.StartCoolDown), (object)10, 10000, 0);
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ExecuteNonQuery("UPDATE event_information SET isActif=1 WHERE id = 2");
            }
        }

        private static void StartCoolDown(object state)
        {
            int num = (int)state;
            if (num == 0)
            {
                Survivor.BeginSurvivor();
            }
            else
            {
                foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
                {
                    if (mapInstance != null && !mapInstance.Unloaded)
                    {
                        string str = "Survivor Event will start in " + (object)num + " seconds...";
                        mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                    }
                }
                Survivor.PerformUpdate = new Timer(new TimerCallback(Survivor.StartCoolDown), (object)(num - 1), 1000, 0);
            }
        }

        private static void BeginSurvivor()
        {
            Survivor.Active = true;
            Survivor.SafeBattle = true;
            Survivor.PlayerCountMax = 0;
            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
            {
                if (mapInstance != null && !mapInstance.Unloaded)
                {
                    foreach (MapActor mapActor in (IEnumerable<MapActor>)mapInstance.Actors.Values)
                    {
                        if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                        {
                            Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null)
                            {
                                ++Survivor.PlayerCountMax;
                                MapHandler.OpenPublicConnection(sessionById, 80, (PortalInfo)null);
                            }
                        }
                    }
                }
            }
            Survivor.PerformUpdate = new Timer(new TimerCallback(Survivor.SafePeriod), (object)30, 1000, 0);
        }

        private static void SafePeriod(object state)
        {
            int num = (int)state;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(80);
            if (instanceByMapId == null && Survivor.PerformUpdate != null)
            {
                Survivor.PerformUpdate.Dispose();
                Survivor.SafeBattle = false;
                Survivor.Active = false;
                Survivor.PlayerCount = 0;
            }
            if (num == 0)
            {
                Survivor.SafeBattle = false;
                string str = "Survivor battle begin... May the best survive !";
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                Survivor.PerformUpdate = new Timer(new TimerCallback(Survivor.Monitor), (object)null, 0, 5000);
            }
            else
            {
                if (num < 5 || num % 5 == 0)
                {
                    string str = "Survivor battle will begin in " + (object)num + " seconds...";
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                }
                Survivor.PerformUpdate = new Timer(new TimerCallback(Survivor.SafePeriod), (object)(num - 1), 1000, 0);
            }
        }

        private static void Monitor(object state)
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(80);
            if (instanceByMapId == null && Survivor.PerformUpdate != null)
            {
                Survivor.PerformUpdate.Dispose();
                Survivor.Active = false;
                Survivor.PlayerCount = 0;
            }
            Survivor.PlayerCount = 0;
            foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
            {
                if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                {
                    Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                    if (sessionById != null && sessionById.CharacterInfo != null)
                        ++Survivor.PlayerCount;
                }
            }
            if (Survivor.PlayerCount > 1)
            {
                foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                {
                    if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                    {
                        Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                        if (sessionById != null && sessionById.CharacterInfo != null)
                        {
                            string str = Survivor.PlayerCount.ToString() + " players left...";
                            sessionById.SendData(PacketComposer.Compose("A", "STD|" + str));
                        }
                    }
                }
            }
            else
            {
                if (Survivor.PerformUpdate != null)
                    Survivor.PerformUpdate.Dispose();
                foreach (MapActor mapActor in (IEnumerable<MapActor>)instanceByMapId.Actors.Values)
                {
                    if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                    {
                        Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                        if (sessionById != null && sessionById.CharacterInfo != null)
                        {
                            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
                            {
                                if (mapInstance != null && !mapInstance.Unloaded)
                                {
                                    string str = "The winner of the survival event is : " + sessionById.CharacterInfo.Username;
                                    mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                                }
                            }
                            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                            {
                                string _Message1 = "Congratulations ! You are the survivor !";
                                sessionById.SendData(PacketComposer.Compose("A", "STD|" + _Message1));
                                sessionById.CharacterInfo.AddLog(client, _Message1);
                                sessionById.CharacterInfo.AddReward(client, 0, 500000, 0, true);
                                sessionById.SendData(PacketComposer.Compose("y", "URI|" + (object)500000 + "|" + (object)sessionById.CharacterInfo.Uridium));
                                string _Message2 = "You received 10.000 Pvp points !";
                                sessionById.SendData(PacketComposer.Compose("A", "STD|" + _Message2));
                                sessionById.CharacterInfo.AddLog(client, _Message2);
                                sessionById.CharacterInfo.AddPvpPoints(client, 10000);
                                int rankpoints = Survivor.PlayerCountMax * 250;
                                sessionById.SendData(PacketComposer.Compose("A", "STD|You received " + (object)rankpoints + " rankpoint(s)."));
                                sessionById.CharacterInfo.AddRankpoints(client, rankpoints);
                                client.ClearParameters();
                                client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 2");
                                client.ExecuteNonQuery("UPDATE event_information SET playerId=" + sessionById.CharacterInfo.Id + " WHERE id = 5");
                                client.ExecuteNonQuery("UPDATE users SET game_title = '' WHERE game_title = 'title_20'");
                                sessionById.CharacterInfo.AddSurvivorWin(client, 1);
                            }
                            sessionById.CharacterInfo.GameTitle = "title_20";
                            sessionById.CharacterInfo.SetTitle("title_20");
                            MapHandler.OpenPublicConnection(sessionById, 17, (PortalInfo)null);
                            Survivor.Active = false;
                            Survivor.PlayerCount = 0;
                            break;
                        }
                    }
                }
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Event\TeamDeathMatch.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Event.TeamDeathMatch
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Event
{
    public class TdmTeam
    {
        private string name;
        private int faction;
        private CList<int> members;

        public TdmTeam(Session creator, string name)
        {
            if (creator != null && creator.CharacterInfo != null)
            {
                this.faction = creator.CharacterInfo.FactionId;
                this.members = new CList<int>();
                this.members.Add(creator.CharacterId);
                this.name = name;
            }
        }

        public CList<int> getMembers()
        {
            return this.members;
        }

        public void addMember(int Member)
        {
            this.members.Add(Member);
        }

        public void removeMember(int member)
        {
            this.members.Remove(member);
        }

        public bool hasMember(int member)
        {
            return this.members.Contains(member);
        }

        public int countMembers()
        {
            return this.members.Count;
        }

        public string getName()
        {
            return this.name;
        }

        public int getFaction()
        {
            return this.faction;
        }

        public void displayChatMessage(string message)
        {
            foreach (int id in (IEnumerable<int>)this.members.Keys)
            {
                Session session = SessionManager.GetSessionByCharacterId(id);
                if (session != null && session.CharacterInfo != null)
                {
                    Output.WriteLine(session.Id);
                    session.SendData(PacketComposer.Compose("A", "STD|" + message));
                }

            }
        }
    }


    public static class TeamDeathMatch
    {
        public static int maxMember = 5;
        private static CDictionnary<string, TdmTeam> teams;
        private static bool mIsActive = false;
        private static Timer performSearching;
        private static Timer cooldown;
        private static Timer performMatch;
        private static TdmTeam Team1;
        private static TdmTeam Team2;
        private static double timeMatch;
        private static bool mSafeBattle = false;
        private static Timer performSearchingMsg;

        public static bool SafeBattle()
        {
            return TeamDeathMatch.mSafeBattle;
        }
        public static string DisplayTeam(string name)
        {
            string msg = "Team name: " + name;
            foreach (int id in (IEnumerable<int>)(TeamDeathMatch.teams[name].getMembers().Keys))
            {
                Session session = SessionManager.GetSessionByCharacterId(id);
                if (session != null && session.CharacterInfo != null)
                    msg = msg + ", " + session.CharacterInfo.Username;
            }
            msg = msg + ". Numbers: " + TeamDeathMatch.teams[name].countMembers();
            return msg;

        }

        private static void displayMessageTdm(string msg)
        {
            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
            {
                if (!mapInstance.Unloaded)
                {
                    mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + msg), false);
                }
            }
        }
        private static void SearchTeam(object state)
        {
            if (!TeamDeathMatch.mIsActive)
            {
                if (TeamDeathMatch.performSearching != null)
                    TeamDeathMatch.performSearching.Dispose();
                return;
            }
            if (TeamDeathMatch.Team1 == null)
                TeamDeathMatch.Team1 = TeamDeathMatch.findTeam(TeamDeathMatch.Team2);
            if (TeamDeathMatch.Team2 == null)
                TeamDeathMatch.Team2 = TeamDeathMatch.findTeam(TeamDeathMatch.Team1);

            TeamDeathMatch.CheckTeamValid();

            if (TeamDeathMatch.Team1 != null && TeamDeathMatch.Team2 != null)
            {
                TeamDeathMatch.PrepareMatch();
                if (TeamDeathMatch.performSearching != null)
                    TeamDeathMatch.performSearching.Dispose();
                if (TeamDeathMatch.performSearchingMsg != null)
                    TeamDeathMatch.performSearchingMsg.Dispose();
            }
        }

        private static void CheckTeamValid()
        {
            if (TeamDeathMatch.Team1 != null)
            {
                CList<int> toRemoveT1 = new CList<int>();
                foreach (int num in Team1.getMembers().Keys)
                {
                    Session sessionByCharId = SessionManager.GetSessionByCharacterId(num);
                    if (sessionByCharId == null || sessionByCharId.CharacterInfo == null)
                    {
                        toRemoveT1.Add(num);
                    }
                }
                foreach (int num in toRemoveT1.Keys)
                    TeamDeathMatch.Team1.removeMember(num);
                toRemoveT1.Clear();
            }
            if (TeamDeathMatch.Team2 != null)
            {
                CList<int> toRemoveT2 = new CList<int>();
                foreach (int num in Team2.getMembers().Keys)
                {
                    Session sessionByCharId = SessionManager.GetSessionByCharacterId(num);
                    if (sessionByCharId == null || sessionByCharId.CharacterInfo == null)
                    {
                        toRemoveT2.Add(num);
                    }
                }
                foreach (int num in toRemoveT2.Keys)
                    TeamDeathMatch.Team2.removeMember(num);
                toRemoveT2.Clear();
            }

            if (TeamDeathMatch.Team1 != null && TeamDeathMatch.Team1.countMembers() != TeamDeathMatch.maxMember)
                TeamDeathMatch.Team1 = null;
            if (TeamDeathMatch.Team2 != null && TeamDeathMatch.Team2.countMembers() != TeamDeathMatch.maxMember)
                TeamDeathMatch.Team2 = null;
        }

        private static void SearchTeamMsg(object state)
        {
            TeamDeathMatch.displayMessageTdm("Searching teams for next match...");
        }

        private static TdmTeam findTeam(TdmTeam oponnent)
        {
            foreach (KeyValuePair<string, TdmTeam> entry in TeamDeathMatch.teams)
            {
                if (entry.Value.countMembers() == TeamDeathMatch.maxMember)
                {
                    if (oponnent == null)
                    {
                        return entry.Value;
                    }
                    else if (oponnent.getName() != entry.Value.getName())
                    {
                        return entry.Value;
                    }
                }
            }

            return null;
        }

        private static void PrepareMatch()
        {
            foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
            {
                if (!mapInstance.Unloaded)
                {
                    string str = "Match: " + TeamDeathMatch.Team1.getName() + " VS " + TeamDeathMatch.Team2.getName() + " will start in 10 sec !";
                    mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                }
            }
            TeamDeathMatch.cooldown = new Timer(new TimerCallback(TeamDeathMatch.StartCoolDown), (object)10, 5000, 0);
        }

        private static void StartCoolDown(object state)
        {
            int num = (int)state;
            if (num == 0)
            {
                TeamDeathMatch.BeginMatch();
            }
            else
            {
                foreach (MapInstance mapInstance in (IEnumerable<MapInstance>)MapManager.MapInstances.Values)
                {
                    if (mapInstance != null && !mapInstance.Unloaded)
                    {
                        string str = (object)num + " seconds left ...";
                        mapInstance.BroadcastMessage(PacketComposer.Compose("A", "STD|" + str), false);
                    }
                }
                TeamDeathMatch.cooldown = new Timer(new TimerCallback(TeamDeathMatch.StartCoolDown), (object)(num - 1), 1000, 0);
            }
        }

        private static void BeginMatch()
        {
            foreach (int id in (IEnumerable<int>)(TeamDeathMatch.Team1.getMembers().Keys))
            {
                Session session = SessionManager.GetSessionByCharacterId(id);
                if (session != null && session.CharacterInfo != null)
                {
                    Session sessionByCharId = SessionManager.GetSessionByCharacterId(session.CharacterId);
                    sessionByCharId.CharacterInfo.LocX = 8600;
                    sessionByCharId.CharacterInfo.LocY = 6600;
                    sessionByCharId.CharacterInfo.NewLocX = sessionByCharId.CharacterInfo.LocX;
                    sessionByCharId.CharacterInfo.NewLocY = sessionByCharId.CharacterInfo.LocY;
                    sessionByCharId.CharacterInfo.PlayerInRange.Clear();
                    sessionByCharId.CharacterInfo.FactionId = 1;
                    sessionByCharId.CharacterInfo.ClanId = 0;
                    MapHandler.OpenPublicConnection(sessionByCharId, 83, (PortalInfo)null);
                }
            }

            foreach (int id in (IEnumerable<int>)TeamDeathMatch.Team2.getMembers().Keys)
            {
                Session session = SessionManager.GetSessionByCharacterId(id);
                if (session != null && session.CharacterInfo != null)
                {
                    Session sessionByCharId = SessionManager.GetSessionByCharacterId(session.CharacterId);
                    sessionByCharId.CharacterInfo.LocX = 12000;
                    sessionByCharId.CharacterInfo.LocY = 6600;
                    sessionByCharId.CharacterInfo.NewLocX = sessionByCharId.CharacterInfo.LocX;
                    sessionByCharId.CharacterInfo.NewLocY = sessionByCharId.CharacterInfo.LocY;
                    sessionByCharId.CharacterInfo.PlayerInRange.Clear();
                    sessionByCharId.CharacterInfo.FactionId = 2;
                    sessionByCharId.CharacterInfo.ClanId = 0;
                    MapHandler.OpenPublicConnection(sessionByCharId, 83, (PortalInfo)null);
                }
            }
            TeamDeathMatch.cooldown = new Timer(new TimerCallback(TeamDeathMatch.StartCoolDownSafe), (object)20, 5000, 0);
            TeamDeathMatch.mSafeBattle = true;
        }

        private static void StartCoolDownSafe(object state)
        {
            int num = (int)state;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(83);
            if (instanceByMapId == null)
            {
                TeamDeathMatch.Disable();
                return;
            }
            if (num == 0)
            {
                TeamDeathMatch.mSafeBattle = false;
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|FIGHT !"), false);
                TeamDeathMatch.timeMatch = UnixTimestamp.GetCurrent();
                TeamDeathMatch.performMatch = new Timer(new TimerCallback(TeamDeathMatch.Match), (object)null, 0, 5000);
            }
            else
            {
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("A", "STD|Fight begin in " + num + " seconds ..."), false);
                TeamDeathMatch.cooldown = new Timer(new TimerCallback(TeamDeathMatch.StartCoolDownSafe), (object)(num - 1), 1000, 0);
            }
        }
        private static void Match(object state)
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(83);
            if (instanceByMapId == null)
            {
                TeamDeathMatch.Disable();
            }
            int nbLeftT1 = 0;
            int nbLeftT2 = 0;
            foreach (MapActor actor in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                Session sessionById = SessionManager.GetSessionById(actor.ReferenceSessionId);
                if (sessionById == null || sessionById.CharacterInfo == null)
                    continue;
                if (TeamDeathMatch.Team1.hasMember(sessionById.CharacterId))
                    nbLeftT1 = nbLeftT1 + 1;
                else if (TeamDeathMatch.Team2.hasMember(sessionById.CharacterId))
                    nbLeftT2 = nbLeftT2 + 1;
            }
            bool finish = TeamDeathMatch.checkWinner(nbLeftT1, nbLeftT2);
            if (finish)
            {
                if (TeamDeathMatch.performMatch != null)
                    TeamDeathMatch.performMatch.Dispose();
                TeamDeathMatch.timeMatch = 0;
            }

        }

        private static bool checkWinner(int nbLeftT1, int nbLeftT2)
        {
            if (nbLeftT1 == 0 && nbLeftT2 > 0)
            {
                TeamDeathMatch.sendVictory(TeamDeathMatch.Team2, TeamDeathMatch.Team1);
                return true;
            }
            else if (nbLeftT1 > 0 && nbLeftT2 == 0)
            {
                TeamDeathMatch.sendVictory(TeamDeathMatch.Team1, TeamDeathMatch.Team2);
                return true;
            }
            else if (nbLeftT1 == 0 && nbLeftT2 == 0)
            {
                TeamDeathMatch.sendEquality();
                return true;
            }
            else if (UnixTimestamp.GetCurrent() - TeamDeathMatch.timeMatch >= 180.0)
            {
                if (nbLeftT1 > nbLeftT2)
                {
                    TeamDeathMatch.sendVictory(TeamDeathMatch.Team1, TeamDeathMatch.Team2);
                    return true;
                }
                else if (nbLeftT1 < nbLeftT2)
                {
                    TeamDeathMatch.sendVictory(TeamDeathMatch.Team2, TeamDeathMatch.Team1);
                    return true;
                }
                else
                {
                    TeamDeathMatch.sendEquality();
                    return true;
                }
            }
            return false;
        }

        private static void sendEquality()
        {
            TeamDeathMatch.BackAll();
            string msg = "Equality between " + TeamDeathMatch.Team1.getName() + " and " + TeamDeathMatch.Team2.getName();
            TeamDeathMatch.displayMessageTdm(msg);
            TeamDeathMatch.finishMatch();
        }

        private static void sendVictory(TdmTeam teamWon, TdmTeam teamLose)
        {
            foreach (int id in (IEnumerable<int>)teamWon.getMembers().Keys)
            {
                Session session = SessionManager.GetSessionByCharacterId(id);
                if (session != null && session.CharacterInfo != null)
                {
                    Session sessionById = SessionManager.GetSessionByCharacterId(session.CharacterId);
                    sessionById.SendData(PacketComposer.Compose("A", "STD|You won the match !"));
                    sessionById.SendData(PacketComposer.Compose("A", "STD|You receive 800 Rankpoints\n You receive 400 PvP Points !"));

                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        sessionById.CharacterInfo.AddTdmMatch(client, 1, 1);
                        sessionById.CharacterInfo.AddPvpPoints(client, 400);
                        sessionById.CharacterInfo.AddRankpoints(client, 800);
                    }
                }
            }
            foreach (int id in (IEnumerable<int>)teamLose.getMembers().Keys)
            {
                Session session = SessionManager.GetSessionByCharacterId(id);
                if (session != null && session.CharacterInfo != null)
                {
                    Session sessionById = SessionManager.GetSessionByCharacterId(session.CharacterId);
                    sessionById.SendData(PacketComposer.Compose("A", "STD|You losed the match ..."));
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        sessionById.CharacterInfo.AddTdmMatch(client, 0, 1);
                    }
                }
            }
            TeamDeathMatch.BackAll();
            TeamDeathMatch.displayMessageTdm(teamWon.getName() + " won against " + teamLose.getName() + " !");
            TeamDeathMatch.finishMatch();
        }

        private static void BackAll()
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(83);
            foreach (MapActor actor in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                Session sessionByCharacterId = SessionManager.GetSessionById(actor.ReferenceSessionId);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null)
                    continue;
                sessionByCharacterId.CharacterInfo.FactionId = sessionByCharacterId.CharacterInfo.RealFaction;
                sessionByCharacterId.CharacterInfo.ClanId = sessionByCharacterId.CharacterInfo.RealClan;
                sessionByCharacterId.CharacterInfo.PlayerInRange.Clear();
                if (sessionByCharacterId.CharacterInfo.FactionId == 1)
                {
                    sessionByCharacterId.CharacterInfo.LocX = 2000;
                    sessionByCharacterId.CharacterInfo.LocY = 1100;
                    sessionByCharacterId.CharacterInfo.NewLocX = sessionByCharacterId.CharacterInfo.LocX;
                    sessionByCharacterId.CharacterInfo.NewLocY = sessionByCharacterId.CharacterInfo.LocY;
                    sessionByCharacterId.CharacterInfo.MapId = 1;
                }
                else if (sessionByCharacterId.CharacterInfo.FactionId == 2)
                {
                    sessionByCharacterId.CharacterInfo.LocX = 18500;
                    sessionByCharacterId.CharacterInfo.LocY = 1100;
                    sessionByCharacterId.CharacterInfo.NewLocX = sessionByCharacterId.CharacterInfo.LocX;
                    sessionByCharacterId.CharacterInfo.NewLocY = sessionByCharacterId.CharacterInfo.LocY;
                    sessionByCharacterId.CharacterInfo.MapId = 5;
                }
                else if (sessionByCharacterId.CharacterInfo.FactionId == 3)
                {
                    sessionByCharacterId.CharacterInfo.LocX = 19000;
                    sessionByCharacterId.CharacterInfo.LocY = 11300;
                    sessionByCharacterId.CharacterInfo.NewLocX = sessionByCharacterId.CharacterInfo.LocX;
                    sessionByCharacterId.CharacterInfo.NewLocY = sessionByCharacterId.CharacterInfo.LocY;
                    sessionByCharacterId.CharacterInfo.MapId = 9;
                }
                MapHandler.OpenPublicConnection(sessionByCharacterId, sessionByCharacterId.CharacterInfo.MapId, (PortalInfo)null);
            }
        }

        private static void finishMatch()
        {
            TeamDeathMatch.teams.Remove(TeamDeathMatch.Team1.getName());
            TeamDeathMatch.teams.Remove(TeamDeathMatch.Team2.getName());
            TeamDeathMatch.Team1 = null;
            TeamDeathMatch.Team2 = null;
            if (TeamDeathMatch.IsActive())
            {
                TeamDeathMatch.performSearching = new System.Threading.Timer(new TimerCallback(TeamDeathMatch.SearchTeam), (object)null, (int)0, 5000);
                TeamDeathMatch.performSearchingMsg = new System.Threading.Timer(new TimerCallback(TeamDeathMatch.SearchTeamMsg), (object)null, (int)0, 15000);
            }
        }

        public static bool IsActive()
        {
            return TeamDeathMatch.mIsActive;
        }

        public static bool CreateNewTeam(string name, Session creator)
        {
            if (TeamDeathMatch.teams.ContainsKey(name))
                return false;
            if (TeamDeathMatch.userTeam(creator) != null)
                return false;
            TeamDeathMatch.teams.Add(name, new TdmTeam(creator, name));
            return true;
        }

        public static string userTeam(Session user)
        {
            foreach (KeyValuePair<string, TdmTeam> entry in TeamDeathMatch.teams)
            {
                if (entry.Value.getMembers().Contains(user.CharacterId))
                {
                    return entry.Value.getName();
                }
            }
            return null;
        }

        public static bool JoinTeam(string name, Session joiner)
        {
            if (!TeamDeathMatch.teams.ContainsKey(name))
                return false;
            if (TeamDeathMatch.teams[name].countMembers() >= TeamDeathMatch.maxMember)
                return false;
            if (TeamDeathMatch.userTeam(joiner) != null)
                return false;
            TeamDeathMatch.teams[name].addMember(joiner.CharacterId);
            TeamDeathMatch.teams[name].displayChatMessage(joiner.CharacterInfo.Username + " joined the team. Number : " + TeamDeathMatch.teams[name].countMembers());
            return true;
        }

        public static bool LeaveTeam(string name, Session leaver)
        {
            if (!TeamDeathMatch.teams.ContainsKey(name))
                return false;
            if (!TeamDeathMatch.teams[name].hasMember(leaver.CharacterId))
                return false;
            TeamDeathMatch.teams[name].removeMember(leaver.CharacterId);
            if (TeamDeathMatch.teams[name].countMembers() <= 0)
                TeamDeathMatch.teams.Remove(name);
            else
                TeamDeathMatch.teams[name].displayChatMessage(leaver.CharacterInfo.Username + " left the team. Number : " + TeamDeathMatch.teams[name].countMembers());
            return true;
        }

        public static void Enable()
        {
            TeamDeathMatch.mIsActive = true;
            TeamDeathMatch.teams = new CDictionnary<string, TdmTeam>();
            if (TeamDeathMatch.performMatch == null)
            {
                TeamDeathMatch.Team1 = null;
                TeamDeathMatch.Team2 = null;
                TeamDeathMatch.performSearching = new System.Threading.Timer(new TimerCallback(TeamDeathMatch.SearchTeam), (object)null, (int)0, 5000);
                TeamDeathMatch.performSearchingMsg = new System.Threading.Timer(new TimerCallback(TeamDeathMatch.SearchTeamMsg), (object)null, (int)0, 15000);
            }
        }

        public static void Disable()
        {
            if (TeamDeathMatch.performSearching != null)
                TeamDeathMatch.performSearching.Dispose();
            if (TeamDeathMatch.performSearchingMsg != null)
                TeamDeathMatch.performSearchingMsg.Dispose();
            TeamDeathMatch.mIsActive = false;
            TeamDeathMatch.teams.Clear();
        }

        public static void removeUserFromTdm(Session Session)
        {
            if (Session == null || Session.CharacterInfo == null)
                return;
            string team = TeamDeathMatch.userTeam(Session);
            if (team == null)
                return;
            TeamDeathMatch.LeaveTeam(team, Session);
        }


    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\AutoEvent.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Misc;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Handlers
{
    class AutoEvent
    {

        private List<Timer> eventTimers;


        AutoEvent()
        {
            this.eventTimers = new List<Timer>();
        }

        public void Initialize()
        {
            List<Event> events = this.loadEvent();
            if (events == null)
            {
                return;
            }
        }

        private List<Timer> createTimersList(List<Event> events)
        {
            List<Timer> timers = new List<Timer>();
            return null; //TODO
        }

        private Timer createTimerbyEvent(Event e)
        {
            DateTime now = DateTime.Now;
            DateTime dateTime = DateTime.Today;
            dateTime = dateTime.AddHours(e.hours);
            double totalMilliseconds = (dateTime.TimeOfDay - now.TimeOfDay).TotalMilliseconds;
            switch (e.type)
            {
                case "hh":
                    return new Timer(new TimerCallback(this.HhTimer), (object)null, (long)totalMilliseconds, 0);
                case "inv":
                    return new Timer(new TimerCallback(this.InvTimer), (object)null, (long)totalMilliseconds, 0);
                default:
                    return null;
            }
        }

        private List<Event> loadEvent()
        {
            int day = this.convertDayToInt(new DateTime().DayOfWeek.ToString());
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("day", day);
                DataRowCollection dataRows = client.ExecuteQueryRows("SELECT * from event WHERE event_day = @day");
                if (dataRows == null)
                {
                    return null;
                }
                List<Event> events = new List<Event>();
                foreach (DataRow data in dataRows)
                {
                    events.Add(new Event((int)data["event_hours"], (string)data["event_type"]));
                }
                return events;
            }
        }

        private int convertDayToInt(string day)
        {
            switch (day.ToLower())
            {
                case "monday":
                    return 1;
                case "tuesday":
                    return 2;
                case "wednesday":
                    return 3;
                case "thursday":
                    return 4;
                case "friday":
                    return 5;
                case "saturday":
                    return 6;
                case "sunday":
                    return 7;
                default: return 0;
            }
        }

        private void InvTimer(object state)
        {
            if (!Invasion.Active)
                Invasion.StartInvasion();

        }

        private void HhTimer(object state)
        {
            HappyHour.Enabled = true;
        }
    }

    class Event
    {
        public int hours;
        public string type;

        public Event(int hours, string type)
        {
            this.hours = hours;
            this.type = type;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\Chat.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Handlers.Chat
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Chat;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Misc;
using OrbitReborn_Emulator.Game.Moderation;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Handlers
{
    public static class Chat
    {
        public static void Initialize()
        {
            DataRouter.RegisterHandler("bu", new ProcessRequestCallback(OrbitReborn_Emulator.Game.Handlers.Chat.ChatInit), true);
            DataRouter.RegisterHandler("bz", new ProcessRequestCallback(OrbitReborn_Emulator.Game.Handlers.Chat.EnterRoom), true);
        }

        private static void EnterRoom(Session Session, ClientMessage Message)
        {
            int nextInt = Message.GetNextInt(2);
            if (!Session.IsChat)
                return;
            if (Session.CharacterInfo.IsMod || Session.CharacterInfo.IsAdmin)
                Session.CurrentChatRoom = nextInt;
            else if (nextInt == 1)
            {
                Session.CurrentChatRoom = 1;
                string str = " <span class='mwLightblue'>Official global chat: <span class='mwCyan'>Respect the rules</span></span>";
                Session.SendData(PacketComposer.ComposeChat("dq%" + str + "#"));
            }
            else if (nextInt == 5 && Session.CharacterInfo.IsAdmin)
            {
                Session.CurrentChatRoom = 5;
            }
            else
            {
                if (nextInt == 2 && Session.CharacterInfo.FactionId == 1)
                    Session.CurrentChatRoom = 2;
                if (nextInt == 3 && Session.CharacterInfo.FactionId == 2)
                    Session.CurrentChatRoom = 3;
                if (nextInt == 4 && Session.CharacterInfo.FactionId == 3)
                    Session.CurrentChatRoom = 4;
                if (nextInt > 100)
                {
                    if (nextInt == Session.CharacterInfo.ClanId + 100)
                        Session.CurrentChatRoom = Session.CharacterInfo.ClanId + 100;
                }
                else
                    Session.CurrentChatRoom = nextInt;
            }
        }

        private static void ChatInit(Session Session, ClientMessage Message)
        {
            Message.GetNextString(2);
            int num = int.Parse(Message.GetNextString(3));
            string nextString = Message.GetNextString(4);
            if (ModerationBanManager.IsUserIdChatBlacklisted(num))
            {
                Output.WriteLine((object)("Login from id " + (object)num + " rejected: banned from the chat."));
                string str = " You are banned from the chat.";
                Session.SendData(PacketComposer.ComposeChat("dq%" + str + "#"));
            }
            else
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(num);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo.AuthTicket != nextString)
                    return;
                Session.IsChat = true;
                Session.CharacterInfo = sessionByCharacterId.CharacterInfo;
                if (!Session.IsChat)
                    return;
                Session.SendData(PacketComposer.ComposeChat("bv%" + (object)Session.CharacterInfo.Id + "#"));
                ChatManager.AddPlayerToGlobalChannel(Session);
                Session.SendData(PacketComposer.ComposeChat("by%1|Global|0|-1#"));
                if (Session.CharacterInfo.IsAdmin)
                {
                    Session.SendData(PacketComposer.ComposeChat("by%5|Whispers|5|-1#"));
                }
                if (Session.CharacterInfo.IsAdmin || Session.CharacterInfo.IsMod)
                {
                    Session.SendData(PacketComposer.ComposeChat("by%2|MMO|1|-1#"));
                    ChatManager.AddPlayerToMMOChannel(Session);
                    Session.SendData(PacketComposer.ComposeChat("by%3|EIC|2|-1#"));
                    ChatManager.AddPlayerToEICChannel(Session);
                    Session.SendData(PacketComposer.ComposeChat("by%4|VRU|3|-1#"));
                    ChatManager.AddPlayerToVRUChannel(Session);
                }
                else
                {
                    Session.SendData(PacketComposer.ComposeChat("by%2|MMO|1|1#"));
                    Session.SendData(PacketComposer.ComposeChat("by%3|EIC|2|2#"));
                    Session.SendData(PacketComposer.ComposeChat("by%4|VRU|3|3#"));
                }
                if (Session.CharacterInfo.ClanId != 0)
                    Session.SendData(PacketComposer.ComposeChat("by%" + (object)(Session.CharacterInfo.ClanId + 100) + "|Clan|" + (object)(Session.CharacterInfo.ClanId + 100) + "|-1#"));
                string str = " <span class='mwLightblue'>Welcome on <span class='mwCyan'>Andromeda</span></span>";
                Session.SendData(PacketComposer.ComposeChat("dq%" + str + "#"));
            }
        }

        public static void SendMessage(Session Session, ClientMessage Message)
        {
            if (ModerationBanManager.IsUserIdChatBlacklisted(Session.CharacterId) || ModerationBanManager.IsUserIdBlacklisted(Session.CharacterId))
                return;
            string nextString = Message.GetNextString(2);
            string str1 = nextString.Split(' ')[0];

            switch (str1)
            {
                case "/disable_pvp":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    PvpManager.PvpEnabled = false;
                    return;
                case "/test":
                    _1v1.initMatch(21147, 1);
                    return;
                case "/enable_pvp":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    PvpManager.PvpEnabled = true;
                    return;
                case "/stop_hh":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        client.ExecuteNonQuery("UPDATE event_information SET isActif=0 WHERE id = 4");
                    }
                    HappyHour.Enabled = false;
                    return;
                case "/start_hh":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        client.ExecuteNonQuery("UPDATE event_information SET isActif=1 WHERE id = 4");
                    }
                    HappyHour.Enabled = true;
                    return;
                case "/duel":
                    ChatAction.AskDuel(nextString, Session);
                    return;
                case "/duel_accept":
                    ChatAction.DuelAccept(nextString, Session);
                    return;
                case "/start_tdm":
                    if (!Session.CharacterInfo.IsAdmin || TeamDeathMatch.IsActive())
                        return;
                    TeamDeathMatch.Enable();
                    return;
                case "/stop_tdm":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    TeamDeathMatch.Disable();
                    return;
                case "/join_team":
                    if (!TeamDeathMatch.IsActive())
                        return;
                    if (nextString.Split(' ').Length < 2)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%- use /join_team nameOfTeam .#"));
                        return;
                    }
                    string msg = "Team doesnt exist or is full, or you are already on a team.";
                    string name = nextString.Split(' ')[1];
                    bool done = TeamDeathMatch.JoinTeam(name, Session);
                    if (done)
                        msg = "You succesfully joined the team.";
                    Session.SendData(PacketComposer.ComposeChat("dq%- " + msg + "#"));
                    return;
                case "/create_team":
                    if (!TeamDeathMatch.IsActive())
                        return;
                    if (nextString.Split(' ').Length < 2)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%- use /create_team nameOfTeam .#"));
                        return;
                    }
                    string msg1 = "Team already exist, or you are already on a team.";
                    string name1 = nextString.Split(' ')[1];
                    bool created = TeamDeathMatch.CreateNewTeam(name1, Session);
                    if (created)
                        msg1 = "You succesfully created the team.";
                    Session.SendData(PacketComposer.ComposeChat("dq%- " + msg1 + "#"));
                    return;
                case "/members_team":
                    if (!TeamDeathMatch.IsActive())
                        return;
                    string teamName = TeamDeathMatch.userTeam(Session);
                    if (teamName == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%- You are not on a team.#"));
                        return;
                    }
                    Session.SendData(PacketComposer.ComposeChat("dq%- " + TeamDeathMatch.DisplayTeam(teamName) + ".#"));
                    return;
                case "/leave_team":
                    if (!TeamDeathMatch.IsActive())
                        return;
                    string teamName1 = TeamDeathMatch.userTeam(Session);
                    if (teamName1 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%- You are not on a team.#"));
                        return;
                    }
                    bool leave = TeamDeathMatch.LeaveTeam(teamName1, Session);
                    if (!leave)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%- Problemn while leaving team, contact admin.#"));
                        return;
                    }
                    Session.SendData(PacketComposer.ComposeChat("dq%- You succesfully left your team.#"));
                    return;
                case "/setmap_maxusers":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    if (nextString.Split(' ').Length <= 2)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%use /setmap_maxusers [mapid] [max users].#"));
                        return;
                    }
                    int MapId = int.Parse(nextString.Split(' ')[1]);
                    int num1 = int.Parse(nextString.Split(' ')[2]);
                    MapInstance instanceByMapId1 = MapManager.GetInstanceByMapId(MapId);
                    if (instanceByMapId1 != null)
                    {
                        instanceByMapId1.Info.MaxUsers = num1;
                        Session.SendData(PacketComposer.ComposeChat("dq% Map limit have been set to " + (object)num1 + ".#"));
                    }
                    else
                        Session.SendData(PacketComposer.ComposeChat("dq% Map is not loaded.#"));
                    return;
                case "/start_spaceball":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Spaceball.StartSpaceball();
                    return;
                case "/stop_spaceball":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Spaceball.StopSpaceball();
                    return;
                case "/start_survivor":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Survivor.StartSurvivor();
                    return;
                case "/start_pvpfarm":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    PvPFarming.StartPvPFarm();
                    return;
                case "/start_invasion":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Invasion.StartInvasion();
                    return;
                case "/join_survivor":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Session sessionByCharacterId4 = SessionManager.GetSessionByCharacterId(Session.CharacterId);
                    if (sessionByCharacterId4 != null)
                        MapHandler.OpenPublicConnection(sessionByCharacterId4, 80, (PortalInfo)null);
                    return;
                case "/invisible":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Session sessionByCharacterId6 = SessionManager.GetSessionByCharacterId(Session.CharacterInfo.Id);
                    sessionByCharacterId6.CharacterInfo.IsInvisibleForAll = true;
                    Session.SendData(PacketComposer.ComposeChat("dq%You are now invisible for everyone !#"));
                    MapInstance instanceByMapId3 = MapManager.GetInstanceByMapId(sessionByCharacterId6.CurrentMapId);
                    if (instanceByMapId3 == null)
                        return;
                    instanceByMapId3.BroadcastMovement(PacketComposer.Compose("R", sessionByCharacterId6.CharacterId.ToString()), sessionByCharacterId6.CharacterId, false);
                    return;
                case "/visible":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Session sessionByCharacterId7 = SessionManager.GetSessionByCharacterId(Session.CharacterInfo.Id);
                    sessionByCharacterId7.CharacterInfo.IsInvisibleForAll = false;
                    Session.SendData(PacketComposer.ComposeChat("dq%You are now visible for everyone !#"));
                    MapInstance instanceByMapId4 = MapManager.GetInstanceByMapId(sessionByCharacterId7.CurrentMapId);
                    if (instanceByMapId4 == null)
                        return;
                    instanceByMapId4.BroadcastMessageUserEnter(sessionByCharacterId7.CharacterInfo);
                    return;
                case "/invisible_npc":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Session.SendData(PacketComposer.ComposeChat("dq%You will not see npc anymore, jump a portal, to apply effect#"));
                    Session.CharacterInfo.DisableNpc = true;
                    Session.CharacterInfo.NpcInRange.Clear();
                    return;
                case "/visible_npc":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Session.SendData(PacketComposer.ComposeChat("dq%Npc are now visible !#"));
                    Session.CharacterInfo.DisableNpc = false;
                    ShipMovement.CheckAliensInRange(Session);
                    return;
                case "/commands":
                    if (!Session.CharacterInfo.IsAdmin && !Session.CharacterInfo.IsMod)
                        return;
                    Session.SendData(PacketComposer.ComposeChat("dq%- /getuserid [username].#"));
                    Session.SendData(PacketComposer.ComposeChat("dq%- /kick [id].#"));
                    Session.SendData(PacketComposer.ComposeChat("dq%- /chatban [id] [time in hours] [reason].#"));
                    if (Session.CharacterInfo.IsAdmin)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%- /ban [id] [time in hours] [reason].#"));
                        Session.SendData(PacketComposer.ComposeChat("dq%- /hp [amount].#"));
                        Session.SendData(PacketComposer.ComposeChat("dq%- /damages [amount].#"));
                        Session.SendData(PacketComposer.ComposeChat("dq%- /speed [amount].#"));
                        Session.SendData(PacketComposer.ComposeChat("dq%- /invisible .#"));
                        Session.SendData(PacketComposer.ComposeChat("dq%- /visible .#"));
                        Session.SendData(PacketComposer.ComposeChat("dq%- /invisible_npc .#"));
                        Session.SendData(PacketComposer.ComposeChat("dq%- /visible_npc .#"));
                    }
                    return;
                case "/getuserid":
                    if (!Session.CharacterInfo.IsAdmin && !Session.CharacterInfo.IsMod)
                        return;
                    if (nextString.Split(' ').Length <= 1)
                        return;
                    Session sessionByUsernameChat2 = SessionManager.GetSessionByUsernameChat(nextString.Split(new char[1]
                    {
            ' '
                    }, 2)[1].ToLower());
                    if (sessionByUsernameChat2 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    Session.SendData(PacketComposer.ComposeChat("dq%" + nextString.Split(new char[1]
                    {
            ' '
                    }, 2)[1] + " id is " + (object)sessionByUsernameChat2.CharacterInfo.Id + ".#"));
                    return;
                case "/chatban":
                    if (!Session.CharacterInfo.IsAdmin && !Session.CharacterInfo.IsMod)
                        return;
                    if (nextString.Split(' ').Length <= 3)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%use /chatban [id] [time in hours] [reason].#"));
                        return;
                    }
                    int num2 = int.Parse(nextString.Split(' ')[1]);
                    double num3 = (double)int.Parse(nextString.Split(' ')[2]);
                    string MessageText1 = nextString.Split(new char[1]
                    {
            ' '
                    }, 4)[3];
                    Session sessionByCharacterId8 = SessionManager.GetSessionByCharacterId(num2);
                    if (sessionByCharacterId8 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    sessionByCharacterId8.SendData(PacketComposer.Compose("A", "STD|\n\n\n\n\n\n\nYou have been banned from the chat by " + Session.CharacterInfo.Username + " for " + (object)num3 + " hours.\nReason : " + MessageText1));
                    Session.SendData(PacketComposer.Compose("A", "STD|\n\n\n\n\n\n\nYou have banned from the chat " + sessionByCharacterId8.CharacterInfo.Username + " for " + (object)num3 + " hours.\nReason : " + MessageText1));
                    sessionByCharacterId8.SendData(PacketComposer.ComposeChat("dq%You have been banned from the chat by " + Session.CharacterInfo.Username + " for " + (object)num3 + " hours.\nReason : " + MessageText1 + ".#"));
                    Session.SendData(PacketComposer.ComposeChat("dq%You have banned from the chat " + sessionByCharacterId8.CharacterInfo.Username + " for " + (object)num3 + " hours.\nReason : " + MessageText1 + ".#"));
                    ChatManager.MutePlayer(sessionByCharacterId8.CharacterInfo.Id);
                    ChatManager.RemovePlayerFromEICChannel(sessionByCharacterId8);
                    ChatManager.RemovePlayerFromMMOChannel(sessionByCharacterId8);
                    ChatManager.RemovePlayerFromVRUChannel(sessionByCharacterId8);
                    ChatManager.RemovePlayerFromGlobalChannel(sessionByCharacterId8);
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        ModerationBanManager.ChatBanUser(client, num2, MessageText1, sessionByCharacterId8.RemoteAddress, Session.CharacterId, num3 * 3600.0);
                        ModerationBanManager.LogModerationAction(client, Session, "Chat banned user", "User '" + sessionByCharacterId8.CharacterInfo.Username + "' (ID " + (object)sessionByCharacterId8.CharacterId + ") for " + (object)num3 + " hours: '" + MessageText1 + "'");
                        return;
                    }
                case "/ban":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    if (nextString.Split(' ').Length <= 3)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%use /ban [id] [time in hours] [reason].#"));
                        return;
                    }
                    int num5 = int.Parse(nextString.Split(' ')[1]);
                    double num6 = (double)int.Parse(nextString.Split(' ')[2]);
                    string MessageText3 = nextString.Split(new char[1]
                    {
            ' '
                    }, 4)[3];
                    Session sessionByCharacterId9 = SessionManager.GetSessionByCharacterId(num5);
                    if (sessionByCharacterId9 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    sessionByCharacterId9.SendData(PacketComposer.Compose("A", "STD|\n\n\n\n\n\n\nYou have been banned by " + Session.CharacterInfo.Username + " for " + (object)num6 + " hours.\nReason : " + MessageText3));
                    Session.SendData(PacketComposer.Compose("A", "STD|\n\n\n\n\n\n\nYou have banned " + sessionByCharacterId9.CharacterInfo.Username + " for " + (object)num6 + " hours.\nReason : " + MessageText3 + ".#"));
                    sessionByCharacterId9.SendData(PacketComposer.ComposeChat("dq%You have been banned by " + Session.CharacterInfo.Username + " for " + (object)num6 + " hours.\nReason : " + MessageText3 + ".#"));
                    Session.SendData(PacketComposer.ComposeChat("dq%You have banned " + sessionByCharacterId9.CharacterInfo.Username + " for " + (object)num6 + " hours.\nReason : " + MessageText3 + ".#"));
                    ChatManager.MutePlayer(sessionByCharacterId9.CharacterInfo.Id);
                    ChatManager.RemovePlayerFromEICChannel(sessionByCharacterId9);
                    ChatManager.RemovePlayerFromMMOChannel(sessionByCharacterId9);
                    ChatManager.RemovePlayerFromVRUChannel(sessionByCharacterId9);
                    ChatManager.RemovePlayerFromGlobalChannel(sessionByCharacterId9);
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        ModerationBanManager.BanUser(client, num5, MessageText3, sessionByCharacterId9.RemoteAddress, Session.CharacterId, num6 * 3600.0);
                        ModerationBanManager.LogModerationAction(client, Session, "Banned user", "User '" + sessionByCharacterId9.CharacterInfo.Username + "' (ID " + (object)sessionByCharacterId9.CharacterId + ") for " + (object)num6 + " hours: '" + MessageText3 + "'");
                    }
                    sessionByCharacterId9.CharacterInfo.Disconnected = true;
                    MapManager.RemoveUserFromMap(sessionByCharacterId9);
                    SessionManager.StopSession(sessionByCharacterId9.Id);
                    return;
                case "/hp":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    if (nextString.Split(' ').Length <= 1)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%use /hp [hp].#"));
                        return;
                    }
                    int newHP = int.Parse(nextString.Split(' ')[1]);
                    Session sessionByCharacterId13 = SessionManager.GetSessionByCharacterId(Session.CharacterId);
                    if (sessionByCharacterId13 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    Session.SendData(PacketComposer.ComposeChat("dq%HP are now set to " + (object)newHP + ".#"));
                    sessionByCharacterId13.CharacterInfo.ShipHp = newHP;
                    sessionByCharacterId13.SendData(PacketComposer.Compose("A", "HL|1|" + (object)sessionByCharacterId13.CharacterInfo.Id + "|HPT|" + (object)sessionByCharacterId13.CharacterInfo.ShipHp + "|" + newHP));
                    return;
                case "/kickPacket":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    if (DataRouter.HasToKick)
                        DataRouter.HasToKick = false;
                    else
                        DataRouter.HasToKick = true;
                    Session.SendData(PacketComposer.Compose("A", "STD|Kick wrong packet : " + DataRouter.HasToKick));
                    break;
                case "/kick":
                    if (!Session.CharacterInfo.IsAdmin && !Session.CharacterInfo.IsMod)
                        return;
                    if (nextString.Split(' ').Length <= 1)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%use /kick [id].#"));
                        return;
                    }
                    Session sessionByCharacterId10 = SessionManager.GetSessionByCharacterId(int.Parse(nextString.Split(' ')[1]));
                    if (sessionByCharacterId10 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    sessionByCharacterId10.SendData(PacketComposer.Compose("A", "STD|\n\n\n\n\n\n\nYou have been kicked by " + Session.CharacterInfo.Username));
                    Session.SendData(PacketComposer.Compose("A", "STD|\n\n\n\n\n\n\nYou have kicked " + sessionByCharacterId10.CharacterInfo.Username));
                    sessionByCharacterId10.SendData(PacketComposer.ComposeChat("dq%You have been kicked by " + Session.CharacterInfo.Username + ".#"));
                    Session.SendData(PacketComposer.ComposeChat("dq%You have kicked " + sessionByCharacterId10.CharacterInfo.Username + ".#"));
                    ChatManager.MutePlayer(sessionByCharacterId10.CharacterInfo.Id);
                    ChatManager.RemovePlayerFromEICChannel(sessionByCharacterId10);
                    ChatManager.RemovePlayerFromMMOChannel(sessionByCharacterId10);
                    ChatManager.RemovePlayerFromVRUChannel(sessionByCharacterId10);
                    ChatManager.RemovePlayerFromGlobalChannel(sessionByCharacterId10);
                    sessionByCharacterId10.CharacterInfo.Disconnected = true;
                    MapManager.RemoveUserFromMap(sessionByCharacterId10);
                    SessionManager.StopSession(sessionByCharacterId10.Id);
                    return;
                case "/members":
                    foreach (int num in Session.CharacterInfo.Members.Keys)
                    {
                        Session sessionMembers1 = SessionManager.GetSessionByCharacterId(num);
                        Session.SendData(PacketComposer.ComposeChat("dq%Your Members are :" + sessionMembers1.CharacterInfo.Id + "  #")); // sending the new member who joined the group the leader if he got invited from somone without leader

                    }
                    return;
                case "/speed":
                    if (!Session.CharacterInfo.IsAdmin && !Session.CharacterInfo.IsMod)
                        return;
                    if (nextString.Split(' ').Length <= 1)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%use /speed [speed].#"));
                        return;
                    }
                    int num8 = int.Parse(nextString.Split(' ')[1]);
                    Session sessionByCharacterId11 = SessionManager.GetSessionByCharacterId(Session.CharacterId);
                    if (sessionByCharacterId11 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    Session.SendData(PacketComposer.ComposeChat("dq%speed is now set to " + (object)num8 + ".#"));
                    sessionByCharacterId11.CharacterInfo.ShipSpeed = num8;
                    sessionByCharacterId11.SendData(PacketComposer.Compose("A", "v|" + (object)sessionByCharacterId11.CharacterInfo.ShipSpeed));
                    return;
                case "/damages":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    if (nextString.Split(' ').Length <= 1)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%use /damages [damages].#"));
                        return;
                    }
                    int num9 = int.Parse(nextString.Split(' ')[1]);
                    Session sessionByCharacterId12 = SessionManager.GetSessionByCharacterId(Session.CharacterId);
                    if (sessionByCharacterId12 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    Session.SendData(PacketComposer.ComposeChat("dq%damages are now set to " + (object)num9 + ".#"));
                    sessionByCharacterId12.CharacterInfo.Config1.MaxDamage = num9;
                    sessionByCharacterId12.CharacterInfo.Config2.MaxDamage = num9;
                    return;
                case "/stop":
                    if (!Session.CharacterInfo.IsAdmin)
                        return;
                    Session.SendData(PacketComposer.ComposeChat("dq%Stopping emulator...#"));
                    Input.mTimer = new Timer(new TimerCallback(Input.StopDelay), (object)10, 1000, 0);
                    return;
                case "/mute":
                    if (!Session.CharacterInfo.IsAdmin && !Session.CharacterInfo.IsMod)
                        return;
                    if (nextString.Split(' ').Length <= 1)
                        return;
                    Session sessionByUsernameChat6 = SessionManager.GetSessionByUsernameChat(nextString.Split(new char[1]
                    {
            ' '
                    }, 2)[1].ToLower());
                    if (sessionByUsernameChat6 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    ChatManager.MutePlayer(sessionByUsernameChat6.CharacterInfo.Id);
                    ChatManager.RemovePlayerFromEICChannel(sessionByUsernameChat6);
                    ChatManager.RemovePlayerFromMMOChannel(sessionByUsernameChat6);
                    ChatManager.RemovePlayerFromVRUChannel(sessionByUsernameChat6);
                    ChatManager.RemovePlayerFromGlobalChannel(sessionByUsernameChat6);
                    sessionByUsernameChat6.SendData(PacketComposer.ComposeChat("dq%You have been muted by " + Session.CharacterInfo.Username + ".#"));
                    Session.SendData(PacketComposer.ComposeChat("dq%You have muted " + sessionByUsernameChat6.CharacterInfo.Username + ".#"));
                    return;
                case "/unmute":
                    if (!Session.CharacterInfo.IsAdmin && !Session.CharacterInfo.IsMod)
                        return;
                    if (nextString.Split(' ').Length <= 1)
                        return;
                    Session sessionByUsernameChat7 = SessionManager.GetSessionByUsernameChat(nextString.Split(new char[1]
                    {
            ' '
                    }, 2)[1].ToLower());
                    if (sessionByUsernameChat7 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    ChatManager.UnmutePlayer(sessionByUsernameChat7.CharacterInfo.Id);
                    ChatManager.AddPlayerToEICChannel(sessionByUsernameChat7);
                    ChatManager.AddPlayerToMMOChannel(sessionByUsernameChat7);
                    ChatManager.AddPlayerToVRUChannel(sessionByUsernameChat7);
                    ChatManager.AddPlayerToGlobalChannel(sessionByUsernameChat7);
                    sessionByUsernameChat7.SendData(PacketComposer.ComposeChat("dq%You have been unmuted by " + Session.CharacterInfo.Username + ".#"));
                    Session.SendData(PacketComposer.ComposeChat("dq%You have unmuted " + sessionByUsernameChat7.CharacterInfo.Username + ".#"));
                    return;
                case "/muteall":
                    if (Session.CharacterInfo.IsAdmin || Session.CharacterInfo.IsMod)
                    {
                        ChatManager.ChatMuted = true;
                        Session.SendData(PacketComposer.ComposeChat("dq%Chat muted.#"));
                        return;
                    }
                    break;
                case "/unmuteall":
                    if (Session.CharacterInfo.IsAdmin || Session.CharacterInfo.IsMod)
                    {
                        ChatManager.ChatMuted = false;
                        Session.SendData(PacketComposer.ComposeChat("dq%Chat unmuted.#"));
                        return;
                    }
                    break;
                case "/users":
                    Session.SendData(PacketComposer.ComposeChat("dq%<span class='admin'>" + (object)SessionManager.ConnectedUserData.Count + " users online</span>.#"));
                    return;
                case "/send":
                    if (Session.CharacterInfo.IsAdmin)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD|~~~ Andromeda ~~~"));
                        Session.SendData(PacketComposer.ComposeChat("dq%<span class='admin'>Packet sent</span>.#"));
                        return;
                    }
                    break;
                case "/w":
                    if (nextString.Split(' ').Length <= 1)
                        return;
                    string str3 = nextString.Split(' ')[1];
                    int num10 = nextString.IndexOf(' ');
                    int num11 = nextString.IndexOf(' ', num10 + 1);
                    string str4 = nextString.Remove(0, num11 + 1);
                    if (Session.CharacterInfo.Username.ToLower() == str3.ToLower())
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%You can't whisper yourself.#"));
                        return;
                    }
                    Session sessionByUsernameChat8 = SessionManager.GetSessionByUsernameChat(str3.ToLower());
                    if (sessionByUsernameChat8 == null)
                    {
                        Session.SendData(PacketComposer.ComposeChat("dq%The user don't exist or is not online.#"));
                        return;
                    }
                    Session.SendData(PacketComposer.ComposeChat("cw%" + sessionByUsernameChat8.CharacterInfo.Username + "@ " + str4 + "#"));
                    sessionByUsernameChat8.SendData(PacketComposer.ComposeChat("cv%" + Session.CharacterInfo.Username + "@ " + str4 + "#"));

                    ChatManager.BroadcastMessage(PacketComposer.ComposeChat("a%" + (object)5 + "@[" + Session.CharacterInfo.Username + " TO " + sessionByUsernameChat8.CharacterInfo.Username + "]@" + str4 + "#"), false);
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        client.ClearParameters();
                        client.SetParameter("whisper", (object)Session.CharacterInfo.Id);
                        client.SetParameter("whispered", (object)sessionByUsernameChat8.CharacterInfo.Id);
                        client.SetParameter("message", (object)str4);
                        client.ExecuteNonQuery("INSERT INTO chat_whispers (id_whisper, message, id_whispered) VALUES (@whisper,@message, @whispered)");
                    }
                    return;
            }
            if (str1.StartsWith("/"))
                Session.SendData(PacketComposer.ComposeChat("dq%The command you entered does not exist.#"));
            else if (Session.CurrentChatRoom == 5)
            {
                return;
            }
            else if (Session.CharacterInfo.IsAdmin || Session.CharacterInfo.IsMod)
            {
                ChatManager.BroadcastMessage(PacketComposer.ComposeChat("j%" + (object)Session.CurrentChatRoom + "@" + Session.CharacterInfo.Username + "@" + nextString + "@3#"), false);
            }
            else
            {
                if (ChatManager.ChatMuted || ChatManager.IsMuted(Session.CharacterInfo.Id))
                    return;
                if (Session.CharacterInfo.ClanTag == "")
                {
                    ServerMessage msgNormal = PacketComposer.ComposeChat("a%" + (object)Session.CurrentChatRoom + "@" + Session.CharacterInfo.Username + "@" + nextString + "#");
                    ServerMessage msgAdmin = PacketComposer.ComposeChat("a%" + (object)Session.CurrentChatRoom + "@" + Session.CharacterInfo.Username + " - " + Session.CharacterId.ToString() + "@" + nextString + "#");
                    ChatManager.BroadcastMessageDifferentForAdmin(msgNormal, msgAdmin, false);
                }
                else
                {
                    ServerMessage msgNormal = PacketComposer.ComposeChat("a%" + (object)Session.CurrentChatRoom + "@" + Session.CharacterInfo.Username + "@" + nextString + "@" + Session.CharacterInfo.ClanTag + "#");
                    ServerMessage msgAdmin = PacketComposer.ComposeChat("a%" + (object)Session.CurrentChatRoom + "@" + Session.CharacterInfo.Username + " - " + Session.CharacterId.ToString() + "@" + nextString + "@" + Session.CharacterInfo.ClanTag + "#");
                    ChatManager.BroadcastMessageDifferentForAdmin(msgNormal, msgAdmin, false);
                }
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\Fight.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Handlers.Fight
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Maps.Collectables;
using OrbitReborn_Emulator.Game.Misc;
using OrbitReborn_Emulator.Game.Npcs;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Net;
using System.Threading;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Handlers
{
    public static class Fight
    {
        static CList<Session> attacked;

        public static void Initialize()
        {
            DataRouter.RegisterHandler("SES", new ProcessRequestCallback(Fight.SelectPlayer), false);
            DataRouter.RegisterHandler("SEL", new ProcessRequestCallback(Fight.SelectPlayerDecoy), false);
            DataRouter.RegisterHandler("u", new ProcessRequestCallback(Fight.SelectAmmo), false);
            DataRouter.RegisterHandler("G", new ProcessRequestCallback(Fight.StopLaserAttack), false);
            DataRouter.RegisterHandler("a", new ProcessRequestCallback(Fight.LaserAttack), true);
            DataRouter.RegisterHandler("v", new ProcessRequestCallback(Fight.RocketAttack), false);
            DataRouter.RegisterHandler("d", new ProcessRequestCallback(Fight.SelectRocket), false);
            DataRouter.RegisterHandler("TX", new ProcessRequestCallback(Fight.Techs), false);
        }

        private static void Techs(Session Session, ClientMessage Message)
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            if (Message.GetNextInt(1) == 4)
            {
                if (Session.CharacterInfo.CoolDownTechSh > 0)
                    return;
                Session.SendData(PacketComposer.Compose("A", "CLD|SBU|" + (object)45));
                Session.CharacterInfo.LastTechSh = UnixTimestamp.GetCurrent();
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("TX", "A|" + (object)0 + "|SBU|" + (object)Session.CharacterId), 0 != 0);
                int num = 75000;
                if (Session.CharacterInfo.ShipShield >= Session.CharacterInfo.ShipMaxShield)
                    return;
                if (Session.CharacterInfo.ShipShield + num > Session.CharacterInfo.ShipMaxShield)
                {
                    num = Session.CharacterInfo.ShipMaxShield - Session.CharacterInfo.ShipShield;
                    Session.CharacterInfo.ShipShield = Session.CharacterInfo.ShipMaxShield;
                }
                else
                    Session.CharacterInfo.ShipShield = Session.CharacterInfo.ShipShield + num;
                Session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|SHD|" + (object)Session.CharacterInfo.ShipShield + "|" + (object)num));
                foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
                {
                    if (key.Type == MapActorType.UserCharacter)
                    {
                        Session sessionById = SessionManager.GetSessionById(key.ReferenceSessionId);
                        if (sessionById != null && sessionById.CharacterInfo.SelectedPlayer == Session.CharacterId)
                            sessionById.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|SHD|" + (object)Session.CharacterInfo.ShipShield + "|" + (object)num));
                    }
                }
            }
            else
            {
                if (Message.GetNextInt(1) != 5 || Session.CharacterInfo.CoolDownTechHp > 0)
                    return;
                Session.SendData(PacketComposer.Compose("A", "CLD|BRB|" + (object)45));
                Session.CharacterInfo.LastTechHp = UnixTimestamp.GetCurrent();
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("TX", "A|" + (object)0 + "|BRB|" + (object)Session.CharacterId), 0 != 0);
                Session.CharacterInfo.BattleRepairCount = 8;
                Session.CharacterInfo.BattleRepairTimer = new System.Threading.Timer(new TimerCallback(Fight.BattleRepairTimer), (object)Session, 0, 1000);
            }
        }

        private static void BattleRepairTimer(object state)
        {
            Session session = (Session)state;
            if (session == null || session.CharacterInfo == null)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(session.CurrentMapId);
            if (instanceByMapId == null)
            {
                if (session.CharacterInfo.BattleRepairTimer == null)
                    return;
                session.CharacterInfo.BattleRepairTimer.Dispose();
            }
            else
            {
                int num = 10000;
                if (session.CharacterInfo.ShipHp < session.CharacterInfo.ShipMaxHp)
                {
                    if (session.CharacterInfo.ShipHp + num > session.CharacterInfo.ShipMaxHp)
                    {
                        num = session.CharacterInfo.ShipMaxHp - session.CharacterInfo.ShipHp;
                        session.CharacterInfo.ShipHp = session.CharacterInfo.ShipMaxHp;
                        instanceByMapId.BroadcastMessage(PacketComposer.Compose("TX", "D|" + (object)0 + "|BRB|" + (object)session.CharacterId), 0 != 0);
                        session.CharacterInfo.BattleRepairTimer.Dispose();
                    }
                    else
                        session.CharacterInfo.ShipHp = session.CharacterInfo.ShipHp + num;
                    session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)session.CharacterInfo.Id + "|HPT|" + (object)session.CharacterInfo.ShipHp + "|" + (object)num));
                    foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
                    {
                        if (key.Type == MapActorType.UserCharacter)
                        {
                            Session sessionById = SessionManager.GetSessionById(key.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null && sessionById.CharacterInfo.SelectedPlayer == session.CharacterId)
                                sessionById.SendData(PacketComposer.Compose("A", "HL|1|" + (object)session.CharacterInfo.Id + "|HPT|" + (object)session.CharacterInfo.ShipHp + "|" + (object)num));
                        }
                    }
                    --session.CharacterInfo.BattleRepairCount;
                    if (session.CharacterInfo.BattleRepairCount != 0)
                        return;
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("TX", "D|" + (object)0 + "|BRB|" + (object)session.CharacterId), 0 != 0);
                    if (session.CharacterInfo.BattleRepairTimer != null)
                        session.CharacterInfo.BattleRepairTimer.Dispose();
                }
                else
                {
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("TX", "D|" + (object)0 + "|BRB|" + (object)session.CharacterId), 0 != 0);
                    if (session.CharacterInfo.BattleRepairTimer != null)
                        session.CharacterInfo.BattleRepairTimer.Dispose();
                }
            }
        }

        private static void SelectPlayerDecoy(Session Session, ClientMessage Message)
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                client.ClearParameters();
                client.SetParameter("player_id", (object)Session.CharacterId);
                client.SetParameter("comment", (object)(WebUtility.HtmlEncode(Session.CharacterInfo.Username) + " : OLD CLIENT"));
                client.ExecuteNonQuery("INSERT INTO `swf_hacker`(`player_id`, `comment`) VALUES (@player_id, @comment)");
            }
            Fight.SelectPlayer(Session, Message);
        }

        private static void SelectPlayer(Session Session, ClientMessage Message)
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            int nextInt = Message.GetNextInt(1);
            if (instanceByMapId.GetActorByReferenceId(nextInt, MapActorType.AiBot) != null)
            {
                if (Session.CharacterInfo.SelectedPlayer != nextInt)
                {
                    if (Session.CharacterInfo.LaserAttackTimer != null)
                        Session.CharacterInfo.LaserAttackTimer.Dispose();
                    Session.CharacterInfo.SelectedPlayer = nextInt;
                    if (Session.CharacterInfo.Attacking)
                    {
                        Fight.StopLaserAttack(Session, Message);
                    }
                }
                Npc referenceObject = (Npc)instanceByMapId.GetActorByReferenceId(nextInt, MapActorType.AiBot).ReferenceObject;
                Session.SendData(PacketComposer.Compose("N", referenceObject.Id.ToString() + "|" + referenceObject.Name + "|" + (object)referenceObject.ShipShield + "|" + (object)referenceObject.ShipMaxShield + "|" + (object)referenceObject.ShipHp + "|" + (object)referenceObject.ShipMaxHp));
                if (referenceObject.Attackers.ContainsKey(Session.CharacterId) || referenceObject.Attackers.Keys.Count == 0)
                    return;
                Session.SendData(PacketComposer.Compose("n", "LSH|" + (object)referenceObject.Id));
            }
            else
            {
                MapActor actorByReferenceId = instanceByMapId.GetActorByReferenceId(nextInt, MapActorType.UserCharacter);
                if (actorByReferenceId == null)
                    return;
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(actorByReferenceId.ReferenceId);
                if (UnixTimestamp.GetCurrent() - sessionByCharacterId.CharacterInfo.LastEMP <= 2.0)
                    return;
                if (Session.CharacterInfo.SelectedPlayer != nextInt)
                {
                    if (Session.CharacterInfo.LaserAttackTimer != null)
                        Session.CharacterInfo.LaserAttackTimer.Dispose();
                    Session.CharacterInfo.SelectedPlayer = nextInt;
                    if (Session.CharacterInfo.Attacking)
                    {
                        Fight.StopLaserAttack(Session, Message);
                    }
                }
                Session.SendData(FightSelectPlayerComposer.Compose(sessionByCharacterId.CharacterInfo));
                if (sessionByCharacterId.CharacterInfo.Attacker != Session && sessionByCharacterId.CharacterInfo.Attacker != null)
                    Session.SendData(PacketComposer.Compose("n", "LSH|" + (object)sessionByCharacterId.CharacterId));
            }
        }

        private static bool PlayerCanAttack(Session Player, Session Ennemy)
        {
            if (_1v1.IsOnMap(Player.CharacterInfo.MapId))
                return _1v1.isSafeBattle(Player.CharacterInfo.MapId) != true;
            if (Player.CharacterInfo.MapId == 83)
                return TeamDeathMatch.SafeBattle() != true;
            if (Ennemy.CharacterInfo.PeaceZone || Player.CharacterInfo.MapId == 80 && Survivor.Active && Survivor.SafeBattle || Player.CharacterInfo.MapId == 81 && Invasion.Active && Invasion.SafeBattle)
                return false;
            if (Player.CharacterInfo.FactionId != Ennemy.CharacterInfo.FactionId || (Player.CharacterInfo.ClanWar.Contains(Ennemy.CharacterInfo.ClanId) || Ennemy.CharacterInfo.ClanWar.Contains(Player.CharacterInfo.ClanId)))
                return true;
            if (Player.CharacterInfo.MapId == 1 || Player.CharacterInfo.MapId == 2)
                return Player.CharacterInfo.FactionId != 1;
            if (Player.CharacterInfo.MapId == 5 || Player.CharacterInfo.MapId == 6)
                return Player.CharacterInfo.FactionId != 2;
            return Player.CharacterInfo.MapId != 9 && Player.CharacterInfo.MapId != 10 || Player.CharacterInfo.FactionId != 3;
        }

        private static void SelectAmmo(Session Session, ClientMessage Message)
        {
            int result;
            if (!int.TryParse(Message.GetNextString(1), out result))
                return;
            if (new CList<int>() { 1, 2, 3, 4, 5, 6 }.Contains(result))
            {
                if (result == 6)
                {
                    double num = DateTime.Now.TimeOfDay.TotalMilliseconds - Session.CharacterInfo.LastRSB75;
                    if (num > 0.0 && num < 3000.0)
                        return;
                    MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
                    if (instanceByMapId == null)
                        return;
                    if (instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.AiBot) != null)
                    {
                        Npc referenceObject = (Npc)instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.AiBot).ReferenceObject;
                        if (Fight.GetDistanceNpc(Session, referenceObject) >= 850.0)
                            return;
                        Fight.AttackNpc(instanceByMapId, Session, referenceObject, result);
                        Session.CharacterInfo.LastRSB75 = DateTime.Now.TimeOfDay.TotalMilliseconds;
                        Session.SendData(PacketComposer.Compose("A", "CLD|RSB|3"));
                        if (Session.CharacterInfo.Invisible == 1)
                        {
                            Session.CharacterInfo.Invisible = 0;
                            instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)Session.CharacterInfo.Id + "|" + (object)0), 0 != 0);
                        }
                    }
                    else
                    {
                        if (instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.UserCharacter) == null)
                            return;
                        MapActor actorByReferenceId = instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.UserCharacter);
                        if (actorByReferenceId == null)
                            return;
                        Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(actorByReferenceId.ReferenceId);
                        if (!Fight.PlayerCanAttack(Session, sessionByCharacterId) || Fight.GetDistance(Session, sessionByCharacterId) >= 850.0)
                            return;
                        Fight.AttackPlayer(instanceByMapId, Session, sessionByCharacterId, result);
                        Session.CharacterInfo.LastRSB75 = DateTime.Now.TimeOfDay.TotalMilliseconds;
                        Session.SendData(PacketComposer.Compose("A", "CLD|RSB|3"));
                        if (Session.CharacterInfo.Invisible == 1)
                        {
                            Session.CharacterInfo.Invisible = 0;
                            instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)Session.CharacterInfo.Id + "|" + (object)0), 0 != 0);
                        }
                    }
                }
                else
                    Session.CharacterInfo.SelectedAmmo = result;
            }
        }

        private static void SelectRocket(Session Session, ClientMessage Message)
        {
            int result;
            if (!int.TryParse(Message.GetNextString(1), out result))
                return;
            if (new CList<int>() { 1, 2, 3 }.Contains(result))
                Session.CharacterInfo.SelectedRocket = result;
        }

        private static async void AutoRocket(Session Session, ClientMessage Message)
        {
            if (Session == null || Session.CharacterInfo == null || Message == null || !Session.Authenticated || Session.CharacterInfo.SelectedRocket <= 0)
                return;
            if (!Session.CharacterInfo.ActiveAutoRocket)
                return;
            if (Session.CharacterInfo.Attacking == true)
            {
                RocketAttack(Session, Message);
                await Task.Delay(2100);
                AutoRocket(Session, Message);
                return;
            }
            await Task.Delay(1500);
            AutoRocket(Session, Message);
        }

        private static void RocketAttack(Session Session, ClientMessage Message)
        {
            if (Session == null || Session.CharacterInfo == null || Message == null || !Session.Authenticated)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null || UnixTimestamp.GetCurrent() - Session.CharacterInfo.LastRocket < 2.0 || Session.CharacterInfo.SelectedRocket <= 0)
                return;
            if (Session.CharacterInfo.SelectedPlayer == 0)
                return;
            MapActor actorByReferenceId1 = instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.AiBot);
            if (actorByReferenceId1 != null)
            {
                Npc referenceObject = (Npc)actorByReferenceId1.ReferenceObject;
                if (referenceObject == null || referenceObject.IsDestroying || Fight.GetDistanceNpc(Session, referenceObject) >= 850.0)
                    return;
                if (Session.CharacterInfo.Invisible == 1)
                {
                    Session.CharacterInfo.Invisible = 0;
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)Session.CharacterInfo.Id + "|" + (object)0), 0 != 0);
                }
                Session.CharacterInfo.SelectedPlayerRocket = Session.CharacterInfo.SelectedPlayer;
                if (Session.CharacterInfo.AutoRocketSkill == 1)
                {
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("v", Session.CharacterId.ToString() + "|" + (object)referenceObject.Id + "|H|" + (object)Session.CharacterInfo.SelectedRocket + "|" + (object)Session.CharacterInfo.RocketPattern + "|1"), 0 != 0);
                }
                else
                {
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("v", Session.CharacterId.ToString() + "|" + (object)referenceObject.Id + "|H|" + (object)Session.CharacterInfo.SelectedRocket + "|" + (object)Session.CharacterInfo.RocketPattern + "|0"), 0 != 0);
                }
                Session.SendData(PacketComposer.Compose("A", "CLD|ROK|2"));
                Session.CharacterInfo.RocketAttackTimer = new System.Threading.Timer(new TimerCallback(Fight.EffectRocket), (object)Session, 1000, 0);
                Session.CharacterInfo.LastRocket = UnixTimestamp.GetCurrent();
            }
            else
            {
                MapActor actorByReferenceId2 = instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.UserCharacter);
                if (actorByReferenceId2 == null)
                    return;
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(actorByReferenceId2.ReferenceId);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null || !Fight.PlayerCanAttack(Session, sessionByCharacterId) || (sessionByCharacterId.CharacterInfo.PeaceZone || Fight.GetDistance(Session, sessionByCharacterId) >= 850.0))
                    return;
                if (Session.CharacterInfo.Invisible == 1)
                {
                    Session.CharacterInfo.Invisible = 0;
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)Session.CharacterInfo.Id + "|" + (object)0), 0 != 0);
                }
                Session.CharacterInfo.SelectedPlayerRocket = Session.CharacterInfo.SelectedPlayer;
                if (Session.CharacterInfo.AutoRocketSkill == 1)
                {
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("v", Session.CharacterId.ToString() + "|" + (object)sessionByCharacterId.CharacterId + "|H|" + (object)Session.CharacterInfo.SelectedRocket + "|" + (object)Session.CharacterInfo.RocketPattern + "|1"), 0 != 0);
                }
                else
                {
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("v", Session.CharacterId.ToString() + "|" + (object)sessionByCharacterId.CharacterId + "|H|" + (object)Session.CharacterInfo.SelectedRocket + "|" + (object)Session.CharacterInfo.RocketPattern + "|0"), 0 != 0);
                }

                Session.SendData(PacketComposer.Compose("A", "CLD|ROK|2"));
                Session.CharacterInfo.RocketAttackTimer = new System.Threading.Timer(new TimerCallback(Fight.EffectRocket), (object)Session, 1000, 0);
                Session.CharacterInfo.LastRocket = UnixTimestamp.GetCurrent();
            }
        }

        private static void EffectRocket(object state)
        {
            Random random = new Random();
            Session session = (Session)state;
            if (session == null || session.CharacterInfo == null)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            MapActor actorByReferenceId1 = instanceByMapId.GetActorByReferenceId(session.CharacterInfo.SelectedPlayerRocket, MapActorType.AiBot);
            if (actorByReferenceId1 != null)
            {
                Npc referenceObject = (Npc)actorByReferenceId1.ReferenceObject;
                if (referenceObject == null || referenceObject.IsDestroying)
                    return;
                int Damage = session.CharacterInfo.RckDamages + random.Next(-500, 500);
                if (session.CharacterInfo.LabInfos != null && session.CharacterInfo.LabInfos.Rocket[1] > 0)
                {
                    if (session.CharacterInfo.LabInfos.Rocket[0] == 11)
                        Damage = (int)((double)Damage * 1.05);
                    else if (session.CharacterInfo.LabInfos.Rocket[0] == 13)
                        Damage = (int)((double)Damage * 1.1);
                    --session.CharacterInfo.LabInfos.Rocket[1];
                    ++session.CharacterInfo.LabInfos.Update;
                    if (session.CharacterInfo.LabInfos.Update > 8)
                        session.CharacterInfo.UpdateLaserRocketReff();
                }
                if (referenceObject.ShipId == 442)
                {
                    if (session.CharacterInfo.SelectedAmmo == 5)
                        return;
                    Spaceball.DoDamage(Damage, session.CharacterInfo.FactionId);
                }
                else
                {
                    int num1 = Convert.ToInt32((double)Damage * 0.8);
                    int num2 = Damage - num1;
                    if (referenceObject.ShipShield - num1 > 0)
                    {
                        referenceObject.ShipShield -= num1;
                    }
                    else
                    {
                        num2 += num1 - referenceObject.ShipShield;
                        num1 = referenceObject.ShipShield;
                        referenceObject.ShipShield = 0;
                    }
                    if (referenceObject.ShipHp - num2 > 0)
                    {
                        referenceObject.ShipHp -= num2;
                    }
                    else
                    {
                        num2 = referenceObject.ShipHp;
                        referenceObject.ShipHp = 0;
                    }
                    int damages = num1 + num2;
                    foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
                    {
                        if (key.Type == MapActorType.UserCharacter)
                        {
                            Session sessionById = SessionManager.GetSessionById(key.ReferenceSessionId);
                            if (sessionById != null && sessionById.CharacterInfo != null && sessionById.CharacterInfo.SelectedPlayerRocket == referenceObject.Id)
                                sessionById.SendData(PacketComposer.Compose("Y", "0|" + (object)referenceObject.Id + "|L|" + (object)referenceObject.ShipHp + "|" + (object)referenceObject.ShipShield + "|" + (object)damages));
                        }
                    }
                    referenceObject.UpdateAttackers(session.CharacterId, damages);
                    if (referenceObject.ShipHp > 0)
                        return;
                    Fight.KillNPC(instanceByMapId, referenceObject, session);
                }
            }
            else
            {
                MapActor actorByReferenceId2 = instanceByMapId.GetActorByReferenceId(session.CharacterInfo.SelectedPlayerRocket, MapActorType.UserCharacter);
                if (actorByReferenceId2 == null)
                    return;
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(actorByReferenceId2.ReferenceId);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null || sessionByCharacterId.CharacterInfo.ActiveISH || sessionByCharacterId.CharacterInfo.PeaceZone)
                    return;
                int num1 = session.CharacterInfo.RckDamages + random.Next(-500, 500);
                if (session.CharacterInfo.LabInfos.Rocket[1] > 0)
                {
                    if (session.CharacterInfo.LabInfos.Rocket[0] == 11)
                        num1 = (int)((double)num1 * 1.05);
                    else if (session.CharacterInfo.LabInfos.Rocket[0] == 13)
                        num1 = (int)((double)num1 * 1.1);
                    --session.CharacterInfo.LabInfos.Rocket[1];
                    ++session.CharacterInfo.LabInfos.Update;
                    if (session.CharacterInfo.LabInfos.Update > 8)
                        session.CharacterInfo.UpdateLaserRocketReff();
                }
                int int32 = Convert.ToInt32((double)num1 * sessionByCharacterId.CharacterInfo.ShieldAbsorption);
                int num2 = num1 - int32;
                if (sessionByCharacterId.CharacterInfo.ShipShield - int32 > 0)
                    sessionByCharacterId.CharacterInfo.ShipShield -= int32;
                else if (sessionByCharacterId.CharacterInfo.ShipShield - int32 <= 0)
                {
                    num2 = num1 - sessionByCharacterId.CharacterInfo.ShipShield;
                    sessionByCharacterId.CharacterInfo.ShipShield = 0;
                }
                if (sessionByCharacterId.CharacterInfo.ShipHp - num2 > 0)
                    sessionByCharacterId.CharacterInfo.ShipHp -= num2;
                else if (sessionByCharacterId.CharacterInfo.ShipHp - num2 <= 0)
                    sessionByCharacterId.CharacterInfo.ShipHp = 0;
                session.SendData(PacketComposer.Compose("Y", "0|" + (object)sessionByCharacterId.CharacterId + "|L|" + (object)sessionByCharacterId.CharacterInfo.ShipHp + "|" + (object)sessionByCharacterId.CharacterInfo.ShipShield + "|" + (object)num1));
                sessionByCharacterId.SendData(PacketComposer.Compose("Y", "0|" + (object)sessionByCharacterId.CharacterId + "|L|" + (object)sessionByCharacterId.CharacterInfo.ShipHp + "|" + (object)sessionByCharacterId.CharacterInfo.ShipShield + "|" + (object)num1));
                if (sessionByCharacterId.CharacterInfo.ShipHp > 0 || sessionByCharacterId.CharacterInfo.Destroy)
                    return;
                sessionByCharacterId.CharacterInfo.SendReward(sessionByCharacterId);
                Fight.StopLaser(session, sessionByCharacterId);
                Fight.KillPlayer(sessionByCharacterId);
            }
        }

        private static void StopLaserAttack(Session Session, ClientMessage Message)
        {
            int result = 0;
            if (!int.TryParse(Message.GetNextString(1), out result))
                Fight.StopLaser(Session, null);
            else
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(result);
                Fight.StopLaser(Session, sessionByCharacterId, false);
            }
        }

        public static void CanAttack(object state)
        {
            Session session = (Session)state;
            if (session == null || session.CharacterInfo == null)
                return;
            session.CharacterInfo.CanLaserAttack = true;
        }

        private static void LaserAttack(Session Session, ClientMessage Message)
        {
            if (Session.CharacterInfo == null)
                return;
            if (Session.IsChat)
            {
                Chat.SendMessage(Session, Message);
                return;
            }
            if (Session.CharacterInfo == null)
                return;
            if (Session.CharacterInfo.LaserAttackTimer != null)
                Session.CharacterInfo.LaserAttackTimer.Dispose();
            Session.CharacterInfo.Attacking = false;
            if (!Session.CharacterInfo.CanLaserAttack)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            if (Session.CharacterInfo.SelectedPlayer == 0)
                return;
            MapActor actorByReferenceId1 = instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.AiBot);
            bool npc = true;
            Object referenceObject = null;
            if (actorByReferenceId1 != null)
            {
                referenceObject = (Npc)actorByReferenceId1.ReferenceObject;
                if (referenceObject == null)
                    return;
                if (Fight.GetDistanceNpc(Session, (Npc)referenceObject) >= 850.0)
                    return;
            }
            else
            {
                if (!PvpManager.PvpEnabled)
                    return;
                MapActor actorByReferenceId2 = instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.UserCharacter);
                if (actorByReferenceId2 == null)
                    return;
                referenceObject = SessionManager.GetSessionByCharacterId(actorByReferenceId2.ReferenceId);
                if (referenceObject == null || ((Session)referenceObject).CharacterInfo == null || !Fight.PlayerCanAttack(Session, (Session)referenceObject))
                    return;
                if (Fight.GetDistance(Session, (Session)referenceObject) >= 850.0)
                    return;
                npc = false;
            }
            Session.CharacterInfo.Attacking = true;
            Session.CharacterInfo.PeaceZone = false;
            if (!npc)
                lock (((Session)referenceObject).CharacterInfo.Attacked)
                {
                    if (!((Session)referenceObject).CharacterInfo.Attacked.Contains(Session))
                        ((Session)referenceObject).CharacterInfo.Attacked.Add(Session);
                }
            if (Session.CharacterInfo.Invisible == 1)
                Fight.RemoveCloack(Session, instanceByMapId);
            double wait = 0;
            if (Session.CharacterInfo.PreviousAttacked == 0 || !npc || Session.CharacterInfo.PreviousAttacked == Session.CharacterInfo.SelectedPlayer)
            {
                wait = DateTime.Now.TimeOfDay.TotalMilliseconds - Session.CharacterInfo.PreviousDamageTime;
                if (wait >= Session.CharacterInfo.AttackSpeed || wait < 0)
                    wait = 0;
                else
                {
                    Fight.FacticeLaserAttack(Session);
                    wait = Session.CharacterInfo.AttackSpeed - wait;
                }
            }
            Session.CharacterInfo.LaserAttackTimer = new System.Threading.Timer(new TimerCallback(Fight.LaserAttackTimer), (object)Session, (int)wait, Session.CharacterInfo.AttackSpeed);
            if (Session.CharacterInfo.AutoRocketSkill == 1)
            {
                Session.CharacterInfo.ActiveAutoRocket = true;
                AutoRocket(Session, Message);
            }
            Session.CharacterInfo.LaserAttackCanTimer = new System.Threading.Timer(new TimerCallback(Fight.CanAttack), (object)Session, 0, 0);
        }

        private static void RemoveCloack(Session session, MapInstance instanceByMapId)
        {
            session.CharacterInfo.Invisible = 0;
            instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)session.CharacterInfo.Id + "|" + (object)0), 0 != 0);
        }

        private static void FacticeLaserAttack(object attacker)
        {
            Session Session = (Session)attacker;
            if (Session == null || Session.CharacterInfo == null)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            if (Session.CharacterInfo.SelectedPlayer == 0)
                return;
            MapActor actorByReferenceId = instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.AiBot);
            if (actorByReferenceId != null)
            {
                Npc referenceObject = (Npc)actorByReferenceId.ReferenceObject;
                if (referenceObject == null || referenceObject.IsDestroying)
                    return;
                Fight.AttackNpc(instanceByMapId, Session, referenceObject, Session.CharacterInfo.SelectedAmmo, false);
            }
            else if (Session.CharacterInfo.MapId == 80 && Survivor.Active && Survivor.SafeBattle)
                return;
            else if (Session.CharacterInfo.MapId == 81 && Invasion.Active && Invasion.SafeBattle)
                return;
            else
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(Session.CharacterInfo.SelectedPlayer);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null || Session.CurrentMapId != sessionByCharacterId.CurrentMapId)
                    return;
                else if (sessionByCharacterId.CharacterInfo.PeaceZone)
                    return;
                else
                    Fight.AttackPlayer(instanceByMapId, Session, sessionByCharacterId, Session.CharacterInfo.SelectedAmmo, false);
            }
        }

        private static void LaserAttackTimer(object attacker)
        {
            Session Session = (Session)attacker;
            if (Session == null || Session.CharacterInfo == null)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            if (Session.CharacterInfo.SelectedPlayer == 0)
            {
                Fight.StopLaser(Session, null);
                return;
            }
            MapActor actorByReferenceId = instanceByMapId.GetActorByReferenceId(Session.CharacterInfo.SelectedPlayer, MapActorType.AiBot);
            if (actorByReferenceId != null)
            {
                Npc referenceObject = (Npc)actorByReferenceId.ReferenceObject;
                if (referenceObject == null || referenceObject.IsDestroying)
                    return;
                Fight.AttackNpc(instanceByMapId, Session, referenceObject, Session.CharacterInfo.SelectedAmmo);
            }
            else if (Session.CharacterInfo.MapId == 80 && Survivor.Active && Survivor.SafeBattle)
            {
                Fight.StopLaser(Session, null, false);
            }
            else if (Session.CharacterInfo.MapId == 81 && Invasion.Active && Invasion.SafeBattle)
            {
                Fight.StopLaser(Session, null, false);
            }
            else
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(Session.CharacterInfo.SelectedPlayer);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null || Session.CurrentMapId != sessionByCharacterId.CurrentMapId)
                {
                    Fight.StopLaser(Session, sessionByCharacterId);
                }
                else if (sessionByCharacterId.CharacterInfo.PeaceZone)
                {
                    Fight.StopLaser(Session, sessionByCharacterId);
                }
                else
                    Fight.AttackPlayer(instanceByMapId, Session, sessionByCharacterId, Session.CharacterInfo.SelectedAmmo);
            }

        }

        private static void Unlock(Session session)
        {
            session.CharacterInfo.SelectedPlayer = 0;
            session.SendData(PacketComposer.Compose("N", "-1"));
        }

        private static void AttackNpc(MapInstance Instance, Session Session, Npc Npc, int Ammo, bool damage = true)
        {
            double distanceNpc = Fight.GetDistanceNpc(Session, Npc);
            if (distanceNpc <= 850.0 && Session.CharacterInfo.OutOfRange)
            {
                Session.CharacterInfo.OutOfRange = false;
                Session.SendData(PacketComposer.Compose("X", ""));
            }
            if (distanceNpc <= 850.0 && !Session.CharacterInfo.OutOfRange)
            {
                double now = DateTime.Now.TimeOfDay.TotalMilliseconds;
                double num = now - Session.CharacterInfo.LastRSB75;
                Session.CharacterInfo.AttackingRepBug = true;
                if (num < 0.0 || num >= 300.0)
                    Instance.BroadcastMessage(PacketComposer.Compose("a", Session.CharacterId.ToString() + "|" + (object)Npc.Id + "|" + (object)Fight.GetAmmoType(Ammo) + "|" + (object)Npc.ShieldMechanics + "|" + (object)Session.CharacterInfo.FatLasers), 0 != 0);
                if (damage)
                    Fight.DoDamageNpc(Instance, Session, Npc, Ammo);
                Session.CharacterInfo.PreviousAttacked = Npc.Id;
                if (Ammo != 6)
                    Session.CharacterInfo.PreviousDamageTime = now;
                if (Session.CharacterInfo.Invisible == 1)
                {
                    Session.CharacterInfo.Invisible = 0;
                    Instance.BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)Session.CharacterInfo.Id + "|" + (object)0), 0 != 0);
                }
                if (Npc.IsAttacking || Session.CharacterInfo.SelectedPlayer != Npc.Id || !(Npc.Name != "Spaceball"))
                    return;
                Npc.LockTarget(Session.CharacterInfo.Id);
            }
            else
            {
                if (distanceNpc <= 850.0 || Session.CharacterInfo.OutOfRange)
                    return;
                Session.SendData(PacketComposer.Compose("O", ""));
                Session.CharacterInfo.OutOfRange = true;
                Session.CharacterInfo.Attacking = false;
            }
        }

        private static void DoDamageNpc(MapInstance Instance, Session Session, Npc Npc, int Ammo)
        {
            if (Npc == null)
                return;
            double multiplier = Fight.GetMultiplier(Ammo, Session.CharacterInfo.ApisBuilt, Session.CharacterInfo.ZeusBuilt);
            int num1 = Session.CharacterInfo.RandomDamage.Next(-200, 200);
            int num2 = Convert.ToInt32((double)Session.CharacterInfo.MaxDamage * multiplier * Session.CharacterInfo.MultiplierAgainstNpcs) + num1;
            if (Session.CharacterInfo.LabInfos.Laser[1] > 0)
            {
                if (Session.CharacterInfo.LabInfos.Laser[0] == 11)
                    num2 = (int)((double)num2 * 1.05);
                else if (Session.CharacterInfo.LabInfos.Laser[0] == 13)
                    num2 = (int)((double)num2 * 1.1);
                --Session.CharacterInfo.LabInfos.Laser[1];
                ++Session.CharacterInfo.LabInfos.Update;
                if (Session.CharacterInfo.LabInfos.Update > 8)
                    Session.CharacterInfo.UpdateLaserRocketReff();
            }
            if (Npc.ShipId == 442)
            {
                if (Session.CharacterInfo.SelectedAmmo == 5)
                    return;
                Spaceball.DoDamage(num2, Session.CharacterInfo.FactionId);
            }
            else
            {
                if (Ammo == 5)
                {
                    if (Npc.ShipShield - num2 > 0)
                    {
                        Npc.ShipShield -= num2;
                    }
                    else
                    {
                        num2 = Npc.ShipShield;
                        Npc.ShipShield = 0;
                    }
                    int num3 = num2;
                    if (Session.CharacterInfo.ShipShield + num3 > Session.CharacterInfo.ShipMaxShield)
                    {
                        num3 = Session.CharacterInfo.ShipMaxShield - Session.CharacterInfo.ShipShield;
                        Session.CharacterInfo.ShipShield = Session.CharacterInfo.ShipMaxShield;
                    }
                    else
                        Session.CharacterInfo.ShipShield += num3;
                    Session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|SHD|" + (object)Session.CharacterInfo.ShipShield + "|" + (object)num3));
                }
                else if (Ammo == 3)
                {
                    if (Npc.ShipHp - num2 > 0)
                    {
                        Npc.ShipHp -= num2;
                    }
                    else
                    {
                        num2 = Npc.ShipHp;
                        Npc.ShipHp = 0;
                    }
                    int num3 = num2;
                    if (Session.CharacterInfo.ShipHp + num3 > Session.CharacterInfo.ShipMaxHp)
                    {
                        num3 = Session.CharacterInfo.ShipMaxHp - Session.CharacterInfo.ShipHp;
                        Session.CharacterInfo.ShipHp = Session.CharacterInfo.ShipMaxHp;
                    }
                    else
                        Session.CharacterInfo.ShipHp += num3;
                    Session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|HPT|" + (object)Session.CharacterInfo.ShipHp + "|" + (object)num3));
                }
                else
                {
                    int num3 = Convert.ToInt32((double)num2 * 0.8);
                    int num4 = num2 - num3;
                    if (Npc.ShipShield - num3 > 0)
                    {
                        Npc.ShipShield -= num3;
                    }
                    else
                    {
                        num4 += num3 - Npc.ShipShield;
                        num3 = Npc.ShipShield;
                        Npc.ShipShield = 0;
                    }
                    if (Npc.ShipHp - num4 > 0)
                    {
                        Npc.ShipHp -= num4;
                    }
                    else
                    {
                        num4 = Npc.ShipHp;
                        Npc.ShipHp = 0;
                    }
                    num2 = num3 + num4;
                }
                foreach (MapActor key in (IEnumerable<MapActor>)MapManager.GetInstanceByMapId(Session.CharacterInfo.MapId).Actors.Keys)
                {
                    if (key.Type == MapActorType.UserCharacter)
                    {
                        Session sessionById = SessionManager.GetSessionById(key.ReferenceSessionId);
                        if (sessionById != null && sessionById.CharacterInfo != null && sessionById.CharacterInfo.SelectedPlayer == Npc.Id)
                            sessionById.SendData(PacketComposer.Compose("Y", "0|" + (object)Npc.Id + "|L|" + (object)Npc.ShipHp + "|" + (object)Npc.ShipShield + "|" + (object)num2));
                    }
                }
                Npc.UpdateAttackers(Session.CharacterId, num2);
                if (Npc.ShipHp > 0)
                    return;
                Fight.KillNPC(Instance, Npc, Session);
            }
        }

        private static double GetMultiplier(int SelectedAmmo, bool bApis, bool bZeus)
        {
            double num;
            switch (SelectedAmmo)
            {
                case 1:
                    num = 1.0;
                    break;
                case 2:
                    num = 2.0;
                    break;
                case 3:
                    num = 1.5;
                    break;
                case 4:
                    num = !bApis ? 4.0 : 4.6;
                    break;
                case 5:
                    num = !bZeus ? 2.0 : 2.4;
                    break;
                case 6:
                    num = 5.5;
                    break;
                default:
                    num = 1.0;
                    break;
            }
            return num;
        }

        private static void AttackPlayer(MapInstance Instance, Session Session, Session Ennemy, int Ammo, bool damage = true)
        {
            double distance = Fight.GetDistance(Session, Ennemy);
            if (distance <= 850.0 && Session.CharacterInfo.OutOfRange)
            {
                Session.CharacterInfo.OutOfRange = false;
                Session.SendData(PacketComposer.Compose("X", ""));
            }
            if (distance <= 850.0 && !Session.CharacterInfo.OutOfRange)
            {
                double now = DateTime.Now.TimeOfDay.TotalMilliseconds;
                double num = now - Session.CharacterInfo.LastRSB75;
                if (num < 0.0 || num >= 300.0)
                    Instance.BroadcastMessage(PacketComposer.Compose("a", Session.CharacterId.ToString() + "|" + (object)Ennemy.CharacterId + "|" + (object)Fight.GetAmmoType(Ammo) + "|" + (object)Ennemy.CharacterInfo.ShieldMechanics + "|" + (object)Session.CharacterInfo.FatLasers), 0 != 0);
                Session.CharacterInfo.Attacking = true;
                if (damage)
                    Fight.DoDamage(Instance, Session, Ennemy, Ammo);
                Session.CharacterInfo.PreviousAttacked = 0;
                if (Ammo != 6)
                    Session.CharacterInfo.PreviousDamageTime = now;
                if (Session.CharacterInfo.Invisible == 1)
                {
                    Session.CharacterInfo.Invisible = 0;
                    Instance.BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)Session.CharacterInfo.Id + "|" + (object)0), 0 != 0);
                }
                lock (Ennemy.CharacterInfo.Attacked)
                {
                    if (Ennemy.CharacterInfo.Attacked.Contains(Session))
                        return;
                    Ennemy.CharacterInfo.Attacked.Add(Session);
                }
            }
            else
            {
                if (distance <= 850.0 || Session.CharacterInfo.OutOfRange)
                    return;
                Session.SendData(PacketComposer.Compose("O", ""));
                Session.CharacterInfo.OutOfRange = true;
                Session.CharacterInfo.Attacking = false;
                lock (Ennemy.CharacterInfo.Attacked)
                {
                    if (Ennemy.CharacterInfo.Attacked.Contains(Session))
                        Ennemy.CharacterInfo.Attacked.Remove(Session);
                }
            }
        }

        private static void DoDamage(MapInstance Instance, Session Session, Session Ennemy, int Ammo)
        {
            if (Instance == null || (Session == null || Session.CharacterInfo == null) || (Ennemy == null || Ennemy.CharacterInfo == null || Ennemy.CharacterInfo.ActiveISH))
                return;
            double multiplier = Fight.GetMultiplier(Ammo, Session.CharacterInfo.ApisBuilt, Session.CharacterInfo.ZeusBuilt);
            int num1 = Session.CharacterInfo.RandomDamage.Next(-200, 200);
            int num2 = Convert.ToInt32((double)Session.CharacterInfo.MaxDamage * multiplier * Session.CharacterInfo.MultiplierAgainstPlayers) + num1;
            if (Session.CharacterInfo.LabInfos.Laser[1] > 0)
            {
                if (Session.CharacterInfo.LabInfos.Laser[0] == 11)
                    num2 = (int)((double)num2 * 1.05);
                else if (Session.CharacterInfo.LabInfos.Laser[0] == 13)
                    num2 = (int)((double)num2 * 1.1);
                --Session.CharacterInfo.LabInfos.Laser[1];
                ++Session.CharacterInfo.LabInfos.Update;
                if (Session.CharacterInfo.LabInfos.Update > 8)
                    Session.CharacterInfo.UpdateLaserRocketReff();
            }
            if (num2 > 45000)
            {
                Output.WriteLine((object)"Hacker have damage !");
            }
            else
            {
                if (Ammo == 5)
                {
                    if (Ennemy.CharacterInfo.ShipShield - num2 > 0)
                    {
                        Ennemy.CharacterInfo.ShipShield -= num2;
                    }
                    else
                    {
                        num2 = Ennemy.CharacterInfo.ShipShield;
                        Ennemy.CharacterInfo.ShipShield = 0;
                    }
                    int num3 = num2;
                    if (Session.CharacterInfo.ShipShield + num3 > Session.CharacterInfo.ShipMaxShield)
                    {
                        num3 = Session.CharacterInfo.ShipMaxShield - Session.CharacterInfo.ShipShield;
                        Session.CharacterInfo.ShipShield = Session.CharacterInfo.ShipMaxShield;
                    }
                    else
                        Session.CharacterInfo.ShipShield += num3;
                    Session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|SHD|" + (object)Session.CharacterInfo.ShipShield + "|" + (object)num3));
                    Ennemy.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|SHD|" + (object)Session.CharacterInfo.ShipShield + "|" + (object)num3));
                }
                else if (Ammo == 3)
                {
                    if (Ennemy.CharacterInfo.ShipHp - num2 > 0)
                    {
                        Ennemy.CharacterInfo.ShipHp -= num2;
                    }
                    else
                    {
                        num2 = Ennemy.CharacterInfo.ShipHp;
                        Ennemy.CharacterInfo.ShipHp = 0;
                    }
                    int num3 = num2;
                    if (Session.CharacterInfo.ShipHp + num3 > Session.CharacterInfo.ShipMaxHp)
                    {
                        num3 = Session.CharacterInfo.ShipMaxHp - Session.CharacterInfo.ShipHp;
                        Session.CharacterInfo.ShipHp = Session.CharacterInfo.ShipMaxHp;
                    }
                    else
                        Session.CharacterInfo.ShipHp += num3;
                    Session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|HPT|" + (object)Session.CharacterInfo.ShipHp + "|" + (object)num3));
                    Ennemy.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|HPT|" + (object)Session.CharacterInfo.ShipHp + "|" + (object)num3));
                }
                else
                {
                    int num3 = Convert.ToInt32((double)num2 * Ennemy.CharacterInfo.ShieldAbsorption);
                    int num4 = num2 - num3;
                    if (Ennemy.CharacterInfo.ShipShield - num3 > 0)
                    {
                        Ennemy.CharacterInfo.ShipShield -= num3;
                    }
                    else
                    {
                        num4 += num3 - Ennemy.CharacterInfo.ShipShield;
                        num3 = Ennemy.CharacterInfo.ShipShield;
                        Ennemy.CharacterInfo.ShipShield = 0;
                    }
                    if (Ennemy.CharacterInfo.ShipHp - num4 > 0)
                    {
                        Ennemy.CharacterInfo.ShipHp -= num4;
                    }
                    else
                    {
                        num4 = Ennemy.CharacterInfo.ShipHp;
                        Ennemy.CharacterInfo.ShipHp = 0;
                    }
                    num2 = num3 + num4;
                }
                foreach (MapActor key in (IEnumerable<MapActor>)MapManager.GetInstanceByMapId(Session.CharacterInfo.MapId).Actors.Keys)
                {
                    if (key.Type == MapActorType.UserCharacter)
                    {
                        Session sessionById = SessionManager.GetSessionById(key.ReferenceSessionId);
                        if (sessionById != null && sessionById.CharacterInfo != null && (sessionById.CharacterInfo.SelectedPlayer == Ennemy.CharacterId || sessionById.CharacterId == Ennemy.CharacterId))
                            sessionById.SendData(PacketComposer.Compose("Y", "0|" + (object)Ennemy.CharacterId + "|L|" + (object)Ennemy.CharacterInfo.ShipHp + "|" + (object)Ennemy.CharacterInfo.ShipShield + "|" + (object)num2));
                    }
                }
                Ennemy.CharacterInfo.UpdateAttacker(Session);
                if (Ennemy.CharacterInfo.ShipHp > 0 || Ennemy.CharacterInfo.Destroy)
                    return;
                Ennemy.CharacterInfo.SendReward(Ennemy);
                Fight.StopLaser(Session, Ennemy);
                Fight.KillPlayer(Ennemy);
            }
        }

        private static double GetDistanceNpc(Session Attacker, Npc Npc)
        {
            return Math.Sqrt(Math.Pow((double)(Attacker.CharacterInfo.LocX - Npc.LocX), 2.0) + Math.Pow((double)(Attacker.CharacterInfo.LocY - Npc.LocY), 2.0));
        }

        private static double GetDistance(Session Attacker, Session Ennemy)
        {
            return Math.Sqrt(Math.Pow((double)(Attacker.CharacterInfo.LocX - Ennemy.CharacterInfo.LocX), 2.0) + Math.Pow((double)(Attacker.CharacterInfo.LocY - Ennemy.CharacterInfo.LocY), 2.0));
        }

        public static void StopLaser(Session Session, Session Ennemy, bool unlock = true)
        {
            if (Session.CharacterInfo.LaserAttackTimer != null)
                Session.CharacterInfo.LaserAttackTimer.Dispose();
            if (Session.CharacterInfo.LaserAttackCanTimer != null)
                Session.CharacterInfo.LaserAttackCanTimer.Dispose();
            Session.CharacterInfo.Attacking = false;
            Session.CharacterInfo.ActiveAutoRocket = false;
            if (unlock)
                Fight.Unlock(Session);
            Session.CharacterInfo.LaserAttackCanTimer = new System.Threading.Timer(new TimerCallback(Fight.CanAttack), (object)Session, 1000, 0);
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            instanceByMapId.BroadcastMessageForOtherOnly(PacketComposer.Compose("a", Session.CharacterId.ToString() + "|" + (object)-1 + "|" + (object)0 + "|" + (object)Session.CharacterInfo.ShieldMechanics + "|" + (object)Session.CharacterInfo.FatLasers), Session);
            if (Ennemy == null || Ennemy.CharacterInfo == null)
                return;
            bool lockTaken2 = false;
            try
            {
                Monitor.Enter((object)(attacked = Ennemy.CharacterInfo.Attacked), ref lockTaken2);
                if (Ennemy.CharacterInfo.Attacked.Contains(Session))
                    Ennemy.CharacterInfo.Attacked.Remove(Session);
            }
            finally
            {
                if (lockTaken2)
                    Monitor.Exit((object)attacked);
            }
        }

        private static int GetAmmoType(int _SelectedAmmo)
        {
            int num;
            switch (_SelectedAmmo)
            {
                case 1:
                    num = 1;
                    break;
                case 2:
                    num = 1;
                    break;
                case 3:
                    num = 2;
                    break;
                case 4:
                    num = 3;
                    break;
                case 5:
                    num = 4;
                    break;
                case 6:
                    num = 6;
                    break;
                default:
                    num = 1;
                    break;
            }
            return num;
        }

        public static void LootCargoBox(Session Session, MapInstance instance)
        {
            int num = Session.Id + 100;
            int locX = Session.CharacterInfo.LocX;
            int locY = Session.CharacterInfo.LocY;
            int int32_1 = Convert.ToInt32(Math.Round((double)Session.CharacterInfo.LabInfos.Prometium * 0.2));
            int int32_2 = Convert.ToInt32(Math.Round((double)Session.CharacterInfo.LabInfos.Endurium * 0.2));
            int int32_3 = Convert.ToInt32(Math.Round((double)Session.CharacterInfo.LabInfos.Terbium * 0.2));
            int int32_4 = Convert.ToInt32(Math.Round((double)Session.CharacterInfo.LabInfos.Prometid * 0.1));
            int int32_5 = Convert.ToInt32(Math.Round((double)Session.CharacterInfo.LabInfos.Duranium * 0.1));
            int int32_6 = Convert.ToInt32(Math.Round((double)Session.CharacterInfo.LabInfos.Promerium * 0.1));
            Session.CharacterInfo.RemoveCargo(1L, int32_1);
            Session.CharacterInfo.RemoveCargo(2L, int32_2);
            Session.CharacterInfo.RemoveCargo(3L, int32_3);
            Session.CharacterInfo.RemoveCargo(11L, int32_4);
            Session.CharacterInfo.RemoveCargo(12L, int32_5);
            Session.CharacterInfo.RemoveCargo(13L, int32_6);
            CargoBox cargoBox = new CargoBox(num, locX, locY, instance.MapId);
            cargoBox.Prometium = int32_1;
            cargoBox.Endurium = int32_2;
            cargoBox.Terbium = int32_3;
            cargoBox.Prometid = int32_4;
            cargoBox.Duranium = int32_5;
            cargoBox.Promerium = int32_6;
            if (instance.Info.Collectables.ContainsKey(num))
            {
                instance.Info.Collectables.Remove(num);
                instance.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)num)), false);
            }
            instance.Info.Collectables.Add(num, (Collectable)cargoBox);
            instance.BroadcastMessage(PacketComposer.Compose("c", num.ToString() + "|" + (object)1 + "|" + (object)locX + "|" + (object)locY), 0 != 0);
        }

        public static void KillPlayer(Session Session, bool keepCargo = false)
        {
            Fight.StopLaser(Session, null);
            Session.CharacterInfo.Destroy = true;
            Session.CharacterInfo.FactionId = Session.CharacterInfo.RealFaction;
            Session.CharacterInfo.ClanId = Session.CharacterInfo.RealClan;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId != null)
            {
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("K", Session.CharacterId.ToString()), false);
                if (!keepCargo && Session.CharacterInfo.MapId != 83)
                    Fight.LootCargoBox(Session, instanceByMapId);
                if (Session.CharacterInfo.Attacker != null &&
                    Session.CharacterInfo.Attacker.CharacterInfo.FactionId != Session.CharacterInfo.FactionId)
                    Fight.LootSilverBox(Session, instanceByMapId);
                foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
                {
                    if (key.Type == MapActorType.UserCharacter && key.ReferenceId != Session.CharacterId)
                    {
                        Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key.ReferenceId);
                        if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                        {
                            if (sessionByCharacterId.CharacterInfo.IsAdmin)
                            {
                                sessionByCharacterId.CharacterInfo.PlayerInRange.Remove(Session.CharacterInfo.Id);
                            }
                        }
                    }
                }
            }
            Session.CharacterInfo.Attacker = null;
            Session.CharacterInfo.ShipHp = 1000;
            Session.CharacterInfo.Config1.Shield = 1000;
            Session.CharacterInfo.Config2.Shield = 1000;
           // using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
           //     Session.CharacterInfo.SynchronizeStatistics(client, 1);
            Session.CharacterInfo.Destroy = false;
            Session.CharacterInfo.OutOfRange = false;
            Session.CharacterInfo.CanMove = true;
            Session.CharacterInfo.NoFightTimer = 0;
            Session.CharacterInfo.KillStrek = 0;
            Session.CharacterInfo.IsRepairing = false;
            Session.CharacterInfo.PeaceZone = true;
            int factionId = Session.CharacterInfo.FactionId;
            if (Session != null && Session.CharacterInfo != null)
            {
                foreach (int id in (IEnumerable<int>)Session.CharacterInfo.PlayerInRange.Keys)
                {
                    Session sessionByCharacterId2 = SessionManager.GetSessionByCharacterId(id);
                    if (sessionByCharacterId2 != null && sessionByCharacterId2.CharacterInfo != null)
                        sessionByCharacterId2.CharacterInfo.PlayerInRange.Remove(Session.CharacterInfo.Id);
                }
                if (factionId == 1)
                {
                    Session.CharacterInfo.LocX = 2000;
                    Session.CharacterInfo.LocY = 1100;
                    Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
                    Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
                    Session.CharacterInfo.MapId = 1;
                }
                else if (factionId == 2)
                {
                    Session.CharacterInfo.LocX = 18500;
                    Session.CharacterInfo.LocY = 1100;
                    Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
                    Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
                    Session.CharacterInfo.MapId = 5;
                }
                else if (factionId == 3)
                {
                    Session.CharacterInfo.LocX = 19000;
                    Session.CharacterInfo.LocY = 11300;
                    Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
                    Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
                    Session.CharacterInfo.MapId = 9;
                }
            }
            MapHandler.OpenPublicConnection(Session, Session.CharacterInfo.MapId, (PortalInfo)null);
        }

        public static void LootSilverBox(Session session, MapInstance instanceByMapId)
        {
            Random random = new Random();
            int numRand = random.Next(1, 101);
            if (session.CharacterInfo.IsBeginner)
                return;
            if (numRand <= 15)
            {
                int id = session.CharacterInfo.Id + 1000;
                int locX = session.CharacterInfo.LocX + random.Next(-200, 200);
                int locY = session.CharacterInfo.LocY + random.Next(-200, 200);
                SilverBootyBox bootyBox = new SilverBootyBox(id, locX, locY, instanceByMapId.MapId);
                if (instanceByMapId.Info.Collectables.ContainsKey(id))
                {
                    instanceByMapId.Info.Collectables.Remove(id);
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)id)), false);
                }
                instanceByMapId.Info.Collectables.Add(id, (Collectable)bootyBox);
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("c", id.ToString() + "|" + (object)25 + "|" + (object)locX + "|" + (object)locY), 0 != 0);
            }
        }

        public static void RegeneratingShield(Session Session)
        {
            if (!Session.CharacterInfo.CanRegenShield || Session.CharacterInfo.ShipShield == Session.CharacterInfo.ShipMaxShield || Session.CharacterInfo.ShipShield >= Session.CharacterInfo.ShipMaxShield)
                return;
            int num = Session.CharacterInfo.ShRegen;
            if (Session.CharacterInfo.ShipShield + num <= Session.CharacterInfo.ShipMaxShield)
            {
                Session.CharacterInfo.ShipShield += num;
            }
            else
            {
                num = Session.CharacterInfo.ShipMaxShield - Session.CharacterInfo.ShipShield;
                Session.CharacterInfo.ShipShield = Session.CharacterInfo.ShipMaxShield;
            }
            Session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)Session.CharacterInfo.Id + "|SHD|" + (object)Session.CharacterInfo.ShipShield + "|" + (object)num));
        }

        private static void KillNPC(MapInstance map, Npc npc, Session session)
        {
            npc.Destroy(map);
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\GroupManager.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Util;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Handlers
{
    class GroupManager
    {
        private static Object thisLock = new Object();
        private static List<int> groupList = new List<int>();

        public GroupManager() { }


        #region Monitor (Head´s)
        public void Monitor(Session Session, ClientMessage Message)
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;

            string head = Message.GetNextString(1);

            if (head.StartsWith("inv"))
            {
                string shead = Message.GetNextString(2);

                if (shead.StartsWith("name"))
                {
                    this.InvitePlayer(Session, Message);
                }
                else if (shead.StartsWith("ack"))
                {
                    this.AcceptInvite(Session, Message);
                }
                else if (shead.StartsWith("rjc"))
                {
                    this.RejectInvite(Session, Message);
                }
                else if (shead.StartsWith("rji"))
                {
                    this.RevokeInvite(Session, Message);
                }
            }
            else if (head.StartsWith("s"))
            {
                Session.SendData(PacketComposer.Compose("A", "STD| not added"));
            }
            else if (head.StartsWith("blk"))
            {
                this.BlockInvite(Session, Message);
            }
            else if (head.StartsWith("lv"))
            {
                this.leaveGroup(Session);
            }
            else if (head.StartsWith("flw"))
            {
                this.FollowPlayer(Session, Message);
            }
            else if (head.StartsWith("lc"))
            {
                this.ChangeLeader(Session, Message);
            }
            else if (head.StartsWith("kick"))
            {
                this.KickPlayer(Session, Message);
            }
            else if (head.StartsWith("png"))
            {
                string head2 = Message.GetNextString(2);
                if (head2.StartsWith("usr"))
                {
                    this.PingPlayer(Session, Message);

                }
                else if (head2.StartsWith("pos"))
                {
                    this.PingMap(Session, Message);
                }
            }
        }
        #endregion

        #region Follow Player
        private void FollowPlayer(Session Session, ClientMessage Message)
        {
            int id = Message.GetNextInt(2);
            Session sessiontwo = SessionManager.GetSessionByCharacterId(id);

            if (!Session.CharacterInfo.Members.Contains(sessiontwo.CharacterInfo.Id))
                return;
            if (Session.CharacterInfo.MapId != sessiontwo.CharacterInfo.MapId)
            {
                Session.SendData(PacketComposer.Compose("A", "STD| Player is not on this Map!"));
                return;
            }
            else
            {
                double TimeTaken = ShipMovement.getTimeTaken(Session, sessiontwo.CharacterInfo.LocX, sessiontwo.CharacterInfo.LocY);
                if (TimeTaken == -1)
                    return;
                Session.CharacterInfo.NewLocX = sessiontwo.CharacterInfo.LocX;
                Session.CharacterInfo.NewLocY = sessiontwo.CharacterInfo.LocY;
                ShipMovement.MoveShip(Session, TimeTaken);
                Session.SendData(MapShipMovementComposer.Compose(Session.CharacterId, Session.CharacterInfo.NewLocX, Session.CharacterInfo.NewLocY, TimeTaken));
                ShipMovement.MovementToSeeEveryone(Session, TimeTaken);
            }
        }
        #endregion

        #region Ping Map
        private void PingMap(Session Session, ClientMessage Message)
        {
            string str1 = Message.GetNextString(3);
            string str2 = Message.GetNextString(4);
            foreach (int num in Session.CharacterInfo.Members.Keys)
            {
                Session sessionpingplayer = SessionManager.GetSessionByCharacterId(num);
                if (Session.CharacterInfo.MapId != sessionpingplayer.CharacterInfo.MapId)
                {
                    return;
                }
                else
                {
                    sessionpingplayer.SendData(PacketComposer.Compose("ps", "png|" + str1 + "|" + str2));
                }
            }
            return;
        }
        #endregion

        #region Ping Player
        private void PingPlayer(Session Session, ClientMessage Message)
        {
            int id = Message.GetNextInt(3);
            Session sessionping = SessionManager.GetSessionByCharacterId(id);
            try
            {
                if (id == 0)
                {
                    Session.SendData(PacketComposer.Compose("A", "STD| Error"));
                    return;
                }
                else
                {
                    if (Session.CharacterInfo.MapId != sessionping.CharacterInfo.MapId)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD| Player is not on this map"));
                        return;
                    }
                    else
                    {
                        if (Session.CharacterInfo.Members.Contains(id))
                        {
                            string posx = sessionping.CharacterInfo.LocX.ToString();
                            string posy = sessionping.CharacterInfo.LocY.ToString();
                            foreach (int num in Session.CharacterInfo.Members.Keys)
                            {
                                Session sessionpingplayer = SessionManager.GetSessionByCharacterId(num);
                                if (Session.CharacterInfo.MapId == sessionpingplayer.CharacterInfo.MapId)
                                {
                                    sessionpingplayer.SendData(PacketComposer.Compose("ps", "png|" + posx + "|" + posy));
                                }
                            }
                            return;
                        }
                    }
                }
            }
            catch (Exception)
            { }
        }
        #endregion

        #region Kick Player
        private void KickPlayer(Session Session, ClientMessage Message)
        {
            int id = Message.GetNextInt(2);
            Session sessiontwo = SessionManager.GetSessionByCharacterId(id);
            if (id == 0)
            {
                Session.SendData(PacketComposer.Compose("A", "STD| Error"));
                return;
            }
            try
            {
                List<int> list = new List<int>();
                foreach (int index in Session.CharacterInfo.Members.Keys)
                {
                    Session sessionindex = SessionManager.GetSessionByCharacterId(index);
                    sessionindex.SendData(PacketComposer.Compose("ps", "lp|kick|" + sessiontwo.CharacterInfo.Id));
                    list.Add(index);
                }
                if (Session.CharacterInfo.Members.Count <= 2)
                {
                    foreach (int index in Session.CharacterInfo.Members.Keys)
                    {
                        Session sessionindex2 = SessionManager.GetSessionByCharacterId(index);
                        if (sessionindex2.CharacterInfo.Id != Session.CharacterInfo.Id)
                        {
                            sessionindex2.CharacterInfo.Members.Clear();

                        }
                        GroupManager.groupList.Clear();
                        sessionindex2.SendData(PacketComposer.Compose("ps", "end|"));
                        sessionindex2.CharacterInfo.GroupLeader = false;
                    }
                    Session.CharacterInfo.Members.Clear();
                    Session.CharacterInfo.GroupLeader = false;
                }
                else
                {
                    foreach (int index in list)
                    {
                        Session sessionindex = SessionManager.GetSessionByCharacterId(index);
                        sessionindex.CharacterInfo.Members.Remove(sessiontwo.CharacterInfo.Id);
                    }
                }
                sessiontwo.CharacterInfo.Members.Clear();
                GroupManager.groupList.Remove(sessiontwo.CharacterInfo.Id);
            }
            catch (Exception)
            { }
        }
        #endregion

        #region Change Leader
        private void ChangeLeader(Session Session, ClientMessage Message)
        {
            int id = Message.GetNextInt(2);
            Session sessiontwo = SessionManager.GetSessionByCharacterId(id);
            if (id == 0)
            {
                Session.SendData(PacketComposer.Compose("A", "STD| Error"));
                return;
            }
            try
            {
                Session.CharacterInfo.GroupLeader = false;
                sessiontwo.CharacterInfo.GroupLeader = true;
                foreach (int index in Session.CharacterInfo.Members.Keys)
                {
                    Session sessionindex = SessionManager.GetSessionByCharacterId(index);
                    sessionindex.SendData(PacketComposer.Compose("ps", "nl|" + sessiontwo.CharacterInfo.Id)); // send all players in group the new leader 
                }

            }
            catch (Exception)
            { }
        }
        #endregion

        #region Leave Group
        private void leaveGroup(Session Session)
        {
            // Session.SendData(PacketComposer.Compose("ps", "lp|lv|" + Session.CharacterInfo.Id));
            List<int> list = new List<int>();
            foreach (int index in Session.CharacterInfo.Members.Keys)
            {
                Session sessionindex = SessionManager.GetSessionByCharacterId(index);
                if (sessionindex != null && sessionindex.CharacterInfo != null)
                {
                    sessionindex.SendData(PacketComposer.Compose("ps", "lp|lv|" + Session.CharacterInfo.Id));
                }
                list.Add(index);
            }
            if (Session.CharacterInfo.GroupLeader)
            {
                foreach (int num in Session.CharacterInfo.Members.Keys)
                {
                    Session sessionNewleader = SessionManager.GetSessionByCharacterId(num);
                    if (sessionNewleader.CharacterInfo.Id != Session.CharacterInfo.Id && sessionNewleader != null && sessionNewleader.CharacterInfo != null)
                    {
                        sessionNewleader.CharacterInfo.GroupLeader = true;
                        foreach (int index in Session.CharacterInfo.Members.Keys)
                        {
                            Session sessionByIndex = SessionManager.GetSessionByCharacterId(index);
                            sessionByIndex.SendData(PacketComposer.Compose("ps", "nl|" + sessionNewleader.CharacterInfo.Id)); // send the player that hes now the leader

                        }
                        break;
                    }
                }
                Session.CharacterInfo.GroupLeader = false;
            }
            if (Session.CharacterInfo.Members.Count <= 2)
            {
                foreach (int index in Session.CharacterInfo.Members.Keys)
                {
                    Session sessionindex2 = SessionManager.GetSessionByCharacterId(index);
                    if (sessionindex2.CharacterInfo.Id != Session.CharacterInfo.Id)
                    {
                        sessionindex2.CharacterInfo.Members.Clear();
                    }
                    GroupManager.groupList.Clear();
                    sessionindex2.SendData(PacketComposer.Compose("ps", "end|"));
                    sessionindex2.CharacterInfo.GroupLeader = false;
                }
                Session.CharacterInfo.Members.Clear();
                Session.CharacterInfo.GroupLeader = false;
            }
            else
            {
                foreach (int index in list)
                {
                    Session sessionindex = SessionManager.GetSessionByCharacterId(index);
                    if (sessionindex != null && sessionindex.CharacterInfo != null)
                    {
                        sessionindex.CharacterInfo.Members.Remove(Session.CharacterInfo.Id);
                    }
                }
            }
            Session.CharacterInfo.Members.Clear();
            GroupManager.groupList.Remove(Session.CharacterInfo.Id);
        }
        #endregion

        #region BlockInvite
        private void BlockInvite(Session Session, ClientMessage Message)
        {
            if (Session.CharacterInfo.Blk == 0)
            {
                Session.SendData(PacketComposer.Compose("ps", "blk|1"));
                Session.CharacterInfo.Blk = 1;
            }
            else
            {
                Session.SendData(PacketComposer.Compose("ps", "blk|0"));
                Session.CharacterInfo.Blk = 0;
            }

            this.removeAllInvitationReceive(Session);
        }
        #endregion

        public void removeAllInvitationReceive(Session Session)
        {
            foreach (int num in Session.CharacterInfo.InvitationReceive.Keys)
            {
                Session sessionBycharacterId = SessionManager.GetSessionByCharacterId(num);
                Session.SendData(PacketComposer.Compose("ps", "inv|del|none|" + num));
                if (sessionBycharacterId != null && sessionBycharacterId.CharacterInfo != null)
                {
                    sessionBycharacterId.SendData(PacketComposer.Compose("ps", "inv|del|none|" + sessionBycharacterId.CharacterInfo.Id + "|" + Session.CharacterInfo.Id));
                    sessionBycharacterId.CharacterInfo.InvitationSend.Remove(Session.CharacterInfo.Id);
                }
            }
            Session.CharacterInfo.InvitationReceive.Clear();
        }

        #region Reject Invite
        private void RejectInvite(Session Session, ClientMessage Message)
        {
            int id = Message.GetNextInt(3);
            Session sessiontwo = SessionManager.GetSessionByCharacterId(id);
            if (id == 0)
            {
                Session.SendData(PacketComposer.Compose("A", "STD| Error"));
                return;
            }
            try
            {
                Session.CharacterInfo.GroupLeader = false;
                sessiontwo.SendData(PacketComposer.Compose("ps", "inv|del|rj|" + id + "|" + Session.CharacterInfo.Id));
                Session.SendData(PacketComposer.Compose("ps", "inv|del|none|" + id));
                Session.CharacterInfo.InvitationReceive.Remove(sessiontwo.CharacterInfo.Id);
                sessiontwo.CharacterInfo.InvitationSend.Remove(Session.CharacterInfo.Id);
            }
            catch (Exception)
            { }
        }
        #endregion

        #region Revoke Invite
        private void RevokeInvite(Session Session, ClientMessage Message)
        {
            int id = Message.GetNextInt(3);
            Session sessiontwo = SessionManager.GetSessionByCharacterId(id);
            if (id == 0)
            {
                Session.SendData(PacketComposer.Compose("A", "STD| Error"));
                return;
            }
            try
            {
                Session.SendData(PacketComposer.Compose("ps", "inv|del|rv|" + Session.CharacterInfo.Id + "|" + id));
                sessiontwo.SendData(PacketComposer.Compose("ps", "inv|del|rv|" + Session.CharacterInfo.Id));
                Session.CharacterInfo.InvitationSend.Remove(sessiontwo.CharacterInfo.Id);
                sessiontwo.CharacterInfo.InvitationReceive.Remove(Session.CharacterInfo.Id);
            }
            catch (Exception)
            { }
        }
        #endregion

        #region Accept Invite
        private void AcceptInvite(Session Session, ClientMessage Message)
        {
            int id = Message.GetNextInt(3);
            Session sessiontwo = SessionManager.GetSessionByCharacterId(id);
            if (id == 0)
            {
                Session.SendData(PacketComposer.Compose("A", "STD| Error"));
                return;
            }
            try
            {
                this.removeAllInvitationReceive(Session);
                sessiontwo.CharacterInfo.InvitationSend.Remove(Session.CharacterInfo.Id);
                Session.CharacterInfo.GroupLeader = false;
                if (sessiontwo.CharacterInfo.Members.Count == 0 && sessiontwo.CharacterInfo.Blk == 0 && Session.CharacterInfo.Blk == 0)
                {
                    sessiontwo.CharacterInfo.GroupLeader = true;
                    sessiontwo.CharacterInfo.Members.Add(id);
                    sessiontwo.CharacterInfo.Members.Add(Session.CharacterInfo.Id);

                    Session.CharacterInfo.Members.Add(Session.CharacterInfo.Id);
                    Session.CharacterInfo.Members.Add(id);

                    GroupManager.groupList.Add(id);
                    GroupManager.groupList.Add(Session.CharacterInfo.Id);
                }
                else if (sessiontwo.CharacterInfo.Blk == 1 && Session.CharacterInfo.Blk == 1)// doesnt matter
                {
                    Session.SendData(PacketComposer.Compose("A", "STD| duel system not added to groupsystem yet"));
                }
                else // members will be added to the existing group
                {
                    foreach (int num in sessiontwo.CharacterInfo.Members.Keys)
                    {
                        Session.CharacterInfo.Members.Add(num);
                    }
                    sessiontwo.CharacterInfo.Members.Add(Session.CharacterInfo.Id);
                    GroupManager.groupList.Add(Session.CharacterInfo.Id);
                    foreach (int num in sessiontwo.CharacterInfo.Members.Keys)
                    {
                        if (num == sessiontwo.CharacterId)
                            continue;
                        Session sessionmembers = SessionManager.GetSessionByCharacterId(num);
                        if (sessionmembers != null && sessionmembers.CharacterInfo != null)
                            sessionmembers.CharacterInfo.Members.Add(Session.CharacterId);
                    }

                }
                uint leader = 0;
                foreach (int index1 in sessiontwo.CharacterInfo.Members.Keys)
                {
                    Session sessionmembers = SessionManager.GetSessionByCharacterId(index1);
                    string str = "";
                    /*if (sessionmembers.CharacterInfo.GroupLeader == true)
                    
                        str = str + sessionmembers.CharacterInfo.Username + "|" + index1 + "|" + sessionmembers.CharacterInfo.ShipHp + "|" + sessionmembers.CharacterInfo.ShipMaxHp + "|" + sessionmembers.CharacterInfo.ShipShield + "|" + sessionmembers.CharacterInfo.ShipMaxShield + "|" + +sessionmembers.CharacterInfo.MapId + "|0|0|0|0|" + sessionmembers.CharacterInfo.Invisible + "|0|0|" + sessionmembers.CharacterInfo.SelectedPlayer + "|0|" + sessionmembers.CharacterInfo.ShipId + "|0|1|";
                    } */
                    foreach (uint index2 in sessiontwo.CharacterInfo.Members.Keys)
                    {
                        Session sessionmembers2 = SessionManager.GetSessionByCharacterId(Convert.ToInt32(index2));
                        if (sessionmembers2.CharacterInfo.GroupLeader)
                            leader = index2;
                        if ((int)index2 != (int)index1)
                            str = str + sessionmembers2.CharacterInfo.Username + "|" + index2 + "|" + sessionmembers2.CharacterInfo.ShipHp + "|" + sessionmembers2.CharacterInfo.ShipMaxHp + "|" + sessionmembers2.CharacterInfo.ShipShield + "|" + sessionmembers2.CharacterInfo.ShipMaxShield + "|" + sessionmembers2.CharacterInfo.MapId + "|0|0|0|0|" + sessionmembers2.CharacterInfo.Invisible + "|0|0|" + sessionmembers2.CharacterInfo.SelectedPlayer + "|0|136|0|1|";
                    }
                    sessionmembers.SendData(PacketComposer.Compose("ps", "init|grp|1|1|1|1|1|" + str));
                    sessionmembers.SendData(PacketComposer.Compose("ps", "nl|" + leader));
                }
            }
            catch (Exception)
            { }
        }
        #endregion

        #region Invite Player
        private void InvitePlayer(Session Session, ClientMessage Message)
        {
            string uname = Message.GetNextString(3).ToLower();
            Session sessionByUsername = SessionManager.GetSessionByUsername(uname);

            if (sessionByUsername == null)
            {
                Session.SendData(PacketComposer.Compose("A", "STD|User doesn't exist or is not online!"));
                return;
            }
            else
            {
                var id = sessionByUsername.CharacterInfo.Id;
                Session sessiontwo = SessionManager.GetSessionByCharacterId(id);
                if (sessiontwo == null)
                {
                    Session.SendData(PacketComposer.Compose("A", "STD|Error with 'ENEMY' session"));
                    return;
                }
                try
                {
                    if (sessiontwo.CharacterInfo.Members.Count != 0)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD|User is already in a group!"));
                        return;
                    }
                    if (sessiontwo.CharacterInfo.Id == Session.CharacterInfo.Id)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD|You cant invite yourself!"));
                        return;
                    }
                    if (Session.CharacterInfo.InvitationSend.Contains(sessiontwo.CharacterInfo.Id))
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD|Tou already invited this player !"));
                        return;
                    }
                    if (Session.CharacterInfo.Blk == 0 && sessiontwo.CharacterInfo.Blk == 0)
                    {
                        sessiontwo.SendData(PacketComposer.Compose("ps", "inv|new|" + Session.CharacterInfo.Id + "|" + Session.CharacterInfo.Username + "|136|" + id));
                        Session.SendData(PacketComposer.Compose("ps", "inv|new|" + Session.CharacterInfo.Id + "|" + uname + "|136|" + id + "|" + uname + "|136"));
                        Session.SendData(PacketComposer.Compose("A", "STD|User " + uname + " invited!"));
                        sessiontwo.SendData(PacketComposer.Compose("A", "STD|You received invitation from " + Session.CharacterInfo.Username));
                        sessiontwo.CharacterInfo.InvitationReceive.Add(Session.CharacterInfo.Id);
                        Session.CharacterInfo.InvitationSend.Add(sessiontwo.CharacterInfo.Id);
                    }
                    else if (Session.CharacterInfo.Blk == 1 && sessiontwo.CharacterInfo.Blk == 1)
                    {
                        //invit for a duel
                    }
                    else if (sessiontwo.CharacterInfo.Blk == 1)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD| " + sessiontwo.CharacterInfo.Username + " activated his duel system and can't be  in a group !"));
                    }
                    else if (sessiontwo.CharacterInfo.Blk == 0)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD| " + sessiontwo.CharacterInfo.Username + " didn't activate his duel system !"));
                    }

                }
                catch (Exception)
                { }
            }
        }
        #endregion

        private static void closeGroup(Session session)
        {
            session.SendData(PacketComposer.Compose("ps", "end|"));
            session.CharacterInfo.Members.Clear();
            session.CharacterInfo.GroupLeader = false;
        }

        #region Group Updater
        public static void UpdateGroup(object state)
        {
            Session Session = (Session)state;
            try
            {
                if (Session.CharacterInfo.Members.Count > 1)
                {
                    foreach (int key in Session.CharacterInfo.Members.Keys)
                    {
                        Session sessiongroup = SessionManager.GetSessionByCharacterId(key);
                        if (sessiongroup == null || sessiongroup.CharacterInfo == null)
                        {
                            Session.CharacterInfo.Members.Remove(key);
                            if (Session.CharacterInfo.Members.Count <= 1)
                                GroupManager.closeGroup(Session);
                            UpdateGroup(Session);
                            return;
                        }
                        if (sessiongroup.Stopped)
                        {
                            List<int> list = new List<int>();
                            Session.SendData(PacketComposer.Compose("ps", "lp|lv|" + sessiongroup.CharacterInfo.Id));

                            if (sessiongroup.CharacterInfo.GroupLeader)
                            {
                                sessiongroup.CharacterInfo.GroupLeader = false;

                                foreach (int num in sessiongroup.CharacterInfo.Members.Keys)
                                {
                                    Session sessionNewleader = SessionManager.GetSessionByCharacterId(num);

                                    if (sessionNewleader.CharacterInfo.Id != sessiongroup.CharacterInfo.Id)
                                    {
                                        sessionNewleader.CharacterInfo.GroupLeader = true;
                                        foreach (int index in sessiongroup.CharacterInfo.Members.Keys)
                                        {
                                            Session sessionByIndex = SessionManager.GetSessionByCharacterId(index);
                                            sessionByIndex.SendData(PacketComposer.Compose("ps", "nl|" + sessionNewleader.CharacterInfo.Id)); // send the player that hes now the leader
                                        }
                                        break;
                                    }
                                }
                            }
                            sessiongroup.CharacterInfo.Members.Clear();
                            Session.CharacterInfo.Members.Remove(sessiongroup.CharacterInfo.Id);
                        }
                        else
                        {
                            string str = "<1 hp=\"" + sessiongroup.CharacterInfo.ShipHp + "\" hpM=\"" + sessiongroup.CharacterInfo.ShipMaxHp + "\" sh=\"" + sessiongroup.CharacterInfo.ShipShield + "\"  shM=\"" + sessiongroup.CharacterInfo.ShipMaxShield + "\"  tgt=\"" + sessiongroup.CharacterInfo.SelectedPlayer + "\"  fgt=\"" + GeneralFunctions.ToEnum(sessiongroup.CharacterInfo.Attacking) + "\"  map=\"" + sessiongroup.CharacterInfo.MapId + "\" act=\"" + sessiongroup.CharacterInfo.Destroy + "\" clk=\"" + sessiongroup.CharacterInfo.Invisible + "\"></1>";
                            Session.SendData(PacketComposer.Compose("ps", "upd|" + key + "|" + str));
                        }
                    }
                    if (Session.CharacterInfo.Members.Count <= 1)
                        GroupManager.closeGroup(Session);
                }
                GroupManager.UpdateInvitiation(Session);
            }
            catch
            {
            }
        }
        #endregion

        private static void UpdateInvitiation(Session Session)
        {
            foreach (int num in Session.CharacterInfo.InvitationSend.Keys)
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(num);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null || sessionByCharacterId.Stopped)
                {
                    Session.SendData(PacketComposer.Compose("ps", "inv|del|none|" + Session.CharacterInfo.Id + "|" + num));
                    Session.CharacterInfo.InvitationSend.Remove(num);
                }
            }
            foreach (int num in Session.CharacterInfo.InvitationReceive.Keys)
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(num);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null || sessionByCharacterId.Stopped)
                {
                    Session.SendData(PacketComposer.Compose("ps", "inv|del|none|" + num));
                    Session.CharacterInfo.InvitationReceive.Remove(num);
                }
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\Groupsystem.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Sessions;
using System;
using System.Collections.Generic;
namespace OrbitReborn_Emulator.Game.Handlers
{
    class Groupsystem
    {
        public static void Initialize()
        {
            GroupManager group = new GroupManager();
            DataRouter.RegisterHandler("ps", new ProcessRequestCallback(group.Monitor), false);
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\Handshake.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Handlers.Handshake
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Specialized;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Handlers
{
    public static class Handshake
    {
        public static void Initialize()
        {
            DataRouter.RegisterHandler("LOGIN", new ProcessRequestCallback(Handshake.GetUserInfo), true);
        }

        private static void GetUserInfo(Session Session, ClientMessage Message)
        {
            string nextString = Message.GetNextString(2);
            Session.TryAuthenticate(nextString, Session.RemoteAddress);
            if (!Session.Authenticated)
                return;
            Output.WriteLine("LOGIN OK pour ticket " + nextString + " depuis " + Session.RemoteAddress, OutputLevel.Notification);
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                Session.CharacterInfo.RefreshSettings(client);
                Session.CharacterInfo.RefreshUserData(client);
                Session.CharacterInfo.RefreshClan(client);
                Session.CharacterInfo.NpcInRange.Clear();
                foreach (int key in (IEnumerable<int>)Session.CharacterInfo.PlayerInRange.Keys)
                {
                    Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key);
                    if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                    {
                        sessionByCharacterId.CharacterInfo.PlayerInRange.Remove(Session.CharacterId);
                        sessionByCharacterId.SendData(MapUserLeaveComposer.Compose(Session.CharacterId));
                    }
                }
                Session.CharacterInfo.PlayerInRange.Clear();
            }
            Session.CharacterInfo.AuthTicket = nextString;
            Session.CharacterInfo.Disconnected = false;
            MapManager.RemoveUserFromMap(Session);
            Session.SendData(PacketComposer.Compose("A", "SET|" + Session.CharacterInfo.Settings.Set));
            Session.SendData(PacketComposer.Compose("7", "CLIENT_RESOLUTION|" + Session.CharacterInfo.Settings.ClientResolution));
            Session.SendData(PacketComposer.Compose("7", "MINIMAP_SCALE," + Session.CharacterInfo.Settings.MinimapScale));
            Session.SendData(PacketComposer.Compose("7", "RESIZABLE_WINDOWS," + Session.CharacterInfo.Settings.ResizableWindows));
            Session.SendData(PacketComposer.Compose("7", "DISPLAY_PLAYER_NAMES|" + (object)Session.CharacterInfo.Settings.DisplayPlayerNames));
            Session.SendData(PacketComposer.Compose("7", "DISPLAY_CHAT|" + (object)Session.CharacterInfo.Settings.DisplayChat));
            Session.SendData(PacketComposer.Compose("7", "PLAY_MUSIC|0"));
            Session.SendData(PacketComposer.Compose("7", "PLAY_SFX|0"));
            Session.SendData(PacketComposer.Compose("7", "BAR_STATUS|" + Session.CharacterInfo.Settings.BarStatus));
            Session.SendData(PacketComposer.Compose("7", "WINDOW_SETTINGS," + Session.CharacterInfo.Settings.WindowSettings));
            Session.SendData(PacketComposer.Compose("7", "AUTO_REFINEMENT|" + (object)Session.CharacterInfo.Settings.AutoRefinement));
            Session.SendData(PacketComposer.Compose("7", "QUICKSLOT_STOP_ATTACK|" + (object)Session.CharacterInfo.Settings.QuickSlotStopAttack));
            Session.SendData(PacketComposer.Compose("7", "DOUBLECLICK_ATTACK|" + (object)Session.CharacterInfo.Settings.DoubleClickAttack));
            Session.SendData(PacketComposer.Compose("7", "AUTO_START|" + (object)Session.CharacterInfo.Settings.AutoStart));
            Session.SendData(PacketComposer.Compose("7", "DISPLAY_NOTIFICATIONS|" + (object)Session.CharacterInfo.Settings.DisplayNotification));
            Session.SendData(PacketComposer.Compose("7", "SHOW_DRONES|" + (object)Session.CharacterInfo.Settings.ShowDrones));
            Session.SendData(PacketComposer.Compose("7", "DISPLAY_WINDOW_BACKGROUND|" + (object)Session.CharacterInfo.Settings.DisplayWindowBackground));
            Session.SendData(PacketComposer.Compose("7", "ALWAYS_DRAGGABLE_WINDOWS|" + (object)Session.CharacterInfo.Settings.AlwaysDraggableWindows));
            Session.SendData(PacketComposer.Compose("7", "PRELOAD_USER_SHIPS|" + (object)Session.CharacterInfo.Settings.PreloadUserShips));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_PRESETTING|" + (object)Session.CharacterInfo.Settings.QualityPresseting));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_CUSTOMIZED|" + (object)Session.CharacterInfo.Settings.QualityCustomized));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_BACKGROUND|" + (object)Session.CharacterInfo.Settings.QualityBackground));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_POIZONE|" + (object)Session.CharacterInfo.Settings.QualityPoizone));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_SHIP|" + (object)Session.CharacterInfo.Settings.QualityShip));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_ENGINE|" + (object)Session.CharacterInfo.Settings.QualityEngine));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_COLLECTABLE|" + (object)Session.CharacterInfo.Settings.QualityCollectable));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_ATTACK|" + (object)Session.CharacterInfo.Settings.QualityAttack));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_EFFECT|" + (object)Session.CharacterInfo.Settings.QualityEffect));
            Session.SendData(PacketComposer.Compose("7", "QUALITY_EXPLOSION|" + (object)Session.CharacterInfo.Settings.QualityExplosion));
            Session.SendData(PacketComposer.Compose("7", "QUICKBAR_SLOT|" + Session.CharacterInfo.Settings.QuickbarSlot));
            Session.SendData(PacketComposer.Compose("7", "SLOTMENU_POSITION," + Session.CharacterInfo.Settings.SlotmenuPosition));
            Session.SendData(PacketComposer.Compose("7", "SLOTMENU_ORDER," + Session.CharacterInfo.Settings.SlotmenuOrder));
            Session.SendData(PacketComposer.Compose("7", "MAINMENU_POSITION," + Session.CharacterInfo.Settings.MainmenuPosition));
            MapHandler.OpenPublicConnection(Session, Session.CharacterInfo.MapId, (PortalInfo)null);
            Session.SendData(PacketComposer.Compose("B", "200|200|200|9000000|9000000|9000000"));
            Session.SendData(PacketComposer.Compose("3", "0|0|100000|0|0|0|0|0|100000|100000|100000|0|0|0"));
            Session.SendData(PacketComposer.Compose("7", "HS"));
            Session.SendData(PacketComposer.Compose("S", "CFG|1"));
            Session.SendData(PacketComposer.Compose("A", "ITM|0|0|0|0|4|0|0|1|1|0|1|0|2|0|0|0"));
            Session.SendData(PacketComposer.Compose("A", "CPU|C|" + (object)100));
            Session.SendData(PacketComposer.Compose("TX", "S|0|0|0|0|0|0|0|0|0|1|0|0|1|0|0"));
            Session.SendData(PacketComposer.Compose("m", "1|1000|1000"));
            Session.SendData(Session.CharacterInfo.GetCargoMessage());
            int num1 = 0;
            int num2 = 0;
            int num3 = 0;
            int num4 = 0;
            int totalSeconds = (int)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;
            if (Session.CharacterInfo.BoosterDmgTime > totalSeconds)
                num1 = 100;
            if (Session.CharacterInfo.BoosterHpTime > totalSeconds)
                num2 = 100;
            if (Session.CharacterInfo.BoosterShdTime > totalSeconds)
                num3 = 100;
            if (Session.CharacterInfo.BoosterNpcTime > totalSeconds)
                num4 = 50;
            Session.SendData(PacketComposer.Compose("A", "BS|" + (object)num4 + "/0/" + (object)num1 + "/" + (object)num3 + "/0/0/0/" + (object)num2));
            Session.SendData(PacketComposer.Compose("A", "JV|0"));
            Session.SendData(PacketComposer.Compose("A", "BK|" + (object)Session.CharacterInfo.BootyKeys));
            Session.SendData(PacketComposer.Compose("POI", "RDY"));
            Session.SendData(PacketComposer.Compose("A", "STD|~~~ Andromeda ~~~"));
            Session.CharacterInfo.SendCollectibles(Session);
            Session.SendData(PacketComposer.Compose("A", "CLD|ISH|" + (object)Session.CharacterInfo.CoolDownISH));
            Session.SendData(PacketComposer.Compose("A", "CLD|SMB|" + (object)Session.CharacterInfo.CoolDownSMB));
            Session.SendData(PacketComposer.Compose("CSS", "1"));
            Session.SendData(PacketComposer.Compose("SMP", "1|1"));
            // Session.SendData(PacketComposer.Compose("UI", "W|HW|23"));
            Session.SendData(PacketComposer.Compose("UI", "W|HW|10"));
            Spaceball.ShowHud(Session);
            Session.CharacterInfo.WarningZone = false;
            if (Session.CharacterInfo.WarningZoneTimer != null)
            {
                Session.CharacterInfo.WarningZoneTimer.Dispose();
                --TimerManager.TimerRunning;
                Session.CharacterInfo.WarningZoneTimer = (Timer)null;
            }
            ShipMovement.CheckWarningZone(Session);
            Session.CharacterInfo.PeaceZone = false;
            ShipMovement.CheckPeaceZone(Session);
            Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
            Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
            Session.CharacterInfo.RandomDamage = new Random();
            Session.CharacterInfo.Destroy = false;
            Session.CharacterInfo.Attacking = false;
            Session.CharacterInfo.LaserAttackCanTimer = new Timer(new TimerCallback(Fight.CanAttack), (object)Session, 1000, 0);
            Session.CharacterInfo.OutOfRange = false;
            Session.CharacterInfo.CanMove = true;
            Session.CharacterInfo.NoFightTimer = 0;
            ShipMovement.CheckAliensInRange((object)Session);
            ShipMovement.CheckPlayerInRange((object)Session);
            if (Session.CharacterInfo.UpdateGroupTimer != null)
                Session.CharacterInfo.UpdateGroupTimer.Dispose();
            Session.CharacterInfo.UpdateGroupTimer = new System.Threading.Timer(new TimerCallback(GroupManager.UpdateGroup), (object)Session, (int)0, 1000);
            if (Session.CharacterInfo.MapId == 83 || _1v1.IsOnMap(Session.CharacterInfo.MapId))
            {
                Fight.KillPlayer(Session, true);
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\Laboratory.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Handlers.Laboratory
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;

namespace OrbitReborn_Emulator.Game.Handlers
{
    public static class Laboratory
    {
        public static void Initialize()
        {
            DataRouter.RegisterHandler("T", new ProcessRequestCallback(Laboratory.SellOre), false);
            DataRouter.RegisterHandler("LAB", new ProcessRequestCallback(Laboratory.Lab), false);
            DataRouter.RegisterHandler("b", new ProcessRequestCallback(Laboratory.GetOrePrices), false);
        }

        private static void ProdReff(Session Session, ClientMessage Message)
        {
            long nextInt1 = (long)Message.GetNextInt(3);
            int nextInt2 = (int)Message.GetNextInt(4);

            if (nextInt1 < 0 || nextInt2 < 0)
                return;

            if (nextInt2 > 20000)
                Session.SendData(PacketComposer.Compose("A", "STD|Can't create more than 20.000 units at once."));
            else if (nextInt1 == 11L && Session.CharacterInfo.LabInfos.GetCargo(1L) >= 20 * nextInt2 && Session.CharacterInfo.LabInfos.GetCargo(2L) >= 10 * nextInt2)
            {
                if (Session.CharacterInfo.GetUpdatedCredits() > nextInt2 * 100000L)
                {
                    Session.CharacterInfo.RemoveReward(nextInt2 * 100000L, 0L);
                    Session.SendData(PacketComposer.Compose("y", "CRE|-" + (object)(nextInt2 * 100000L) + "|" + (object)Session.CharacterInfo.Credits));
                    Session.CharacterInfo.RemoveCargo(1L, 20 * nextInt2);
                    Session.CharacterInfo.RemoveCargo(2L, 10 * nextInt2);
                    Session.CharacterInfo.AddCargo(11L, nextInt2);
                    Session.SendData(Session.CharacterInfo.GetCargoMessage());
                }
                else
                    Session.SendData(PacketComposer.Compose("A", "STD|Not enought credits."));
            }
            else if (nextInt1 == 12L && Session.CharacterInfo.LabInfos.GetCargo(3L) >= 20L * nextInt2 && Session.CharacterInfo.LabInfos.GetCargo(2L) >= 10L * nextInt2)
            {
                if (Session.CharacterInfo.GetUpdatedCredits() > nextInt2 * 100000L)
                {
                    Session.CharacterInfo.RemoveReward(nextInt2 * 100000L, 0L);
                    Session.SendData(PacketComposer.Compose("y", "CRE|-" + (object)(nextInt2 * 100000L) + "|" + (object)Session.CharacterInfo.Credits));
                    Session.CharacterInfo.RemoveCargo(3L, 20 * nextInt2);
                    Session.CharacterInfo.RemoveCargo(2L, 10 * nextInt2);
                    Session.CharacterInfo.AddCargo(12L, nextInt2);
                    Session.SendData(Session.CharacterInfo.GetCargoMessage());
                }
                else
                    Session.SendData(PacketComposer.Compose("A", "STD|Not enought credits."));
            }
            else
            {
                if (nextInt1 != 13L || Session.CharacterInfo.LabInfos.GetCargo(11L) < 10L * nextInt2 || Session.CharacterInfo.LabInfos.GetCargo(12L) < 10L * nextInt2 || Session.CharacterInfo.LabInfos.GetCargo(4L) < nextInt2)
                    return;
                if (Session.CharacterInfo.GetUpdatedUridium() > nextInt2 * 1000L)
                {
                    Session.CharacterInfo.RemoveReward(0L, nextInt2 * 1000L);
                    Session.SendData(PacketComposer.Compose("y", "URI|-" + (object)(nextInt2 * 1000L) + "|" + (object)Session.CharacterInfo.Uridium));
                    Session.CharacterInfo.RemoveCargo(11L, 10 * nextInt2);
                    Session.CharacterInfo.RemoveCargo(12L, 10 * nextInt2);
                    Session.CharacterInfo.RemoveCargo(4L, nextInt2);
                    Session.CharacterInfo.AddCargo(13L, nextInt2);
                    Session.SendData(Session.CharacterInfo.GetCargoMessage());
                }
                else
                    Session.SendData(PacketComposer.Compose("A", "STD|Not enought credits."));
            }
        }

        private static void AddReff(Session Session, ClientMessage Message)
        {
            int nextInt1 = Message.GetNextInt(4);
            int nextInt2 = Message.GetNextInt(5);
            if (nextInt1 < 0 || nextInt2 < 0)
            {
                return;
            }
            if (Message.GetNextString(3) == "LASER")
            {
                if (Session.CharacterInfo.LabInfos.GetCargo((long)nextInt1) < nextInt2)
                    return;
                Session.CharacterInfo.AddLaserReff(nextInt1, nextInt2);
                Session.CharacterInfo.RemoveCargo((long)nextInt1, nextInt2);
                Session.SendData(Session.CharacterInfo.GetCargoMessage());
                Session.SendData(Session.CharacterInfo.GetReffMessage());
            }
            else if (Message.GetNextString(3) == "ROCKET")
            {
                if (Session.CharacterInfo.LabInfos.GetCargo((long)nextInt1) < nextInt2)
                    return;
                Session.CharacterInfo.AddRocketReff(nextInt1, nextInt2);
                Session.CharacterInfo.RemoveCargo((long)nextInt1, nextInt2);
                Session.SendData(Session.CharacterInfo.GetCargoMessage());
                Session.SendData(Session.CharacterInfo.GetReffMessage());
            }
            else if (Message.GetNextString(3) == "SHIELD")
            {
                if (Session.CharacterInfo.LabInfos.GetCargo((long)nextInt1) < nextInt2)
                    return;
                Session.CharacterInfo.AddShieldReff(nextInt1, nextInt2);
                Session.SendData(PacketComposer.Compose("A", "v|" + (object)Session.CharacterInfo.ShipSpeed));
                Session.SendData(PacketComposer.Compose("A", "SHD|" + (object)Session.CharacterInfo.ShipShield + "|" + (object)Session.CharacterInfo.ShipMaxShield));
                Session.CharacterInfo.RemoveCargo((long)nextInt1, nextInt2);
                Session.SendData(Session.CharacterInfo.GetCargoMessage());
                Session.SendData(Session.CharacterInfo.GetReffMessage());
            }
            else if (Message.GetNextString(3) == "DRIVING")
            {
                if (Session.CharacterInfo.LabInfos.GetCargo((long)nextInt1) < nextInt2)
                    return;
                Session.CharacterInfo.AddSpeedReff(nextInt1, nextInt2);
                Session.CharacterInfo.RemoveCargo((long)nextInt1, nextInt2);
                Session.SendData(Session.CharacterInfo.GetCargoMessage());
                Session.SendData(Session.CharacterInfo.GetReffMessage());
            }
            else
                Output.WriteLine((object)(Message.GetNextString(3) + " : " + (object)nextInt1 + " -> " + (object)nextInt2));
        }

        private static void Lab(Session Session, ClientMessage Message)
        {
            if (Message.GetNextString(1) == "REF")
            {
                if (Message.GetNextString(2) == "PROD")
                    Laboratory.ProdReff(Session, Message);
                else
                    Output.WriteLine("Lab REF:" + (object)Message.ToString());
            }
            else if (Message.GetNextString(1) == "UPD")
            {
                if (Message.GetNextString(2) == "SET")
                {
                    Laboratory.AddReff(Session, Message);
                }
                else
                {
                    if (!(Message.GetNextString(2) == "GET"))
                        return;
                    Session.SendData(Session.CharacterInfo.GetCargoMessage());
                    Session.SendData(Session.CharacterInfo.GetReffMessage());
                }
            }
            else
                Output.WriteLine("Lab PROD :" + (object)Message.ToString());
        }

        private static int GetPrice(int iResId)
        {
            if (iResId == 1 || iResId == 2 || iResId == 3)
                return 800;
            return iResId == 11 || iResId == 12 || iResId == 13 ? 50000 : 0;
        }

        private static void SellOre(Session Session, ClientMessage Message)
        {
            int nextInt1 = Message.GetNextInt(1);
            int nextInt2 = Message.GetNextInt(2);
            if (nextInt2 > Session.CharacterInfo.LabInfos.GetCargo((long)nextInt1))
                return;
            int credits = nextInt2 * Laboratory.GetPrice(nextInt1);
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                Session.CharacterInfo.RemoveCargo((long)nextInt1, nextInt2);
                Session.SendData(Session.CharacterInfo.GetCargoMessage());
                Session.CharacterInfo.AddReward(client, credits, 0, 0, false);
                Session.SendData(PacketComposer.Compose("y", "CRE|" + (object)credits + "|" + (object)Session.CharacterInfo.Credits));
            }
        }

        private static void GetOrePrices(Session Session, ClientMessage Message)
        {
            Session.SendData(PacketComposer.Compose("g", Laboratory.GetPrice(1).ToString() + "|" + (object)Laboratory.GetPrice(2) + "|" + (object)Laboratory.GetPrice(3) + "|" + (object)Laboratory.GetPrice(11) + "|" + (object)Laboratory.GetPrice(12) + "|" + (object)Laboratory.GetPrice(13)));
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\Others.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Handlers.Others
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Maps.Collectables;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Specialized;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Handlers
{
    public static class Others
    {
        public static List<int> invasionPortal = new List<int>();
        public static void Initialize()
        {
            Others.invasionPortal.Add(204);
            Others.invasionPortal.Add(205);
            Others.invasionPortal.Add(206);
            DataRouter.RegisterHandler("l", new ProcessRequestCallback(Others.Logout), false);
            DataRouter.RegisterHandler("o", new ProcessRequestCallback(Others.LogoutCancel), false);
            DataRouter.RegisterHandler("j", new ProcessRequestCallback(Others.PortalJump), false);
            DataRouter.RegisterHandler("PNG", new ProcessRequestCallback(Others.ErrorSupressor), false);
            DataRouter.RegisterHandler("RDY", new ProcessRequestCallback(Others.ErrorSupressor), false);
            DataRouter.RegisterHandler("5", new ProcessRequestCallback(Others.ErrorSupressor), false);
            DataRouter.RegisterHandler("i", new ProcessRequestCallback(Others.ErrorSupressor), false);
            DataRouter.RegisterHandler("bx", new ProcessRequestCallback(Others.ErrorSupressor), false);
            DataRouter.RegisterHandler("x", new ProcessRequestCallback(Others.CollectBox), false);
        }

        private static void ErrorSupressor(Session Session, ClientMessage Message)
        {
        }

        private static void CollectBox(Session Session, ClientMessage Message)
        {
            int nextInt = Message.GetNextInt(1);
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CharacterInfo.MapId);
            if (!instanceByMapId.Info.Collectables.ContainsKey(nextInt))
                return;
            Collectable collectable = instanceByMapId.Info.Collectables[nextInt];
            if (collectable == null)
                Session.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
            else
                collectable.Collect(Session);
        }

        private static void Logout(Session Session, ClientMessage Message)
        {
            if (Session.IsChat)
                return;
            if (Session.CharacterInfo.DisconnectTimer != null)
            {
                Session.CharacterInfo.DisconnectTimer.Dispose();
                --TimerManager.TimerRunning;
                Session.CharacterInfo.DisconnectTimer = (Timer)null;
            }
            if (Session.CharacterInfo.WarningZone || Session.CharacterInfo.Attacked.Count > 0 || Session.CharacterInfo.Attacking)
            {
                Session.SendData(PacketComposer.Compose("t", ""));
            }
            else
            {
                Session.CharacterInfo.DisconnectCounter = 0;
                Session.CharacterInfo.DisconnectTimer = new Timer(new TimerCallback(Others.LogoutTimer), (object)Session, 0, 1000);
                ++TimerManager.TimerRunning;
            }
        }

        private static void LogoutTimer(object state)
        {
            Session Session = (Session)state;
            if (Session.CharacterInfo.Disconnected || Session.StoppedPlayer || Session.CharacterInfo.Destroy)
            {
                if (Session.CharacterInfo.DisconnectTimer == null)
                    return;
                Session.CharacterInfo.DisconnectTimer.Dispose();
                --TimerManager.TimerRunning;
                Session.CharacterInfo.DisconnectTimer = (Timer)null;
            }
            else if (Session.CharacterInfo.WarningZone || Session.CharacterInfo.Attacked.Count > 0 || Session.CharacterInfo.Attacking)
            {
                if (Session.CharacterInfo.DisconnectTimer != null)
                {
                    Session.CharacterInfo.DisconnectTimer.Dispose();
                    --TimerManager.TimerRunning;
                    Session.CharacterInfo.DisconnectTimer = (Timer)null;
                }
                Session.SendData(PacketComposer.Compose("t", ""));
            }
            else if (Session.CharacterInfo.DisconnectCounter == 5)
            {
                if (Session.CharacterInfo.DisconnectTimer != null)
                {
                    Session.CharacterInfo.DisconnectTimer.Dispose();
                    --TimerManager.TimerRunning;
                    Session.CharacterInfo.DisconnectTimer = (Timer)null;
                }
                Session.CharacterInfo.Disconnected = true;
                foreach (int key in (IEnumerable<int>)Session.CharacterInfo.PlayerInRange.Keys)
                {
                    Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key);
                    if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                    {
                        sessionByCharacterId.CharacterInfo.PlayerInRange.Remove(Session.CharacterId);
                        sessionByCharacterId.SendData(MapUserLeaveComposer.Compose(Session.CharacterId));
                    }
                }
                MapManager.RemoveUserFromMap(Session);
                if (TeamDeathMatch.IsActive())
                    TeamDeathMatch.removeUserFromTdm(Session);
                SessionManager.StopSession(Session.Id);
            }
            else
                ++Session.CharacterInfo.DisconnectCounter;
        }

        private static void LogoutCancel(Session Session, ClientMessage Message)
        {
            if (Session.CharacterInfo.DisconnectTimer != null)
            {
                Session.CharacterInfo.DisconnectTimer.Dispose();
                --TimerManager.TimerRunning;
                Session.CharacterInfo.DisconnectTimer = (Timer)null;
            }
            Session.SendData(PacketComposer.Compose("t", ""));
        }

        private static void PortalJump(Session Session, ClientMessage Message)
        {
            bool canJump = true;
            if (MapManager.GetInstanceByMapId(Session.CurrentMapId) == null || (Session.CharacterInfo.CurrentPortal == 0 || Session.CharacterInfo.IsJumping || !Session.CharacterInfo.PortalZone))
                return;
            if (Session.CharacterInfo.PortalJumpTimer != null)
                Session.CharacterInfo.PortalJumpTimer.Dispose();
            PortalInfo portalById1 = PortalManager.GetPortalById(Session.CharacterInfo.CurrentPortal);
            PortalInfo portalById2 = PortalManager.GetPortalById(portalById1.LinkedId);
            if (Session.CharacterInfo.Attacked.Count > 0 || UnixTimestamp.GetCurrent() - Session.CharacterInfo.LastAttackByAttackerReceived < 3.0)
            {
                Session.SendData(PacketComposer.Compose("A", "STD|You can't jump if you are under attack!"));
            }
            else
            {
                canJump = checkCanJump(Session, portalById1);
                if (canJump)
                {
                    Session.CharacterInfo.IsJumping = true;
                    if (Others.invasionPortal.Contains(portalById1.Id))
                        Session.SendData(PacketComposer.Compose("U", "81|" + (object)portalById1.Id));
                    else
                        Session.SendData(PacketComposer.Compose("U", portalById2.MapId.ToString() + "|" + (object)portalById1.Id));
                    Session.CharacterInfo.PortalJumpTimer = new Timer(new TimerCallback(Others.ChangeMap), (object)Session, 3000, 0);
                    ++TimerManager.TimerRunning;
                }
            }
        }

        private static bool checkCanJump(Session Session, PortalInfo portal)
        {
            switch (portal.Id)
            {
                case 204:
                case 205:
                case 206:
                    if (!Invasion.Active)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD|Invasion isn't active !"));
                        return false;
                    }
                    return true;
                case 201:
                    if (Session.CharacterInfo.FactionId != 1)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD|Only MMO can jump this portal !"));
                        return false;
                    }
                    return true;
                case 202:
                    if (Session.CharacterInfo.FactionId != 2)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD|Only EIC can jump this portal !"));
                        return false;
                    }
                    return true;
                case 203:
                    if (Session.CharacterInfo.FactionId != 3)
                    {
                        Session.SendData(PacketComposer.Compose("A", "STD|Only VRU can jump this portal !"));
                        return false;
                    }
                    return true;
                default:
                    return true;
            }
        }

        private static void ChangeMap(object state)
        {
            Session session = (Session)state;
            if (session == null)
                return;
            if (MapManager.GetInstanceByMapId(session.CurrentMapId) == null)
            {
                if (session.CharacterInfo.PortalJumpTimer != null)
                    session.CharacterInfo.PortalJumpTimer.Dispose();
                session.CharacterInfo.IsJumping = false;
                session.CharacterInfo.CanMove = true;
                session.SendData(UserDataComposer.Compose(session));
            }
            else if (session.CharacterInfo.Attacked.Count > 0 || UnixTimestamp.GetCurrent() - session.CharacterInfo.LastAttackByAttackerReceived < 3.0)
            {
                session.SendData(PacketComposer.Compose("A", "STD|Jump canceled, you are under attack!"));
                session.CharacterInfo.IsJumping = false;
                session.CharacterInfo.CanMove = true;
                session.SendData(UserDataComposer.Compose(session));
                if (session.CharacterInfo.PortalJumpTimer == null)
                    return;
                session.CharacterInfo.PortalJumpTimer.Dispose();
            }
            else
            {
                PortalInfo portalById = PortalManager.GetPortalById(PortalManager.GetPortalById(session.CharacterInfo.CurrentPortal).LinkedId);
                session.CharacterInfo.CanMove = false;
                if (session.CharacterInfo.PathFinding != null)
                {
                    session.CharacterInfo.PathFinding.Dispose();
                    session.CharacterInfo.IsMoving = false;
                    session.CharacterInfo.LastMove.Stop();
                }
                if (session.CharacterInfo.PathTime != null)
                    session.CharacterInfo.PathTime.Dispose();
                if (Others.invasionPortal.Contains(session.CharacterInfo.CurrentPortal))
                    MapHandler.OpenPublicConnection(session, 81, null);
                else
                    MapHandler.OpenPublicConnection(session, portalById.MapId, portalById);
                session.CharacterInfo.IsJumping = false;
                session.CharacterInfo.CanMove = true;
                session.CharacterInfo.SendCollectibles(session);
                if (session.CharacterInfo.PortalJumpTimer == null)
                    return;
                session.CharacterInfo.PortalJumpTimer.Dispose();
                --TimerManager.TimerRunning;
                session.CharacterInfo.PortalJumpTimer = (Timer)null;
            }
        }

    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\SelectAction.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Handlers.SelectAction
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Misc;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using System;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Handlers
{
    public static class SelectAction
    {
        public static void Initialize()
        {
            DataRouter.RegisterHandler("S", new ProcessRequestCallback(SelectAction.Select), false);
        }

        private static void ChangeCfg(Session Session, ClientMessage Message)
        {
            int result;
            if (!int.TryParse(Message.GetNextString(2), out result))
                return;
            if (new CList<int>() { 1, 2 }.Contains(result) && Session.CharacterInfo.CanChangeConfig)
            {
                Session.CharacterInfo.ActiveConfig = result;
                Session.CharacterInfo.LastConfigChange = UnixTimestamp.GetCurrent();
                Session.SendData(PacketComposer.Compose("S", "CFG|" + (object)result));
                Session.SendData(PacketComposer.Compose("A", "v|" + (object)Session.CharacterInfo.ShipSpeed));
                Session.SendData(PacketComposer.Compose("A", "SHD|" + (object)Session.CharacterInfo.ShipShield + "|" + (object)Session.CharacterInfo.ShipMaxShield));
                if (Session.CharacterInfo.IsMoving && (Session.CharacterInfo.NewLocX != Session.CharacterInfo.LocX || Session.CharacterInfo.NewLocY != Session.CharacterInfo.LocY))
                {
                    double num = Math.Sqrt(Math.Pow((double)(Session.CharacterInfo.LocX - Session.CharacterInfo.NewLocX), 2.0) + Math.Pow((double)(Session.CharacterInfo.LocY - Session.CharacterInfo.NewLocY), 2.0));
                    if (num >= 50.0 && (Session.CharacterInfo.NewLocX <= 22000 && Session.CharacterInfo.NewLocX >= -1000 && Session.CharacterInfo.NewLocY <= 14000 && Session.CharacterInfo.NewLocY >= -1000))
                    {
                        double TimeTaken = num * 1000.0 / (double)Session.CharacterInfo.ShipSpeed;
                        foreach (int key in (IEnumerable<int>)Session.CharacterInfo.PlayerInRange.Keys)
                        {
                            Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key);
                            if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                                sessionByCharacterId.SendData(MapShipMovementComposer.Compose(Session.CharacterId, Session.CharacterInfo.NewLocX, Session.CharacterInfo.NewLocY, TimeTaken));
                        }
                    }
                }
            }
            else
                Session.SendData(PacketComposer.Compose("A", "STD|You must wait 4 seconds between each config change."));
        }

        private static void UseRob(Session Session)
        {
            if (Session.CharacterInfo.AttackingRepBug)
            {
                if (Session.CharacterInfo.RepairTimer == null)
                    return;
                Session.CharacterInfo.RepairTimer.Dispose();
                return;
            }
            if (!Session.CharacterInfo.IsMoving && Session.CharacterInfo.Attacked.Count == 0 && (!Session.CharacterInfo.AttackingRepBug && !Session.CharacterInfo.WarningZone) && !Session.CharacterInfo.IsRepairing && Session.CharacterInfo.NoFightTimer >= 6)
            {
                if (Session.CharacterInfo.RepairTimer != null)
                    Session.CharacterInfo.RepairTimer.Dispose();
                Session.CharacterInfo.IsRepairing = true;
                if (Session.CharacterInfo.RepairBotHp == 30000)
                    Session.SendData(PacketComposer.Compose("A", "RS|1"));
                else
                    Session.SendData(PacketComposer.Compose("A", "RS|0"));
                Session.SendData(PacketComposer.Compose("D", Session.CharacterInfo.LocX.ToString() + "|" + (object)Session.CharacterInfo.LocY + "|0|1|1|0|0|0"));
                Session.CharacterInfo.RepairTimer = new Timer(new TimerCallback(SelectAction.RepairTimer), (object)Session, 0, 1000);
            }
            else if (Session.CharacterInfo.IsRepairing)
                return;
        }

        private static void UseIsh(Session Session)
        {
            if (Session.CharacterInfo.CoolDownISH > 0 || Session.CharacterInfo.ActiveISH)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "ISH|" + (object)Session.CharacterId), false);
            Session.CharacterInfo.LastISH = UnixTimestamp.GetCurrent();
            Session.SendData(PacketComposer.Compose("A", "CLD|ISH|" + (object)Session.CharacterInfo.CoolDownISH));
        }

        private static void UseSmb(Session Session)
        {
            if (!PvpManager.PvpEnabled || (Session == null || Session.CharacterInfo == null || Session.CharacterInfo.CoolDownSMB > 0) || Session.CharacterInfo.MapId == 81 && Invasion.Active && Invasion.SafeBattle)
                return;
            if (Session.CharacterInfo.MapId == 83 && TeamDeathMatch.SafeBattle())
                return;
            if (_1v1.IsOnMap(Session.CharacterInfo.MapId) && _1v1.isSafeBattle(Session.CharacterInfo.MapId) == true)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "SMB|" + (object)Session.CharacterId), false);
            Session.CharacterInfo.LastSMB = UnixTimestamp.GetCurrent();
            Session.SendData(PacketComposer.Compose("A", "CLD|SMB|" + (object)Session.CharacterInfo.CoolDownSMB));
            Session.CharacterInfo.PeaceZone = false;
            foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                if (key.Type == MapActorType.UserCharacter && key.ReferenceId != Session.CharacterId)
                {
                    Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key.ReferenceId);
                    if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null && (!sessionByCharacterId.CharacterInfo.ActiveISH && !sessionByCharacterId.CharacterInfo.PeaceZone && Math.Sqrt(Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocX - Session.CharacterInfo.LocX), 2.0) + Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocY - Session.CharacterInfo.LocY), 2.0)) < 600.0))
                    {
                        int smbDamages = Session.CharacterInfo.SmbDamages;
                        if (sessionByCharacterId.CharacterInfo.ShipHp - smbDamages > 0)
                        {
                            sessionByCharacterId.CharacterInfo.ShipHp -= smbDamages;
                            Session.SendData(PacketComposer.Compose("Y", "0|" + (object)sessionByCharacterId.CharacterId + "|L|" + (object)sessionByCharacterId.CharacterInfo.ShipHp + "|" + (object)sessionByCharacterId.CharacterInfo.ShipShield + "|" + (object)smbDamages));
                            sessionByCharacterId.SendData(PacketComposer.Compose("Y", "0|" + (object)sessionByCharacterId.CharacterId + "|L|" + (object)sessionByCharacterId.CharacterInfo.ShipHp + "|" + (object)sessionByCharacterId.CharacterInfo.ShipShield + "|" + (object)smbDamages));
                        }
                    }
                }
            }
        }

        private static void UseEmp(Session Session)
        {
            if (UnixTimestamp.GetCurrent() - Session.CharacterInfo.LastEMP < 29.0)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "EMP|" + (object)Session.CharacterId), false);
            Session.CharacterInfo.LastEMP = UnixTimestamp.GetCurrent();
            Session.SendData(PacketComposer.Compose("A", "CLD|EMP|30"));
            foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                if (key.Type == MapActorType.UserCharacter && key.ReferenceId != Session.CharacterId)
                {
                    Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key.ReferenceId);
                    if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                    {
                        if (sessionByCharacterId.CharacterInfo.SelectedPlayer == Session.CharacterInfo.Id)
                        {
                            sessionByCharacterId.SendData(PacketComposer.Compose("A", "STM|msg_own_targeting_harmed"));
                            Fight.StopLaser(sessionByCharacterId, Session);
                        }
                        if (sessionByCharacterId.CharacterInfo.Invisible == 1 && Math.Sqrt(Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocX - Session.CharacterInfo.LocX), 2.0) + Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocY - Session.CharacterInfo.LocY), 2.0)) < 600.0)
                        {
                            sessionByCharacterId.CharacterInfo.Invisible = 0;
                            instanceByMapId.BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)sessionByCharacterId.CharacterInfo.Id + "|" + (object)0), 0 != 0);
                        }
                    }
                }
            }
        }

        private static void UseCloak(Session Session)
        {
            if (Session.CharacterInfo.Attacking)
                return;
            int totalSeconds = (int)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;
            if (Session.CharacterInfo.InvisibleCooldown > totalSeconds)
            {
                Session.SendData(PacketComposer.Compose("A", "STD|You can only use a cloack every 10 seconds !"));
            }
            else
            {
                if (Session.CharacterInfo.Invisible != 1)
                {
                    Session.CharacterInfo.Invisible = 1;
                    Session.CharacterInfo.InvisibleCooldown = totalSeconds + 10;
                }
                MapManager.GetInstanceByMapId(Session.CharacterInfo.MapId).BroadcastMessage(PacketComposer.Compose("n", "INV|" + (object)Session.CharacterInfo.Id + "|" + (object)1), 0 != 0);
            }
        }

        private static void Select(Session Session, ClientMessage Message)
        {
            string nextString = Message.GetNextString(1);
            switch (nextString)
            {
                case "CFG":
                    SelectAction.ChangeCfg(Session, Message);
                    break;
                case "ROB":
                    SelectAction.UseRob(Session);
                    break;
                case "ISH":
                    SelectAction.UseIsh(Session);
                    break;
                case "SMB":
                    SelectAction.UseSmb(Session);
                    break;
                case "EMP":
                    SelectAction.UseEmp(Session);
                    break;
                case "CLK":
                    SelectAction.UseCloak(Session);
                    break;
                default:
                    return;
            }
        }

        private static bool isbetween(int point_x, int point_y, int box_x, int box_y, int box_w, int box_h)
        {
            return point_x >= box_x && point_x < box_x + box_w && point_y >= box_y && point_y < box_y + box_h;
        }

        private static void RepairTimer(object state)
        {
            Session session = (Session)state;
            int repairBotHp = session.CharacterInfo.RepairBotHp;
            if (session.CharacterInfo.IsMoving || session.CharacterInfo.AttackingRepBug || (session.CharacterInfo.Attacked.Count > 0 || session.CharacterInfo.WarningZone) || (!session.CharacterInfo.IsRepairing || session.StoppedPlayer || session.CharacterInfo.Destroy) || session.CharacterInfo.Disconnected)
            {
                if (session.CharacterInfo.RepairTimer != null)
                    session.CharacterInfo.RepairTimer.Dispose();
                session.CharacterInfo.IsRepairing = false;
                session.SendData(PacketComposer.Compose("D", session.CharacterInfo.LocX.ToString() + "|" + (object)session.CharacterInfo.LocY + "|0|0|1|0|0|0"));
            }
            else if (session.CharacterInfo.ShipHp >= session.CharacterInfo.ShipMaxHp)
            {
                if (session.CharacterInfo.RepairTimer != null)
                    session.CharacterInfo.RepairTimer.Dispose();
                session.CharacterInfo.IsRepairing = false;
                session.SendData(PacketComposer.Compose("D", session.CharacterInfo.LocX.ToString() + "|" + (object)session.CharacterInfo.LocY + "|0|0|1|0|0|0"));
            }
            else if (session.CharacterInfo.AttackingRepBug)
            {
                if (session.CharacterInfo.RepairTimer != null)
                    session.CharacterInfo.RepairTimer.Dispose();
                session.CharacterInfo.IsRepairing = false;
                session.SendData(PacketComposer.Compose("D", session.CharacterInfo.LocX.ToString() + "|" + (object)session.CharacterInfo.LocY + "|0|0|1|0|0|0"));
            }
            else if (session.CharacterInfo.ShipHp + repairBotHp <= session.CharacterInfo.ShipMaxHp)
            {
                session.CharacterInfo.ShipHp += repairBotHp;
                session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)session.CharacterInfo.Id + "|HPT|" + (object)session.CharacterInfo.ShipHp + "|" + (object)repairBotHp));
            }
            else
            {
                int num = session.CharacterInfo.ShipMaxHp - session.CharacterInfo.ShipHp;
                session.CharacterInfo.ShipHp = session.CharacterInfo.ShipMaxHp;
                session.SendData(PacketComposer.Compose("A", "HL|1|" + (object)session.CharacterInfo.Id + "|HPT|" + (object)session.CharacterInfo.ShipHp + "|" + (object)num));
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\SettingsHandlers.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Handlers.SettingsHandlers
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System.Text.RegularExpressions;

namespace OrbitReborn_Emulator.Game.Handlers
{
  public static class SettingsHandlers
  {
    public static void Initialize()
    {
      DataRouter.RegisterHandler("7", new ProcessRequestCallback(SettingsHandlers.SetClientSettings), false);
      DataRouter.RegisterHandler("A", new ProcessRequestCallback(SettingsHandlers.SetAttribute), false);
    }

    private static void SetClientSettings(Session Session, ClientMessage Message)
    {
      string packet = Message.Packet;
      if (!(packet != ""))
        return;
      foreach (string str in Regex.Split(packet, "7\\|"))
      {
        if (str != "")
        {
          string[] strArray = str.Split(new char[1]{ '|' }, 1)[0].Split(new char[2]
          {
            ',',
            '|'
          }, 2);
          if (strArray.Length > 1)
          {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
              Session.CharacterInfo.UpdateSettings(client, strArray[0], strArray[1]);
          }
        }
      }
    }

    private static void SetAttribute(Session Session, ClientMessage Message)
    {
      if (!(Message.GetNextString(1) == "SET"))
        return;
      string[] strArray = Message.Packet.Split(new char[1]
      {
        '|'
      }, 3);
      using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
        Session.CharacterInfo.UpdateSettings(client, "flash_set", strArray[2]);
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Handlers\ShipMovement.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Handlers.ShipMovement
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Event;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Npcs;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Specialized;
using System;
using System.Collections.Generic;
using System.Threading;
using System.Windows;

namespace OrbitReborn_Emulator.Game.Handlers
{
    public static class ShipMovement
    {
        public static Timer CheckAliensInRangeTimer;

        public static void Initialize()
        {
            DataRouter.RegisterHandler("1", new ProcessRequestCallback(ShipMovement.Movement), false);
        }

        private static void MovePlayer(Session Session, double time)
        {
            Vector vector1 = new Vector((double)Session.CharacterInfo.LocX, (double)Session.CharacterInfo.LocY);
            Vector vector2 = new Vector((double)Session.CharacterInfo.NewLocX, (double)Session.CharacterInfo.NewLocY);
            Vector vector3 = Vector.Subtract(vector2, vector1);
            double num = Math.Sqrt(Math.Pow(vector3.X, 2.0) + Math.Pow(vector3.Y, 2.0));
            Vector position = ShipMovement.calculatePosition(vector1, vector2, time, (double)Session.CharacterInfo.ShipSpeed / 1000.0);
            Vector vector4 = Vector.Subtract(vector1, position);
            if (Math.Sqrt(Math.Pow(vector4.X, 2.0) + Math.Pow(vector4.Y, 2.0)) >= num)
            {
                Session.CharacterInfo.LocX = Session.CharacterInfo.NewLocX;
                Session.CharacterInfo.LocY = Session.CharacterInfo.NewLocY;
                Session.CharacterInfo.LastMove.Stop();
                Session.CharacterInfo.IsMoving = false;
                if (Session.CharacterInfo.PathFinding != null)
                    Session.CharacterInfo.PathFinding.Dispose();
            }
            else
            {
                try
                {
                    Session.CharacterInfo.LocX = Convert.ToInt32(position.X);
                    Session.CharacterInfo.LocY = Convert.ToInt32(position.Y);
                    Session.CharacterInfo.LastMove.Restart();
                }
                catch (OverflowException ex)
                {
                    Output.WriteLine((object)("BUG3 : " + (object)position.X + ", " + (object)Session.CharacterInfo.LocX + ", " + (object)position.Y + ", " + (object)Session.CharacterInfo.LocY));
                    Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
                    Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
                }
            }
            ShipMovement.CheckWarningZone(Session);
            ShipMovement.CheckPeaceZone(Session);
            ShipMovement.CheckPortalZone(Session);
            ShipMovement.UpdateMovement((object)Session);
        }

        private static void TryMovePlayer(Session Session)
        {
            if (Session.CharacterInfo.NewLocX != Session.CharacterInfo.LocX || Session.CharacterInfo.NewLocY != Session.CharacterInfo.LocY)
            {
                Session.CharacterInfo.LastMove.Stop();
                ShipMovement.MovePlayer(Session, (double)Session.CharacterInfo.LastMove.ElapsedMilliseconds);
            }
            else
            {
                if (Session.CharacterInfo.PathFinding != null)
                    Session.CharacterInfo.PathFinding.Dispose();
                Session.CharacterInfo.IsMoving = false;
                Session.CharacterInfo.LastMove.Stop();
            }
        }

        private static void PathFinding(object state)
        {
            Session Session = (Session)state;
            if (Session == null || Session.CharacterInfo == null || Session.CharacterInfo.Destroy)
            {
                if (Session.CharacterInfo.PathFinding == null)
                    return;
                Session.CharacterInfo.PathFinding.Dispose();
                Session.CharacterInfo.IsMoving = false;
                Session.CharacterInfo.LastMove.Stop();
            }
            else
                ShipMovement.TryMovePlayer(Session);
        }

        private static void Movement(Session Session, ClientMessage Message)
        {
            if (Session == null || Session.CharacterInfo == null || MapManager.GetInstanceByMapId(Session.CurrentMapId) == null || !Session.CharacterInfo.CanMove)
                return;
            int nextInt1 = Message.GetNextInt(1);
            int nextInt2 = Message.GetNextInt(2);
            int nextInt3 = Message.GetNextInt(3);
            int nextInt4 = Message.GetNextInt(4);
            if (nextInt1 == 0 || nextInt2 == 0 || nextInt3 == 0 || nextInt4 == 0)
                return;
            /* double num = Math.Sqrt(Math.Pow((double)(Session.CharacterInfo.LocX - nextInt1), 2.0) + Math.Pow((double)(Session.CharacterInfo.LocY - nextInt2), 2.0));
            if (num < 50.0 || (nextInt1 > 22000 || nextInt1 < -1000 || nextInt2 > 14000 || nextInt2 < -1000))
                return;
            double TimeTaken = num * 1000.0 / (double)Session.CharacterInfo.ShipSpeed; */
            double TimeTaken = ShipMovement.getTimeTaken(Session, nextInt1, nextInt2);
            if (TimeTaken == -1)
                return;
            Session.CharacterInfo.NewLocX = nextInt1;
            Session.CharacterInfo.NewLocY = nextInt2;
            /* if (!Session.CharacterInfo.IsMoving)
             {
                 Session.CharacterInfo.LastMove.Restart();
                 Session.CharacterInfo.PathFinding = new Timer(new TimerCallback(ShipMovement.PathFinding), (object)Session, 300, 300);
                 Session.CharacterInfo.IsMoving = true;
             }
             foreach (int key in (IEnumerable<int>)Session.CharacterInfo.PlayerInRange.Keys)
             {
                 Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key);
                 if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                     sessionByCharacterId.SendData(MapShipMovementComposer.Compose(Session.CharacterId, Session.CharacterInfo.NewLocX, Session.CharacterInfo.NewLocY, TimeTaken));
             } */
            ShipMovement.MoveShip(Session, TimeTaken);
            ShipMovement.MovementToSeeEveryone(Session, TimeTaken);
        }

        public static double getTimeTaken(Session Session, int nextInt1, int nextInt2)
        {
            double num = Math.Sqrt(Math.Pow((double)(Session.CharacterInfo.LocX - nextInt1), 2.0) + Math.Pow((double)(Session.CharacterInfo.LocY - nextInt2), 2.0));
            if (num < 50.0 || (nextInt1 > 22000 || nextInt1 < -1000 || nextInt2 > 14000 || nextInt2 < -1000))
                return -1;
            double TimeTaken = num * 1000.0 / (double)Session.CharacterInfo.ShipSpeed;
            return TimeTaken;
        }

        public static void MoveShip(Session Session, double TimeTaken) {
            if (!Session.CharacterInfo.IsMoving)
            {
                Session.CharacterInfo.LastMove.Restart();
                Session.CharacterInfo.PathFinding = new Timer(new TimerCallback(ShipMovement.PathFinding), (object)Session, 300, 300);
                Session.CharacterInfo.IsMoving = true;
            }
            foreach (int key in (IEnumerable<int>)Session.CharacterInfo.PlayerInRange.Keys)
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key);
                if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                    sessionByCharacterId.SendData(MapShipMovementComposer.Compose(Session.CharacterId, Session.CharacterInfo.NewLocX, Session.CharacterInfo.NewLocY, TimeTaken));
            }
        }

        public static void MovementToSeeEveryone(Session Session, double TimeTaken)
        {
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                if (key.Type == MapActorType.UserCharacter && key.ReferenceId != Session.CharacterId)
                {
                    Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key.ReferenceId);
                    if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                    {
                        if (ShipMovement.CanSeeEveryone(sessionByCharacterId))
                        {
                            sessionByCharacterId.SendData(MapShipMovementComposer.Compose(Session.CharacterId, Session.CharacterInfo.NewLocX, Session.CharacterInfo.NewLocY, TimeTaken));
                        }
                    }
                }
            }
        }

        private static bool CanSeeEveryone(Session session)
        {
            return (session.CharacterInfo.IsAdmin || session.CharacterInfo.MapId == 83 || _1v1.IsOnMap(session.CharacterInfo.MapId));
        }

        private static bool IsBetween(int point_x, int point_y, int box_x, int box_y, int box_w, int box_h)
        {
            return point_x >= box_x && point_x < box_x + box_w && point_y >= box_y && point_y < box_y + box_h;
        }

        public static void UpdateMovement(object state)
        {
            ShipMovement.CheckPlayerInRange(state);
            ShipMovement.CheckAliensInRange(state);
        }

        public static void CheckPlayerInRange(object state)
        {
            Session Session = (Session)state;
            if (Session == null || Session.CharacterInfo == null)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(Session.CurrentMapId);
            if (instanceByMapId == null)
                return;
            CList<int> clist = new CList<int>();
            foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                if (key.Type == MapActorType.UserCharacter && key.ReferenceId != Session.CharacterId)
                {
                    Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key.ReferenceId);
                    if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null)
                    {
                        if (ShipMovement.CanSeeEveryone(Session) || Math.Sqrt(Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocX - Session.CharacterInfo.LocX), 2.0) + Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocY - Session.CharacterInfo.LocY), 2.0)) < 2000.0)
                        {
                            if (!Session.CharacterInfo.PlayerInRange.Contains(sessionByCharacterId.CharacterId))
                            {
                                Session.CharacterInfo.PlayerInRange.Add(sessionByCharacterId.CharacterId);
                                Session.SendData(MapUserEnterComposer.Compose(sessionByCharacterId.CharacterInfo, Session));
                                double TimeTaken = Math.Sqrt(Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocX - sessionByCharacterId.CharacterInfo.NewLocX), 2.0) + Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocY - sessionByCharacterId.CharacterInfo.NewLocY), 2.0)) * 1000.0 / (double)Session.CharacterInfo.ShipSpeed;
                                Session.SendData(MapShipMovementComposer.Compose(sessionByCharacterId.CharacterId, sessionByCharacterId.CharacterInfo.NewLocX, sessionByCharacterId.CharacterInfo.NewLocY, TimeTaken));
                            }
                        }
                        else if (Session.CharacterInfo.PlayerInRange.Contains(sessionByCharacterId.CharacterId))
                        {
                            if (Session.CharacterInfo.SelectedPlayer == sessionByCharacterId.CharacterId)
                                Fight.StopLaser(Session, sessionByCharacterId);
                            clist.Add(sessionByCharacterId.CharacterId);
                        }
                    }
                }
            }
            foreach (int key in (IEnumerable<int>)Session.CharacterInfo.PlayerInRange.Keys)
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(key);
                if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null)
                    clist.Add(key);
                else if (Session.CurrentMapId != sessionByCharacterId.CurrentMapId)
                    clist.Add(key);
            }
            foreach (int key in (IEnumerable<int>)clist.Keys)
            {
                Session.CharacterInfo.PlayerInRange.Remove(key);
                Session.SendData(MapUserLeaveComposer.Compose(key));
            }
        }

        public static void CheckAliensInRange(object state)
        {
            Session session = (Session)state;
            if (session == null)
                return;
            if (session.CharacterInfo.IsAdmin && session.CharacterInfo.DisableNpc)
                return;
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(session.CharacterInfo.MapId);
            if (instanceByMapId == null)
                return;
            CList<int> clist = new CList<int>();
            foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
            {
                if (key != null && key.Type == MapActorType.AiBot)
                {
                    Npc referenceObject = (Npc)key.ReferenceObject;
                    if ((Math.Sqrt(Math.Pow((double)(referenceObject.LocX - session.CharacterInfo.LocX), 2.0) + Math.Pow((double)(referenceObject.LocY - session.CharacterInfo.LocY), 2.0)) < 2000.0 || referenceObject.IsBoss == 1 || referenceObject.Name == "Spaceball") && session.CharacterInfo.MapId == referenceObject.MapId)
                    {
                        if (!session.CharacterInfo.NpcInRange.Contains(referenceObject.Id) && !referenceObject.IsDestroying)
                        {
                            session.CharacterInfo.NpcInRange.Add(referenceObject.Id);
                            session.SendData(PacketComposer.Compose("C", referenceObject.Id.ToString() + "|" + (object)referenceObject.ShipId + "|0|" + referenceObject.ClanTag + "|" + referenceObject.Name + "|" + (object)referenceObject.LocX + "|" + (object)referenceObject.LocY + "|" + (object)referenceObject.FactionId + "|" + (object)referenceObject.IsClanMember + "|" + (object)referenceObject.Rank + "|" + (object)referenceObject.IsBoss + "|" + (object)referenceObject.IsClanMember + "|" + (object)referenceObject.GalaxyGatesRings));
                            ServerMessage Message = MapUserMovementListComposer.ComposeIA(new CList<MapActor>() { key });
                            session.SendData(Message);
                            if (referenceObject.Drones == 1)
                                session.SendData(PacketComposer.Compose("n", "d|" + (object)referenceObject.Id + "|3/2-15-15,3/4-15-15-15-15,3/2-15-15"));
                            else if (referenceObject.Drones == 2)
                                session.SendData(PacketComposer.Compose("n", "d|" + (object)referenceObject.Id + "|3/2-25-25,3/4-25-25-25-25,3/2-25-25"));
                        }
                    }
                    else if (session.CharacterInfo.NpcInRange.Contains(referenceObject.Id))
                    {
                        if (session.CharacterInfo.SelectedPlayer == referenceObject.Id)
                        {
                            if (session.CharacterInfo.LaserAttackTimer != null)
                                session.CharacterInfo.LaserAttackTimer.Dispose();
                            if (session.CharacterInfo.LaserAttackCanTimer != null)
                                session.CharacterInfo.LaserAttackCanTimer.Dispose();
                            session.CharacterInfo.Attacking = false;
                            session.CharacterInfo.CanLaserAttack = false;
                            session.CharacterInfo.SelectedPlayer = 0;
                            session.SendData(PacketComposer.Compose("N", "-1"));
                            session.CharacterInfo.LaserAttackCanTimer = new Timer(new TimerCallback(Fight.CanAttack), (object)session, 1000, 0);
                        }
                        clist.Add(referenceObject.Id);
                    }
                }
            }

            foreach (int key in (IEnumerable<int>)session.CharacterInfo.NpcInRange.Keys)
            {
                if (instanceByMapId.GetActorByReferenceId(key, MapActorType.AiBot) == null)
                {
                    clist.Add(key);
                }
                else
                {
                    Npc referenceObject = (Npc)instanceByMapId.GetActorByReferenceId(key, MapActorType.AiBot).ReferenceObject;
                    if (referenceObject == null)
                        clist.Add(key);
                    else if (session.CurrentMapId != referenceObject.MapId)
                        clist.Add(key);
                }

            }
            foreach (int key in (IEnumerable<int>)clist.Keys)
            {
                session.CharacterInfo.NpcInRange.Remove(key);
                session.SendData(PacketComposer.Compose("R", key.ToString()));
            }
        }

        public static void CheckWarningZone(Session Session)
        {
            if (Session.CharacterInfo.MapId != 16)
            {
                if (!ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, 0, 0, 21000, 13000) && Session.CharacterInfo.WarningZoneTimer == null)
                {
                    Session.CharacterInfo.WarningZone = true;
                    if (Session.Authenticated)
                        Session.SendData(PacketComposer.Compose("D", Session.CharacterInfo.LocX.ToString() + "|" + (object)Session.CharacterInfo.LocY + "|0|0|1|1|0|0"));
                    if (Session.CharacterInfo.WarningZoneTimer != null)
                    {
                        Session.CharacterInfo.WarningZoneTimer.Dispose();
                        --TimerManager.TimerRunning;
                        Session.CharacterInfo.WarningZoneTimer = (Timer)null;
                    }
                    Session.CharacterInfo.WarningZoneTimer = new Timer(new TimerCallback(ShipMovement.WarningZone), (object)Session, 0, 1000);
                    ++TimerManager.TimerRunning;
                }
                else if (ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, 0, 0, 21000, 13000) && Session.CharacterInfo.WarningZoneTimer != null)
                {
                    Session.CharacterInfo.WarningZone = false;
                    if (Session.Authenticated)
                        Session.SendData(PacketComposer.Compose("D", Session.CharacterInfo.LocX.ToString() + "|" + (object)Session.CharacterInfo.LocY + "|0|0|1|0|0|0"));
                    if (Session.CharacterInfo.WarningZoneTimer != null)
                    {
                        Session.CharacterInfo.WarningZoneTimer.Dispose();
                        --TimerManager.TimerRunning;
                        Session.CharacterInfo.WarningZoneTimer = (Timer)null;
                    }
                }
            }
            if (Session.CharacterInfo.MapId != 16)
                return;
            if (!ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, 0, 0, 42000, 28000) && Session.CharacterInfo.WarningZoneTimer == null)
            {
                Session.CharacterInfo.WarningZone = true;
                if (Session.Authenticated)
                    Session.SendData(PacketComposer.Compose("D", Session.CharacterInfo.LocX.ToString() + "|" + (object)Session.CharacterInfo.LocY + "|0|0|1|1|0|0"));
                if (Session.CharacterInfo.WarningZoneTimer != null)
                {
                    Session.CharacterInfo.WarningZoneTimer.Dispose();
                    --TimerManager.TimerRunning;
                    Session.CharacterInfo.WarningZoneTimer = (Timer)null;
                }
                Session.CharacterInfo.WarningZoneTimer = new Timer(new TimerCallback(ShipMovement.WarningZone), (object)Session, 0, 1000);
                ++TimerManager.TimerRunning;
            }
            else if (ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, 0, 0, 42000, 28000) && Session.CharacterInfo.WarningZoneTimer != null)
            {
                Session.CharacterInfo.WarningZone = false;
                if (Session.Authenticated)
                    Session.SendData(PacketComposer.Compose("D", Session.CharacterInfo.LocX.ToString() + "|" + (object)Session.CharacterInfo.LocY + "|0|0|1|0|0|0"));
                if (Session.CharacterInfo.WarningZoneTimer != null)
                {
                    Session.CharacterInfo.WarningZoneTimer.Dispose();
                    --TimerManager.TimerRunning;
                    Session.CharacterInfo.WarningZoneTimer = (Timer)null;
                }
            }
        }

        public static void SendPeacePortalInfos(Session Session)
        {
            if (Session.CharacterInfo.PeaceZone)
            {
                if (Session.CharacterInfo.PortalZone)
                    Session.SendData(PacketComposer.Compose("D", Session.CharacterInfo.LocX.ToString() + "|" + (object)Session.CharacterInfo.LocY + "|1|0|1|0|1|0"));
                else
                    Session.SendData(PacketComposer.Compose("D", Session.CharacterInfo.LocX.ToString() + "|" + (object)Session.CharacterInfo.LocY + "|1|0|1|0|0|0"));
            }
            else
            {
                if (!Session.CharacterInfo.PortalZone)
                    return;
                Session.SendData(PacketComposer.Compose("D", Session.CharacterInfo.LocX.ToString() + "|" + (object)Session.CharacterInfo.LocY + "|0|0|1|0|1|0"));
            }
        }

        public static void CheckPeaceZone(Session Session)
        {
            int factionId = Session.CharacterInfo.FactionId;
            int mapId = Session.CharacterInfo.MapId;
            bool isBeginner = Session.CharacterInfo.IsBeginner;
            long rankPoints = Session.CharacterInfo.RankPoints;
            if (Session.CharacterInfo.Attacking)
            {
                Session.CharacterInfo.PeaceZone = false;
                ShipMovement.SendPeacePortalInfos(Session);
            }
            else
            {
                if (mapId == 1)
                {
                    if (factionId == 1 && ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, 1000, 600, 1600, 1600))
                    {
                        Session.CharacterInfo.PeaceZone = true;
                        ShipMovement.SendPeacePortalInfos(Session);
                        return;
                    }
                }
                else if (mapId == 5)
                {
                    if (factionId == 2 && ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, 18000, 600, 1600, 1600))
                    {
                        Session.CharacterInfo.PeaceZone = true;
                        ShipMovement.SendPeacePortalInfos(Session);
                        return;
                    }
                }
                else if (mapId == 9 && factionId == 3 && ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, 18300, 10700, 1600, 1600))
                {
                    Session.CharacterInfo.PeaceZone = true;
                    ShipMovement.SendPeacePortalInfos(Session);
                    return;
                }
                if (isBeginner)
                {
                    if (mapId == 1 || mapId == 2)
                    {
                        if (factionId == 1)
                        {
                            Session.CharacterInfo.PeaceZone = true;
                            ShipMovement.SendPeacePortalInfos(Session);
                            return;
                        }
                    }
                    else if (mapId == 5 || mapId == 6)
                    {
                        if (factionId == 2)
                        {
                            Session.CharacterInfo.PeaceZone = true;
                            ShipMovement.SendPeacePortalInfos(Session);
                            return;
                        }
                    }
                    else if ((mapId == 9 || mapId == 10) && factionId == 3)
                    {
                        Session.CharacterInfo.PeaceZone = true;
                        ShipMovement.SendPeacePortalInfos(Session);
                        return;
                    }
                }
                CList<PortalInfo> portalForMap = PortalManager.GetPortalForMap(Session.CharacterInfo.MapId);
                if (portalForMap != null)
                {
                    foreach (PortalInfo key in (IEnumerable<PortalInfo>)portalForMap.Keys)
                    {
                        if (!PortalManager.isPortalUnsafe(key.Id))
                        {
                            if (key.MapId == Session.CharacterInfo.MapId && key.MapId != 17 && ((Session.CharacterInfo.FactionId == 1 && (key.MapId == 1 || key.MapId == 2 || key.MapId == 3) || Session.CharacterInfo.FactionId == 2 && (key.MapId == 5 || key.MapId == 6 || key.MapId == 7) || Session.CharacterInfo.FactionId == 3 && (key.MapId == 9 || key.MapId == 10 || key.MapId == 11)) && ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, key.PosX - 500, key.PosY - 500, 1000, 1000)))
                            {
                                Session.CharacterInfo.PeaceZone = true;
                                ShipMovement.SendPeacePortalInfos(Session);
                                return;
                            }
                        }

                    }
                }
                ShipMovement.SendPeacePortalInfos(Session);
                Session.CharacterInfo.PeaceZone = false;
            }
        }

        public static void CheckPortalZone(Session Session)
        {
            if (Session.CharacterInfo.IsJumping)
                return;
            CList<PortalInfo> portalForMap = PortalManager.GetPortalForMap(Session.CharacterInfo.MapId);
            Session.CharacterInfo.CurrentPortal = 0;
            Session.CharacterInfo.PortalZone = false;
            if (portalForMap != null)
            {
                foreach (PortalInfo key in (IEnumerable<PortalInfo>)portalForMap.Keys)
                {
                    if (key.MapId == Session.CharacterInfo.MapId && ShipMovement.IsBetween(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY, key.PosX - 500, key.PosY - 500, 1000, 1000))
                    {
                        Session.CharacterInfo.CurrentPortal = key.Id;
                        Session.CharacterInfo.PortalZone = true;
                    }
                }
            }
            ShipMovement.SendPeacePortalInfos(Session);
        }

        private static void WarningZone(object state)
        {
            Session session = (Session)state;
            if (session == null || session.CharacterInfo == null)
            {
                if (session.CharacterInfo.WarningZoneTimer == null)
                    return;
                session.CharacterInfo.WarningZoneTimer.Dispose();
            }
            else if (session.StoppedPlayer || session.CharacterInfo.ShipHp < 0 || session.CharacterInfo.Destroy || session.CharacterInfo.Disconnected)
            {
                if (session.CharacterInfo.WarningZoneTimer == null)
                    return;
                session.CharacterInfo.WarningZoneTimer.Dispose();
            }
            else
            {
                int num1 = 25000;
                int num2 = num1 / 100 * 80;
                int num3 = num1 - num2;
                if (session.CharacterInfo.ShipShield - num2 > 0)
                    session.CharacterInfo.ShipShield -= num2;
                else if (session.CharacterInfo.ShipShield - num2 <= 0)
                {
                    num3 = num1 - session.CharacterInfo.ShipShield;
                    session.CharacterInfo.ShipShield -= session.CharacterInfo.ShipShield;
                }
                else if (session.CharacterInfo.ShipShield == 0)
                    num3 = num1;
                if (session.CharacterInfo.ShipHp - num3 > 0)
                    session.CharacterInfo.ShipHp -= num3;
                else if (session.CharacterInfo.ShipHp - num3 <= 0)
                    session.CharacterInfo.ShipHp -= session.CharacterInfo.ShipHp;
                session.SendData(PacketComposer.Compose("Y", "0|" + (object)session.CharacterId + "|L|" + (object)session.CharacterInfo.ShipHp + "|" + (object)session.CharacterInfo.ShipShield + "|" + (object)num1));
                if (session.CharacterInfo.ShipHp <= 0 && !session.CharacterInfo.Destroy)
                {
                    if (session.CharacterInfo.LaserAttackTimer != null)
                        session.CharacterInfo.LaserAttackTimer.Dispose();
                    session.CharacterInfo.SendReward(session);
                    Fight.KillPlayer(session);
                }
                if (!session.StoppedPlayer && session.CharacterInfo.ShipHp >= 0 && !session.CharacterInfo.Destroy && !session.CharacterInfo.Disconnected || session.CharacterInfo.WarningZoneTimer == null)
                    return;
                session.CharacterInfo.WarningZoneTimer.Dispose();
                --TimerManager.TimerRunning;
                session.CharacterInfo.WarningZoneTimer = (Timer)null;
            }
        }

        private static void ShowStatus(object state)
        {
            Session session = (Session)state;
            session.CharacterInfo.IsMoving = false;
            if ((session.StoppedPlayer || session.CharacterInfo.Destroy || session.CharacterInfo.Disconnected) && session.CharacterInfo.PathTime != null)
            {
                session.CharacterInfo.PathTime.Dispose();
                --TimerManager.TimerRunning;
                session.CharacterInfo.PathTime = (Timer)null;
            }
            if (session.CharacterInfo.PathTime == null)
                return;
            session.CharacterInfo.PathTime.Dispose();
            --TimerManager.TimerRunning;
            session.CharacterInfo.PathTime = (Timer)null;
        }

        public static Vector calculatePosition(Vector start_pos, Vector end_pos, double time, double speed)
        {
            Vector vector = Vector.Subtract(end_pos, start_pos);
            if (vector.Length < 10.0)
                return end_pos;
            vector.Normalize();
            Vector vector2 = vector * time * speed;
            return Vector.Add(start_pos, vector2);
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Laboratory\LabInfos.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Laboratory.LabInfos
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Game.Laboratory
{
  public class LabInfos
  {
    private int m_iPrometium;
    private int m_iEndurium;
    private int m_iTerbium;
    private int m_iXenomit;
    private int m_iPalladium;
    private int m_iPrometid;
    private int m_iDuranium;
    private int m_iPromerium;
    private int[] m_Laser;
    private int[] m_Rocket;
    private int[] m_Speed;
    private int[] m_Shield;
    private int m_iUpdate;

    public int Prometium
    {
      get
      {
        return this.m_iPrometium;
      }
      set
      {
        this.m_iPrometium = value;
      }
    }

    public int Endurium
    {
      get
      {
        return this.m_iEndurium;
      }
      set
      {
        this.m_iEndurium = value;
      }
    }

    public int Terbium
    {
      get
      {
        return this.m_iTerbium;
      }
      set
      {
        this.m_iTerbium = value;
      }
    }

    public int Xenomit
    {
      get
      {
        return this.m_iXenomit;
      }
      set
      {
        this.m_iXenomit = value;
      }
    }

    public int Palladium
    {
      get
      {
        return this.m_iPalladium;
      }
      set
      {
        this.m_iPalladium = value;
      }
    }

    public int Prometid
    {
      get
      {
        return this.m_iPrometid;
      }
      set
      {
        this.m_iPrometid = value;
      }
    }

    public int Duranium
    {
      get
      {
        return this.m_iDuranium;
      }
      set
      {
        this.m_iDuranium = value;
      }
    }

    public int Promerium
    {
      get
      {
        return this.m_iPromerium;
      }
      set
      {
        this.m_iPromerium = value;
      }
    }

    public int[] Laser
    {
      get
      {
        return this.m_Laser;
      }
      set
      {
        this.m_Laser = value;
      }
    }

    public int[] Rocket
    {
      get
      {
        return this.m_Rocket;
      }
      set
      {
        this.m_Rocket = value;
      }
    }

    public int[] Speed
    {
      get
      {
        return this.m_Speed;
      }
      set
      {
        this.m_Speed = value;
      }
    }

    public int[] Shield
    {
      get
      {
        return this.m_Shield;
      }
      set
      {
        this.m_Shield = value;
      }
    }

    public int Update
    {
      get
      {
        return this.m_iUpdate;
      }
      set
      {
        this.m_iUpdate = value;
      }
    }

    public LabInfos()
    {
      this.m_iPrometium = 0;
      this.m_iEndurium = 0;
      this.m_iTerbium = 0;
      this.m_iXenomit = 0;
      this.m_iPalladium = 0;
      this.m_iPrometid = 0;
      this.m_iDuranium = 0;
      this.m_iPromerium = 0;
      this.m_Laser = new int[2];
      this.m_Laser[0] = 0;
      this.m_Laser[1] = 0;
      this.m_Rocket = new int[2];
      this.m_Rocket[0] = 0;
      this.m_Rocket[1] = 0;
      this.m_Speed = new int[2];
      this.m_Speed[0] = 0;
      this.m_Speed[1] = 0;
      this.m_Shield = new int[2];
      this.m_Shield[0] = 0;
      this.m_Shield[1] = 0;
      this.m_iUpdate = 0;
    }

    public int GetCargo(long iResId)
    {
      if (iResId == 1L)
        return this.m_iPrometium;
      if (iResId == 2L)
        return this.m_iEndurium;
      if (iResId == 3L)
        return this.m_iTerbium;
      if (iResId == 4L)
        return this.m_iXenomit;
      if (iResId == 5L)
        return this.m_iPalladium;
      if (iResId == 11L)
        return this.m_iPrometid;
      if (iResId == 12L)
        return this.m_iDuranium;
      if (iResId == 13L)
        return this.m_iPromerium;
      return 0;
    }

    public void AddCargo(long iResId, int iAmount)
    {
      if (iResId == 1L)
        this.m_iPrometium += iAmount;
      else if (iResId == 2L)
        this.m_iEndurium += iAmount;
      else if (iResId == 3L)
        this.m_iTerbium += iAmount;
      else if (iResId == 4L)
        this.m_iXenomit += iAmount;
      else if (iResId == 5L)
        this.m_iPalladium += iAmount;
      else if (iResId == 11L)
        this.m_iPrometid += iAmount;
      else if (iResId == 12L)
      {
        this.m_iDuranium += iAmount;
      }
      else
      {
        if (iResId != 13L)
          return;
        this.m_iPromerium += iAmount;
      }
    }

    public void RemoveCargo(long iResId, int iAmount)
    {
      if (iResId == 1L)
        this.m_iPrometium -= iAmount;
      else if (iResId == 2L)
        this.m_iEndurium -= iAmount;
      else if (iResId == 3L)
        this.m_iTerbium -= iAmount;
      else if (iResId == 4L)
        this.m_iXenomit -= iAmount;
      else if (iResId == 5L)
        this.m_iPalladium -= iAmount;
      else if (iResId == 11L)
        this.m_iPrometid -= iAmount;
      else if (iResId == 12L)
      {
        this.m_iDuranium -= iAmount;
      }
      else
      {
        if (iResId != 13L)
          return;
        this.m_iPromerium -= iAmount;
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\MapActor.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.MapActor
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Characters;
using OrbitReborn_Emulator.Specialized;

namespace OrbitReborn_Emulator.Game.Maps
{
  public class MapActor
  {
    private int mId;
    private int mReferenceId;
    private int mReferenceSessionId;
    private object mReferenceObject;
    private MapActorType mType;
    private MapInstance mInstance;
    private Vector2 mPosition;
    private int mIdleTime;
    private bool mIsSleeping;
    private object mMovementSyncRoot;

    public int Id
    {
      get
      {
        return this.mId;
      }
    }

    public int ReferenceSessionId
    {
      get
      {
        return this.mReferenceSessionId;
      }
    }

    public int ReferenceId
    {
      get
      {
        return this.mReferenceId;
      }
    }

    public object ReferenceObject
    {
      get
      {
        return this.mReferenceObject;
      }
    }

    public MapActorType Type
    {
      get
      {
        return this.mType;
      }
    }

    public bool IsBot
    {
      get
      {
        return this.mType != MapActorType.UserCharacter;
      }
    }

    public string Name
    {
      get
      {
        return ((CharacterInfo) this.mReferenceObject).Username;
      }
    }

    public Vector2 Position
    {
      get
      {
        return this.mPosition;
      }
      set
      {
        this.mPosition = value;
      }
    }

    public int IdleTime
    {
      get
      {
        return this.mIdleTime;
      }
    }

    public bool IsSleeping
    {
      get
      {
        return this.mIsSleeping;
      }
    }

    public MapActor(int Id, MapActorType Type, int ReferenceSessionId, int ReferenceId, object ReferenceObject, Vector2 Position, MapInstance Instance)
    {
      this.mId = Id;
      this.mType = Type;
      this.mReferenceSessionId = ReferenceSessionId;
      this.mReferenceId = ReferenceId;
      this.mReferenceObject = ReferenceObject;
      this.mPosition = Position;
      this.mInstance = Instance;
      this.mMovementSyncRoot = new object();
    }

    public static MapActor TryCreateActor(int Id, MapActorType Type, int ReferenceSessionId, int ReferenceId, object ReferenceObject, Vector2 Position, MapInstance Instance)
    {
      if (ReferenceObject == null)
        return (MapActor) null;
      return new MapActor(Id, Type, ReferenceSessionId, ReferenceId, ReferenceObject, Position, Instance);
    }

    public void IncreaseIdleTime()
    {
      ++this.mIdleTime;
      if (this.IsSleeping || this.mIdleTime < 50)
        return;
      this.mIsSleeping = true;
    }

    public void Unidle()
    {
      this.mIdleTime = 0;
      if (!this.mIsSleeping)
        return;
      this.mIsSleeping = false;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\MapActorType.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.MapActorType
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Game.Maps
{
  public enum MapActorType
  {
    UserCharacter = 1,
    AiBot = 2,
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\MapHandler.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.MapHandler
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Handlers;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Maps
{
    internal class MapHandler
    {
        public static void OpenPublicConnection(Session Session, int MapId, PortalInfo LinkedPortal = null)
        {
            MapHandler.PrepareMap(Session, MapId, LinkedPortal, false);
        }

        public static void PrepareMap(Session Session, int MapId, PortalInfo LinkedPortal, bool BypassAuthentication = false)
        {
            MapInfo mapInfo = MapInfoLoader.GetMapInfo(MapId);
            if (!MapManager.InstanceIsLoadedForMap(mapInfo.Id))
                MapManager.TryLoadMapInstance(mapInfo.Id);
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(mapInfo.Id);
            if (instanceByMapId == null)
                return;
            if (mapInfo.CurrentCompanyUsers(Session.CharacterInfo.FactionId) >= mapInfo.MaxUsers && !Session.CharacterInfo.IsAdmin && !Session.CharacterInfo.IsMod)
            {
                Session.SendData(PacketComposer.Compose("A", "STD|The map is full for your company !"));
                if (Session.CharacterInfo.MapId != MapId)
                    return;
                Fight.KillPlayer(Session);
            }
            else
            {
                MapManager.RemoveUserFromMap(Session);
                Session.AbsoluteMapId = mapInfo.Id;
                Session.CharacterInfo.MapId = mapInfo.Id;
                Session.MapJoined = false;
                Session.MapAuthed = true;
                MapHandler.EnterMap(Session, instanceByMapId, LinkedPortal);
            }
        }

        public static void EnterMap(Session Session, MapInstance Instance, PortalInfo LinkedPortal)
        {
            if (!Session.MapAuthed || Session.MapJoined || Session.AbsoluteMapId != Instance.MapId || (Instance == null || Session.MapJoined || !Session.MapAuthed))
                return;
            if (!Instance.AddUserToMap(Session))
            {
                MapManager.RemoveUserFromMap(Session);
            }
            else
            {
                Session.MapAuthed = true;
                Session.MapJoined = true;
                if (LinkedPortal != null)
                {
                    Session.CharacterInfo.LocX = LinkedPortal.PosX;
                    Session.CharacterInfo.LocY = LinkedPortal.PosY;
                    Session.CharacterInfo.NewLocX = Session.CharacterInfo.LocX;
                    Session.CharacterInfo.NewLocY = Session.CharacterInfo.LocY;
                    Session.SendData(PacketComposer.Compose("i", LinkedPortal.MapId.ToString()));
                    Session.SendData(UserDataComposer.Compose(Session));
                    if (Session.CharacterInfo.Settings.ShowDrones == 1)
                    {
                        Session.SendData(PacketComposer.Compose("n", "d|" + (object)Session.CharacterId + "|" + Session.CharacterInfo.Drones));
                    }
                    else
                    {
                        int num = Session.CharacterInfo.Drones.Split('-').Length - 1 - 2;
                        Session.SendData(PacketComposer.Compose("n", "e|" + (object)Session.CharacterId + "|0/" + (object)num));
                    }
                    if (Session.CharacterInfo.GameTitle != "")
                        Session.SendData(PacketComposer.Compose("n", "pt|" + (object)Session.CharacterId + "|" + Session.CharacterInfo.GameTitle));
                    Session.CharacterInfo.CurrentPortal = LinkedPortal.Id;
                }
                else
                {
                    Session.SendData(PacketComposer.Compose("i", Session.CharacterInfo.MapId.ToString()));
                    Session.SendData(UserDataComposer.Compose(Session));
                    if (Session.CharacterInfo.Settings.ShowDrones == 1)
                    {
                        Session.SendData(PacketComposer.Compose("n", "d|" + (object)Session.CharacterId + "|" + Session.CharacterInfo.Drones));
                    }
                    else
                    {
                        int num = Session.CharacterInfo.Drones.Split('-').Length - 1 - 2;
                        Session.SendData(PacketComposer.Compose("n", "e|" + (object)Session.CharacterId + "|0/" + (object)num));
                    }
                    if (Session.CharacterInfo.GameTitle != "")
                        Session.SendData(PacketComposer.Compose("n", "pt|" + (object)Session.CharacterId + "|" + Session.CharacterInfo.GameTitle));
                }
                Session.CharacterInfo.Attacker = (Session)null;
                Session.CharacterInfo.Attacked.Clear();
                Session.CharacterInfo.SelectedPlayer = 0;
                Session.SendData(PacketComposer.Compose("N", "-1"));
                Instance.SendObjects(Session);
                Instance.SendPortals(Session);
                Session.CharacterInfo.WarningZone = false;
                if (Session.CharacterInfo.WarningZoneTimer != null)
                {
                    Session.CharacterInfo.WarningZoneTimer.Dispose();
                    Session.CharacterInfo.WarningZoneTimer = (Timer)null;
                }
                ShipMovement.CheckWarningZone(Session);
                Session.CharacterInfo.PeaceZone = false;
                ShipMovement.CheckPeaceZone(Session);
                if (Session.CharacterInfo.UpdateMovementTimer != null)
                    Session.CharacterInfo.UpdateMovementTimer.Dispose();
                lock (Session.CharacterInfo.PlayerInRange)
                {
                    foreach (int item_0 in (IEnumerable<int>)Session.CharacterInfo.PlayerInRange.Keys)
                    {
                        Session local_2 = SessionManager.GetSessionByCharacterId(item_0);
                        if (local_2 != null && local_2.CharacterInfo != null)
                            local_2.SendData(MapUserLeaveComposer.Compose(Session.CharacterId));
                    }
                }
                ShipMovement.UpdateMovement((object)Session);
                Session.CharacterInfo.UpdateMovementTimer = new Timer(new TimerCallback(ShipMovement.UpdateMovement), (object)Session, 300, 300);
                ShipMovement.CheckPeaceZone(Session);
                ShipMovement.CheckPortalZone(Session);
            }
            if (Session.CharacterInfo.KillStrek >= 10)
                Session.SendData(PacketComposer.Compose("n", "fx|start|RAGE|" + (object)Session.CharacterInfo.Id));
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\MapInfo.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.MapInfo
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Maps.Collectables;
using OrbitReborn_Emulator.Libs;
using System;

namespace OrbitReborn_Emulator.Game.Maps
{
  public class MapInfo
  {
    private int mId;
    private string mName;
    private double mCacheAge;
    private int mMaxUsers;
    public CDictionnary<int, Collectable> Collectables;

    public int Id
    {
      get
      {
        return this.mId;
      }
    }

    public string Name
    {
      get
      {
        return this.mName;
      }
      set
      {
        this.mName = value;
      }
    }

    public double CacheAge
    {
      get
      {
        return UnixTimestamp.GetCurrent() - this.mCacheAge;
      }
    }

    public int CurrentUsers
    {
      get
      {
        MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.mId);
        if (instanceByMapId != null)
          return instanceByMapId.HumanActorCount;
        return 0;
      }
    }

    public int MaxUsers
    {
      get
      {
        if (this.mMaxUsers == 0)
          return 500;
        return this.mMaxUsers;
      }
      set
      {
        this.mMaxUsers = value;
      }
    }

    public MapInfo(int Id, string Name)
    {
      this.mId = Id;
      this.mName = Name;
      this.Collectables = new CDictionnary<int, Collectable>();
      Random random = new Random();
      int num = 0;
      while (num < 100)
      {
        ++num;
        this.Collectables.Add(num, (Collectable) new BonusBox(num, random.Next(500, 20000), random.Next(500, 12000), this.mId));
      }
    }

    public int CurrentCompanyUsers(int _FactionID)
    {
      MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.mId);
      if (instanceByMapId != null)
        return instanceByMapId.HumanActorFactionCount(_FactionID);
      return 0;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\MapInfoLoader.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.MapInfoLoader
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Data;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Maps
{
  public static class MapInfoLoader
  {
    private const double CACHE_LIFE_TIME = 300.0;
    private static CDictionnary<int, MapInfo> mMapInfoCache;
    private static Timer mCacheMonitor;

    public static void Initialize()
    {
      MapInfoLoader.mMapInfoCache = new CDictionnary<int, MapInfo>();
      MapInfoLoader.mCacheMonitor = new Timer(new TimerCallback(MapInfoLoader.MonitorCache), (object) null, TimeSpan.FromSeconds(30.0), TimeSpan.FromSeconds(30.0));
    }

    private static void MonitorCache(object state)
    {
      lock (MapInfoLoader.mMapInfoCache)
      {
        CList<int> local_0 = new CList<int>();
        foreach (MapInfo item_0 in (IEnumerable<MapInfo>) MapInfoLoader.mMapInfoCache.Values)
        {
          if (MapManager.GetInstanceByMapId(item_0.Id) != null || item_0.CacheAge >= 300.0)
            local_0.Add(item_0.Id);
        }
        foreach (int item_1 in (IEnumerable<int>) local_0.Keys)
          MapInfoLoader.mMapInfoCache.Remove(item_1);
      }
    }

    public static void RemoveFromCache(int MapId)
    {
      lock (MapInfoLoader.mMapInfoCache)
      {
        if (!MapInfoLoader.mMapInfoCache.ContainsKey(MapId))
          return;
        MapInfoLoader.mMapInfoCache.Remove(MapId);
      }
    }

    private static MapInfo TryGetInfoFromCache(int MapId)
    {
      lock (MapInfoLoader.mMapInfoCache)
      {
        if (MapInfoLoader.mMapInfoCache.ContainsKey(MapId))
          return MapInfoLoader.mMapInfoCache[MapId];
      }
      return (MapInfo) null;
    }

    public static MapInfo GetMapInfo(int MapId)
    {
      return MapInfoLoader.GetMapInfo(MapId, false);
    }

    public static MapInfo GetMapInfo(int MapId, bool IgnoreCache)
    {
      MapInstance instanceByMapId = MapManager.GetInstanceByMapId(MapId);
      if (instanceByMapId != null)
        return instanceByMapId.Info;
      if (!IgnoreCache)
      {
        MapInfo infoFromCache = MapInfoLoader.TryGetInfoFromCache(MapId);
        if (infoFromCache != null)
          return infoFromCache;
      }
      using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
      {
        client.ClearParameters();
        client.SetParameter("id", (object) MapId);
        DataRow Row = client.ExecuteQueryRow("SELECT * FROM maps WHERE id = @id LIMIT 1");
        if (Row != null)
          return MapInfoLoader.GenerateMapInfoFromRow(Row);
      }
      return (MapInfo) null;
    }

    public static MapInfo GenerateMapInfoFromRow(DataRow Row)
    {
      return new MapInfo((int) Row["id"], (string) Row["name"]);
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\MapInstance.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.MapInstance
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Characters;
using OrbitReborn_Emulator.Game.Npcs;
using OrbitReborn_Emulator.Game.Portal;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Specialized;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Maps
{
    public class MapInstance : IDisposable
    {
        private object mActorSyncRoot;
        private CDictionnary<int, MapActor> mActors;
        private int mActorIdGenerator;
        private object mActorIdGeneratorSyncLock;
        private int mInstanceId;
        private MapInfo mInfo;
        private bool mUnloaded;
        private double mUnloadedTimestamp;
        private int mMarkedEmptyMap;
        private Timer mUpdater;

        public int ActorCount
        {
            get
            {
                return this.mActors.Count;
            }
        }

        public int HumanActorCount
        {
            get
            {
                int num = 0;
                lock (this.mActors)
                {
                    foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                        ++num;
                }
                return num;
            }
        }

        public CList<MapActor> Actors
        {
            get
            {
                lock (this.mActors)
                {
                    CList<MapActor> local_0 = new CList<MapActor>();
                    foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                        local_0.Add(item_0);
                    return local_0;
                }
            }
        }

        public int InstanceId
        {
            get
            {
                return this.mInstanceId;
            }
        }

        public MapInfo Info
        {
            get
            {
                return this.mInfo;
            }
        }

        public int MapId
        {
            get
            {
                return this.mInfo.Id;
            }
        }

        public bool Unloaded
        {
            get
            {
                return this.mUnloaded;
            }
        }

        public double TimeUnloaded
        {
            get
            {
                return this.Unloaded ? UnixTimestamp.GetCurrent() - this.mUnloadedTimestamp : 0.0;
            }
        }

        public int MarkedAsEmpty
        {
            get
            {
                return this.mMarkedEmptyMap;
            }
            set
            {
                this.mMarkedEmptyMap = value;
            }
        }

        public MapInstance(int InstanceId, MapInfo Info)
        {
            this.mActorSyncRoot = new object();
            this.mInstanceId = InstanceId;
            this.mInfo = Info;
            this.mActors = new CDictionnary<int, MapActor>();
            this.mActorIdGenerator = 1;
            this.mActorIdGeneratorSyncLock = new object();
            this.mUpdater = new Timer(new TimerCallback(this.PerformUpdate), (object)null, TimeSpan.FromMilliseconds(500.0), TimeSpan.FromMilliseconds(500.0));
        }

        public int HumanActorFactionCount(int _FactioID)
        {
            int num = 0;
            lock (this.mActors)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (!item_0.IsBot && ((CharacterInfo)item_0.ReferenceObject).FactionId == _FactioID)
                        ++num;
                }
            }
            return num;
        }

        private int GenerateActorId()
        {
            lock (this.mActorIdGeneratorSyncLock)
            {
                if (this.mActorIdGenerator >= int.MaxValue)
                    return 0;
                return this.mActorIdGenerator++;
            }
        }

        public bool AddUserToMap(Session Session)
        {
            if (Session.AbsoluteMapId != this.MapId || !Session.Authenticated)
                return false;
            int actorId = this.GenerateActorId();
            if (actorId == 0)
                return false;
            Vector2 Position = new Vector2(Session.CharacterInfo.LocX, Session.CharacterInfo.LocY);
            MapActor actor = MapActor.TryCreateActor(actorId, MapActorType.UserCharacter, Session.Id, Session.CharacterId, (object)Session.CharacterInfo, Position, this);
            if (actor == null)
                return false;
            this.AddActorToMap(actor);
            return true;
        }

        public bool AddNpcToMap(Npc Npc)
        {
            int actorId = this.GenerateActorId();
            Vector2 Position = new Vector2(Npc.LocX, Npc.LocY);
            MapActor actor = MapActor.TryCreateActor(actorId, MapActorType.AiBot, 0, Npc.Id, (object)Npc, Position, this);
            if (actor == null)
                return false;
            this.AddActorToMap(actor);
            return true;
        }

        private bool AddActorToMap(MapActor Actor)
        {
            if (this.mActors.ContainsKey(Actor.Id))
                return false;
            lock (this.mActors)
                this.mActors.Add(Actor.Id, Actor);
            if (Actor.Type == MapActorType.AiBot)
            {
                Npc referenceObject = (Npc)Actor.ReferenceObject;
                this.BroadcastMessageInRange(PacketComposer.Compose("C", referenceObject.Id.ToString() + "|" + (object)referenceObject.ShipId + "|0||" + referenceObject.Name + "|" + (object)referenceObject.LocX + "|" + (object)referenceObject.LocY + "|" + (object)referenceObject.FactionId + "|" + (object)referenceObject.IsClanMember + "|" + (object)referenceObject.Rank + "|" + (object)referenceObject.IsBoss + "|" + (object)referenceObject.IsClanMember + "|" + (object)referenceObject.GalaxyGatesRings), referenceObject.Id, false);
            }
            return true;
        }

        public MapActor GetActor(int ActorId)
        {
            lock (this.mActors)
            {
                if (this.mActors.ContainsKey(ActorId))
                    return this.mActors[ActorId];
            }
            return (MapActor)null;
        }

        public MapActor GetActorByReferenceId(int ReferenceId, MapActorType ReferenceType = MapActorType.UserCharacter)
        {
            lock (this.mActors)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (item_0.Type == ReferenceType && item_0.ReferenceId == ReferenceId)
                        return item_0;
                }
            }
            return (MapActor)null;
        }

        public void KickNpc(int ActorId)
        {
            MapActor actor = this.GetActor(ActorId);
            if (actor == null || actor.Type != MapActorType.AiBot || (Npc)actor.ReferenceObject == null)
                return;
            this.RemoveActorFromMap(ActorId);
        }

        public bool RemoveCharacterFromMap(int CharacterId)
        {
            int ActorId = 0;
            lock (this.mActorSyncRoot)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (item_0.Type == MapActorType.UserCharacter && item_0.ReferenceId == CharacterId)
                    {
                        ActorId = item_0.Id;
                        break;
                    }
                }
            }
            if (ActorId > 0)
                return this.RemoveActorFromMap(ActorId);
            return false;
        }

        public bool RemoveActorFromMap(int ActorId)
        {
            lock (this.mActorSyncRoot)
            {
                if (this.GetActor(ActorId) == null)
                {
                    Output.WriteLine((object)"Player null.");
                    return false;
                }
                this.mActors.Remove(ActorId);
                return true;
            }
        }

        public void BroadcastMovement(ServerMessage Message, int _Id, bool UsersWithRightsOnly = false)
        {
            lock (this.mActors)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (item_0.Type == MapActorType.UserCharacter && item_0.ReferenceId != _Id && item_0.ReferenceSessionId > 0)
                    {
                        Session local_1 = SessionManager.GetSessionById(item_0.ReferenceSessionId);
                        if (local_1 != null)
                            local_1.SendData(Message);
                    }
                }
            }
        }

        public void BroadcastMessageInRange(ServerMessage Message, int id, bool UsersWithRightsOnly = false)
        {
            lock (this.mActors)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (item_0.Type == MapActorType.UserCharacter)
                    {
                        Session local_1 = SessionManager.GetSessionById(item_0.ReferenceSessionId);
                        if (local_1 != null && local_1.CharacterInfo != null && local_1.CharacterInfo.NpcInRange.Contains(id))
                        {
                            local_1.SendData(Message);
                        }
                    }

                }
            }
        }

        public void BroadcastMessageForOtherOnly(ServerMessage Message, Session session)
        {
            lock (this.mActors)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (item_0.Type == MapActorType.UserCharacter)
                    {
                        Session local_1 = SessionManager.GetSessionById(item_0.ReferenceSessionId);
                        if (local_1 != null && local_1.CharacterId != session.CharacterId)
                            local_1.SendData(Message);
                    }
                }
            }
        }

        public void BroadcastMessage(ServerMessage Message, bool UsersWithRightsOnly = false)
        {
            lock (this.mActors)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (item_0.Type == MapActorType.UserCharacter)
                    {
                        Session local_1 = SessionManager.GetSessionById(item_0.ReferenceSessionId);
                        if (local_1 != null)
                            local_1.SendData(Message);
                    }
                }
            }
        }

        public void BroadcastMessageUserEnter(CharacterInfo User)
        {
            lock (this.mActors)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (item_0.Type == MapActorType.UserCharacter)
                    {
                        Session local_1 = SessionManager.GetSessionById(item_0.ReferenceSessionId);
                        if (local_1 != null)
                            local_1.SendData(MapUserEnterComposer.Compose(User, local_1));
                    }
                }
            }
        }

        public void SendObjects(Session Session)
        {
            CList<MapActor> Actors1 = new CList<MapActor>();
            CList<MapActor> Actors2 = new CList<MapActor>();
            CList<MapActor> clist1 = new CList<MapActor>();
            CList<int> clist2 = new CList<int>();
            lock (this.mActorSyncRoot)
            {
                foreach (MapActor item_0 in (IEnumerable<MapActor>)this.mActors.Values)
                {
                    if (item_0.Type != MapActorType.AiBot && item_0.Type != MapActorType.UserCharacter)
                    {
                        if (!((CharacterInfo)item_0.ReferenceObject).IsInvisibleForAll)
                            Actors1.Add(item_0);
                        if (((CharacterInfo)item_0.ReferenceObject).IsMoving && !((CharacterInfo)item_0.ReferenceObject).IsInvisibleForAll)
                            Actors2.Add(item_0);
                    }
                }
            }
            if (Actors1.Count > 0)
                Session.SendData(MapUserObjectListComposer.Compose(Actors1, Session));
            if (Actors2.Count > 0)
                Session.SendData(MapUserMovementListComposer.Compose(Actors2));
            // 🔥 Envoie au client la position actuelle du héros (0|H|x|y)
            Session.SendData(MapHeroInitComposer.Compose(Session.CharacterInfo));

            if (clist1.Count <= 0)
                ;
            if (Session.CharacterInfo.MapId == 1)
                Session.SendData(PacketComposer.Compose("s", "0|1|redStation|1|0|2000|1200"));
            if (Session.CharacterInfo.MapId == 5)
                Session.SendData(PacketComposer.Compose("s", "0|1|blueStation|2|0|19000|1200"));
            if (Session.CharacterInfo.MapId != 9)
                return;
            Session.SendData(PacketComposer.Compose("s", "0|1|greenStation|3|0|19200|11500"));
        }

        public void SendPortals(Session Session)
        {
            CList<PortalInfo> portalForMap = PortalManager.GetPortalForMap(this.MapId);
            if (portalForMap == null)
                return;
            Session.SendData(MapPortalsComposer.Compose(portalForMap, Session));
        }

        public static MapInstance TryCreateMapInstance(int InstanceId, int MapId)
        {
            MapInfo mapInfo = MapInfoLoader.GetMapInfo(MapId);
            if (mapInfo == null)
                return (MapInstance)null;
            return new MapInstance(InstanceId, mapInfo);
        }

        public void Unload()
        {
            if (this.mUnloaded)
                return;
            this.mUnloaded = true;
            lock (this.mActorSyncRoot)
                this.mActors.Clear();
            this.mUnloadedTimestamp = UnixTimestamp.GetCurrent();
        }

        public void Dispose()
        {
            if (!this.mUnloaded)
                this.Unload();
            this.mUpdater.Dispose();
            this.mUpdater = (Timer)null;
            this.mInfo = (MapInfo)null;
        }

        public void PerformUpdate(object state)
        {
            CDictionnary<int, MapActor> cdictionnary = new CDictionnary<int, MapActor>();
            lock (this.mActorSyncRoot)
            {
                foreach (KeyValuePair<int, MapActor> item_0 in (ConcurrentDictionary<int, MapActor>)this.mActors)
                    cdictionnary.Add(item_0.Key, item_0.Value);
            }
            foreach (MapActor mapActor in (IEnumerable<MapActor>)cdictionnary.Values)
            {
                if (mapActor.Type == MapActorType.UserCharacter)
                    mapActor.IncreaseIdleTime();
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\MapManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.MapManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Maps
{
  public static class MapManager
  {
    private static Timer mMapInstanceThread;
    private static CDictionnary<int, MapInstance> mMapInstances;
    private static int mInstanceIdGenerator;
    private static object mIdGeneratorSyncLock;

    public static CDictionnary<int, MapInstance> MapInstances
    {
      get
      {
        return MapManager.mMapInstances;
      }
    }

    public static void Initialize(SqlDatabaseClient MySqlClient)
    {
      MapManager.mMapInstances = new CDictionnary<int, MapInstance>();
      MapManager.mMapInstanceThread = new Timer(new TimerCallback(MapManager.ProcessMaps), (object) null, TimeSpan.FromSeconds(10.0), TimeSpan.FromSeconds(10.0));
      MapManager.mInstanceIdGenerator = 1;
      MapManager.mIdGeneratorSyncLock = new object();
    }

    public static int GenerateInstanceId()
    {
      lock (MapManager.mIdGeneratorSyncLock)
        return MapManager.mInstanceIdGenerator++;
    }

    private static void ProcessMaps(object state)
    {
      CDictionnary<int, MapInstance> cdictionnary = new CDictionnary<int, MapInstance>();
      bool lockTaken1 = false;
      try
      {
        Monitor.Enter((object) (mMapInstances = MapManager.mMapInstances), ref lockTaken1);
        foreach (KeyValuePair<int, MapInstance> mMapInstance in (ConcurrentDictionary<int, MapInstance>) MapManager.mMapInstances)
          cdictionnary.Add(mMapInstance.Key, mMapInstance.Value);
      }
      finally
      {
        if (lockTaken1)
          Monitor.Exit((object) mMapInstances);
      }
      CList<int> clist1 = new CList<int>();
      CList<int> clist2 = new CList<int>();
      foreach (MapInstance mapInstance in (IEnumerable<MapInstance>) cdictionnary.Values)
      {
        if (mapInstance.Unloaded)
        {
          if (mapInstance.TimeUnloaded > 15.0)
            clist1.Add(mapInstance.InstanceId);
        }
        else if (mapInstance.HumanActorCount == 0)
        {
          if (mapInstance.MarkedAsEmpty >= 1)
            clist2.Add(mapInstance.InstanceId);
          else
            ++mapInstance.MarkedAsEmpty;
        }
        else if (mapInstance.MarkedAsEmpty > 0)
          mapInstance.MarkedAsEmpty = 0;
      }
      bool lockTaken2 = false;
      try
      {
        Monitor.Enter((object) (mMapInstances = MapManager.mMapInstances), ref lockTaken2);
        foreach (int key in (IEnumerable<int>) clist2.Keys)
        {
          if (MapManager.mMapInstances.ContainsKey(key))
          {
            MapManager.mMapInstances[key].Unload();
            Output.WriteLine((object) ("[MapMgr] Unloaded map instance " + (object) key + "."), OutputLevel.Warning);
          }
        }
        foreach (int key in (IEnumerable<int>) clist1.Keys)
        {
          if (MapManager.mMapInstances.ContainsKey(key))
          {
            MapManager.mMapInstances[key].Dispose();
            MapManager.mMapInstances[key] = (MapInstance) null;
            MapManager.mMapInstances.Remove(key);
            Output.WriteLine((object) ("[MapMgr] Disposed of map instance " + (object) key + " and associated resources."), OutputLevel.Warning);
          }
        }
      }
      finally
      {
        if (lockTaken2)
          Monitor.Exit((object) mMapInstances);
      }
    }

    public static bool InstanceIsLoadedForMap(int MapId)
    {
      return MapManager.GetInstanceByMapId(MapId) != null;
    }

    public static bool TryLoadMapInstance(int MapId)
    {
      lock (MapManager.mMapInstances)
      {
        if (MapManager.GetInstanceByMapId(MapId) != null)
          return false;
        int local_1 = MapManager.GenerateInstanceId();
        MapInstance local_2 = MapInstance.TryCreateMapInstance(local_1, MapId);
        if (local_2 == null)
          return false;
        lock (MapManager.mMapInstances)
          MapManager.mMapInstances.Add(local_1, local_2);
        Output.WriteLine((object) ("[MapMgr] Map instance " + (object) local_1 + " has been loaded for Map " + (object) MapId + "."), OutputLevel.Warning);
      }
      return true;
    }

    public static MapInstance GetInstanceByMapId(int MapId)
    {
      lock (MapManager.mMapInstances)
      {
        foreach (MapInstance item_0 in (IEnumerable<MapInstance>) MapManager.mMapInstances.Values)
        {
          if (!item_0.Unloaded && item_0.Info.Id == MapId)
            return item_0;
        }
      }
      return (MapInstance) null;
    }

    public static bool RemoveUserFromMap(Session Session)
    {
      int absoluteMapId = Session.AbsoluteMapId;
      bool flag = false;
      if (absoluteMapId > 0)
      {
        if (Session.MapJoined)
        {
          MapInstance instanceByMapId = MapManager.GetInstanceByMapId(absoluteMapId);
          if (instanceByMapId != null)
            instanceByMapId.RemoveCharacterFromMap(Session.CharacterId);
        }
        Session.AbsoluteMapId = 0;
        Session.MapAuthed = false;
        Session.MapJoined = false;
        flag = true;
      }
      return flag;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\ApocalypseBox.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
    class ApocalypseBox : Collectable
    {

        public ApocalypseBox(int Id, int X, int Y, int MapId)
            : base(Id, 26, X, Y, MapId)
        {
        }

        public override void Collect(Session user)
        {
            if (this.Collecting)
            {
                user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
            }
            else
            {
                MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
                if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id) || Math.Sqrt(Math.Pow((double)(this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double)(this.Y - user.CharacterInfo.LocY), 2.0)) > 300.0)
                    return;
                if (user.CharacterInfo.BootyKeys <= 0)
                {
                    user.SendData(PacketComposer.Compose("A", "STD|You don't have any booty key."));
                }
                else
                {
                    user.CharacterInfo.RemoveBootyKey(1);
                    user.SendData(PacketComposer.Compose("A", "BK|" + (object)user.CharacterInfo.BootyKeys));
                    this.Collecting = true;
                    Random random = new Random();
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        int num = random.Next(1, 101);
                        if (num > 0 && num <= 5)
                        {
                            user.CharacterInfo.AddTokens(client, 1);
                            user.SendData(PacketComposer.Compose("A", "STD|You received a token."));
                        }
                        else if (num > 5 && num <= 10)
                        {
                            user.CharacterInfo.AddTickets(client, 1);
                            user.SendData(PacketComposer.Compose("A", "STD|You received a lottery's ticket."));
                        }
                        else if (num > 10 && num <= 25)
                        {
                            int npcPoints = random.Next(800, 1000);
                            user.CharacterInfo.AddReward(client, 0, 0, npcPoints, true);
                            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)npcPoints + " NPC point(s)."));
                        }
                        else if (num > 25 && num <= 40)
                        {
                            int rp = random.Next(800,1000);
                            user.CharacterInfo.AddRankpoints(client, rp);
                            user.SendData(PacketComposer.Compose("A", "STD|You received "+ rp +" rankpoints."));
                        }
                        else if (num > 40 && num <= 55)
                        {
                            int uri = random.Next(8000, 10000);
                            user.CharacterInfo.AddReward(client, 0, uri, 0, true);
                            user.SendData(PacketComposer.Compose("y", "URI|" + (object)uri + "|" + (object)user.CharacterInfo.Uridium));
                        }
                        else if (num > 55 && num <=70)
                        {
                            user.CharacterInfo.AddCargo(11L, 200);
                            user.CharacterInfo.AddCargo(12L, 200);
                            user.SendData(PacketComposer.Compose("A", "STD|You received 200 Prometids/Duraniums."));
                            user.SendData(user.CharacterInfo.GetCargoMessage());
                        }
                        else if (num > 70 && num <= 85)
                        {
                            int credit = random.Next(150000000, 200000000);
                            user.CharacterInfo.AddReward(client, credit, 0, 0, true);
                            user.SendData(PacketComposer.Compose("y", "CRE|" + (object)credit + "|" + (object)user.CharacterInfo.Credits));
                        }
                        else if (num > 85 && num <= 100)
                        {
                            user.CharacterInfo.AddCargo(5L, 40);
                            user.SendData(PacketComposer.Compose("A", "STD|You received 40 palladiums."));
                            user.SendData(user.CharacterInfo.GetCargoMessage());
                        }
                    }
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)this.Id)), false);
                    instanceByMapId.Info.Collectables.Remove(this.Id);
                }
            }
        }

    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\BonusBox.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.Collectables.BonusBox
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
  internal class BonusBox : Collectable
  {
    public BonusBox(int Id, int X, int Y, int MapId)
      : base(Id, 2, X, Y, MapId)
    {
    }

    public override void Collect(Session user)
    {
      if (this.Collecting)
      {
        user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
      }
      else
      {
        MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
        if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id) || Math.Sqrt(Math.Pow((double) (this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double) (this.Y - user.CharacterInfo.LocY), 2.0)) > 300.0)
          return;
        this.Collecting = true;
        Random random = new Random();
        using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
        {
          if (random.Next(0, 2) == 0)
          {
            int uridium = random.Next(500, 1200);
            user.CharacterInfo.AddReward(client, 0, uridium, 0, true);
            user.SendData(PacketComposer.Compose("y", "URI|" + (object) uridium + "|" + (object) user.CharacterInfo.Uridium));
          }
          else
          {
            int credits = random.Next(4000, 30000);
            user.CharacterInfo.AddReward(client, credits, 0, 0, true);
            user.SendData(PacketComposer.Compose("y", "CRE|" + (object) credits + "|" + (object) user.CharacterInfo.Credits));
          }
        }
        instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object) this.Id)), false);
        this.X = random.Next(500, 20000);
        this.Y = random.Next(500, 12000);
        this.Collecting = false;
        instanceByMapId.BroadcastMessage(PacketComposer.Compose("c", this.Id.ToString() + "|" + (object) this.Type + "|" + (object) this.X + "|" + (object) this.Y), 0 != 0);
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\BootyBox.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.Collectables.BootyBox
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
  internal class BootyBox : Collectable
  {
    public BootyBox(int Id, int X, int Y, int MapId)
      : base(Id, 21, X, Y, MapId)
    {
    }

    public override void Collect(Session user)
    {
      if (this.Collecting)
      {
        user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
      }
      else
      {
        MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
        if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id) || Math.Sqrt(Math.Pow((double) (this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double) (this.Y - user.CharacterInfo.LocY), 2.0)) > 300.0)
          return;
        if (user.CharacterInfo.BootyKeys <= 0)
        {
          user.SendData(PacketComposer.Compose("A", "STD|You don't have any booty key."));
        }
        else
        {
          user.CharacterInfo.RemoveBootyKey(1);
          user.SendData(PacketComposer.Compose("A", "BK|" + (object) user.CharacterInfo.BootyKeys));
          this.Collecting = true;
          Random random = new Random();
          using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
          {
            int num = random.Next(1, 100);
            if (num >= 1 && num < 25)
            {
              int uridium = random.Next(1000, 2500);
              user.CharacterInfo.AddReward(client, 0, uridium, 0, true);
              user.SendData(PacketComposer.Compose("y", "URI|" + (object) uridium + "|" + (object) user.CharacterInfo.Uridium));
            }
            else if (num >= 25 && num < 35)
            {
              int npcPoints = random.Next(50,100);
              user.CharacterInfo.AddReward(client, 0, 0, npcPoints, true);
              user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) npcPoints + " NPC point(s)."));
            }
            else if (num >= 35 && num < 70)
            {
              if (random.Next(1, 3) == 1)
              {
                user.CharacterInfo.AddBoosterReward("dmg", 1);
                user.SendData(PacketComposer.Compose("A", "STD|You received DMG-Booster (1 hour)"));
              }
              else
              {
                user.CharacterInfo.AddBoosterReward("shd", 1);
                user.SendData(PacketComposer.Compose("A", "STD|You received SHD-Booster (1 hour)"));
              }
            }
            else if (num >= 70 && num < 85)
            {
              user.CharacterInfo.AddBoosterReward("npcPoints", 1);
              user.SendData(PacketComposer.Compose("A", "STD|You received NPC_POINTS-Booster (1 hour)"));
            }
            else if (num >= 85 && num < 100)
            {
              if (!user.CharacterInfo.ApisBuilt || !user.CharacterInfo.ZeusBuilt)
              {
                user.CharacterInfo.AddDronePart(1);
                user.SendData(PacketComposer.Compose("A", "STD|You received a special drone part."));
              }
              else
              {
                int amount = random.Next(3, 6);
                user.CharacterInfo.AddLogfiles(amount);
                user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) amount + " logfiles."));
              }
            }
          }
          instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object) this.Id)), false);
          instanceByMapId.Info.Collectables.Remove(this.Id);
        }
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\CargoBox.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.Collectables.CargoBox
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using System;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
  internal class CargoBox : Collectable
  {
    private int m_iPrometium;
    private int m_iEndurium;
    private int m_iTerbium;
    private int m_iXenomit;
    private int m_iPalladium;
    private int m_iPrometid;
    private int m_iDuranium;
    private int m_iPromerium;

    public int Prometium
    {
      get
      {
        return this.m_iPrometium;
      }
      set
      {
        this.m_iPrometium = value;
      }
    }

    public int Endurium
    {
      get
      {
        return this.m_iEndurium;
      }
      set
      {
        this.m_iEndurium = value;
      }
    }

    public int Terbium
    {
      get
      {
        return this.m_iTerbium;
      }
      set
      {
        this.m_iTerbium = value;
      }
    }

    public int Xenomit
    {
      get
      {
        return this.m_iXenomit;
      }
      set
      {
        this.m_iXenomit = value;
      }
    }

    public int Palladium
    {
      get
      {
        return this.m_iPalladium;
      }
      set
      {
        this.m_iPalladium = value;
      }
    }

    public int Prometid
    {
      get
      {
        return this.m_iPrometid;
      }
      set
      {
        this.m_iPrometid = value;
      }
    }

    public int Duranium
    {
      get
      {
        return this.m_iDuranium;
      }
      set
      {
        this.m_iDuranium = value;
      }
    }

    public int Promerium
    {
      get
      {
        return this.m_iPromerium;
      }
      set
      {
        this.m_iPromerium = value;
      }
    }

    public CargoBox(int Id, int X, int Y, int MapId)
      : base(Id, 1, X, Y, MapId)
    {
    }

    public override void Collect(Session user)
    {
      if (this.Collecting)
      {
        user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
      }
      else
      {
        MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
        if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id))
          return;
        double num = Math.Sqrt(Math.Pow((double) (this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double) (this.Y - user.CharacterInfo.LocY), 2.0));
        if (num > 300.0)
        {
          Output.WriteLine((object) num);
        }
        else
        {
          this.Collecting = true;
          if (this.Prometium > 0)
          {
            user.CharacterInfo.AddCargo(1L, this.Prometium);
            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) this.Prometium + " Prometium."));
          }
          if (this.Endurium > 0)
          {
            user.CharacterInfo.AddCargo(2L, this.Endurium);
            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) this.Endurium + " Endurium."));
          }
          if (this.Terbium > 0)
          {
            user.CharacterInfo.AddCargo(3L, this.Terbium);
            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) this.Terbium + " Terbium."));
          }
          if (this.Xenomit > 0)
          {
            user.CharacterInfo.AddCargo(4L, this.Xenomit);
            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) this.Xenomit + " Xenomit."));
          }
          if (this.Palladium > 0)
          {
            user.CharacterInfo.AddCargo(5L, this.Palladium);
            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) this.Palladium + " Palladium."));
          }
          if (this.Prometid > 0)
          {
            user.CharacterInfo.AddCargo(11L, this.Prometid);
            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) this.Prometid + " Prometid."));
          }
          if (this.Duranium > 0)
          {
            user.CharacterInfo.AddCargo(12L, this.Duranium);
            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) this.Duranium + " Duranium."));
          }
          if (this.Promerium > 0)
          {
            user.CharacterInfo.AddCargo(13L, this.Promerium);
            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object) this.Promerium + " Promerium."));
          }
          user.SendData(user.CharacterInfo.GetCargoMessage());
          instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object) this.Id)), false);
          instanceByMapId.Info.Collectables.Remove(this.Id);
        }
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\Collectable.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.Collectables.Collectable
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Sessions;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
  public class Collectable
  {
    private int m_iId;
    private int m_iType;
    private int m_iX;
    private int m_iY;
    private int m_iMapId;
    private bool m_bCollecting;

    public int Id
    {
      get
      {
        return this.m_iId;
      }
      set
      {
        this.m_iId = value;
      }
    }

    public int Type
    {
      get
      {
        return this.m_iType;
      }
      set
      {
        this.m_iType = value;
      }
    }

    public int X
    {
      get
      {
        return this.m_iX;
      }
      set
      {
        this.m_iX = value;
      }
    }

    public int Y
    {
      get
      {
        return this.m_iY;
      }
      set
      {
        this.m_iY = value;
      }
    }

    public int MapId
    {
      get
      {
        return this.m_iMapId;
      }
      set
      {
        this.m_iMapId = value;
      }
    }

    public bool Collecting
    {
      get
      {
        return this.m_bCollecting;
      }
      set
      {
        this.m_bCollecting = value;
      }
    }

    public Collectable(int Id, int Type, int X, int Y, int MapId)
    {
      this.Id = Id;
      this.Type = Type;
      this.X = X;
      this.Y = Y;
      this.MapId = MapId;
      this.Collecting = false;
    }

    public virtual void Collect(Session user)
    {
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\GoldBootyBox.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
    internal class GoldBootyBox : Collectable
    {

        public GoldBootyBox(int Id, int X, int Y, int MapId)
        : base(Id, 24, X, Y, MapId)
        {
        }

        public override void Collect(Session user)
        {
            if (this.Collecting)
            {
                user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
            }
            else
            {
                MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
                if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id) || Math.Sqrt(Math.Pow((double)(this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double)(this.Y - user.CharacterInfo.LocY), 2.0)) > 300.0)
                    return;
                if (user.CharacterInfo.BootyKeys <= 0)
                {
                    user.SendData(PacketComposer.Compose("A", "STD|You don't have any booty key."));
                }
                else
                {
                    user.CharacterInfo.RemoveBootyKey(1);
                    user.SendData(PacketComposer.Compose("A", "BK|" + (object)user.CharacterInfo.BootyKeys));
                    this.Collecting = true;
                    Random random = new Random();
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        int num = random.Next(1, 101);

                        if(num > 0 && num <=5)
                        {
                            user.CharacterInfo.AddTokens(client, 1);
                            user.SendData(PacketComposer.Compose("A", "STD|You received a token."));
                        }
                        else if(num > 5 && num <= 10)
                        {
                            user.CharacterInfo.AddTickets(client, 1);
                            user.SendData(PacketComposer.Compose("A", "STD|You received a lottery's ticket."));
                        }
                        else if (num > 10 && num <= 35)
                        {
                            int uridium = random.Next(5000, 7000);
                            user.CharacterInfo.AddReward(client, 0, uridium, 0, true);
                            user.SendData(PacketComposer.Compose("y", "URI|" + (object)uridium + "|" + (object)user.CharacterInfo.Uridium));
                        }
                        else if (num > 35 && num <= 45)
                        {
                            int rp = random.Next(300, 500);
                            user.CharacterInfo.AddRankpoints(client, rp);
                            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)rp + " rankpoints."));
                        }
                        else if(num > 45 && num <= 65)
                        {
                            user.CharacterInfo.AddCargo(11L, 150);
                            user.CharacterInfo.AddCargo(12L, 150);
                            user.SendData(PacketComposer.Compose("A", "STD|You received 150 Prometids/Duraniums."));
                            user.SendData(user.CharacterInfo.GetCargoMessage());
                        }
                        else if(num > 65 && num <= 85)
                        {
                            user.CharacterInfo.AddBoosterReward("dmg", 1);
                            user.CharacterInfo.AddBoosterReward("shd", 1);
                            user.CharacterInfo.AddBoosterReward("hp", 1);
                            user.CharacterInfo.AddBoosterReward("spd", 1);
                            user.CharacterInfo.AddBoosterReward("npcPoints", 1);
                            user.SendData(PacketComposer.Compose("A", "STD|You received 1 hour of each boosters."));
                        }
                        else if (num > 85 && num <= 100)
                        {
                            if (!user.CharacterInfo.ApisBuilt || !user.CharacterInfo.ZeusBuilt)
                            {
                                user.CharacterInfo.AddDronePart(3);
                                user.SendData(PacketComposer.Compose("A", "STD|You received 3 specials drone parts."));
                            }
                            else
                            {
                                int amount = random.Next(30, 50);
                                user.CharacterInfo.AddLogfiles(amount);
                                user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)amount + " logfiles."));
                            }
                        }
                    }
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)this.Id)), false);
                    instanceByMapId.Info.Collectables.Remove(this.Id);
                }
            }
        }

    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\LifeBox.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.Collectables.LifeBox
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using System;
using System.Collections.Generic;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
  internal class LifeBox : Collectable
  {
    public LifeBox(int Id, int X, int Y, int MapId)
      : base(Id, 19, X, Y, MapId)
    {
    }

    public override void Collect(Session user)
    {
      if (this.Collecting)
      {
        user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
      }
      else
      {
        MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
        if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id))
          return;
        double num1 = Math.Sqrt(Math.Pow((double) (this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double) (this.Y - user.CharacterInfo.LocY), 2.0));
        if (num1 > 300.0)
        {
          Output.WriteLine((object) num1);
        }
        else
        {
          this.Collecting = true;
          Random random = new Random();
          int num2 = 15000 + random.Next(0, 10000);
          if (user.CharacterInfo.ShipHp + num2 > user.CharacterInfo.ShipMaxHp)
          {
            num2 = user.CharacterInfo.ShipMaxHp - user.CharacterInfo.ShipHp;
            user.CharacterInfo.ShipHp = user.CharacterInfo.ShipMaxHp;
          }
          else
            user.CharacterInfo.ShipHp = user.CharacterInfo.ShipHp + num2;
          user.SendData(PacketComposer.Compose("A", "HL|1|" + (object) user.CharacterInfo.Id + "|HPT|" + (object) user.CharacterInfo.ShipHp + "|" + (object) num2));
          foreach (MapActor key in (IEnumerable<MapActor>) instanceByMapId.Actors.Keys)
          {
            if (key.Type == MapActorType.UserCharacter)
            {
              Session sessionById = SessionManager.GetSessionById(key.ReferenceSessionId);
              if (sessionById != null && sessionById.CharacterInfo != null && sessionById.CharacterInfo.SelectedPlayer == user.CharacterId)
                sessionById.SendData(PacketComposer.Compose("A", "HL|1|" + (object) user.CharacterInfo.Id + "|HPT|" + (object) user.CharacterInfo.ShipHp + "|" + (object) num2));
            }
          }
          instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object) this.Id)), false);
          this.X = random.Next(500, 20000);
          this.Y = random.Next(500, 12000);
          this.Collecting = false;
          instanceByMapId.BroadcastMessage(PacketComposer.Compose("c", this.Id.ToString() + "|" + (object) this.Type + "|" + (object) this.X + "|" + (object) this.Y), 0 != 0);
        }
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\RedBootyBox.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
    internal class RedBootyBox : Collectable
    {

        public RedBootyBox(int Id, int X, int Y, int MapId)
         : base(Id, 23, X, Y, MapId)
        {
        }

        public override void Collect(Session user)
        {
            if (this.Collecting)
            {
                user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
            }
            else
            {
                MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
                if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id) || Math.Sqrt(Math.Pow((double)(this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double)(this.Y - user.CharacterInfo.LocY), 2.0)) > 300.0)
                    return;
                if (user.CharacterInfo.BootyKeys <= 0)
                {
                    user.SendData(PacketComposer.Compose("A", "STD|You don't have any booty key."));
                }
                else
                {
                    user.CharacterInfo.RemoveBootyKey(1);
                    user.SendData(PacketComposer.Compose("A", "BK|" + (object)user.CharacterInfo.BootyKeys));
                    this.Collecting = true;
                    Random random = new Random();
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        int num = random.Next(1, 100);
                        if (num >= 1 && num < 25)
                        {
                            int uridium = random.Next(3000, 5000);
                            user.CharacterInfo.AddReward(client, 0, uridium, 0, true);
                            user.SendData(PacketComposer.Compose("y", "URI|" + (object)uridium + "|" + (object)user.CharacterInfo.Uridium));
                        }
                        else if (num >= 25 && num < 35)
                        {
                            int npcPoints = random.Next(200, 300);
                            user.CharacterInfo.AddReward(client, 0, 0, npcPoints, true);
                            user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)npcPoints + " NPC point(s)."));
                        }
                        else if (num >= 35 && num < 70)
                        {
                            if (random.Next(1, 4) <=2)
                            {
                                user.CharacterInfo.AddBoosterReward("spd", 1);
                                user.SendData(PacketComposer.Compose("A", "STD|You received SPD-Booster (1 hour)"));
                            }
                            else
                            {
                                user.CharacterInfo.AddBoosterReward("hp", 1);
                                user.SendData(PacketComposer.Compose("A", "STD|You received HP-Booster (1 hour)"));
                            }
                        }
                        else if (num >= 70 && num < 85)
                        {
                            user.CharacterInfo.AddBoosterReward("npcPoints", 2);
                            user.SendData(PacketComposer.Compose("A", "STD|You received NPC_POINTS-Booster (2 hours)"));
                        }
                        else if (num >= 85 && num < 100)
                        {
                            if (!user.CharacterInfo.ApisBuilt || !user.CharacterInfo.ZeusBuilt)
                            {
                                user.CharacterInfo.AddDronePart(2);
                                user.SendData(PacketComposer.Compose("A", "STD|You received 2 specials drone parts."));
                            }
                            else
                            {
                                int amount = random.Next(10, 15);
                                user.CharacterInfo.AddLogfiles(amount);
                                user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)amount + " logfiles."));
                            }
                        }
                    }
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)this.Id)), false);
                    instanceByMapId.Info.Collectables.Remove(this.Id);
                }
            }
        }

    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\ShieldBox.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.Collectables.ShieldBox
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using System;
using System.Collections.Generic;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
  internal class ShieldBox : Collectable
  {
    public ShieldBox(int Id, int X, int Y, int MapId)
      : base(Id, 10, X, Y, MapId)
    {
    }

    public override void Collect(Session user)
    {
      if (this.Collecting)
      {
        user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
      }
      else
      {
        MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
        if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id))
          return;
        double num1 = Math.Sqrt(Math.Pow((double) (this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double) (this.Y - user.CharacterInfo.LocY), 2.0));
        if (num1 > 300.0)
        {
          Output.WriteLine((object) num1);
        }
        else
        {
          this.Collecting = true;
          Random random = new Random();
          int num2 = 30000 + random.Next(0, 20000);
          if (user.CharacterInfo.ShipShield + num2 > user.CharacterInfo.ShipMaxShield)
          {
            num2 = user.CharacterInfo.ShipMaxShield - user.CharacterInfo.ShipShield;
            user.CharacterInfo.ShipShield = user.CharacterInfo.ShipMaxShield;
          }
          else
            user.CharacterInfo.ShipShield = user.CharacterInfo.ShipShield + num2;
          user.SendData(PacketComposer.Compose("A", "HL|1|" + (object) user.CharacterInfo.Id + "|SHD|" + (object) user.CharacterInfo.ShipShield + "|" + (object) num2));
          foreach (MapActor key in (IEnumerable<MapActor>) instanceByMapId.Actors.Keys)
          {
            if (key.Type == MapActorType.UserCharacter)
            {
              Session sessionById = SessionManager.GetSessionById(key.ReferenceSessionId);
              if (sessionById != null && sessionById.CharacterInfo.SelectedPlayer == user.CharacterId)
                sessionById.SendData(PacketComposer.Compose("A", "HL|1|" + (object) user.CharacterInfo.Id + "|SHD|" + (object) user.CharacterInfo.ShipShield + "|" + (object) num2));
            }
          }
          instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object) this.Id)), false);
          this.X = random.Next(500, 20000);
          this.Y = random.Next(500, 12000);
          this.Collecting = false;
          instanceByMapId.BroadcastMessage(PacketComposer.Compose("c", this.Id.ToString() + "|" + (object) this.Type + "|" + (object) this.X + "|" + (object) this.Y), 0 != 0);
        }
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\SilverBootyKey.cs 
======================================================== 
﻿using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
    class SilverBootyBox : Collectable
    {

        public SilverBootyBox(int Id, int X, int Y, int MapId)
            : base(Id, 25, X, Y, MapId)
        {
        }

        public override void Collect(Session user)
        {
            if (this.Collecting)
            {
                user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
            }
            else
            {
                MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
                if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id) || Math.Sqrt(Math.Pow((double)(this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double)(this.Y - user.CharacterInfo.LocY), 2.0)) > 300.0)
                    return;
                if (user.CharacterInfo.BootyKeys <= 0)
                {
                    user.SendData(PacketComposer.Compose("A", "STD|You don't have any booty key."));
                }
                else
                {
                    user.CharacterInfo.RemoveBootyKey(1);
                    user.SendData(PacketComposer.Compose("A", "BK|" + (object)user.CharacterInfo.BootyKeys));
                    this.Collecting = true;
                    Random random = new Random();
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        int num = random.Next(1, 101);
                        if(num > 0 && num <=5)
                        {
                            user.CharacterInfo.AddTokens(client, 1);
                            user.SendData(PacketComposer.Compose("A", "STD|You received a token."));
                        }
                        else if(num > 5 && num <=25)
                        {
                            int pvpPoints = random.Next(400, 500);
                            user.CharacterInfo.AddPvpPoints(client, pvpPoints);
                            user.SendData(PacketComposer.Compose("A", "STD|You received "+pvpPoints+" Pvp points."));
                        }
                        else if (num > 25 && num <= 40)
                        {
                            user.CharacterInfo.AddCargo(13L, 20);
                            user.SendData(PacketComposer.Compose("A", "STD|You received 20 promeriums."));
                            user.SendData(user.CharacterInfo.GetCargoMessage());
                        }
                        else if (num > 40 && num <= 60)
                        {
                            int rp = random.Next(300, 500);
                            user.CharacterInfo.AddRankpoints(client, rp);
                            user.SendData(PacketComposer.Compose("A", "STD|You received "+rp+" rankpoints."));
                        }
                        else if(num > 60 && num <= 85 )
                        {
                            user.CharacterInfo.AddCargo(5L, 20);
                            user.SendData(PacketComposer.Compose("A", "STD|You received 20 palladiums."));
                            user.SendData(user.CharacterInfo.GetCargoMessage());
                        }
                        else if (num > 85 && num <= 100)
                        {
                            user.CharacterInfo.AddCargo(11L, 200);
                            user.SendData(PacketComposer.Compose("A", "STD|You received 200 prometids."));
                            user.SendData(user.CharacterInfo.GetCargoMessage());
                        }
                    }
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)this.Id)), false);
                    instanceByMapId.Info.Collectables.Remove(this.Id);
                }
            }
        }

    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Maps\Collectables\SpaceballBox.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Maps.Collectables.SpaceballBox
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System;

namespace OrbitReborn_Emulator.Game.Maps.Collectables
{
    internal class SpaceballBox : Collectable
    {
        public SpaceballBox(int Id, int X, int Y, int MapId)
          : base(Id, 1, X, Y, MapId)
        {
        }

        public override void Collect(Session user)
        {
            if (this.Collecting)
            {
                user.SendData(PacketComposer.Compose("A", "STD|Box is already beeing collected !"));
            }
            else
            {
                MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
                if (instanceByMapId == null || !instanceByMapId.Info.Collectables.ContainsKey(this.Id) || Math.Sqrt(Math.Pow((double)(this.X - user.CharacterInfo.LocX), 2.0) + Math.Pow((double)(this.Y - user.CharacterInfo.LocY), 2.0)) > 300.0)
                    return;
                this.Collecting = true;
                Random random = new Random();
                using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                {
                    int num1 = random.Next(1, 100);
                    if (num1 >= 0 && num1 < 20)
                    {
                        int uridium = random.Next(12000, 20000);
                        user.CharacterInfo.AddReward(client, 0, uridium, 0, true);
                        user.SendData(PacketComposer.Compose("y", "URI|" + (object)uridium + "|" + (object)user.CharacterInfo.Uridium));
                    }
                    else if (num1 >= 20 && num1 < 30)
                    {
                        user.CharacterInfo.AddBoosterReward("npcPoints", 2);
                        user.SendData(PacketComposer.Compose("A", "STD|You received NPC_POINTS-Booster (2 hours)"));
                    }
                    else if (num1 >= 30 && num1 < 40)
                    {
                        user.CharacterInfo.AddPvpPoints(client, 150);
                        user.SendData(PacketComposer.Compose("A", "STD|You received 150 Pvp points."));
                    }
                    else if (num1 >= 40 && num1 < 50)
                    {
                        string _Message = "You received 500 rankpoints";
                        user.SendData(PacketComposer.Compose("A", "STD|" + _Message));
                        user.CharacterInfo.AddLog(client, _Message);
                        user.CharacterInfo.AddRankpoints(client, 500);
                    }
                    else if (num1 >= 50 && num1 < 60)
                    {
                        int num2 = random.Next(20, 30);
                        user.CharacterInfo.AddCargo(13L, num2);
                        user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)num2 + " Promerium."));
                    }
                    else if (num1 >= 60 && num1 < 70)
                    {
                        int num2 = random.Next(10, 30);
                        user.CharacterInfo.AddCargo(5L, num2);
                        user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)num2 + " Palladium."));
                    }
                    else if (num1 >= 70 && num1 < 90)
                    {
                        user.CharacterInfo.AddBoosterReward("shd", 3);
                        user.CharacterInfo.AddBoosterReward("dmg", 3);
                        user.CharacterInfo.AddBoosterReward("hp", 3);
                        user.CharacterInfo.AddBoosterReward("spd", 3);
                        user.SendData(PacketComposer.Compose("A", "STD|You received SHD/DMG/HP/SPD-Booster (1 hour)"));
                    }
                    else if (num1 >= 90 && num1 < 100)
                    {
                        int num2 = 300;
                        user.CharacterInfo.AddCargo(11L, num2);
                        user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)num2 + " Prometid."));
                        int num3 = 300;
                        user.CharacterInfo.AddCargo(12L, num3);
                        user.SendData(PacketComposer.Compose("A", "STD|You received " + (object)num3 + " Duranium."));
                    }
                }
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)this.Id)), false);
                instanceByMapId.Info.Collectables.Remove(this.Id);
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Misc\CrossdomainPolicy.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Misc.CrossdomainPolicy
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Config;
using System;
using System.IO;
using System.Text;

namespace OrbitReborn_Emulator.Game.Misc
{
  public static class CrossdomainPolicy
  {
    private static string mPolicyText;

    public static string PolicyText
    {
      get
      {
        return CrossdomainPolicy.mPolicyText;
      }
    }

    public static void Initialize(string Path)
    {
      if (!File.Exists(Path))
        throw new ArgumentException("Crossdomain policy file not found at: " + Path + ".");
      CrossdomainPolicy.mPolicyText = File.ReadAllText(Path);
    }

    public static byte[] GetBytes()
    {
      return CrossdomainPolicy.GetBytes(Constants.DefaultEncoding);
    }

    public static byte[] GetBytes(Encoding Encoding)
    {
      return Encoding.GetBytes(CrossdomainPolicy.mPolicyText);
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Misc\HappyHour.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Misc.HappyHour
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Game.Misc
{
  public static class HappyHour
  {
    private static bool mEnabled = false;

    public static bool Enabled
    {
      get
      {
        return HappyHour.mEnabled;
      }
      set
      {
        HappyHour.mEnabled = value;
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Misc\PvpManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Misc.PvpManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Game.Misc
{
  public static class PvpManager
  {
    private static bool mPvpEnabled = true;

    public static bool PvpEnabled
    {
      get
      {
        return PvpManager.mPvpEnabled;
      }
      set
      {
        PvpManager.mPvpEnabled = value;
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Moderation\ModerationBanManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Moderation.ModerationBanManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Data;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Moderation
{
  public static class ModerationBanManager
  {
    private static CList<int> mCharacterBlacklist;
    private static CList<string> mRemoteAddressBlacklist;
    private static CList<int> mChatBlacklist;
    private static Timer mWorker;
    private static object mSyncRoot;

    public static void Initialize(SqlDatabaseClient MySqlClient)
    {
      ModerationBanManager.mCharacterBlacklist = new CList<int>();
      ModerationBanManager.mRemoteAddressBlacklist = new CList<string>();
      ModerationBanManager.mChatBlacklist = new CList<int>();
      ModerationBanManager.mSyncRoot = new object();
      ModerationBanManager.mWorker = new Timer(new TimerCallback(ModerationBanManager.ProcessThread), (object) null, TimeSpan.FromMinutes(15.0), TimeSpan.FromMinutes(15.0));
      ModerationBanManager.ReloadCache(MySqlClient);
    }

    public static void ProcessThread(object state)
    {
      using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
        ModerationBanManager.ReloadCache(client);
    }

    public static void ReloadCache(SqlDatabaseClient MySqlClient)
    {
      lock (ModerationBanManager.mSyncRoot)
      {
        ModerationBanManager.mCharacterBlacklist.Clear();
        ModerationBanManager.mRemoteAddressBlacklist.Clear();
        ModerationBanManager.mChatBlacklist.Clear();
        MySqlClient.ClearParameters();
        MySqlClient.SetParameter("timestamp", (object) UnixTimestamp.GetCurrent());
        foreach (DataRow item_0 in (InternalDataCollectionBase) MySqlClient.ExecuteQueryTable("SELECT * FROM bans WHERE timestamp_expire > @timestamp").Rows)
        {
          int local_2 = (int) item_0["user_id"];
          string local_3 = (string) item_0["remote_address"];
          if (local_2 > 0 && !ModerationBanManager.mCharacterBlacklist.Contains(local_2))
            ModerationBanManager.mCharacterBlacklist.Add(local_2);
          if (local_3.Length > 0 && !ModerationBanManager.mRemoteAddressBlacklist.Contains(local_3))
            ModerationBanManager.mRemoteAddressBlacklist.Add(local_3);
        }
        MySqlClient.ClearParameters();
        MySqlClient.SetParameter("timestamp", (object) UnixTimestamp.GetCurrent());
        foreach (DataRow item_1 in (InternalDataCollectionBase) MySqlClient.ExecuteQueryTable("SELECT * FROM chat_bans WHERE timestamp_expire > @timestamp").Rows)
        {
          int local_2_1 = (int) item_1["user_id"];
          if (local_2_1 > 0 && !ModerationBanManager.mChatBlacklist.Contains(local_2_1))
            ModerationBanManager.mChatBlacklist.Add(local_2_1);
        }
      }
    }

    public static bool IsRemoteAddressBlacklisted(string RemoteAddressString)
    {
      lock (ModerationBanManager.mSyncRoot)
        return ModerationBanManager.mRemoteAddressBlacklist.Contains(RemoteAddressString);
    }

    public static bool IsUserIdBlacklisted(int UserId)
    {
      lock (ModerationBanManager.mSyncRoot)
        return ModerationBanManager.mCharacterBlacklist.Contains(UserId);
    }

    public static bool IsUserIdChatBlacklisted(int UserId)
    {
      lock (ModerationBanManager.mSyncRoot)
        return ModerationBanManager.mChatBlacklist.Contains(UserId);
    }

    public static void BanUser(SqlDatabaseClient MySqlClient, int UserId, string MessageText, string IP, int ModeratorId, double Length)
    {
      MySqlClient.ClearParameters();
      MySqlClient.SetParameter("userid", (object) UserId);
      MySqlClient.SetParameter("reason", (object) MessageText);
      MySqlClient.SetParameter("ip", (object) IP);
      MySqlClient.SetParameter("timestamp", (object) UnixTimestamp.GetCurrent());
      MySqlClient.SetParameter("timestampex", (object) (UnixTimestamp.GetCurrent() + Length));
      MySqlClient.SetParameter("moderator", (object) ModeratorId);
      MySqlClient.ExecuteNonQuery("INSERT INTO bans (user_id,remote_address,reason_text,timestamp_created,timestamp_expire,moderator_id) VALUES (@userid,@ip,@reason,@timestamp,@timestampex,@moderator)");
      lock (ModerationBanManager.mSyncRoot)
      {
        ModerationBanManager.mCharacterBlacklist.Add(UserId);
        ModerationBanManager.mRemoteAddressBlacklist.Add(IP);
      }
    }

    public static void ChatBanUser(SqlDatabaseClient MySqlClient, int UserId, string MessageText, string IP, int ModeratorId, double Length)
    {
      MySqlClient.ClearParameters();
      MySqlClient.SetParameter("userid", (object) UserId);
      MySqlClient.SetParameter("reason", (object) MessageText);
      MySqlClient.SetParameter("ip", (object) IP);
      MySqlClient.SetParameter("timestamp", (object) UnixTimestamp.GetCurrent());
      MySqlClient.SetParameter("timestampex", (object) (UnixTimestamp.GetCurrent() + Length));
      MySqlClient.SetParameter("moderator", (object) ModeratorId);
      MySqlClient.ExecuteNonQuery("INSERT INTO chat_bans (user_id,remote_address,reason_text,timestamp_created,timestamp_expire,moderator_id) VALUES (@userid,@ip,@reason,@timestamp,@timestampex,@moderator)");
      lock (ModerationBanManager.mSyncRoot)
        ModerationBanManager.mChatBlacklist.Add(UserId);
    }

    public static void LogModerationAction(SqlDatabaseClient MySqlClient, Session Session, string ActionDescr, string ActionDetail)
    {
      MySqlClient.ClearParameters();
      MySqlClient.SetParameter("userid", (object) Session.CharacterInfo.Id);
      MySqlClient.SetParameter("username", (object) Session.CharacterInfo.Username);
      MySqlClient.SetParameter("timestamp", (object) UnixTimestamp.GetCurrent());
      MySqlClient.SetParameter("actiondescr", (object) ActionDescr);
      MySqlClient.SetParameter("actiondetail", (object) ActionDetail);
      MySqlClient.ExecuteNonQuery("INSERT INTO moderation_action_log (moderator_id,moderator_name,action_descr,action_detail,timestamp) VALUES (@userid,@username,@actiondescr,@actiondetail,@timestamp)");
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Npcs\Npc.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Npcs.Npc
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Handlers;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Maps.Collectables;
using OrbitReborn_Emulator.Game.Misc;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Specialized;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Npcs
{
    public class Npc
    {
        private int mIsBoss = 0;
        private int mDamages = 0;
        private int mSharedRewards = 0;
        private bool mIsAttacking = false;
        private bool mIsDestroying = false;
        private CDictionnary<int, int> mAttackers = new CDictionnary<int, int>();
        private int mId;
        private int mMapId;
        private int mOldLocX;
        private int mOldLocY;
        private int mLocX;
        private int mLocY;
        private int mNewLocX;
        private int mNewLocY;
        private bool mIsMoving;
        private DateTime mLastMove;
        private double mTimeTaken;
        private string mName;
        private int mShipId;
        private int mShipHp;
        private int mShipMaxHp;
        private int mShipShield;
        private int mShipMaxShield;
        private int mShipSpeed;
        public int Credits;
        public int Uridium;
        public int FactionId;
        public int FatLasers;
        public int ShieldMechanics;
        public string ClanTag;
        public int IsClanMember;
        public int Rank;
        public int GalaxyGatesRings;
        public int Drones;
        private Timer mPathFinder;
        private int mNpcPoints;
        private bool mRespawn;
        private Timer mAttackTimer;
        private int mTargetId;
        private double mLastAttackByAttackerReceived;
        private double mLastAttackReceived;

        public int Id
        {
            get
            {
                return this.mId;
            }
        }

        public int MapId
        {
            get
            {
                return this.mMapId;
            }
            set
            {
                this.mMapId = value;
            }
        }

        public bool IsMoving
        {
            get
            {
                return this.mIsMoving;
            }
            set
            {
                this.mIsMoving = value;
            }
        }

        public bool Respawn
        {
            get
            {
                return this.mRespawn;
            }
            set
            {
                this.mRespawn = value;
            }
        }

        public int OldLocX
        {
            get
            {
                return this.mOldLocX;
            }
            set
            {
                this.mOldLocX = value;
            }
        }

        public int OldLocY
        {
            get
            {
                return this.mOldLocY;
            }
            set
            {
                this.mOldLocY = value;
            }
        }

        public int LocX
        {
            get
            {
                return this.mLocX;
            }
            set
            {
                this.mLocX = value;
            }
        }

        public int LocY
        {
            get
            {
                return this.mLocY;
            }
            set
            {
                this.mLocY = value;
            }
        }

        public int NewLocX
        {
            get
            {
                return this.mNewLocX;
            }
            set
            {
                this.mNewLocX = value;
            }
        }

        public int NewLocY
        {
            get
            {
                return this.mNewLocY;
            }
            set
            {
                this.mNewLocY = value;
            }
        }

        public double TimeTaken
        {
            get
            {
                return this.mTimeTaken;
            }
            set
            {
                this.mTimeTaken = value;
            }
        }

        public DateTime LastMove
        {
            get
            {
                return this.mLastMove;
            }
            set
            {
                this.mLastMove = value;
            }
        }

        public string Name
        {
            get
            {
                return this.mName;
            }
            set
            {
                this.mName = value;
            }
        }

        public int ShipId
        {
            get
            {
                return this.mShipId;
            }
            set
            {
                this.mShipId = value;
            }
        }

        public int ShipHp
        {
            get
            {
                return this.mShipHp;
            }
            set
            {
                this.mShipHp = value;
            }
        }

        public int ShipMaxHp
        {
            get
            {
                return this.mShipMaxHp;
            }
            set
            {
                this.mShipMaxHp = value;
            }
        }

        public int ShipShield
        {
            get
            {
                return this.mShipShield;
            }
            set
            {
                this.mShipShield = value;
            }
        }

        public int ShipMaxShield
        {
            get
            {
                return this.mShipMaxShield;
            }
            set
            {
                this.mShipMaxShield = value;
            }
        }

        public int ShipSpeed
        {
            get
            {
                return this.mShipSpeed;
            }
            set
            {
                this.mShipSpeed = value;
            }
        }

        public Timer PathFinder
        {
            get
            {
                return this.mPathFinder;
            }
            set
            {
                this.mPathFinder = value;
            }
        }

        public int NpcPoints
        {
            get
            {
                return this.mNpcPoints;
            }
            set
            {
                this.mNpcPoints = value;
            }
        }

        public int IsBoss
        {
            get
            {
                return this.mIsBoss;
            }
            set
            {
                this.mIsBoss = value;
            }
        }

        public int Damages
        {
            get
            {
                return this.mDamages;
            }
            set
            {
                this.mDamages = value;
            }
        }

        public CDictionnary<int, int> Attackers
        {
            get
            {
                return this.mAttackers;
            }
        }

        public double LastAttackByAttackerReceived
        {
            get
            {
                return this.mLastAttackByAttackerReceived;
            }
            set
            {
                this.mLastAttackByAttackerReceived = value;
            }
        }

        public int SharedRewards
        {
            get
            {
                return this.mSharedRewards;
            }
            set
            {
                this.mSharedRewards = value;
            }
        }

        public bool IsAttacking
        {
            get
            {
                return this.mIsAttacking;
            }
            set
            {
                this.mIsAttacking = value;
            }
        }

        public Timer AttackTimer
        {
            get
            {
                return this.mAttackTimer;
            }
            set
            {
                this.mAttackTimer = value;
            }
        }

        public int TargetId
        {
            get
            {
                return this.mTargetId;
            }
            set
            {
                this.mTargetId = value;
            }
        }

        public bool IsDestroying
        {
            get
            {
                return this.mIsDestroying;
            }
            set
            {
                this.mIsDestroying = value;
            }
        }

        public double LastAttackReceived
        {
            get
            {
                return this.mLastAttackReceived;
            }
            set
            {
                this.mLastAttackReceived = value;
            }
        }

        public Npc(int Id, string Name, int MapId, int LocX, int LocY, int ShipId, int ShipHp, int ShipMaxHp, int ShipShield, int ShipMaxShield, int ShipSpeed, int nCredits, int nUridium, int nFactionId = 0, int nFatLasers = 0, int nShieldMechanics = 0, string nClanTag = "", int nIsClanMember = 0, int nRank = 0, int nGalaxyGatesRings = 0, int nDrones = 0, int nNpcPoints = 0, int nDamages = 0)
        {
            this.mId = Id;
            this.mName = Name;
            this.mMapId = MapId;
            this.mLocX = LocX;
            this.mLocY = LocY;
            this.mNewLocX = this.mLocX;
            this.mNewLocY = this.mLocY;
            this.mShipId = ShipId;
            this.mShipHp = ShipHp;
            this.mShipMaxHp = ShipMaxHp;
            this.mShipShield = ShipShield;
            this.mShipMaxShield = ShipMaxShield;
            this.mShipSpeed = ShipSpeed;
            this.Credits = nCredits;
            this.Uridium = nUridium;
            this.FactionId = nFactionId;
            this.FatLasers = nFatLasers;
            this.ShieldMechanics = nShieldMechanics;
            this.ClanTag = nClanTag;
            this.IsClanMember = nIsClanMember;
            this.Rank = nRank;
            this.GalaxyGatesRings = nGalaxyGatesRings;
            this.Drones = nDrones;
            this.NpcPoints = nNpcPoints;
            this.Damages = nDamages;
        }

        public void UpdateAttackers(int attacker, int damages)
        {
            if (this.IsDestroying)
                return;
            this.LastAttackReceived = UnixTimestamp.GetCurrent();
            if (this.IsBoss == 1 || this.SharedRewards == 1)
            {
                if (!this.Attackers.ContainsKey(attacker))
                {
                    this.Attackers.Add(attacker, damages);
                }
                else
                {
                    ConcurrentDictionary<int, int> attackers;
                    int index;
                    (attackers = (ConcurrentDictionary<int, int>)this.Attackers)[index = attacker] = attackers[index] + damages;
                }
            }
            else
            {
                if (this.Attackers.ContainsKey(attacker))
                {
                    this.LastAttackByAttackerReceived = UnixTimestamp.GetCurrent();
                    ConcurrentDictionary<int, int> attackers;
                    int index;
                    (attackers = (ConcurrentDictionary<int, int>)this.Attackers)[index = attacker] = attackers[index] + damages;
                }
                if (UnixTimestamp.GetCurrent() - this.LastAttackByAttackerReceived >= 10.0)
                {
                    this.Attackers.Clear();
                    this.Attackers.Add(attacker, damages);
                    Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(attacker);
                    if (sessionByCharacterId != null)
                        sessionByCharacterId.SendData(PacketComposer.Compose("n", "USH|" + (object)this.Id));
                }
            }
        }

        public void Destroy(MapInstance map)
        {
            if (this.Attackers == null || this.IsDestroying)
                return;
            this.IsDestroying = true;
            foreach (KeyValuePair<int, int> attacker in (ConcurrentDictionary<int, int>)this.Attackers)
            {
                Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(attacker.Key);
                if (sessionByCharacterId != null && sessionByCharacterId.CharacterInfo != null && !sessionByCharacterId.CharacterInfo.Destroy)
                {
                    int num1 = attacker.Value;
                    double num2;
                    if (this.IsBoss == 1 || this.SharedRewards == 1)
                    {
                        num2 = Convert.ToDouble(num1) / (Convert.ToDouble(this.ShipMaxHp) + Convert.ToDouble(this.ShipMaxShield));
                        if (num2 > 1.0)
                            num2 = 1.0;
                    }
                    else
                        num2 = 1.0;
                    int int32_1 = Convert.ToInt32((double)this.Credits * num2);
                    int int32_2 = Convert.ToInt32((double)this.Uridium * num2);
                    int int32_3 = Convert.ToInt32((double)this.NpcPoints * num2);
                    if (HappyHour.Enabled)
                    {
                        int32_1 *= 2;
                        int32_2 *= 2;
                        int32_3 *= 2;
                    }
                    int totalSeconds = (int)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;
                    if (sessionByCharacterId.CharacterInfo.BoosterNpcTime > totalSeconds)
                        int32_3 = Convert.ToInt32((double)int32_3 * 1.5);
                    int rankpoints = int32_3;
                    if (sessionByCharacterId.CharacterInfo.KillStrek >= 10)
                        int32_3 *= 2;
                    int npcPoints = int32_3;
                    if (sessionByCharacterId.CharacterInfo.ExtraBooster == "pts")
                    {
                        rankpoints += (int)(rankpoints * 0.5);
                        npcPoints += (int)(npcPoints * 0.5);
                    }
                    if(sessionByCharacterId.CharacterInfo.ExtraBooster == "money")
                    {
                        int32_1 += (int)(int32_1 * 0.5);
                        int32_2 += (int)(int32_2 * 0.5);
                    }
                    using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                    {
                        sessionByCharacterId.CharacterInfo.AddReward(client, int32_1, int32_2, npcPoints, true);
                        sessionByCharacterId.CharacterInfo.AddRankpoints(client, rankpoints);
                        string _Message = "You have detroyed " + this.Name + ".<br/>You received " + (object)int32_1 + " credits.<br/>You received  " + (object)int32_2 + " uridium.<br/>You received  " + (object)npcPoints + " npc point(s).<br/>You received  " + (object)rankpoints + " rankpoint(s).";
                        sessionByCharacterId.CharacterInfo.AddLog(client, _Message);
                        sessionByCharacterId.CharacterInfo.AddNpcCount(client, this.Name);
                        sessionByCharacterId.CharacterInfo.SynchronizeStatistics(client, 1);
                    }
                    sessionByCharacterId.SendData(PacketComposer.Compose("A", "STD|Target destroyed."));
                    if (sessionByCharacterId.CharacterInfo.SelectedPlayer == this.Id)
                    {
                        Fight.StopLaser(sessionByCharacterId, null);
                    }
                    if (int32_1 != 0)
                        sessionByCharacterId.SendData(PacketComposer.Compose("y", "CRE|" + (object)int32_1 + "|" + (object)sessionByCharacterId.CharacterInfo.Credits));
                    if (int32_2 != 0)
                        sessionByCharacterId.SendData(PacketComposer.Compose("y", "URI|" + (object)int32_2 + "|" + (object)sessionByCharacterId.CharacterInfo.Uridium));
                    sessionByCharacterId.SendData(PacketComposer.Compose("A", "STD|You received " + (object)npcPoints + " npc point(s)."));
                    sessionByCharacterId.SendData(PacketComposer.Compose("A", "STD|You received " + (object)rankpoints + " rankpoint(s)."));
                }
            }
            if (this.AttackTimer != null)
            {
                this.AttackTimer.Dispose();
                --TimerManager.TimerRunning;
            }
            this.Loot();
            this.LocX = -100;
            this.LocY = -100;
            this.NewLocX = -100;
            this.NewLocY = -100;
            this.TargetId = 0;
            this.IsAttacking = false;
            if (this.PathFinder != null)
            {
                this.PathFinder.Dispose();
                --TimerManager.TimerRunning;
            }
            this.IsMoving = false;
            MapInstance mapInstance = map;
            string header1 = "K";
            int id1 = this.Id;
            string packet1 = id1.ToString();
            ServerMessage Message1 = PacketComposer.Compose(header1, packet1);
            int id2 = this.Id;
            int num = 0;
            mapInstance.BroadcastMessageInRange(Message1, id2, num != 0);
            foreach (MapActor mapActor in (IEnumerable<MapActor>)map.Actors.Values)
            {
                if (mapActor.Type == MapActorType.UserCharacter && mapActor.ReferenceSessionId > 0)
                {
                    Session sessionById = SessionManager.GetSessionById(mapActor.ReferenceSessionId);
                    if (sessionById != null && sessionById.CharacterInfo != null && sessionById.CharacterInfo.NpcInRange.Contains(this.Id))
                    {
                        if (sessionById.CharacterInfo.SelectedPlayer == this.Id)
                        {
                            if (sessionById.CharacterInfo.LaserAttackTimer != null)
                                sessionById.CharacterInfo.LaserAttackTimer.Dispose();
                            if (sessionById.CharacterInfo.LaserAttackCanTimer != null)
                                sessionById.CharacterInfo.LaserAttackCanTimer.Dispose();
                            sessionById.CharacterInfo.Attacking = false;
                            sessionById.CharacterInfo.CanLaserAttack = false;
                            sessionById.CharacterInfo.SelectedPlayer = 0;
                            sessionById.SendData(PacketComposer.Compose("N", "-1"));
                            sessionById.CharacterInfo.LaserAttackCanTimer = new Timer(new TimerCallback(Fight.CanAttack), (object)sessionById, 1000, 0);
                        }
                        sessionById.CharacterInfo.NpcInRange.Remove(this.Id);
                        Session session = sessionById;
                        string header2 = "R";
                        id1 = this.Id;
                        string packet2 = id1.ToString();
                        ServerMessage Message2 = PacketComposer.Compose(header2, packet2);
                        session.SendData(Message2);
                    }
                }
            }
            if (this.Respawn)
            {
                this.Attackers.Clear();
                this.TargetId = 0;
                this.IsAttacking = false;
                if (this.PathFinder != null)
                {
                    this.PathFinder.Dispose();
                    this.IsMoving = false;
                }
                this.LocX = NpcAI.RandomPos.Next(5, 20000);
                this.LocY = NpcAI.RandomPos.Next(5, 12000);
                this.NewLocX = this.LocX;
                this.NewLocY = this.LocY;
                this.ShipHp = !(this.Name == "-=[ Boss Cubikon ]=-") ? this.ShipMaxHp : this.ShipMaxHp * 2;
                this.ShipShield = this.ShipMaxShield;
                this.IsDestroying = false;
            }
            else
            {
                MapActor actorByReferenceId = map.GetActorByReferenceId(this.Id, MapActorType.AiBot);
                if (actorByReferenceId != null)
                    map.KickNpc(actorByReferenceId.Id);
                NpcAI.NpcToRemove.Add(this);
            }
        }

        public void LockTarget(int targetId)
        {
            this.TargetId = targetId;
            this.IsAttacking = true;
            SessionManager.GetSessionByCharacterId(targetId);
            this.IsMoving = false;
            this.AttackTimer = new Timer(new TimerCallback(this.Attack), (object)this, 0, 1250);
            ++TimerManager.TimerRunning;
        }

        public void Attack(object Npc)
        {
            Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(this.TargetId);
            if (sessionByCharacterId == null || sessionByCharacterId.CharacterInfo == null)
            {
                this.TargetId = 0;
                this.IsAttacking = false;
                if (this.AttackTimer == null)
                    return;
                this.AttackTimer.Dispose();
            }
            else if (this.MapId != sessionByCharacterId.CharacterInfo.MapId)
            {
                this.TargetId = 0;
                this.IsAttacking = false;
                if (this.AttackTimer == null)
                    return;
                this.AttackTimer.Dispose();
            }
            else
            {
                MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
                if (instanceByMapId == null)
                {
                    this.TargetId = 0;
                    this.IsAttacking = false;
                    if (this.AttackTimer == null)
                        return;
                    this.AttackTimer.Dispose();
                }
                else
                {
                    double num1 = Math.Sqrt(Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocX - this.LocX), 2.0) + Math.Pow((double)(sessionByCharacterId.CharacterInfo.LocY - this.LocY), 2.0));
                    int num2 = 0;
                    if (this.IsBoss == 1)
                    {
                        if (num1 > 890.0)
                        {
                            this.TargetId = 0;
                            this.IsAttacking = false;
                            if (this.AttackTimer == null)
                                return;
                            this.AttackTimer.Dispose();
                            return;
                        }
                    }
                    else
                    {
                        if (num1 > 640.0)
                        {
                            this.IsAttacking = false;
                            if (this.AttackTimer == null)
                                return;
                            this.AttackTimer.Dispose();
                            return;
                        }
                        if (num1 > 890.0)
                        {
                            this.TargetId = 0;
                            this.IsAttacking = false;
                            if (this.AttackTimer == null)
                                return;
                            this.AttackTimer.Dispose();
                            return;
                        }
                    }
                    if (this.Name == "-=[ Boss Cubikon ]=-")
                        num2 = 5;
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("a", this.Id.ToString() + "|" + (object)sessionByCharacterId.CharacterId + "|" + (object)num2 + "|" + (object)0 + "|" + (object)0), 0 != 0);
                    int num3 = this.Damages + new Random().Next(-20, 20);
                    int num4 = Convert.ToInt32((double)num3 * sessionByCharacterId.CharacterInfo.ShieldAbsorption);
                    int num5 = Convert.ToInt32((double)num3 * (1.0 - sessionByCharacterId.CharacterInfo.ShieldAbsorption));
                    if (sessionByCharacterId.CharacterInfo.ShipShield <= 0)
                    {
                        sessionByCharacterId.CharacterInfo.ShipShield = 0;
                        num5 = num3;
                    }
                    if (sessionByCharacterId.CharacterInfo.ActiveISH)
                    {
                        num4 = 0;
                        num5 = 0;
                        num3 = 0;
                    }
                    if (sessionByCharacterId.CharacterInfo.ShipShield - num4 > 0)
                        sessionByCharacterId.CharacterInfo.ShipShield -= num4;
                    else if (sessionByCharacterId.CharacterInfo.ShipShield - num4 < 0)
                        sessionByCharacterId.CharacterInfo.ShipShield = 0;
                    sessionByCharacterId.CharacterInfo.ShipHp -= num5;
                    foreach (MapActor key in (IEnumerable<MapActor>)instanceByMapId.Actors.Keys)
                    {
                        if (key.Type == MapActorType.UserCharacter)
                        {
                            Session sessionById = SessionManager.GetSessionById(key.ReferenceSessionId);
                            if (sessionById != null && (sessionById.CharacterInfo.SelectedPlayer == this.TargetId || sessionById.CharacterId == this.TargetId))
                                sessionById.SendData(PacketComposer.Compose("Y", "0|" + (object)sessionByCharacterId.CharacterId + "|L|" + (object)sessionByCharacterId.CharacterInfo.ShipHp + "|" + (object)sessionByCharacterId.CharacterInfo.ShipShield + "|" + (object)num3));
                        }
                    }
                    sessionByCharacterId.CharacterInfo.NoFightTimer = 0;
                    if (sessionByCharacterId.CharacterInfo.ShipHp > 0 || sessionByCharacterId.CharacterInfo.Destroy)
                        return;
                    Fight.KillPlayer(sessionByCharacterId);
                    this.TargetId = 0;
                    this.IsAttacking = false;
                }
            }
        }

        private int PalladiumLoot()
        {
            switch (this.mShipId)
            {
                case 113:
                    return 8;
                case 114:
                    return 16;
                case 115:
                    return 100;
                default:
                    return 0;
            }
        }

        private void Loot()
        {
            Random random = new Random();
            MapInstance instanceByMapId = MapManager.GetInstanceByMapId(this.MapId);
            if (instanceByMapId == null)
                return;
            int id = this.Id;
            int locX = this.LocX;
            int locY = this.LocY;
            CargoBox cargoBox = new CargoBox(id, locX, locY, this.MapId);
            int num1 = this.ShipMaxHp + this.ShipMaxShield;
            cargoBox.Prometium = num1 / 1500;
            cargoBox.Endurium = num1 / 1500;
            cargoBox.Terbium = num1 / 1500;
            if (this.IsBoss == 1 || this.SharedRewards == 1)
                cargoBox.Xenomit = num1 / 300000 + 1;
            if (instanceByMapId.MapId == 4 || instanceByMapId.MapId == 8 || instanceByMapId.MapId == 12)
                cargoBox.Palladium = this.PalladiumLoot();
            if (instanceByMapId.Info.Collectables.ContainsKey(id))
            {
                instanceByMapId.Info.Collectables.Remove(id);
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)id)), false);
            }
            instanceByMapId.Info.Collectables.Add(id, (Collectable)cargoBox);
            instanceByMapId.BroadcastMessage(PacketComposer.Compose("c", id.ToString() + "|" + (object)1 + "|" + (object)locX + "|" + (object)locY), 0 != 0);
            this.BoxSpawn(random, id, instanceByMapId);
        }

        //hitac, devo, ice, kuku, bray
        private bool IsClassicBoss()
        {
            if (this.IsBoss != 1)
                return false;
            if (this.Name == "-=[ Boss Cubikon ]=-" ||
                this.Name == "-=[ Invader ]=-" ||
                this.Name == "-=[ Fast Invader ]=-" ||
                this.Name == "-=[ Super Invader ]=-")
                return false;
            return true;
        }


        private void BoxSpawn(Random random, int id, MapInstance instanceByMapId)
        {
            int type = 0;
            Collectable bootyBox = null;
            int X = this.LocX + random.Next(-200, 200);
            int Y = this.LocY + random.Next(-200, 200);
            int num2 = id - 1000;
            if (this.IsClassicBoss())
            {
                int numRand = random.Next(1, 101);
                if (numRand <= 25)
                {
                    bootyBox = new ApocalypseBox(num2, X, Y, this.MapId);
                    type = 26;
                }
            }
            else
            {
                int num = random.Next(1, 100);
                if (num > 0 && num <= 2)
                {
                    bootyBox = new GoldBootyBox(num2, X, Y, this.MapId);
                    type = 24;
                }
                else if (num > 2 && num <= 9)
                {
                    bootyBox = new RedBootyBox(num2, X, Y, this.MapId);
                    type = 23;
                }
                else if (num > 9 && num <= 25)
                {
                    bootyBox = new BootyBox(num2, X, Y, this.MapId);
                    type = 21;
                }
            }
            if (type != 0)
            {
                if (instanceByMapId.Info.Collectables.ContainsKey(num2))
                {
                    instanceByMapId.Info.Collectables.Remove(num2);
                    instanceByMapId.BroadcastMessage(PacketComposer.Compose("2", string.Concat((object)num2)), false);
                }
                instanceByMapId.Info.Collectables.Add(num2, (Collectable)bootyBox);
                instanceByMapId.BroadcastMessage(PacketComposer.Compose("c", num2.ToString() + "|" + (object)type + "|" + (object)X + "|" + (object)Y), 0 != 0);
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Npcs\NpcAI.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Npcs.NpcAI
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication.Outgoing;
using OrbitReborn_Emulator.Game.Handlers;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Specialized;
using System;
using System.Collections.Generic;
using System.Threading;
using System.Windows;

namespace OrbitReborn_Emulator.Game.Npcs
{
  public class NpcAI
  {
    public static readonly Random RandomPos = new Random();
    public static CList<Npc> NpcList;
    public static CList<Npc> NpcToRemove;
    public static CList<Npc> NpcToAdd;
    private static Timer mPerformUpdate;
    private static object mSyncRoot;
    private static CDictionnary<string, List<string>> RegisteredNpc;

    public static void PreloadNpcs()
    {
      NpcAI.RegisteredNpc = new CDictionnary<string, List<string>>();
      NpcAI.RegisteredNpc.Add("-=[ Streuner ]=-", new List<string>()
      {
        "-=[ Streuner ]=-",
        "1",
        "0",
        "0",
        "2",
        "9000",
        "9000",
        "9000",
        "9000",
        "150",
        "72000",
        "54",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "1",
        "170"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss Streuner ]=-", new List<string>()
      {
        "-=[ Boss Streuner ]=-",
        "1",
        "0",
        "0",
        "34",
        "18000",
        "18000",
        "18000",
        "18000",
        "150",
        "144000",
        "108",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "2",
        "340"
      });
      NpcAI.RegisteredNpc.Add("-=[ Lordakia ]=-", new List<string>()
      {
        "-=[ Lordakia ]=-",
        "1",
        "0",
        "0",
        "71",
        "20000",
        "20000",
        "20000",
        "20000",
        "180",
        "160000",
        "120",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "2",
        "600"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss Lordakia ]=-", new List<string>()
      {
        "-=[ Boss Lordakia ]=-",
        "1",
        "0",
        "0",
        "36",
        "40000",
        "40000",
        "40000",
        "40000",
        "180",
        "320000",
        "240",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "4",
        "1200"
      });
      NpcAI.RegisteredNpc.Add("-=[ Saimon ]=-", new List<string>()
      {
        "-=[ Saimon ]=-",
        "1",
        "0",
        "0",
        "75",
        "30000",
        "30000",
        "30000",
        "30000",
        "200",
        "240000",
        "180",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "3",
        "900"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss Saimon ]=-", new List<string>()
      {
        "-=[ Boss Saimon ]=-",
        "1",
        "0",
        "0",
        "37",
        "60000",
        "60000",
        "60000",
        "60000",
        "200",
        "480000",
        "360",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "6",
        "1800"
      });
      NpcAI.RegisteredNpc.Add("-=[ Sibelon ]=-", new List<string>()
      {
        "-=[ Sibelon ]=-",
        "1",
        "0",
        "0",
        "74",
        "190000",
        "190000",
        "190000",
        "190000",
        "120",
        "1520000",
        "1040",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "19",
        "5700"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss Sibelon ]=-", new List<string>()
      {
        "-=[ Boss Sibelon ]=-",
        "1",
        "0",
        "0",
        "46",
        "280000",
        "280000",
        "280000",
        "280000",
        "120",
        "3040000",
        "2080",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "38",
        "11400"
      });
      NpcAI.RegisteredNpc.Add("-=[ Kristallin ]=-", new List<string>()
      {
        "-=[ Kristallin ]=-",
        "2",
        "0",
        "0",
        "78",
        "60000",
        "60000",
        "60000",
        "60000",
        "210",
        "480000",
        "360",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "6",
        "1800"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss Kristallin ]=-", new List<string>()
      {
        "-=[ Boss Kristallin ]=-",
        "2",
        "0",
        "0",
        "38",
        "120000",
        "120000",
        "120000",
        "120000",
        "210",
        "960000",
        "720",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "12",
        "3600"
      });
      NpcAI.RegisteredNpc.Add("-=[ Kristallon ]=-", new List<string>()
      {
        "-=[ Kristallon ]=-",
        "2",
        "0",
        "0",
        "79",
        "280000",
        "280000",
        "280000",
        "280000",
        "190",
        "2240000",
        "1680",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "28",
        "8400"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss Kristallon ]=-", new List<string>()
      {
        "-=[ Boss Kristallon ]=-",
        "2",
        "0",
        "0",
        "35",
        "560000",
        "560000",
        "560000",
        "560000",
        "190",
        "4480000",
        "3760",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "56",
        "16800"
      });
      NpcAI.RegisteredNpc.Add("-=[ Cubikon ]=-", new List<string>()
      {
        "-=[ Cubikon ]=-",
        "2",
        "0",
        "0",
        "80",
        "1000000",
        "1000000",
        "1000000",
        "1000000",
        "20",
        "8000000",
        "6000",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "100",
        "25000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss Cubikon ]=-", new List<string>()
      {
        "-=[ Boss Cubikon ]=-",
        "17",
        "0",
        "0",
        "39",
        "2000000",
        "1000000",
        "2000000",
        "2000000",
        "20",
        "16000000",
        "16000",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "200",
        "35000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Ice Meteroid ]=-", new List<string>()
      {
        "-=[ Ice Meteroid ]=-",
        "2",
        "0",
        "0",
        "101",
        "6000000",
        "6000000",
        "6000000",
        "6000000",
        "40",
        "48000000",
        "36000",
        "0",
        "1",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "600",
        "40000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss KuKu ]=-", new List<string>()
      {
        "-=[ Boss KuKu ]=-",
        "2",
        "0",
        "0",
        "83",
        "10000000",
        "10000000",
        "10000000",
        "10000000",
        "40",
        "164000000",
        "75000",
        "0",
        "1",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "1250",
        "45000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Hitac ]=-", new List<string>()
      {
        "-=[ Hitac ]=-",
        "2",
        "0",
        "0",
        "142",
        "15000000",
        "15000000",
        "10000000",
        "10000000",
        "20",
        "100000000",
        "87000",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "1500",
        "55000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Scorcher ]=-", new List<string>()
      {
        "-=[ Scorcher ]=-",
        "1",
        "0",
        "0",
        "145",
        "400000",
        "400000",
        "300000",
        "300000",
        "190",
        "2800000",
        "2100",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "35",
        "10500"
      });
      NpcAI.RegisteredNpc.Add("-=[ Boss Curcubitor ]=-", new List<string>()
      {
        "-=[ Boss Curcubitor ]=-",
        "2",
        "0",
        "0",
        "144",
        "1200000",
        "1200000",
        "1200000",
        "1200000",
        "40",
        "9600000",
        "7200",
        "0",
        "1",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "120",
        "20000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Melter ]=-", new List<string>()
      {
        "-=[ Melter ]=-",
        "2",
        "0",
        "0",
        "143",
        "600000",
        "600000",
        "600000",
        "600000",
        "120",
        "4800000",
        "3600",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "60",
        "14000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Devourer ]=-", new List<string>()
      {
        "-=[ Devourer ]=-",
        "2",
        "0",
        "0",
        "147",
        "20000000",
        "20000000",
        "15000000",
        "15000000",
        "40",
        "140000000",
        "116000",
        "0",
        "1",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "2100",
        "60000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Saboteur ]=-", new List<string>()
      {
        "-=[ Saboteur ]=-",
        "2",
        "0",
        "0",
        "113",
        "800000",
        "800000",
        "800000",
        "800000",
        "300",
        "7040000",
        "5280",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "88",
        "28000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Annihilator ]=-", new List<string>()
      {
        "-=[ Annihilator ]=-",
        "2",
        "0",
        "0",
        "114",
        "1600000",
        "1600000",
        "1600000",
        "1600000",
        "250",
        "14080000",
        "10560",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "176",
        "58000"
      });
      NpcAI.RegisteredNpc.Add("-=[ Battleray ]=-", new List<string>()
      {
        "-=[ Battleray ]=-",
        "2",
        "0",
        "0",
        "115",
        "30000000",
        "30000000",
        "20000000",
        "20000000",
        "200",
        "240000000",
        "180000",
        "0",
        "0",
        "0",
        "",
        "0",
        "0",
        "0",
        "0",
        "3250",
        "70000"
      });
    }

    public static void LaunchAI()
    {
      NpcAI.PreloadNpcs();
      NpcAI.mSyncRoot = new object();
      NpcAI.NpcList = new CList<Npc>();
      NpcAI.NpcToRemove = new CList<Npc>();
      NpcAI.NpcToAdd = new CList<Npc>();
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Streuner ]=-"], 1, 23, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Streuner ]=-"], 5, 23, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Streuner ]=-"], 9, 23, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Streuner ]=-"], 1, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Streuner ]=-"], 5, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Streuner ]=-"], 9, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Lordakia ]=-"], 1, 18, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Lordakia ]=-"], 5, 18, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Lordakia ]=-"], 9, 18, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Lordakia ]=-"], 1, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Lordakia ]=-"], 5, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Lordakia ]=-"], 9, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Saimon ]=-"], 1, 13, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Saimon ]=-"], 5, 13, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Saimon ]=-"], 9, 13, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Saimon ]=-"], 1, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Saimon ]=-"], 5, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Saimon ]=-"], 9, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Sibelon ]=-"], 1, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Sibelon ]=-"], 5, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Sibelon ]=-"], 9, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Sibelon ]=-"], 1, 2, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Sibelon ]=-"], 5, 2, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Sibelon ]=-"], 9, 2, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Kristallin ]=-"], 2, 26, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Kristallin ]=-"], 6, 26, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Kristallin ]=-"], 10, 26, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Kristallin ]=-"], 2, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Kristallin ]=-"], 6, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Kristallin ]=-"], 10, 4, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Kristallon ]=-"], 2, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Kristallon ]=-"], 6, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Kristallon ]=-"], 10, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Kristallon ]=-"], 2, 2, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Kristallon ]=-"], 6, 2, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Kristallon ]=-"], 10, 2, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Cubikon ]=-"], 2, 6, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Cubikon ]=-"], 6, 6, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Cubikon ]=-"], 10, 6, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Ice Meteroid ]=-"], 2, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Ice Meteroid ]=-"], 6, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Ice Meteroid ]=-"], 10, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Melter ]=-"], 3, 12, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Melter ]=-"], 7, 12, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Melter ]=-"], 11, 12, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Scorcher ]=-"], 3, 20, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Scorcher ]=-"], 7, 20, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Scorcher ]=-"], 11, 20, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Curcubitor ]=-"], 3, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Curcubitor ]=-"], 7, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Curcubitor ]=-"], 11, 7, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Hitac ]=-"], 3, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Hitac ]=-"], 7, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Hitac ]=-"], 11, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Devourer ]=-"], 3, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Devourer ]=-"], 7, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Devourer ]=-"], 11, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss KuKu ]=-"], 17, 1, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Cubikon ]=-"], 13, 3, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Cubikon ]=-"], 14, 3, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Boss Cubikon ]=-"], 15, 3, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Saboteur ]=-"], 4, 20, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Saboteur ]=-"], 8, 20, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Saboteur ]=-"], 12, 20, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Annihilator ]=-"], 4, 12, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Annihilator ]=-"], 8, 12, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Annihilator ]=-"], 12, 12, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Battleray ]=-"], 4, 3, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Battleray ]=-"], 8, 3, true);
      NpcAI.CreateNpc(NpcAI.RegisteredNpc["-=[ Battleray ]=-"], 12, 3, true);
      NpcAI.mPerformUpdate = new Timer(new TimerCallback(NpcAI.PerformUpdate), (object) null, 0, 1000);
      ++TimerManager.TimerRunning;
    }

    public static void CreateNpc(List<string> npc, int mapId, int amount = 1, bool bRespawn = true)
    {
      MapInfo mapInfo = MapInfoLoader.GetMapInfo(mapId);
      if (!MapManager.InstanceIsLoadedForMap(mapInfo.Id))
        MapManager.TryLoadMapInstance(mapInfo.Id);
      MapInstance instanceByMapId = MapManager.GetInstanceByMapId(mapId);
      if (instanceByMapId == null)
        return;
      for (int index = 0; index < amount; ++index)
      {
        int LocX = !(npc[2] != "0") ? NpcAI.RandomPos.Next(5, 20000) : Convert.ToInt32(npc[2]);
        int LocY = !(npc[3] != "0") ? NpcAI.RandomPos.Next(5, 12000) : Convert.ToInt32(npc[3]);
        Npc newInstance = NpcManager.CreateNewInstance(npc[0], mapId, LocX, LocY, Convert.ToInt32(npc[4]), (int) ((double) Convert.ToInt32(npc[5]) * 1.1), (int) ((double) Convert.ToInt32(npc[6]) * 1.1), (int) ((double) Convert.ToInt32(npc[7]) * 1.1), (int) ((double) Convert.ToInt32(npc[8]) * 1.1), Convert.ToInt32(npc[9]), Convert.ToInt32(npc[10]), Convert.ToInt32(npc[11]), Convert.ToInt32(npc[12]), Convert.ToInt32(npc[13]), Convert.ToInt32(npc[14]), npc[15], Convert.ToInt32(npc[16]), Convert.ToInt32(npc[17]), Convert.ToInt32(npc[18]), Convert.ToInt32(npc[19]), Convert.ToInt32(npc[20]), Convert.ToInt32(npc[21]));
        if (newInstance.Name == "-=[ Boss Cubikon ]=-" || newInstance.Name == "-=[ Ice Meteroid ]=-" || newInstance.Name == "-=[ Boss KuKu ]=-")
          newInstance.IsBoss = 1;
        else if (newInstance.Name == "-=[ Invader ]=-" || newInstance.Name == "-=[ Super Invader ]=-" || newInstance.Name == "-=[ Fast Invader ]=-" || newInstance.Name == "-=[ Super Invader ]=-")
          newInstance.IsBoss = 1;
        else if (newInstance.Name == "-=[ Hitac ]=-" || newInstance.Name == "-=[ Devourer ]=-")
          newInstance.IsBoss = 1;
        else if (newInstance.Name == "-=[ Battleray ]=-")
          newInstance.IsBoss = 1;
        newInstance.SharedRewards = 1;
        newInstance.Respawn = bRespawn;
        instanceByMapId.AddNpcToMap(newInstance);
        NpcAI.NpcToAdd.Add(newInstance);
      }
    }

    public static void Respawn(string name, int mapId)
    {
      NpcAI.CreateNpc(NpcAI.RegisteredNpc[name], mapId, 1, true);
    }

    private static void MoveNpc(Npc Npc, double time)
    {
      Vector vector1 = new Vector((double) Npc.LocX, (double) Npc.LocY);
      Vector vector2 = new Vector((double) Npc.NewLocX, (double) Npc.NewLocY);
      Vector vector3 = Vector.Subtract(vector2, vector1);
      double num = Math.Sqrt(Math.Pow(vector3.X, 2.0) + Math.Pow(vector3.Y, 2.0));
      Vector position = ShipMovement.calculatePosition(vector1, vector2, time, (double) Npc.ShipSpeed / 1000.0);
      Vector vector4 = Vector.Subtract(vector1, position);
      if (Math.Sqrt(Math.Pow(vector4.X, 2.0) + Math.Pow(vector4.Y, 2.0)) > num)
      {
        Npc.LocX = Npc.NewLocX;
        Npc.LocY = Npc.NewLocY;
        if (Npc.PathFinder == null)
          return;
        Npc.PathFinder.Dispose();
        Npc.IsMoving = false;
      }
      else
      {
        Npc.LocX = (int) position.X;
        Npc.LocY = (int) position.Y;
      }
    }

    public static void TryMoveNpc(Npc Npc)
    {
      if (Npc.NewLocX != Npc.LocX || Npc.NewLocY != Npc.LocY)
      {
        DateTime now = DateTime.Now;
        TimeSpan timeSpan = now - Npc.LastMove;
        if (timeSpan.TotalMilliseconds >= 0.0 && timeSpan.TotalMilliseconds < 100.0)
          return;
        NpcAI.MoveNpc(Npc, timeSpan.TotalMilliseconds);
        Npc.LastMove = now;
      }
      else if (Npc.PathFinder != null)
      {
        Npc.PathFinder.Dispose();
        Npc.IsMoving = false;
      }
    }

    public static void PathFinding(object state)
    {
      Npc Npc = (Npc) state;
      if (Npc == null)
        return;
      if (Npc.IsDestroying)
      {
        if (Npc.PathFinder == null)
          return;
        Npc.PathFinder.Dispose();
        Npc.IsMoving = false;
      }
      else
        NpcAI.TryMoveNpc(Npc);
    }

    private static void PerformUpdate(object state)
    {
      Random random = new Random();
      lock (NpcAI.mSyncRoot)
      {
        foreach (Npc item_1 in (IEnumerable<Npc>) NpcAI.NpcList.Keys)
        {
          if (item_1 == null || item_1.Name == "Spaceball")
            return;
          if (!item_1.IsMoving)
          {
            int local_2;
            int local_3;
            if (item_1.TargetId == 0)
            {
              local_2 = random.Next(5, 20000);
              local_3 = random.Next(5, 12000);
            }
            else
            {
              Session local_4 = SessionManager.GetSessionByCharacterId(item_1.TargetId);
              if (local_4 != null && local_4.CharacterInfo != null)
              {
                local_2 = local_4.CharacterInfo.LocX + random.Next(-300, 300);
                local_3 = local_4.CharacterInfo.LocY + random.Next(-300, 300);
              }
              else
              {
                item_1.IsAttacking = false;
                local_2 = random.Next(5, 20000);
                local_3 = random.Next(5, 12000);
              }
            }
            item_1.NewLocX = local_2;
            item_1.NewLocY = local_3;
            if (item_1.PathFinder != null)
              item_1.PathFinder.Dispose();
            if (!item_1.IsMoving)
              item_1.LastMove = DateTime.Now;
            NpcAI.TryMoveNpc(item_1);
            double local_8 = Math.Sqrt(Math.Pow((double) (item_1.LocX - item_1.NewLocX), 2.0) + Math.Pow((double) (item_1.LocY - item_1.NewLocY), 2.0)) / (double) item_1.ShipSpeed * 1000.0;
            item_1.IsMoving = true;
            MapInstance local_9 = MapManager.GetInstanceByMapId(item_1.MapId);
            if (local_9 != null)
              local_9.BroadcastMessageInRange(MapShipMovementComposer.Compose(item_1.Id, item_1.NewLocX, item_1.NewLocY, local_8), item_1.Id, false);
            item_1.PathFinder = new Timer(new TimerCallback(NpcAI.PathFinding), (object) item_1, 300, 300);
          }
          if (UnixTimestamp.GetCurrent() - item_1.LastAttackReceived >= 15.0)
          {
            bool local_10 = false;
            if (item_1.ShipHp < item_1.ShipMaxHp)
            {
              int local_11 = (int) ((double) item_1.ShipMaxHp * 0.01);
              if (item_1.ShipHp + local_11 > item_1.ShipMaxHp)
                item_1.ShipHp = item_1.ShipMaxHp;
              else
                item_1.ShipHp += local_11;
              local_10 = true;
            }
            if (item_1.ShipShield < item_1.ShipMaxShield)
            {
              int local_12 = (int) ((double) item_1.ShipMaxShield * 0.01);
              if (item_1.ShipShield + local_12 > item_1.ShipMaxShield)
                item_1.ShipShield = item_1.ShipMaxShield;
              else
                item_1.ShipShield += local_12;
              local_10 = true;
            }
            if (local_10)
            {
              foreach (MapActor item_0 in (IEnumerable<MapActor>) MapManager.GetInstanceByMapId(item_1.MapId).Actors.Keys)
              {
                if (item_0.Type == MapActorType.UserCharacter)
                {
                  Session local_15 = SessionManager.GetSessionById(item_0.ReferenceSessionId);
                  if (local_15 != null && local_15.CharacterInfo != null && local_15.CharacterInfo.SelectedPlayer == item_1.Id)
                    local_15.SendData(PacketComposer.Compose("Y", "0|" + (object) item_1.Id + "|L|" + (object) item_1.ShipHp + "|" + (object) item_1.ShipShield + "|" + (object) 0));
                }
              }
            }
          }
        }
      }
      foreach (Npc key in (IEnumerable<Npc>) NpcAI.NpcToRemove.Keys)
      {
        if (key == null)
          return;
        NpcAI.NpcList.Remove(key);
      }
      NpcAI.NpcToRemove.Clear();
      foreach (Npc key in (IEnumerable<Npc>) NpcAI.NpcToAdd.Keys)
      {
        if (key == null)
          return;
        NpcAI.NpcList.Add(key);
      }
      NpcAI.NpcToAdd.Clear();
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Npcs\NpcManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Npcs.NpcManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Libs;

namespace OrbitReborn_Emulator.Game.Npcs
{
  public static class NpcManager
  {
    private static CDictionnary<int, Npc> mNpcInstances;
    private static int mNpcInstanceIdGenerator;
    private static object mSyncRoot;

    public static void Initialize()
    {
      NpcManager.mNpcInstances = new CDictionnary<int, Npc>();
      NpcManager.mNpcInstanceIdGenerator = -2;
      NpcManager.mSyncRoot = new object();
    }

    public static Npc CreateNewInstance(string Name, int MapId, int LocX, int LocY, int ShipId, int ShipHp, int ShipMaxHp, int ShipShield, int ShipMaxShield, int ShipSpeed, int Credits, int Uridium, int FactionId, int FatLasers, int ShieldMechanics, string ClanTag, int IsClanMember, int Rank, int GalaxyGatesRings, int Drones, int NpcPoints, int Damages)
    {
      int num = NpcManager.mNpcInstanceIdGenerator--;
      Npc npc = new Npc(num, Name, MapId, LocX, LocY, ShipId, ShipHp, ShipMaxHp, ShipShield, ShipMaxShield, ShipSpeed, Credits, Uridium, FactionId, FatLasers, ShieldMechanics, ClanTag, IsClanMember, Rank, GalaxyGatesRings, Drones, NpcPoints, Damages);
      lock (NpcManager.mSyncRoot)
        NpcManager.mNpcInstances.Add(num, npc);
      return npc;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Portal\PortalInfo.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Portal.PortalInfo
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Storage;

namespace OrbitReborn_Emulator.Game.Portal
{
    public class PortalInfo
    {
        private int mId;
        private int mPosX;
        private int mPosY;
        private int mMapId;
        private int mLinkedId;
        private int mType = 1;

        public int Id
        {
            get
            {
                return this.mId;
            }
        }

        public int PosX
        {
            get
            {
                return this.mPosX;
            }
        }

        public int PosY
        {
            get
            {
                return this.mPosY;
            }
        }

        public int MapId
        {
            get
            {
                return this.mMapId;
            }
        }

        public int LinkedId
        {
            get
            {
                return this.mLinkedId;
            }
        }

        public int Type
        {
            get
            {
                return this.mType;
            }
            set
            {
                this.mType = value;
            }
        }

        public PortalInfo(SqlDatabaseClient MySqlClient, int Id, int PosX, int PosY, int MapId, int LinkedId, int Type)
        {
            this.mId = Id;
            this.mPosX = PosX;
            this.mPosY = PosY;
            this.mMapId = MapId;
            this.mLinkedId = LinkedId;
            this.mType = Type;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Portal\PortalManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Portal.PortalManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System.Collections.Generic;
using System.Data;

namespace OrbitReborn_Emulator.Game.Portal
{
    public static class PortalManager
    {
        private static CList<PortalInfo> mPortals;
        public static int[] UnSafePortals = { 201, 202, 203, 204, 205, 206 };

        public static CList<PortalInfo> Portals
        {
            get
            {
                return PortalManager.mPortals;
            }
        }

        public static bool isPortalUnsafe(int port)
        {
            foreach (int key in PortalManager.UnSafePortals)
            {
                if (key == port)
                    return true;
            }
            return false;
        }

        public static void Initialize()
        {
            PortalManager.mPortals = new CList<PortalInfo>();
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                DataTable dataTable = client.ExecuteQueryTable("SELECT * FROM portals");
                if (dataTable == null)
                    return;
                foreach (DataRow row in (InternalDataCollectionBase)dataTable.Rows)
                {
                    lock (PortalManager.mPortals)
                        PortalManager.mPortals.Add(PortalManager.GetPortal(client, row));
                }
            }
        }

        public static PortalInfo GetPortal(SqlDatabaseClient MySqlClient, DataRow Row)
        {
            return new PortalInfo(MySqlClient, (int)Row["id"], (int)Row["pos_x"] * 100, (int)Row["pos_y"] * 100, (int)Row["map_id"], (int)Row["arrive_id"], (int)Row["type"]);
        }

        public static CList<PortalInfo> GetPortalForMap(int _MapId)
        {
            CList<PortalInfo> clist = new CList<PortalInfo>();
            foreach (PortalInfo key in (IEnumerable<PortalInfo>)PortalManager.Portals.Keys)
            {
                if (key.MapId == _MapId)
                    clist.Add(key);
            }
            if (clist.Count > 0)
                return clist;
            return (CList<PortalInfo>)null;
        }

        public static PortalInfo GetPortalById(int _Id)
        {
            foreach (PortalInfo key in (IEnumerable<PortalInfo>)PortalManager.Portals.Keys)
            {
                if (key.Id == _Id)
                    return key;
            }
            return (PortalInfo)null;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Sessions\Session.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Sessions.Session
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Communication.Incoming;
using OrbitReborn_Emulator.Game.Characters;
using OrbitReborn_Emulator.Game.Chat;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Misc;
using OrbitReborn_Emulator.Specialized;
using OrbitReborn_Emulator.Storage;
using OrbitReborn_Emulator.Util;
using System;
using System.Net.Sockets;
using System.Text;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Sessions
{
    public class Session : IDisposable
    {
        private int mId;
        private Socket mSocket;
        private byte[] mBuffer;
        private CharacterInfo mCharacterInfo;
        private bool mPongOk;
        private double mStoppedTimestamp;
        private bool mAuthProcessed;
        private int mMapId;
        private bool mMapAuthed;
        private bool mMapJoined;
        private bool mStopped;
        private bool mIsChat;
        private int mCurrentChatRoom;

        public int Id
        {
            get
            {
                return this.mId;
            }
        }

        public int CharacterId
        {
            get
            {
                return this.mCharacterInfo != null ? this.mCharacterInfo.Id : 0;
            }
        }

        public string RemoteAddress
        {
            get
            {
                string empty;
                if (this.mSocket == null || !this.mSocket.Connected)
                    empty = string.Empty;
                else
                    empty = this.mSocket.RemoteEndPoint.ToString().Split(':')[0];
                return empty;
            }
        }

        public double TimeStopped
        {
            get
            {
                return UnixTimestamp.GetCurrent() - this.mStoppedTimestamp;
            }
        }

        public bool Stopped
        {
            get
            {
                return this.mSocket == null;
            }
        }

        public bool StoppedPlayer
        {
            get
            {
                return this.mStopped;
            }
            set
            {
                this.mStopped = value;
            }
        }

        public bool Authenticated
        {
            get
            {
                return this.mCharacterInfo != null && this.mAuthProcessed;
            }
        }

        public CharacterInfo CharacterInfo
        {
            get
            {
                return this.mCharacterInfo;
            }
            set
            {
                this.mCharacterInfo = value;
            }
        }

        public bool LatencyTestOk
        {
            get
            {
                return this.mPongOk;
            }
            set
            {
                this.mPongOk = value;
            }
        }

        public bool InMap
        {
            get
            {
                return this.CurrentMapId > 0;
            }
        }

        public int CurrentMapId
        {
            get
            {
                return !this.mMapJoined || !this.mMapAuthed ? 0 : this.mMapId;
            }
        }

        public int AbsoluteMapId
        {
            get
            {
                return this.mMapId;
            }
            set
            {
                this.mMapId = value;
            }
        }

        public bool MapAuthed
        {
            get
            {
                return this.mMapAuthed;
            }
            set
            {
                this.mMapAuthed = value;
            }
        }

        public bool MapJoined
        {
            get
            {
                return this.mMapJoined;
            }
            set
            {
                this.mMapJoined = value;
            }
        }

        public bool IsChat
        {
            get
            {
                return this.mIsChat;
            }
            set
            {
                this.mIsChat = value;
            }
        }

        public int CurrentChatRoom
        {
            get
            {
                return this.mCurrentChatRoom;
            }
            set
            {
                this.mCurrentChatRoom = value;
            }
        }

        public Session(int Id, Socket Socket)
        {
            this.mId = Id;
            this.mSocket = Socket;
            this.mBuffer = new byte[512];
            this.mPongOk = true;
            this.mSocket.Blocking = false;
            this.BeginReceive();
        }

        public void TryAuthenticate(string Ticket, string RemoteAddress)
        {
            using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
            {
                int CharacterId = SingleSignOnAuthenticator.TryAuthenticate(client, Ticket, RemoteAddress);
                if (CharacterId <= 0)
                {
                    SessionManager.StopSession(this.mId);
                }
                else
                {
                    CharacterInfo characterInfo = CharacterInfoLoader.GetCharacterInfo(client, CharacterId, this.mId, Ticket, true);
                    if (characterInfo == null || !characterInfo.HasLinkedSession)
                    {
                        SessionManager.StopSession(this.mId);
                    }
                    else
                    {
                        this.mCharacterInfo = characterInfo;
                        this.mCharacterInfo.TimestampLastOnline = UnixTimestamp.GetCurrent();
                        CharacterResolverCache.AddToCache(this.mCharacterInfo.Id, this.mCharacterInfo.Username, true);
                        this.mAuthProcessed = true;
                    }
                }
            }
        }

        private void BeginReceive()
        {
            try
            {
                if (this.mSocket == null)
                    return;
                this.mSocket.BeginReceive(this.mBuffer, 0, this.mBuffer.Length, SocketFlags.None, new AsyncCallback(this.OnReceiveData), (object)null);
            }
            catch (Exception ex)
            {
                SessionManager.StopSession(this.mId);
            }
        }

        private void OnReceiveData(IAsyncResult Result)
        {
            int ByteCount = 0;
            try
            {
                if (this.mSocket != null)
                    ByteCount = this.mSocket.EndReceive(Result);
            }
            catch (Exception ex)
            {
            }
            if (ByteCount < 1 || ByteCount >= this.mBuffer.Length)
            {
                SessionManager.StopSession(this.mId);
            }
            else
            {
                this.ProcessData(ByteUtil.Subbyte(this.mBuffer, 0, ByteCount));
                this.BeginReceive();
            }
        }

        public void SendData(ServerMessage Message)
        {
            this.SendData(Message.ToDeltas());
        }

        public void SendData(byte[] Data)
        {
            try
            {
                if (this.mSocket == null || !this.mSocket.Connected)
                    return;
                this.mSocket.BeginSend(Data, 0, Data.Length, SocketFlags.None, new AsyncCallback(this.OnDataSent), (object)null);
            }
            catch (Exception ex)
            {
                Output.WriteLine((object)("[SND] Socket is null!\n\n" + ex.StackTrace), OutputLevel.CriticalError);
            }
        }

        private void OnDataSent(IAsyncResult Result)
        {
            try
            {
                if (this.mSocket == null)
                    return;
                this.mSocket.EndSend(Result);
            }
            catch (Exception ex)
            {
                SessionManager.StopSession(this.mId);
            }
        }

        private void ProcessData(byte[] Data)
        {
            if (Data.Length == 0)
                return;
            if ((int)Data[0] == 60)
            {
                this.SendData(CrossdomainPolicy.GetBytes());
                SessionManager.StopSession(this.mId);
            }
            else if ((int)Data[0] > 0)
            {
                ClientMessage Message;
                try
                {
                    int length = Data.Length;
                    Message = new ClientMessage(Encoding.UTF8.GetString(Data));
                    string header = Message.Header;
                }
                catch (Exception ex)
                {
                    Output.WriteLine((object)"ok2");
                    SessionManager.StopSession(this.mId);
                    return;
                }
                if (Message == null)
                    return;
                try
                {
                    DataRouter.HandleData(this, Message);
                }
                catch (Exception ex)
                {
                    Output.WriteLine((object)("Critical error in HandleData stack: " + ex.Message + "\n\n" + ex.StackTrace), OutputLevel.CriticalError);
                    SessionManager.StopSession(this.mId);
                }
            }
            else
            {
                Output.WriteLine((object)"ok3");
                SessionManager.StopSession(this.mId);
            }
        }

        public void Stop(SqlDatabaseClient MySqlClient)
        {
            if (this.Stopped)
                return;
            this.mSocket.Close();
            this.mSocket = (Socket)null;
            if (this.Authenticated)
                this.mCharacterInfo.SynchronizeStatistics(MySqlClient, 0);
            this.mStoppedTimestamp = UnixTimestamp.GetCurrent();
        }

        public void Dispose()
        {
            if (!this.Stopped)
                throw new InvalidOperationException("Cannot dispose of a session that has not been stopped");
            if (this.IsChat)
                ChatManager.RemovePlayerFromGlobalChannel(this);
            if (this.Authenticated)
            {
                if (this.CurrentMapId > 0)
                    MapManager.RemoveUserFromMap(this);
                if (this.CharacterInfo != null)
                {
                    if (this.CharacterInfo.LaserAttackTimer != null)
                    {
                        this.CharacterInfo.LaserAttackTimer.Dispose();
                        --TimerManager.TimerRunning;
                        this.CharacterInfo.LaserAttackTimer = (Timer)null;
                    }
                    if (this.CharacterInfo.WarningZoneTimer != null)
                    {
                        this.CharacterInfo.WarningZoneTimer.Dispose();
                        --TimerManager.TimerRunning;
                        this.CharacterInfo.WarningZoneTimer = (Timer)null;
                    }
                    if (this.CharacterInfo.RepairTimer != null)
                    {
                        this.CharacterInfo.RepairTimer.Dispose();
                        --TimerManager.TimerRunning;
                        this.CharacterInfo.RepairTimer = (Timer)null;
                    }
                    if (this.CharacterInfo.DisconnectTimer != null)
                    {
                        this.CharacterInfo.DisconnectTimer.Dispose();
                        --TimerManager.TimerRunning;
                        this.CharacterInfo.DisconnectTimer = (Timer)null;
                    }
                    if (this.CharacterInfo.LaserAttackCanTimer != null)
                    {
                        this.CharacterInfo.LaserAttackCanTimer.Dispose();
                        --TimerManager.TimerRunning;
                        this.CharacterInfo.LaserAttackCanTimer = (Timer)null;
                    }
                    if (this.CharacterInfo.PortalJumpTimer != null)
                    {
                        this.CharacterInfo.PortalJumpTimer.Dispose();
                        --TimerManager.TimerRunning;
                        this.CharacterInfo.PortalJumpTimer = (Timer)null;
                    }
                    if (this.CharacterInfo.RocketAttackTimer != null)
                    {
                        this.CharacterInfo.RocketAttackTimer.Dispose();
                        --TimerManager.TimerRunning;
                        this.CharacterInfo.RocketAttackTimer = (Timer)null;
                    }
                }
            }
            this.StoppedPlayer = true;
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Sessions\SessionManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Sessions.SessionManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Communication;
using OrbitReborn_Emulator.Game.Handlers;
using OrbitReborn_Emulator.Game.Moderation;
using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Net.Sockets;
using System.Threading;

namespace OrbitReborn_Emulator.Game.Sessions
{
    public static class SessionManager
    {
        private static ConcurrentDictionary<int, Session> mSessions;
        private static int mCounter;
        private static CList<int> mSessionsToStop;
        private static Timer mMonitorThread;
        private static Timer mNoFightThread;
        private static object mSyncRoot;

        public static CDictionnary<int, Session> Sessions
        {
            get
            {
                CDictionnary<int, Session> cdictionnary = new CDictionnary<int, Session>();
                foreach (KeyValuePair<int, Session> mSession in SessionManager.mSessions)
                {
                    if (!mSession.Value.Stopped)
                        cdictionnary.Add(mSession.Key, mSession.Value);
                }
                return cdictionnary;
            }
        }

        public static CList<Session> SessionsUser
        {
            get
            {
                CList<Session> clist = new CList<Session>();
                foreach (Session key in (IEnumerable<Session>)SessionManager.mSessions.Values)
                {
                    if (key != null && !key.Stopped && key.Authenticated && !key.IsChat)
                        clist.Add(key);
                }
                return clist;
            }
        }

        public static CDictionnary<int, string> ConnectedUserData
        {
            get
            {
                CDictionnary<int, string> cdictionnary = new CDictionnary<int, string>();
                foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
                {
                    if (session.Authenticated && !cdictionnary.ContainsKey(session.CharacterId))
                        cdictionnary.Add(session.CharacterId, session.CharacterInfo.Username);
                }
                return cdictionnary;
            }
        }

        public static int ActiveConnections
        {
            get
            {
                if (SessionManager.mSessions != null)
                    return SessionManager.mSessions.Count;
                return 0;
            }
        }

        public static void Initialize()
        {
            SessionManager.mSessions = new ConcurrentDictionary<int, Session>();
            SessionManager.mSessionsToStop = new CList<int>();
            SessionManager.mCounter = 0;
            SessionManager.mMonitorThread = new Timer(new TimerCallback(SessionManager.ExecuteMonitor), (object)null, TimeSpan.FromMilliseconds(300.0), TimeSpan.FromMilliseconds(300.0));
            SessionManager.mNoFightThread = new Timer(new TimerCallback(SessionManager.ExecuteNoFightMonitor), (object)null, TimeSpan.FromMilliseconds(1000.0), TimeSpan.FromMilliseconds(1000.0));
            SessionManager.mSyncRoot = new object();
        }

        private static void ExecuteNoFightMonitor(object state)
        {
            foreach (Session Session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (Session.CharacterInfo != null && !Session.IsChat)
                {
                    if (!Session.CharacterInfo.Destroy && !Session.StoppedPlayer && Session.CharacterInfo.Attacked != null)
                    {
                        lock (Session.CharacterInfo.Attacked)
                        {
                            foreach (Session item_0 in (IEnumerable<Session>)Session.CharacterInfo.Attacked.Keys)
                            {
                                if ((item_0.CharacterInfo.Destroy || item_0.StoppedPlayer || item_0.CharacterInfo.Disconnected || item_0.CharacterInfo.SelectedPlayer != Session.CharacterId) && Session.CharacterInfo.Attacked.Contains(item_0))
                                    Session.CharacterInfo.Attacked.Remove(item_0);
                            }
                        }
                    }
                    if (Session.CharacterInfo.Attacked.Count > 0 || Session.CharacterInfo.WarningZone)
                    {
                        Session.CharacterInfo.NoFightTimer = 0;
                    }
                    else
                    {
                        if (!Session.CharacterInfo.CanRegenShield)
                            ++Session.CharacterInfo.NoFightTimer;
                        if (Session.CharacterInfo.ShipShield != Session.CharacterInfo.ShipMaxShield && Session.CharacterInfo.CanRegenShield)
                            Fight.RegeneratingShield(Session);
                    }
                }
            }
        }

        private static void ExecuteMonitor(object state)
        {
            CList<Session> clist1 = new CList<Session>();
            CList<Session> clist2 = new CList<Session>();
            lock (SessionManager.mSessionsToStop)
            {
                foreach (int item_0 in (IEnumerable<int>)SessionManager.mSessionsToStop.Keys)
                {
                    if (SessionManager.mSessions.ContainsKey(item_0))
                        clist2.Add(SessionManager.mSessions[item_0]);
                }
                SessionManager.mSessionsToStop.Clear();
            }
            foreach (Session key in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (!clist2.Contains(key) && key.Stopped && key.TimeStopped > 30.0)
                    clist1.Add(key);
            }
            if (clist2.Count > 0)
            {
                using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
                {
                    foreach (Session key in (IEnumerable<Session>)clist2.Keys)
                        key.Stop(client);
                }
            }
            foreach (Session key in (IEnumerable<Session>)clist1.Keys)
            {
                key.Dispose();
                if (SessionManager.mSessions.ContainsKey(key.Id))
                {
                    Session session;
                    SessionManager.mSessions.TryRemove(key.Id, out session);
                }
            }
        }

        public static void StopSession(int SessionId)
        {
            lock (SessionManager.mSessionsToStop)
                SessionManager.mSessionsToStop.Add(SessionId);
        }

        public static bool ContainsCharacterId(int Uid)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (!session.StoppedPlayer && session.CharacterId == Uid)
                    return true;
            }
            return false;
        }

        public static Session GetSessionByCharacterId(int Id)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (!session.StoppedPlayer && !session.IsChat && session.CharacterId == Id)
                    return session;
            }
            return (Session)null;
        }

        public static Session GetSessionById(int Id)
        {
            if (SessionManager.mSessions.ContainsKey(Id))
                return SessionManager.mSessions[Id];
            return (Session)null;
        }

        //for group system
        public static Session GetSessionByUsername(string uname)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (!session.StoppedPlayer && session.IsChat && session.CharacterInfo.Username.ToLower() == uname)
                    return session;
            }
            return (Session)null;
        }
        //for group system

        public static Session GetSessionByUsernameChat(string Username)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (!session.StoppedPlayer && session.IsChat && session.CharacterInfo.Username.ToLower() == Username)
                    return session;
            }
            return (Session)null;
        }

        public static bool ContainsCharacterIdCache(int Uid)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (session.CharacterId == Uid && !session.CharacterInfo.Disconnected)
                    return true;
            }
            return false;
        }

        public static Session GetSessionByCharacterIdCache(int Id)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (session.CharacterId == Id && !session.CharacterInfo.Disconnected && !session.IsChat)
                    return session;
            }
            return (Session)null;
        }

        public static void BroadcastPacket(ServerMessage Message)
        {
            SessionManager.BroadcastPacket(Message.ToDeltas(), string.Empty);
        }

        public static void BroadcastPacket(byte[] Data)
        {
            SessionManager.BroadcastPacket(Data, string.Empty);
        }

        public static void BroadcastPacket(ServerMessage Message, string RequiredRight)
        {
            SessionManager.BroadcastPacket(Message.ToDeltas(), RequiredRight);
        }

        public static void BroadcastToMapMovement(int CharacterId, int MapId, ServerMessage Message)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (session != null && !session.Stopped && session.Authenticated && !session.IsChat)
                    session.SendData(Message);
            }
        }

        public static void BroadcastToUser(ServerMessage Message)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (session != null && !session.Stopped && session.Authenticated && !session.IsChat)
                    session.SendData(Message);
            }
        }

        public static void BroadcastPacket(byte[] Data, string RequiredRight)
        {
            foreach (Session session in (IEnumerable<Session>)SessionManager.mSessions.Values)
            {
                if (session != null && !session.Stopped && session.Authenticated)
                    session.SendData(Data);
            }
        }

        public static void HandleIncomingConnection(Socket IncomingSocket)
        {
            bool flag = ModerationBanManager.IsRemoteAddressBlacklisted(IncomingSocket.RemoteEndPoint.ToString().Split(':')[0]);
            Output.WriteLine((object)((flag ? "Rejected" : "Accepted") + " incoming connection from " + IncomingSocket.RemoteEndPoint.ToString().Split(':')[0] + "."), OutputLevel.Informational);
            if (flag)
            {
                try
                {
                    IncomingSocket.Close();
                }
                catch (Exception ex)
                {
                }
            }
            else
            {
                int num = SessionManager.mCounter++;
                SessionManager.mSessions.TryAdd(num, new Session(num, IncomingSocket));
            }
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Game\Sessions\SingleSignOnAuthenticator.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Game.Sessions.SingleSignOnAuthenticator
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Config;
using OrbitReborn_Emulator.Game.Maps;
using OrbitReborn_Emulator.Game.Moderation;
using OrbitReborn_Emulator.Storage;
using System.Data;

namespace OrbitReborn_Emulator.Game.Sessions
{
  public static class SingleSignOnAuthenticator
  {
    private static int mSuccessfulLoginCount;
    private static int mFailedLoginCount;
    private static object mAuthSyncRoot;

    public static int SuccessfulLoginCount
    {
      get
      {
        return SingleSignOnAuthenticator.mSuccessfulLoginCount;
      }
    }

    public static int FailedLoginCount
    {
      get
      {
        return SingleSignOnAuthenticator.mFailedLoginCount;
      }
    }

    public static int TotalLoginCount
    {
      get
      {
        return SingleSignOnAuthenticator.mSuccessfulLoginCount + SingleSignOnAuthenticator.mFailedLoginCount;
      }
    }

    public static void Initialize()
    {
      SingleSignOnAuthenticator.mSuccessfulLoginCount = 0;
      SingleSignOnAuthenticator.mFailedLoginCount = 0;
      SingleSignOnAuthenticator.mAuthSyncRoot = new object();
    }

    public static int TryAuthenticate(SqlDatabaseClient MySqlClient, string Ticket, string RemoteAddress)
    {
      Output.WriteLine((object) ("sso : '" + Ticket + "'"));
      Ticket = Ticket.Trim();
      if (Ticket.Length <= 5)
      {
        ++SingleSignOnAuthenticator.mFailedLoginCount;
        Output.WriteLine((object) ("Login from " + RemoteAddress + " rejected: SSO ticket too short."));
        return 0;
      }
      string str = (string) ConfigManager.GetValue("debug.sso");
      if (str.Length > 0 && Ticket == str)
        return 1;
      int num = 0;
      string empty = string.Empty;
      MySqlClient.ClearParameters();
      MySqlClient.SetParameter("ticket", (object) Ticket);
      DataRow dataRow = MySqlClient.ExecuteQueryRow("SELECT id,username FROM users WHERE AuthTicket = @ticket LIMIT 1");
      if (dataRow != null)
      {
        num = (int) dataRow["id"];
        empty = (string) dataRow["username"];
        SingleSignOnAuthenticator.RemoveTicket(MySqlClient, (int) dataRow["id"], RemoteAddress);
      }
      if (num <= 0)
      {
        ++SingleSignOnAuthenticator.mFailedLoginCount;
        Output.WriteLine((object) ("Login from " + RemoteAddress + " rejected: invalid SSO ticket."));
        return 0;
      }
      if (ModerationBanManager.IsUserIdBlacklisted(num))
      {
        ++SingleSignOnAuthenticator.mFailedLoginCount;
        Output.WriteLine((object) ("Login from " + RemoteAddress + " rejected: blacklisted ID."));
        return 0;
      }
      if (SessionManager.ContainsCharacterId(num))
      {
        Session sessionByCharacterId = SessionManager.GetSessionByCharacterId(num);
        if (sessionByCharacterId != null)
        {
          MapManager.RemoveUserFromMap(sessionByCharacterId);
          SessionManager.StopSession(sessionByCharacterId.Id);
          sessionByCharacterId.StoppedPlayer = true;
        }
        Output.WriteLine((object) "SSO stop previous session.");
      }
      Output.WriteLine((object) ("User " + empty + " (ID " + (object) num + ") has logged in from " + RemoteAddress + "."));
      ++SingleSignOnAuthenticator.mSuccessfulLoginCount;
      return num;
    }

    private static void RemoveTicket(SqlDatabaseClient MySqlClient, int UserId, string AddressToLog)
    {
      MySqlClient.ClearParameters();
      MySqlClient.SetParameter("id", (object) UserId);
      MySqlClient.SetParameter("lastip", (object) AddressToLog);
      MySqlClient.SetParameter("lastonline", (object) UnixTimestamp.GetCurrent());
      MySqlClient.ExecuteNonQuery("UPDATE users SET AuthTicket = '', ip = @lastip, lastlogin = @lastonline, online = 1 WHERE id = @id LIMIT 1");
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Libs\CDictionnary`2.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Libs.CDictionnary`2
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System;
using System.Collections.Concurrent;
using System.Threading;

namespace OrbitReborn_Emulator.Libs
{
  public class CDictionnary<TKey, TValue> : ConcurrentDictionary<TKey, TValue>
  {
    public void Remove(TKey key)
    {
      TValue obj;
      while (this.ContainsKey(key) && !this.TryRemove(key, out obj))
      {
        Output.WriteLine((object) "TryRemove failed");
        Thread.Sleep(100);
      }
    }

    public void Add(TKey key, TValue value)
    {
      this.AddOrUpdate(key, value, (Func<TKey, TValue, TValue>) ((key1, oldValue) => value));
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Libs\CList`1.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Libs.CList`1
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System;

namespace OrbitReborn_Emulator.Libs
{
  public class CList<T> : CDictionnary<T, T>
  {
    public void Add(T key)
    {
      this.AddOrUpdate(key, key, (Func<T, T, T>) ((key1, oldValue) => key));
    }

    public bool Contains(T key)
    {
      return this.ContainsKey(key);
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Network\OnNewConnectionCallback.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Network.OnNewConnectionCallback
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System.Net.Sockets;

namespace OrbitReborn_Emulator.Network
{
  public delegate void OnNewConnectionCallback(Socket Socket);
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Network\SocketListener.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Network.SocketListener
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System;
using System.Net;
using System.Net.Sockets;

namespace OrbitReborn_Emulator.Network
{
  public class SocketListener : IDisposable
  {
    private Socket mSocket;
    private OnNewConnectionCallback mCallback;

    public SocketListener(IPEndPoint LocalEndpoint, int Backlog, OnNewConnectionCallback Callback)
    {
      this.mCallback = Callback;
      this.mSocket = new Socket(LocalEndpoint.AddressFamily, SocketType.Stream, ProtocolType.Tcp);
      this.mSocket.Bind((EndPoint) LocalEndpoint);
      this.mSocket.Listen(Backlog);
      this.mSocket.Blocking = false;
      this.BeginAccept();
    }

    public void Dispose()
    {
      if (this.mSocket == null)
        return;
      this.mSocket.Dispose();
      this.mSocket = (Socket) null;
    }

    private void BeginAccept()
    {
      try
      {
        this.mSocket.BeginAccept(new AsyncCallback(this.OnAccept), (object) null);
      }
      catch (Exception ex)
      {
      }
    }

    private void OnAccept(IAsyncResult Result)
    {
      try
      {
        this.mCallback(this.mSocket.EndAccept(Result));
      }
      catch (Exception ex)
      {
      }
      this.BeginAccept();
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\ScreenShotDemo\ScreenCapture.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: ScreenShotDemo.ScreenCapture
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using System;
using System.Drawing;
using System.Drawing.Imaging;
using System.Runtime.InteropServices;

namespace ScreenShotDemo
{
  public class ScreenCapture
  {
    public Image CaptureScreen()
    {
      return this.CaptureWindow(ScreenCapture.User32.GetDesktopWindow());
    }

    public Image CaptureWindow(IntPtr handle)
    {
      IntPtr windowDc = ScreenCapture.User32.GetWindowDC(handle);
      ScreenCapture.User32.RECT rect = new ScreenCapture.User32.RECT();
      ScreenCapture.User32.GetWindowRect(handle, ref rect);
      int nWidth = rect.right - rect.left;
      int nHeight = rect.bottom - rect.top;
      IntPtr compatibleDc = ScreenCapture.GDI32.CreateCompatibleDC(windowDc);
      IntPtr compatibleBitmap = ScreenCapture.GDI32.CreateCompatibleBitmap(windowDc, nWidth, nHeight);
      IntPtr hObject = ScreenCapture.GDI32.SelectObject(compatibleDc, compatibleBitmap);
      ScreenCapture.GDI32.BitBlt(compatibleDc, 0, 0, nWidth, nHeight, windowDc, 0, 0, 13369376);
      ScreenCapture.GDI32.SelectObject(compatibleDc, hObject);
      ScreenCapture.GDI32.DeleteDC(compatibleDc);
      ScreenCapture.User32.ReleaseDC(handle, windowDc);
      Image image = (Image) Image.FromHbitmap(compatibleBitmap);
      ScreenCapture.GDI32.DeleteObject(compatibleBitmap);
      return image;
    }

    public void CaptureWindowToFile(IntPtr handle, string filename, ImageFormat format)
    {
      this.CaptureWindow(handle).Save(filename, format);
    }

    public void CaptureScreenToFile(string filename, ImageFormat format)
    {
      this.CaptureScreen().Save(filename, format);
    }

    private class GDI32
    {
      public const int SRCCOPY = 13369376;

      [DllImport("gdi32.dll")]
      public static extern bool BitBlt(IntPtr hObject, int nXDest, int nYDest, int nWidth, int nHeight, IntPtr hObjectSource, int nXSrc, int nYSrc, int dwRop);

      [DllImport("gdi32.dll")]
      public static extern IntPtr CreateCompatibleBitmap(IntPtr hDC, int nWidth, int nHeight);

      [DllImport("gdi32.dll")]
      public static extern IntPtr CreateCompatibleDC(IntPtr hDC);

      [DllImport("gdi32.dll")]
      public static extern bool DeleteDC(IntPtr hDC);

      [DllImport("gdi32.dll")]
      public static extern bool DeleteObject(IntPtr hObject);

      [DllImport("gdi32.dll")]
      public static extern IntPtr SelectObject(IntPtr hDC, IntPtr hObject);
    }

    private class User32
    {
      [DllImport("user32.dll")]
      public static extern IntPtr GetDesktopWindow();

      [DllImport("user32.dll")]
      public static extern IntPtr GetWindowDC(IntPtr hWnd);

      [DllImport("user32.dll")]
      public static extern IntPtr ReleaseDC(IntPtr hWnd, IntPtr hDC);

      [DllImport("user32.dll")]
      public static extern IntPtr GetWindowRect(IntPtr hWnd, ref ScreenCapture.User32.RECT rect);

      public struct RECT
      {
        public int left;
        public int top;
        public int right;
        public int bottom;
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Specialized\TimerManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Specialized.TimerManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Specialized
{
  public static class TimerManager
  {
    private static int mTimerRunning;

    public static int TimerRunning
    {
      get
      {
        return TimerManager.mTimerRunning;
      }
      set
      {
        TimerManager.mTimerRunning = value;
      }
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Specialized\Vector2.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Specialized.Vector2
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Specialized
{
  public class Vector2
  {
    private int mX;
    private int mY;

    public int X
    {
      get
      {
        return this.mX;
      }
      set
      {
        this.mX = value;
      }
    }

    public int Y
    {
      get
      {
        return this.mY;
      }
      set
      {
        this.mY = value;
      }
    }

    public Vector2()
    {
      this.mX = 0;
      this.mY = 0;
    }

    public Vector2(int X, int Y)
    {
      this.mX = X;
      this.mY = Y;
    }

    public override string ToString()
    {
      return this.X.ToString() + "|" + (object) this.Y;
    }

    public static Vector2 FromString(string Input)
    {
      string[] strArray = Input.Split('|');
      int result1 = 0;
      int result2 = 0;
      int.TryParse(strArray[0], out result1);
      if (strArray.Length > 1)
        int.TryParse(strArray[1], out result2);
      return new Vector2(result1, result2);
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Storage\SqlDatabaseClient.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Storage.SqlDatabaseClient
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using MySql.Data.MySqlClient;
using System;
using System.Data;

namespace OrbitReborn_Emulator.Storage
{
  public class SqlDatabaseClient: IDisposable
  {
    private int mId;
    private double mLastActivity;
    private MySqlConnection mConnection;
    private MySqlCommand mCommand;
    private bool mAvailable;

    public int Id
    {
      get
      {
        return this.mId;
      }
    }

    public bool Available
    {
      get
      {
        return this.mAvailable;
      }
      set
      {
        this.mAvailable = value;
      }
    }

    public double TimeInactive
    {
      get
      {
        return UnixTimestamp.GetCurrent() - this.mLastActivity;
      }
    }

    public SqlDatabaseClient(int Id, MySqlConnection Connection)
    {
      this.mId = Id;
      this.mConnection = Connection;
      this.mCommand = new MySqlCommand();
      this.mCommand.Connection = this.mConnection;
      this.mAvailable = true;
      this.UpdateLastActivity();
    }

    public void Dispose()
    {
      this.mAvailable = true;
      this.UpdateLastActivity();
      SqlDatabaseManager.PokeAllAwaiting();
    }

    public void Close()
    {
      this.mConnection.Close();
      this.mCommand.Dispose();
      this.mConnection = (MySqlConnection) null;
      this.mCommand = (MySqlCommand) null;
    }

    private void UpdateLastActivity()
    {
      this.mLastActivity = UnixTimestamp.GetCurrent();
    }

    public void ClearParameters()
    {
      this.mCommand.Parameters.Clear();
    }

    public void SetParameter(string Key, object Value)
    {
      this.mCommand.Parameters.Add(new MySqlParameter(Key, Value));
    }

    public void ResetCommand()
    {
      this.mCommand.CommandText = (string) null;
      this.ClearParameters();
    }

    public int ExecuteNonQuery(string CommandText)
    {
            try
            {
                this.mCommand.CommandText = CommandText;
                int num = this.mCommand.ExecuteNonQuery();
                this.ResetCommand();
                return num;
            } catch (Exception error)
            {
                Console.WriteLine("ERROR :", error);
                return -1;
            }
    }

    public DataSet ExecuteQuerySet(string CommandText)
    {
      DataSet dataSet = new DataSet();
      this.mCommand.CommandText = CommandText;
      using (MySqlDataAdapter mySqlDataAdapter = new MySqlDataAdapter(this.mCommand))
        mySqlDataAdapter.Fill(dataSet);
      this.ResetCommand();
      return dataSet;
    }

    public DataTable ExecuteQueryTable(string CommandText)
    {
      DataSet dataSet = this.ExecuteQuerySet(CommandText);
      return dataSet.Tables.Count > 0 ? dataSet.Tables[0] : (DataTable) null;
    }

    public DataRow ExecuteQueryRow(string CommandText)
    {
      DataTable dataTable = this.ExecuteQueryTable(CommandText);
      return dataTable.Rows.Count > 0 ? dataTable.Rows[0] : (DataRow) null;
    }

        public DataRowCollection ExecuteQueryRows(string CommandText)
        {
            DataTable dataTable = this.ExecuteQueryTable(CommandText);
            return dataTable.Rows.Count > 0 ? dataTable.Rows : null;
        }

        public object ExecuteScalar(string CommandText)
    {
      this.mCommand.CommandText = CommandText;
      object obj = this.mCommand.ExecuteScalar();
      this.ResetCommand();
      return obj;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Storage\SqlDatabaseManager.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Storage.SqlDatabaseManager
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using MySql.Data.MySqlClient;
using OrbitReborn_Emulator.Config;
using OrbitReborn_Emulator.Libs;
using System;
using System.Collections.Generic;
using System.Threading;

namespace OrbitReborn_Emulator.Storage
{
  public static class SqlDatabaseManager
  {
    private static CDictionnary<int, SqlDatabaseClient> mClients;
    private static int mStarvationCounter;
    private static int mMinPoolSize;
    private static int mMaxPoolSize;
    private static int mPoolLifetime;
    private static int mClientIdGenerator;
    private static object mSyncRoot;
    private static ManualResetEvent mPoolWait;
    private static Timer mMonitorThread;

    public static int ClientCount
    {
      get
      {
        return SqlDatabaseManager.mClients.Count;
      }
    }

    public static void Initialize()
    {
      SqlDatabaseManager.mClients = new CDictionnary<int, SqlDatabaseClient>();
      SqlDatabaseManager.mMinPoolSize = (int) ConfigManager.GetValue("mysql.pool.min");
      SqlDatabaseManager.mMaxPoolSize = (int) ConfigManager.GetValue("mysql.pool.max");
      SqlDatabaseManager.mPoolLifetime = (int) ConfigManager.GetValue("mysql.pool.lifetime");
      SqlDatabaseManager.mSyncRoot = new object();
      SqlDatabaseManager.mPoolWait = new ManualResetEvent(true);
      SqlDatabaseManager.mMonitorThread = new Timer(new TimerCallback(SqlDatabaseManager.ProcessMonitorThread), (object) null, SqlDatabaseManager.mPoolLifetime / 2, SqlDatabaseManager.mPoolLifetime / 2);
      if (SqlDatabaseManager.mMinPoolSize < 0)
        throw new ArgumentException("(Sql) Invalid database pool size configured (less than zero).");
      SqlDatabaseManager.SetClientAmount(SqlDatabaseManager.mMinPoolSize, "server init");
    }

    public static void Uninitialize()
    {
      int num = 0;
      while (SqlDatabaseManager.mClients.Count > 0)
      {
        lock (SqlDatabaseManager.mSyncRoot)
        {
          CList<int> local_1 = new CList<int>();
          foreach (SqlDatabaseClient item_0 in (IEnumerable<SqlDatabaseClient>) SqlDatabaseManager.mClients.Values)
          {
            if (item_0.Available || num > 15)
              local_1.Add(item_0.Id);
          }
          foreach (int item_1 in (IEnumerable<int>) local_1.Keys)
          {
            SqlDatabaseManager.mClients[item_1].Close();
            SqlDatabaseManager.mClients.Remove(item_1);
          }
        }
        if (SqlDatabaseManager.mClients.Count > 0)
        {
          Output.WriteLine((object) ("(Sql) Waiting for all database clients to release (" + (object) ++num + ")..."), OutputLevel.DebugInformation);
          Thread.Sleep(100);
        }
      }
    }

    public static void ProcessMonitorThread(object state)
    {
      if (SqlDatabaseManager.ClientCount <= SqlDatabaseManager.mMinPoolSize)
        return;
      lock (SqlDatabaseManager.mSyncRoot)
      {
        CList<int> local_0 = new CList<int>();
        foreach (SqlDatabaseClient item_0 in (IEnumerable<SqlDatabaseClient>) SqlDatabaseManager.mClients.Values)
        {
          if (item_0.Available && item_0.TimeInactive >= (double) SqlDatabaseManager.mPoolLifetime)
            local_0.Add(item_0.Id);
        }
        foreach (int item_1 in (IEnumerable<int>) local_0.Keys)
        {
          SqlDatabaseManager.mClients[item_1].Close();
          SqlDatabaseManager.mClients.Remove(item_1);
        }
        if (local_0.Count > 0)
          Output.WriteLine((object) ("(Sql) Disconnected " + (object) local_0.Count + " inactive client(s)."), OutputLevel.DebugInformation);
      }
    }

    public static void SetClientAmount(int ClientAmount, string LogReason = "Unknown")
    {
      lock (SqlDatabaseManager.mSyncRoot)
      {
        int local_0 = ClientAmount - SqlDatabaseManager.ClientCount;
        if (local_0 > 0)
        {
          for (int local_1 = 0; local_1 < local_0; ++local_1)
          {
            int local_2 = SqlDatabaseManager.GenerateClientId();
            SqlDatabaseManager.mClients.Add(local_2, SqlDatabaseManager.CreateClient(local_2));
          }
        }
        else
        {
          int local_3 = -local_0;
          int local_4 = 0;
          foreach (SqlDatabaseClient item_0 in (IEnumerable<SqlDatabaseClient>) SqlDatabaseManager.mClients.Values)
          {
            if (item_0.Available)
            {
              if (local_4 < local_3 && SqlDatabaseManager.ClientCount > SqlDatabaseManager.mMinPoolSize)
              {
                item_0.Close();
                SqlDatabaseManager.mClients.Remove(item_0.Id);
                ++local_4;
              }
              else
                break;
            }
          }
        }
      }
    }

    public static SqlDatabaseClient GetClient()
    {
      lock (SqlDatabaseManager.mSyncRoot)
      {
        foreach (SqlDatabaseClient item_0 in (IEnumerable<SqlDatabaseClient>) SqlDatabaseManager.mClients.Values)
        {
          if (item_0.Available)
          {
            item_0.Available = false;
            return item_0;
          }
        }
        if (SqlDatabaseManager.mMaxPoolSize <= 0 || SqlDatabaseManager.ClientCount < SqlDatabaseManager.mMaxPoolSize)
        {
          SqlDatabaseManager.SetClientAmount(SqlDatabaseManager.ClientCount + 1, "out of assignable clients in GetClient()");
          return SqlDatabaseManager.GetClient();
        }
        ++SqlDatabaseManager.mStarvationCounter;
        Output.WriteLine((object) ("(Sql) Client starvation; out of assignable clients/maximum pool size reached. Consider increasing the `mysql.pool.max` configuration value. Starvation count is " + (object) SqlDatabaseManager.mStarvationCounter + "."), OutputLevel.Warning);
        Monitor.Wait(SqlDatabaseManager.mSyncRoot);
        return SqlDatabaseManager.GetClient();
      }
    }

    public static void PokeAllAwaiting()
    {
      lock (SqlDatabaseManager.mSyncRoot)
        Monitor.PulseAll(SqlDatabaseManager.mSyncRoot);
    }

    private static int GenerateClientId()
    {
      lock (SqlDatabaseManager.mSyncRoot)
        return SqlDatabaseManager.mClientIdGenerator++;
    }

    private static SqlDatabaseClient CreateClient(int Id)
    {
      MySqlConnection Connection = new MySqlConnection(SqlDatabaseManager.GenerateConnectionString());
      Connection.Open();
      return new SqlDatabaseClient(Id, Connection);
    }

    public static string GenerateConnectionString()
    {
      return new MySqlConnectionStringBuilder()
      {
        Server = ((string) ConfigManager.GetValue("mysql.host")),
        Port = ((uint) (int) ConfigManager.GetValue("mysql.port")),
        UserID = ((string) ConfigManager.GetValue("mysql.user")),
        Password = ((string) ConfigManager.GetValue("mysql.pass")),
        Database = ((string) ConfigManager.GetValue("mysql.dbname")),
        MinimumPoolSize = ((uint) (int) ConfigManager.GetValue("mysql.pool.min")),
        MaximumPoolSize = ((uint) (int) ConfigManager.GetValue("mysql.pool.max"))
      }.ToString();
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Util\ByteUtil.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Util.ByteUtil
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

namespace OrbitReborn_Emulator.Util
{
  public static class ByteUtil
  {
    public static byte[] Subbyte(byte[] Bytes, int Offset, int ByteCount)
    {
      int num1 = Offset + ByteCount;
      if (num1 > Bytes.Length)
        num1 = Bytes.Length;
      int num2 = num1 - ByteCount;
      if (ByteCount > Bytes.Length)
        ByteCount = Bytes.Length;
      if (ByteCount < 0)
        ByteCount = 0;
      byte[] numArray = new byte[ByteCount];
      for (int index = 0; index < ByteCount; ++index)
        numArray[index] = Bytes[Offset++];
      return numArray;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Util\CharacterResolverCache.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Util.CharacterResolverCache
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Libs;
using OrbitReborn_Emulator.Storage;
using System.Collections.Concurrent;
using System.Collections.Generic;

namespace OrbitReborn_Emulator.Util
{
  public static class CharacterResolverCache
  {
    private static CDictionnary<int, string> mNameCache = new CDictionnary<int, string>();

    public static void AddToCache(int Id, string Name, bool Override)
    {
      lock (CharacterResolverCache.mNameCache)
      {
        if (CharacterResolverCache.mNameCache.ContainsKey(Id))
        {
          if (!Override)
            return;
          CharacterResolverCache.mNameCache[Id] = Name;
        }
        else
          CharacterResolverCache.mNameCache.Add(Id, Name);
      }
    }

    public static string GetNameFromUid(int UserId)
    {
      lock (CharacterResolverCache.mNameCache)
      {
        if (CharacterResolverCache.mNameCache.ContainsKey(UserId))
          return CharacterResolverCache.mNameCache[UserId];
        using (SqlDatabaseClient resource_0 = SqlDatabaseManager.GetClient())
        {
          resource_0.ClearParameters();
          resource_0.SetParameter("id", (object) UserId);
          string local_1 = (string) resource_0.ExecuteScalar("SELECT username FROM users WHERE id = @id LIMIT 1");
          if (local_1 != null && local_1.Length > 0)
          {
            CharacterResolverCache.mNameCache.Add(UserId, local_1);
            return local_1;
          }
        }
      }
      return "Unknown User";
    }

    public static int GetUidFromName(string Name)
    {
      lock (CharacterResolverCache.mNameCache)
      {
        foreach (KeyValuePair<int, string> item_0 in (ConcurrentDictionary<int, string>) CharacterResolverCache.mNameCache)
        {
          if (item_0.Value.ToLower() == Name.ToLower())
            return item_0.Key;
        }
        using (SqlDatabaseClient resource_0 = SqlDatabaseManager.GetClient())
        {
          resource_0.ClearParameters();
          resource_0.SetParameter("username", (object) Name);
          object local_2 = resource_0.ExecuteScalar("SELECT id FROM users WHERE username = @username LIMIT 1");
          if (local_2 != null)
          {
            int local_3 = (int) local_2;
            CharacterResolverCache.mNameCache.Add(local_3, Name);
            return local_3;
          }
        }
      }
      return 0;
    }
  }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Util\GeneralFunctions.cs 
======================================================== 
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace OrbitReborn_Emulator.Util
{
    class GeneralFunctions
    {
        public static string ToEnum(bool isTrue)
        {
            return !isTrue ? "0" : "1";
        }
    }
}
 
 
======================================================== 
FICHIER : C:\Users\the_k\OneDrive\Desktop\serveur andromeda\Server\Andromeda-emu source\Util\StatisticsSyncUtil.cs 
======================================================== 
﻿// Decompiled with JetBrains decompiler
// Type: OrbitReborn_Emulator.Util.StatisticsSyncUtil
// Assembly: MilkyWay Emulator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 41E1229A-7B44-4276-8108-A67D8866C227
// Assembly location: C:\Totally not GTA\andromedaserver\Emulator\MilkyWay Emulator.exe

using OrbitReborn_Emulator.Game.Sessions;
using OrbitReborn_Emulator.Storage;
using System.Threading;

namespace OrbitReborn_Emulator.Util
{
  public static class StatisticsSyncUtil
  {
    public static void Initialize()
    {
      new Thread(new ThreadStart(StatisticsSyncUtil.ProcessThread))
      {
        Priority = ThreadPriority.Lowest,
        Name = "StatisticsDbSyncThread"
      }.Start();
    }

    private static void ProcessThread()
    {
      while (Program.Alive)
      {
        using (SqlDatabaseClient client = SqlDatabaseManager.GetClient())
        {
          client.ClearParameters();
          client.SetParameter("skey", (object) "active_connections");
          client.SetParameter("sval", (object) SessionManager.ConnectedUserData.Count);
          client.ExecuteNonQuery("UPDATE server_statistics SET sval = @sval WHERE skey = @skey LIMIT 1");
        }
        Thread.Sleep(60000);
      }
    }
  }
}
 
